
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RankQuest (α版)</title>
    
    <!-- LIFFのプログラムを読み込む（LINEが提供しているもの） -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- ========================================
         Firebase SDK の読み込み（フェーズ3で追加）
         ======================================== -->
    <!-- Firebase App (コア機能) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- ========================================
         SortableJS の読み込み（ドラッグ&ドロップライブラリ）
         ======================================== -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <div class="container">
        <h1>🎯 RankQuest (α版)</h1>
        <p class="subtitle">話題が広がる！仲が深まる！<br>ランクを当てるコミュニケーションゲーム</p>
        
        <!-- 読み込み中の表示 -->
        <div id="loading" class="loading">
            <p>読み込み中...</p>
        </div>
        
        <!-- LINEでログインしていない場合のエラー表示 -->
        <div id="error" class="error" style="display: none;">
            <p><strong>エラー:</strong> このアプリはLINEから開いてください。</p>
        </div>
        
        <!-- メイン画面 -->
        <div id="mainScreen" class="screen">
            <!-- ふたりであそぶ -->
            <div style="margin-bottom: 20px;">
                <button onclick="showBetaRoleSelect()" style="background: linear-gradient(135deg, #11998e, #38ef7d); font-size: 17px; padding: 18px 20px;">
                    🏠 ふたりであそぶ
                </button>
                <p style="color: #999; font-size: 11px; margin-top: 5px; text-align: center;">ふたり用のゲームモードです</p>
            </div>
            
            <!-- みんなであそぶ -->
            <div style="margin-bottom: 20px;">
                <button onclick="showMultiRoleSelect()" style="background: linear-gradient(135deg, #6C5CE7, #a29bfe); font-size: 17px; padding: 18px 20px;">
                    👥 みんなであそぶ
                </button>
                <p style="color: #999; font-size: 11px; margin-top: 5px; text-align: center;">3人以上用のゲームモードです</p>
            </div>
            
            <!-- 開発用トグル -->
            <div style="padding-top: 20px; border-top: 1px dashed #ddd; margin-top: 10px;">
                <button onclick="toggleHomeDevMenu()" style="background: #999; font-size: 13px; padding: 8px 16px;">
                    🔧 開発用
                </button>
                
                <div id="homeDevMenuContent" style="display: none; margin-top: 10px;">
                    <!-- 旧：ふたりであそぶ（ペア方式） -->
                    <button id="realtimeGameButton" onclick="tryStartRealtimeGame()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); font-size: 15px; padding: 14px 20px; margin-bottom: 8px;">
                        🎮 ふたりであそぶ（旧・ペア方式）
                    </button>
                    
                    <!-- ペア状態表示エリア -->
                    <div id="pairStatus" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
                        <p style="color: #666; font-size: 13px; margin-bottom: 8px;">👥 ペアの設定状態</p>
                        <div id="pairStatusContent">
                            <p style="color: #999; font-size: 14px;">読み込み中...</p>
                        </div>
                        <button id="pairSettingButton" onclick="showPairScreen()" style="background: #9B59B6; margin-top: 10px; font-size: 14px; padding: 10px 15px;">
                            ⚙️ ペアを設定する
                        </button>
                    </div>
                    
                    <button onclick="startRanking()" style="background: #666; font-size: 14px; padding: 12px; margin-bottom: 8px;">
                        📝 ひとりであそぶ
                    </button>
                    <button onclick="showDevReviewList()" style="background: #FF6B35; font-size: 14px; padding: 12px; margin-bottom: 8px;">
                        🧪 ひとりであそぶ（開発用）
                    </button>
                    <button onclick="showHistory()" style="background: #666; font-size: 14px; padding: 12px;">
                        📋 過去の回答履歴を見る
                    </button>
                </div>
            </div>
            
            <!-- フッター（プライバシーポリシー・利用規約へのリンク） -->
            <div style="
                background: #f8f9fa;
                border-top: 1px solid #ddd;
                padding: 15px 20px;
                margin-top: 30px;
                text-align: center;
                font-size: 12px;
                color: #666;
            ">
                <a href="./privacy-policy.html" target="_blank" style="color: #4A90E2; text-decoration: none; margin: 0 10px;">プライバシーポリシー</a>
                <span style="color: #ccc;">|</span>
                <a href="./terms-of-service.html" target="_blank" style="color: #4A90E2; text-decoration: none; margin: 0 10px;">利用規約</a>
            </div>
        </div>
        
        <!-- ========================================
             テーマモード選択画面（拡張ポイント）
             将来の拡張：投票モード、時間制限モードなど
             ======================================== -->
        <div id="themeModeSelectScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">🎮 ゲームモード選択</h2>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px; line-height: 1.6;">
                どのモードであそびますか？
            </p>
            
            <!-- ランダムテーマモード -->
            <button onclick="selectThemeMode('random')" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                margin-bottom: 15px;
                border: none;
                border-radius: 15px;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        🎲 ランダムテーマ
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        おすすめテーマから自動選択
                    </div>
                </div>
                <div style="font-size: 24px;">→</div>
            </button>
            
            <!-- オリジナルテーマモード -->
            <button onclick="selectThemeMode('custom')" style="
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 25px;
                margin-bottom: 15px;
                border: none;
                border-radius: 15px;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        ✏️ オリジナルテーマ
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        自由にテーマを入力
                    </div>
                </div>
                <div style="font-size: 24px;">→</div>
            </button>
            
            <!-- 将来の拡張ポイント：投票モードなど
            <button onclick="selectThemeMode('vote')" style="opacity: 0.5; pointer-events: none;">
                <div>🗳️ 投票モード（準備中）</div>
                <div style="font-size: 13px;">3つのテーマから選ぶ</div>
            </button>
            -->
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ========================================
             カスタムテーマ入力画面
             将来の拡張：テーマテンプレート、履歴から選択など
             ======================================== -->
        <div id="customThemeInputScreen" class="screen">
            <h2 style="color: #f5576c; margin-bottom: 20px;">✏️ テーマを入力</h2>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px; line-height: 1.6;">
                ランキングのテーマを自由に入力してください
            </p>
            
            <!-- テーマ入力欄 -->
            <div style="background: #FFF0F5; border: 2px solid #f5576c; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <label for="customThemeInput" style="display: block; color: #f5576c; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                    📌 テーマ
                </label>
                <input 
                    type="text" 
                    id="customThemeInput" 
                    placeholder="例：わたしの好きな音楽TOP5"
                    maxlength="50"
                    style="
                        width: 100%;
                        padding: 15px;
                        border: 2px solid #f5576c;
                        border-radius: 8px;
                        font-size: 16px;
                        box-sizing: border-box;
                        outline: none;
                        transition: border-color 0.3s;
                    "
                    onfocus="this.style.borderColor='#ff1744'"
                    onblur="this.style.borderColor='#f5576c'"
                />
                <p style="color: #999; font-size: 12px; margin-top: 8px; text-align: right;">
                    <span id="customThemeCount">0</span> / 50文字
                </p>
            </div>
            
            <!-- 将来の拡張ポイント：テンプレート選択
            <div style="margin-bottom: 20px;">
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">💡 テンプレートから選ぶ</p>
                <button onclick="useTemplate('わたしの好きな○○TOP5')">好きな○○</button>
                <button onclick="useTemplate('わたしの行きたい○○TOP5')">行きたい○○</button>
            </div>
            -->
            
            <!-- 決定ボタン -->
            <button onclick="confirmCustomTheme()" style="
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 18px;
                width: 100%;
                border: none;
                border-radius: 12px;
                font-size: 18px;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
                cursor: pointer;
                transition: transform 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                ✅ このテーマで決定
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="backToThemeModeSelect()" class="fixed-round-button fixed-round-button-home">
                戻る
            </button>
        </div>
        
        <!-- ランキング入力画面 -->
        <div id="rankingScreen" class="screen">
            <div class="theme-box">
                <h2>📌 今回のテーマ</h2>
                <p class="theme-text" id="currentTheme">---</p>
            </div>
            
            <div class="ranking-form">
                <div class="rank-item">
                    <div class="rank-label">1位</div>
                    <input type="text" class="rank-input" id="rank1" placeholder="1位を入力（50文字まで）" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">2位</div>
                    <input type="text" class="rank-input" id="rank2" placeholder="2位を入力（50文字まで）" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">3位</div>
                    <input type="text" class="rank-input" id="rank3" placeholder="3位を入力（50文字まで）" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">4位</div>
                    <input type="text" class="rank-input" id="rank4" placeholder="4位を入力（50文字まで）" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">5位</div>
                    <input type="text" class="rank-input" id="rank5" placeholder="5位を入力（50文字まで）" maxlength="50">
                </div>
            </div>
            
            <button onclick="saveRanking()" style="margin-bottom: 80px;">
                💾 ランキングを保存する
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- 履歴表示画面 -->
        <div id="historyScreen" class="screen">
            <h2 style="color: #4A90E2; margin-bottom: 20px;">📋 過去のランキング</h2>
            
            <div id="historyList" class="history-list" style="padding-bottom: 80px;">
                <!-- ここに履歴が表示されます -->
            </div>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ペア設定画面（フェーズ4で追加） -->
        <div id="pairScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">👥 ペア設定</h2>
            
            <!-- 自分のペアコード表示 -->
            <div style="background: #F8F4FF; border: 2px solid #9B59B6; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #9B59B6; font-size: 16px; margin-bottom: 10px;">📌 あなたのペアコード</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">このコードをお相手に教えてください</p>
                <div style="background: white; border: 2px dashed #9B59B6; border-radius: 8px; padding: 15px; text-align: center;">
                    <p id="myPairCode" style="font-size: 32px; font-weight: bold; color: #9B59B6; letter-spacing: 4px; font-family: 'Courier New', monospace;">------</p>
                </div>
                <button onclick="copyPairUrl()" style="background: #9B59B6; margin-top: 10px; font-size: 14px; padding: 10px; width: 100%;">
                    📋 ペア設定用のURLをコピー
                </button>
            </div>
            
            <!-- お相手のペアコード入力 -->
            <div style="background: #FFF8F0; border: 2px solid #FF9800; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #FF9800; font-size: 16px; margin-bottom: 10px;">🔗 お相手とペアになる</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">お相手のペアコードを入力してください</p>
                <input type="text" id="partnerCodeInput" placeholder="ABC123" maxlength="6" 
                    oninput="updatePartnerNamePreview()"
                    style="width: 100%; padding: 15px; border: 2px solid #FF9800; border-radius: 8px; font-size: 24px; font-weight: bold; text-align: center; letter-spacing: 4px; text-transform: uppercase; font-family: 'Courier New', monospace; margin-bottom: 10px;">
                <div id="partnerNamePreview" style="display: none; padding: 8px 0; margin-bottom: 8px; text-align: center;">
                    <p style="color: #666; font-size: 14px; margin: 0;">
                        <span id="partnerNamePreviewText">---</span>さんのペアコード
                    </p>
                </div>
                <button onclick="connectWithPartner()" style="background: #FF9800;">
                    ✨ ペアになる
                </button>
            </div>
            
            <!-- 現在のペア情報 -->
            <div id="currentPairInfo" style="background: #F0FFF4; border: 2px solid #50C878; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: none;">
                <h3 style="color: #50C878; font-size: 16px; margin-bottom: 10px;">✅ ペア成立中</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 8px;">お相手: <span id="partnerName" style="font-weight: bold; color: #333;">---</span></p>
                <button onclick="disconnectPair()" style="background: #ff6b6b; font-size: 14px; padding: 10px;">
                    ❌ ペアを解除
                </button>
            </div>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- 待機ルーム画面（フェーズ5-Aで追加） -->
        <div id="waitingRoomScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">🎮 ふたりであそぶ</h2>
            
            <!-- 待機中の表示 -->
            <div id="waitingArea" style="text-align: center; padding: 40px 20px;">
                <div style="background: linear-gradient(135deg, #FFF0F5, #F0F8FF); border: 3px solid #FF6B9D; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">⏳</p>
                    <p id="waitingMessage" style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">お相手を待っています...</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">お相手がアプリを開くと<br>自動的にゲームが開始されます</p>
                </div>
                
                <button id="copySessionUrlButton" onclick="copySessionUrl()" style="background: #4A90E2; font-size: 16px; padding: 15px 20px; margin-bottom: 20px;">
                    📋 待機室のURLをコピー
                </button>
            </div>
            
            <!-- 参加確認の表示 -->
            <div id="joinArea" style="text-align: center; padding: 40px 20px; display: none;">
                <div style="background: linear-gradient(135deg, #FFF0F5, #F0F8FF); border: 3px solid #4A90E2; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">🎉</p>
                    <p id="joinMessage" style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">---さんが待っています！</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">一緒にゲームをしますか？</p>
                </div>
                
                <button onclick="joinGame()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); font-size: 17px; padding: 18px 20px;">
                    ✨ 参加する
                </button>
            </div>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="confirmBackToMain('待機室を退出してHOMEに戻りますか？')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ゲーム入力画面（フェーズ5-Aで追加） -->
        <div id="gameInputScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">🎮 ランキング入力</h2>
            
            <div class="theme-box">
                <h2>📌 今回のテーマ</h2>
                <p class="theme-text" id="gameTheme">---</p>
            </div>
            
            <!-- 進行状況表示 -->
            <div id="gameProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">📊 進行状況</p>
                <div id="gameProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <div class="ranking-form" id="gameRankingForm">
                <div class="rank-item draggable-item" data-rank="1">
                    <div class="rank-label">1位</div>
                    <input type="text" class="rank-input" id="gameRank1" placeholder="1位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="2">
                    <div class="rank-label">2位</div>
                    <input type="text" class="rank-input" id="gameRank2" placeholder="2位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="3">
                    <div class="rank-label">3位</div>
                    <input type="text" class="rank-input" id="gameRank3" placeholder="3位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="4">
                    <div class="rank-label">4位</div>
                    <input type="text" class="rank-input" id="gameRank4" placeholder="4位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="5">
                    <div class="rank-label">5位</div>
                    <input type="text" class="rank-input" id="gameRank5" placeholder="5位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
            </div>
            
            <button id="submitGameRankingButton" onclick="submitGameRanking()">
                💾 ランキングを送信
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="confirmBackToMain('HOMEに戻ると現在のゲームを終了します。よろしいですか？')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- 予想画面（フェーズ5-Aで追加） -->
        <div id="guessScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">🤔 お相手のランキングを予想</h2>
            
            <div style="background: #FFF0F5; border: 2px solid #FF6B9D; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; line-height: 1.8; text-align: center;">
                    <span id="guessPartnerName" style="font-weight: bold; color: #FF6B9D;">---</span>さんの<br>
                    ランキングを正しい順番に並べてください
                </p>
            </div>
            
            <div class="theme-box" style="margin-bottom: 20px;">
                <h2>📌 テーマ</h2>
                <p class="theme-text" id="guessTheme">---</p>
            </div>
            
            <!-- 進行状況表示 -->
            <div id="guessProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">📊 進行状況</p>
                <div id="guessProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <!-- 並び替えエリア -->
            <div id="guessRankingArea" style="margin: 20px 0;">
                <!-- JavaScriptで動的に生成 -->
            </div>
            
            <button id="submitGuessButton" onclick="submitGuess()">
                ✅ 予想を送信
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="confirmBackToMain('HOMEに戻ると現在のゲームを終了します。よろしいですか？')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- 結果画面（フェーズ5-Aで追加） -->
        <div id="resultScreen" class="screen" style="padding-bottom: 40px;">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">🎉 結果発表</h2>
            
            <div id="resultContent" style="margin: 20px 0;">
                <!-- JavaScriptで動的に生成 -->
            </div>
            
            <button id="playAgainButton" onclick="playAgain()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); width: 100%;">
                🎮 新しいテーマでもう一度あそぶ
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button id="resultHomeButton" onclick="confirmBackToMain('HOMEに戻ると現在のゲームを終了します。よろしいですか？')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- 振り返り予想：ランキング選択画面（テスト機能） -->
        <div id="reviewListScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">🔄 振り返り予想</h2>
            
            <p style="color: #666; font-size: 14px; line-height: 1.8; text-align: center; margin-bottom: 20px; padding: 15px; background: #F8F4FF; border-radius: 10px;">
                過去に作ったランキングを選んで<br>
                もう一度並べてみましょう！
            </p>
            
            <div id="reviewRankingList" class="history-list">
                <!-- JavaScriptで動的に生成 -->
            </div>
            
            <button onclick="backToMain()" class="secondary-button">
                ← メイン画面に戻る
            </button>
        </div>
        
        <!-- 振り返り予想：並び替え画面（テスト機能） -->
        <div id="reviewGuessScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">🔄 並び替えてみよう</h2>
            
            <div class="theme-box" style="margin-bottom: 20px;">
                <h2>📌 テーマ</h2>
                <p class="theme-text" id="reviewTheme">---</p>
            </div>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px;">
                正しい順番に並べてください
            </p>
            
            <!-- 並び替えエリア -->
            <div id="reviewGuessArea" style="margin: 20px 0; padding-bottom: 80px;">
                <!-- JavaScriptで動的に生成 -->
            </div>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="cancelReview()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
            
            <button onclick="submitReviewGuess()" class="fixed-round-button fixed-round-button-submit">
                ANSWER
            </button>
        </div>
        
        <!-- 振り返り予想：結果画面（テスト機能） -->
        <div id="reviewResultScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">🎉 結果</h2>
            
            <div id="reviewResultContent" style="margin: 20px 0;">
                <!-- JavaScriptで動的に生成 -->
            </div>
            
            <button onclick="showReviewList()" style="background: #9B59B6; margin-bottom: 80px;">
                🔄 別のランキングで挑戦
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ========================================
             開発用：SortableJS テスト画面
             ======================================== -->
        
        <!-- 開発用：並び替え画面 -->
        <div id="devReviewGuessScreen" class="screen">
            <h2 style="color: #FF6B35; margin-bottom: 20px;">🧪 並び替えてみよう（開発用）</h2>
            
            <div class="theme-box" style="margin-bottom: 20px; border-color: #FF6B35;">
                <h2 style="color: #FF6B35;">📌 テーマ</h2>
                <p class="theme-text" id="devReviewTheme">---</p>
            </div>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px;">
                正しい順番に並べてください
            </p>
            
            <!-- 並び替えエリア（SortableJS使用） -->
            <div id="devReviewGuessArea" style="margin: 20px 0; padding-bottom: 80px;">
                <!-- JavaScriptで動的に生成 -->
            </div>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="cancelDevReview()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
            
            <button onclick="submitDevReviewGuess()" class="fixed-round-button fixed-round-button-submit">
                ANSWER
            </button>
        </div>
        
        <!-- 開発用：結果画面 -->
        <div id="devReviewResultScreen" class="screen">
            <h2 style="color: #FF6B35; margin-bottom: 20px;">🎉 結果（開発用）</h2>
            
            <div id="devReviewResultContent" style="margin: 20px 0;">
                <!-- JavaScriptで動的に生成 -->
            </div>
            
            <button onclick="showDevReviewList()" style="background: #FF6B35; margin-bottom: 80px;">
                🔄 別のランキングで挑戦
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ========================================
             β用：部屋ベースのゲーム開始フロー（Phase 2a）
             既存の「ふたりであそぶ」フローとは完全に独立
             ======================================== -->
        
        <!-- β用：ホスト/ゲスト選択画面 -->
        <div id="betaRoleSelectScreen" class="screen">
            <h2 style="color: #11998e; margin-bottom: 20px;">🏠 ふたりであそぶ</h2>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px; line-height: 1.6;">
                どちらかを選んでください
            </p>
            
            <!-- ホスト：部屋を作る -->
            <button onclick="betaCreateRoom()" style="
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                color: white;
                padding: 25px;
                margin-bottom: 15px;
                border: none;
                border-radius: 15px;
                font-size: 16px;
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        👑 部屋をつくる
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        部屋番号を発行してお相手を待つ
                    </div>
                </div>
                <div style="font-size: 24px;">→</div>
            </button>
            
            <!-- ゲスト：部屋に入る -->
            <button onclick="betaShowJoinRoom()" style="
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                padding: 25px;
                margin-bottom: 15px;
                border: none;
                border-radius: 15px;
                font-size: 16px;
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        🚪 部屋に入る
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        部屋番号を入力して参加する
                    </div>
                </div>
                <div style="font-size: 24px;">→</div>
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="showScreen('mainScreen')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- β用：部屋作成完了/待機画面 -->
        <div id="betaWaitingRoomScreen" class="screen">
            <h2 style="color: #11998e; margin-bottom: 20px;">🏠 待機室</h2>
            
            <!-- 部屋番号表示 -->
            <div style="text-align: center; padding: 20px;">
                <div style="background: linear-gradient(135deg, #e8fdf5, #f0fff4); border: 3px solid #11998e; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">部屋番号</p>
                    <p id="betaRoomNumber" style="font-size: 48px; font-weight: bold; color: #11998e; letter-spacing: 8px; font-family: 'Courier New', monospace;">----</p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">この番号をお相手に伝えてください</p>
                </div>
                
                <button onclick="betaCopyRoomNumber()" style="background: #11998e; font-size: 16px; padding: 15px 20px; margin-bottom: 20px; width: 100%;">
                    📋 部屋番号をコピー
                </button>
                
                <!-- 参加状況 -->
                <div style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <p style="color: #666; font-size: 13px; margin-bottom: 8px;">👥 参加状況</p>
                    <div id="betaRoomPlayersArea">
                        <p style="color: #999; font-size: 14px;">お相手の参加を待っています...</p>
                    </div>
                </div>
                
                <!-- ホスト用：部屋を閉じるボタン -->
                <button id="betaCloseRoomButton" onclick="betaCloseRoom()" style="background: #ff6b6b; font-size: 14px; padding: 10px; display: none;">
                    🚪 部屋を閉じる
                </button>
            </div>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="betaConfirmLeaveRoom('一時退出します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- β用：ゲーム設定画面（ホスト専用） -->
        <div id="betaGameSettingsScreen" class="screen">
            <h2 style="color: #11998e; margin-bottom: 10px;">🎮 ゲーム設定</h2>
            <p style="color: #666; font-size: 13px; text-align: center; margin-bottom: 20px;">
                あなたは「ゲームマスター」です。<br>ゲーム設定を行ってください。
            </p>
            
            <!-- テーマモード選択 -->
            <div style="background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <p style="color: #4A90E2; font-weight: bold; font-size: 14px; margin-bottom: 10px; text-align: center;">テーマ設定</p>
                <button id="betaThemeModeApp" onclick="betaSelectThemeMode('app')" style="
                    background: white; color: #333; border: 2px solid #ddd; font-size: 15px; padding: 14px; margin-bottom: 8px; width: 100%; border-radius: 10px; transition: all 0.2s;
                ">
                    📋 アプリ内のテーマで遊ぶ
                </button>
                <button id="betaThemeModeCustom" onclick="betaSelectThemeMode('custom')" style="
                    background: white; color: #333; border: 2px solid #ddd; font-size: 15px; padding: 14px; width: 100%; border-radius: 10px; transition: all 0.2s;
                ">
                    ✏️ オリジナルのテーマで遊ぶ
                </button>
            </div>
            
            <!-- テーマ表示エリア（アプリ内テーマ選択時） -->
            <div id="betaAppThemeArea" style="background: #fff; border: 2px solid #4A90E2; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <p style="color: #4A90E2; font-weight: bold; font-size: 14px; margin-bottom: 10px;">テーマ</p>
                <div style="position: relative; display: flex; align-items: center; gap: 6px;">
                    <div onclick="betaToggleThemeList()" style="
                        background: #F0F8FF; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; align-items: center; min-height: 24px; flex: 1;
                    ">
                        <span id="betaThemeArrow" style="color: #4A90E2; font-size: 12px; margin-right: 10px; flex-shrink: 0;">▼</span>
                        <span id="betaThemeText" style="color: #333; font-size: 15px; flex: 1;">好きな食べ物・料理TOP5</span>
                    </div>
                    <button onclick="betaRandomizeTheme()" style="
                        background: #4A90E2; border: none; color: white; width: 36px; height: 36px; border-radius: 8px;
                        display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
                        box-shadow: 0 2px 8px rgba(74,144,226,0.3); transition: transform 0.15s, box-shadow 0.15s;
                        font-size: 22px; line-height: 1;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">&#x21bb;</button>
                    <!-- テーマリスト（初期非表示） -->
                    <div id="betaThemeListDropdown" style="
                        display: none; position: absolute; top: 100%; left: 0; right: 44px; z-index: 10;
                        background: white; border: 2px solid #4A90E2; border-radius: 8px; margin-top: 4px;
                        max-height: 250px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    ">
                        <!-- JSで動的に生成 -->
                    </div>
                </div>
            </div>
            
            <!-- カスタムテーマ入力エリア（初期非表示） -->
            <div id="betaCustomThemeArea" style="display: none; background: #fff; border: 2px solid #4A90E2; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <p style="color: #4A90E2; font-weight: bold; font-size: 14px; margin-bottom: 10px;">テーマ</p>
                <input 
                    type="text" 
                    id="betaCustomThemeInput" 
                    placeholder="例：わたしの好きな音楽TOP5"
                    maxlength="50"
                    style="width: 100%; padding: 15px; border: 2px solid #4A90E2; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none;"
                />
                <p style="color: #999; font-size: 12px; margin-top: 8px; text-align: right;">
                    <span id="betaCustomThemeCount">0</span> / 50文字
                </p>
            </div>
            
            <!-- ゲームスタートボタン -->
            <button onclick="betaStartGame()" style="
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                color: white; padding: 18px; width: 100%; border: none; border-radius: 12px;
                font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
                cursor: pointer; margin-bottom: 80px;
            ">
                🚀 ゲームスタート
            </button>
            
            <button onclick="betaConfirmLeaveRoom('一時退出します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- β用：ゲスト待機画面（ホストがゲーム設定中） -->
        <div id="betaGuestWaitingScreen" class="screen">
            <h2 style="color: #11998e; margin-bottom: 20px;">🏠 ふたりであそぶ</h2>
            <div style="text-align: center; padding: 40px 20px;">
                <div style="background: linear-gradient(135deg, #e8fdf5, #f0f8ff); border: 3px solid #11998e; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">⏳</p>
                    <p style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">ホストがゲームを設定中...</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">しばらくお待ちください</p>
                </div>
            </div>
            <button onclick="betaConfirmLeaveRoom('一時退出します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- β用：ランキング入力画面 -->
        <div id="betaGameInputScreen" class="screen">
            <h2 style="color: #11998e; margin-bottom: 20px;">🎮 ランキング入力</h2>
            
            <div class="theme-box" style="border-color: #11998e;">
                <h2 style="color: #11998e;">📌 今回のテーマ</h2>
                <p class="theme-text" id="betaGameTheme">---</p>
            </div>
            
            <div id="betaGameProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">📊 進行状況</p>
                <div id="betaGameProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <div class="ranking-form" id="betaGameRankingForm">
                <div class="rank-item draggable-item" data-rank="1">
                    <div class="rank-label">1位</div>
                    <input type="text" class="rank-input" placeholder="1位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="2">
                    <div class="rank-label">2位</div>
                    <input type="text" class="rank-input" placeholder="2位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="3">
                    <div class="rank-label">3位</div>
                    <input type="text" class="rank-input" placeholder="3位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="4">
                    <div class="rank-label">4位</div>
                    <input type="text" class="rank-input" placeholder="4位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="5">
                    <div class="rank-label">5位</div>
                    <input type="text" class="rank-input" placeholder="5位を入力（50文字まで）" maxlength="50">
                    <span class="drag-handle">≡</span>
                </div>
            </div>
            
            <button id="betaSubmitRankingButton" onclick="betaSubmitRanking()" style="margin-bottom: 80px;">
                💾 ランキングを送信
            </button>
            
            <button onclick="betaConfirmLeaveRoom('HOMEに戻ると現在のゲームを中断します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- β用：予想画面 -->
        <div id="betaGuessScreen" class="screen">
            <h2 style="color: #11998e; margin-bottom: 20px;">🤔 お相手のランキングを予想</h2>
            
            <div style="background: #e8fdf5; border: 2px solid #11998e; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; line-height: 1.8; text-align: center;">
                    <span id="betaGuessPartnerName" style="font-weight: bold; color: #11998e;">---</span>さんの<br>
                    ランキングを正しい順番に並べてください
                </p>
            </div>
            
            <div class="theme-box" style="border-color: #11998e; margin-bottom: 20px;">
                <h2 style="color: #11998e;">📌 テーマ</h2>
                <p class="theme-text" id="betaGuessTheme">---</p>
            </div>
            
            <div id="betaGuessProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">📊 進行状況</p>
                <div id="betaGuessProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <div id="betaGuessRankingArea" style="margin: 20px 0;">
                <!-- JSで動的に生成 -->
            </div>
            
            <button id="betaSubmitGuessButton" onclick="betaSubmitGuess()" style="
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                color: white; padding: 16px; width: 100%; border: none; border-radius: 12px;
                font-size: 17px; font-weight: bold; cursor: pointer; margin-bottom: 10px;
                box-shadow: 0 4px 15px rgba(17,153,142,0.3);
            ">
                📤 予想を送信
            </button>
            
            <div style="height: 70px;"></div>
            <button onclick="betaConfirmLeaveRoom('HOMEに戻ると現在のゲームを中断します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- β用：結果画面 -->
        <div id="betaResultScreen" class="screen" style="padding-bottom: 40px;">
            <h2 style="color: #11998e; margin-bottom: 20px;">🎉 結果発表</h2>
            
            <div id="betaResultContent" style="margin: 20px 0;">
                <!-- JSで動的に生成 -->
            </div>
            
            <div id="betaResultButtons" style="margin-bottom: 80px;">
                <!-- ホスト用：もう一度遊ぶボタン（JSで表示制御） -->
                <button id="betaPlayAgainButton" onclick="betaPlayAgain()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); margin-bottom: 10px; display: none;">
                    🔄 もう一度遊ぶ
                </button>
            </div>
            
            <button onclick="betaConfirmLeaveRoom('部屋を退出してHOMEに戻りますか？')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ============================================ -->
        <!-- みんなであそぶ（multi）用画面群 -->
        <!-- ============================================ -->
        
        <!-- multi用：ホスト/ゲスト選択画面 -->
        <div id="multiRoleSelectScreen" class="screen">
            <h2 style="color: #6C5CE7; margin-bottom: 20px;">👥 みんなであそぶ</h2>
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px; line-height: 1.6;">
                どちらかを選んでください
            </p>
            
            <button onclick="multiCreateRoom()" style="
                background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
                color: white; padding: 25px; margin-bottom: 15px; border: none; border-radius: 15px;
                font-size: 16px; width: 100%; display: flex; align-items: center; justify-content: space-between;
                box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); transition: transform 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">👑 部屋をつくる</div>
                    <div style="font-size: 13px; opacity: 0.9;">部屋番号を発行してメンバーを待つ</div>
                </div>
                <div style="font-size: 24px;">→</div>
            </button>
            
            <button onclick="multiShowJoinRoom()" style="
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white; padding: 25px; margin-bottom: 15px; border: none; border-radius: 15px;
                font-size: 16px; width: 100%; display: flex; align-items: center; justify-content: space-between;
                box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); transition: transform 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">🚪 部屋に入る</div>
                    <div style="font-size: 13px; opacity: 0.9;">部屋番号を入力して参加する</div>
                </div>
                <div style="font-size: 24px;">→</div>
            </button>
            
            <button onclick="showScreen('mainScreen')" class="fixed-round-button fixed-round-button-home">HOME</button>
        </div>
        
        <!-- multi用：待機室 -->
        <div id="multiWaitingRoomScreen" class="screen">
            <h2 style="color: #6C5CE7; margin-bottom: 20px;">👥 待機室</h2>
            <div style="text-align: center; padding: 20px;">
                <div style="background: linear-gradient(135deg, #f0edff, #f5f3ff); border: 3px solid #6C5CE7; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">部屋番号</p>
                    <p id="multiRoomNumber" style="font-size: 44px; font-weight: bold; color: #6C5CE7; letter-spacing: 6px; font-family: 'Courier New', monospace;">-----</p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">この番号をメンバーに伝えてください</p>
                    <button onclick="multiCopyRoomNumber()" style="background: #a29bfe; font-size: 14px; padding: 10px 16px; margin-top: 12px; border-radius: 8px;">
                        📋 番号をコピー
                    </button>
                </div>
                
                <div style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <p style="color: #666; font-size: 13px; margin-bottom: 8px;">👥 参加メンバー</p>
                    <div id="multiRoomPlayersArea">
                        <p style="color: #999; font-size: 14px;">メンバーの参加を待っています...</p>
                    </div>
                    <!-- ホスト用：ゲーム開始ボタン（青枠内に配置） -->
                    <button id="multiStartGameButton" onclick="multiGoToSettings()" disabled style="
                        background: #ccc; color: white; padding: 16px; width: 100%; border: none; border-radius: 12px;
                        font-size: 17px; font-weight: bold; cursor: not-allowed; margin-top: 12px; display: none;
                    ">
                        🎮 このメンバーで始める
                    </button>
                </div>
                
                <!-- ホスト用：部屋を閉じるボタン -->
                <button id="multiCloseRoomButton" onclick="multiCloseRoom()" style="background: #ff6b6b; font-size: 14px; padding: 10px; margin-bottom: 15px; display: none;">
                    🚪 部屋を閉じる
                </button>
                
                <!-- 開発用：ダミープレイヤー追加 -->
                <div id="multiDummyArea" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; display: none;">
                    <p style="color: #999; font-size: 11px; margin-bottom: 8px;">🛠 開発用</p>
                    <button onclick="multiAddDummyPlayer()" style="background: #999; font-size: 13px; padding: 8px 12px; margin-bottom: 5px;">
                        🤖 ダミープレイヤーを追加
                    </button>
                </div>
            </div>
            <button onclick="multiConfirmLeave('一時退出します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">HOME</button>
        </div>
        
        <!-- multi用：部屋参加画面 -->
        <div id="multiJoinRoomScreen" class="screen">
            <h2 style="color: #6C5CE7; margin-bottom: 20px;">🚪 部屋に入る</h2>
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px; line-height: 1.6;">
                ホストから教えてもらった<br>部屋番号を入力してください
            </p>
            <div style="background: #f0edff; border: 2px solid #6C5CE7; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <label style="display: block; color: #6C5CE7; font-weight: bold; margin-bottom: 10px; font-size: 14px;">🔢 部屋番号</label>
                <input type="text" id="multiRoomNumberInput" placeholder="例: 45821" maxlength="5" inputmode="numeric" pattern="[0-9]*"
                    style="width: 100%; padding: 20px; border: 2px solid #6C5CE7; border-radius: 10px; font-size: 28px; text-align: center; letter-spacing: 8px; font-weight: bold; box-sizing: border-box; outline: none; font-family: 'Courier New', monospace;" />
            </div>
            <button id="multiJoinRoomButton" onclick="multiJoinRoom()" style="background: linear-gradient(135deg, #6C5CE7, #a29bfe); font-size: 18px; padding: 18px;">
                ✨ 参加する
            </button>
            <button onclick="showScreen('multiRoleSelectScreen')" class="fixed-round-button fixed-round-button-home" style="background: #6C5CE7;">
                戻る
            </button>
        </div>
        
        <!-- multi用：ゲーム設定画面（ホスト専用） -->
        <div id="multiGameSettingsScreen" class="screen">
            <h2 style="color: #6C5CE7; margin-bottom: 10px;">🎮 ゲーム設定</h2>
            <p style="color: #666; font-size: 13px; text-align: center; margin-bottom: 20px;">
                あなたは「ゲームマスター」です。<br>テーマを設定してください。
            </p>
            
            <div style="background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <p style="color: #4A90E2; font-weight: bold; font-size: 14px; margin-bottom: 10px; text-align: center;">テーマ設定</p>
                <button id="multiThemeModeApp" onclick="multiSelectThemeMode('app')" style="
                    background: white; color: #333; border: 2px solid #ddd; font-size: 15px; padding: 14px; margin-bottom: 8px; width: 100%; border-radius: 10px; transition: all 0.2s;">
                    📋 アプリ内のテーマで遊ぶ
                </button>
                <button id="multiThemeModeCustom" onclick="multiSelectThemeMode('custom')" style="
                    background: white; color: #333; border: 2px solid #ddd; font-size: 15px; padding: 14px; width: 100%; border-radius: 10px; transition: all 0.2s;">
                    ✏️ オリジナルのテーマで遊ぶ
                </button>
            </div>
            
            <div id="multiAppThemeArea" style="background: #fff; border: 2px solid #4A90E2; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <p style="color: #4A90E2; font-weight: bold; font-size: 14px; margin-bottom: 10px;">テーマ</p>
                <div style="position: relative; display: flex; align-items: center; gap: 6px;">
                    <div onclick="multiToggleThemeList()" style="background: #F0F8FF; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; align-items: center; min-height: 24px; flex: 1;">
                        <span id="multiThemeArrow" style="color: #4A90E2; font-size: 12px; margin-right: 10px; flex-shrink: 0;">▼</span>
                        <span id="multiThemeText" style="color: #333; font-size: 15px; flex: 1;">好きな食べ物・料理TOP5</span>
                    </div>
                    <button onclick="multiRandomizeTheme()" style="
                        background: #4A90E2; border: none; color: white; width: 36px; height: 36px; border-radius: 8px;
                        display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
                        box-shadow: 0 2px 8px rgba(74,144,226,0.3); transition: transform 0.15s;
                        font-size: 22px; line-height: 1;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">&#x21bb;</button>
                    <div id="multiThemeListDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 44px; z-index: 10; background: white; border: 2px solid #4A90E2; border-radius: 8px; margin-top: 4px; max-height: 250px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
            </div>
            
            <div id="multiCustomThemeArea" style="display: none; background: #fff; border: 2px solid #4A90E2; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <p style="color: #4A90E2; font-weight: bold; font-size: 14px; margin-bottom: 10px;">テーマ</p>
                <input type="text" id="multiCustomThemeInput" placeholder="例：わたしの好きな音楽TOP5" maxlength="50"
                    style="width: 100%; padding: 15px; border: 2px solid #4A90E2; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none;" />
                <p style="color: #999; font-size: 12px; margin-top: 8px; text-align: right;"><span id="multiCustomThemeCount">0</span> / 50文字</p>
            </div>
            
            <button onclick="multiStartGame()" style="
                background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
                color: white; padding: 18px; width: 100%; border: none; border-radius: 12px;
                font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(108,92,231,0.3);
                cursor: pointer; margin-bottom: 80px;">
                🚀 ゲームスタート
            </button>
            <button onclick="multiConfirmLeave('一時退出します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">HOME</button>
        </div>
        
        <!-- multi用：ゲスト待機画面 -->
        <div id="multiGuestWaitingScreen" class="screen">
            <h2 style="color: #6C5CE7; margin-bottom: 20px;">👥 みんなであそぶ</h2>
            <div style="text-align: center; padding: 40px 20px;">
                <div style="background: linear-gradient(135deg, #f0edff, #f0f8ff); border: 3px solid #6C5CE7; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">⏳</p>
                    <p style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">ホストがゲームを設定中...</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">しばらくお待ちください</p>
                </div>
            </div>
            <button onclick="multiConfirmLeave('一時退出します。部屋番号で再参加できます。')" class="fixed-round-button fixed-round-button-home">HOME</button>
        </div>
        
        <!-- multi用：ランキング入力画面 -->
        <div id="multiGameInputScreen" class="screen">
            <h2 style="color: #6C5CE7; margin-bottom: 20px;">🎮 ランキング入力</h2>
            <div class="theme-box" style="border-color: #6C5CE7;">
                <h2 style="color: #6C5CE7;">📌 今回のテーマ</h2>
                <p class="theme-text" id="multiGameTheme">---</p>
            </div>
            <div style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">📊 進行状況</p>
                <div id="multiInputProgressContent"><p style="color: #999; font-size: 14px;">---</p></div>
            </div>
            <div class="ranking-form" id="multiGameRankingForm">
                <div class="rank-item draggable-item" data-rank="1"><div class="rank-label">1位</div><input type="text" class="rank-input" placeholder="1位を入力（50文字まで）" maxlength="50"><span class="drag-handle">≡</span></div>
                <div class="rank-item draggable-item" data-rank="2"><div class="rank-label">2位</div><input type="text" class="rank-input" placeholder="2位を入力（50文字まで）" maxlength="50"><span class="drag-handle">≡</span></div>
                <div class="rank-item draggable-item" data-rank="3"><div class="rank-label">3位</div><input type="text" class="rank-input" placeholder="3位を入力（50文字まで）" maxlength="50"><span class="drag-handle">≡</span></div>
                <div class="rank-item draggable-item" data-rank="4"><div class="rank-label">4位</div><input type="text" class="rank-input" placeholder="4位を入力（50文字まで）" maxlength="50"><span class="drag-handle">≡</span></div>
                <div class="rank-item draggable-item" data-rank="5"><div class="rank-label">5位</div><input type="text" class="rank-input" placeholder="5位を入力（50文字まで）" maxlength="50"><span class="drag-handle">≡</span></div>
            </div>
            <button id="multiSubmitRankingButton" onclick="multiSubmitRanking()" style="margin-bottom: 80px;">💾 ランキングを送信</button>
            <!-- ホスト用：回答を締め切るボタン（送信ボタンと入れ替わる） -->
            <button id="multiCutoffInputButton" onclick="multiCutoffInput()" style="background: #ff9800; font-size: 16px; padding: 16px; margin-bottom: 80px; display: none;">
                ✂️ 回答を締め切ってゲームを進める
            </button>
            <button onclick="multiConfirmLeave('HOMEに戻ると現在のゲームを中断します。')" class="fixed-round-button fixed-round-button-home">HOME</button>
        </div>
        
        <!-- multi用：予想画面 -->
        <div id="multiGuessScreen" class="screen">
            <h2 style="color: #6C5CE7; margin-bottom: 10px;">🤔 ランキングを予想</h2>
            
            <div class="theme-box" style="border-color: #6C5CE7; margin-bottom: 15px;">
                <h2 style="color: #6C5CE7;">📌 テーマ</h2>
                <p class="theme-text" id="multiGuessTheme">---</p>
            </div>
            
            <div style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">📊 進行状況</p>
                <div id="multiGuessProgressContent"><p style="color: #999; font-size: 14px;">---</p></div>
            </div>
            
            <!-- 予想対象の切り替えタブ（YouTube風横スクロール） -->
            <div id="multiGuessTabArea" style="display: flex; gap: 8px; overflow-x: auto; padding: 8px 2px; margin-bottom: 12px; -webkit-overflow-scrolling: touch; scrollbar-width: none;">
                <!-- JSで動的に生成 -->
            </div>
            
            <div style="background: #f0edff; border: 2px solid #6C5CE7; border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                <p style="color: #666; font-size: 14px; line-height: 1.6; text-align: center;">
                    ランキングを正しい順番に並べてください
                </p>
            </div>
            
            <div id="multiGuessRankingArea" style="margin: 15px 0;">
                <!-- JSで動的に生成 -->
            </div>
            
            <!-- 全員分の予想を送信ボタン -->
            <button id="multiSubmitAllGuessButton" onclick="multiSubmitCurrentGuess()" style="
                background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
                color: white; padding: 16px; width: 100%; border: none; border-radius: 12px;
                font-size: 17px; font-weight: bold; cursor: pointer; margin-bottom: 10px;
                box-shadow: 0 4px 15px rgba(108,92,231,0.3);
            ">
                📤 全員分の予想を送信
            </button>
            
            <!-- ホスト用：回答を締め切るボタン -->
            <button id="multiCutoffGuessButton" onclick="multiCutoffGuess()" style="background: #ff9800; font-size: 16px; padding: 16px; display: none; width: 100%; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                ✂️ 予想を締め切ってゲームを進める
            </button>
            
            <div style="height: 70px;"></div>
            <button onclick="multiConfirmLeave('HOMEに戻ると現在のゲームを中断します。')" class="fixed-round-button fixed-round-button-home">HOME</button>
        </div>
        
        <!-- multi用：結果画面 -->
        <div id="multiResultScreen" class="screen" style="padding-bottom: 40px;">
            <h2 style="color: #6C5CE7; margin-bottom: 15px;">🎉 結果発表</h2>
            
            <!-- 理解力ランキング（常時表示） -->
            <div id="multiResultRanking" style="margin-bottom: 20px;">
                <!-- JSで動的に生成 -->
            </div>
            
            <!-- ひとりずつの正解&結果セクション -->
            <div style="margin-bottom: 20px;">
                <h3 style="color: #6C5CE7; font-size: 16px; margin-bottom: 10px; text-align: center;">🎯 ひとりずつの正解＆結果</h3>
                <div id="multiResultPersonTabs" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px;">
                    <!-- JSで動的に生成 -->
                </div>
                <div id="multiResultPersonContent" style="margin-bottom: 15px;">
                    <!-- JSで動的に生成 -->
                </div>
            </div>
            
            <div style="margin-bottom: 80px;">
                <button id="multiBackToRoomButton" onclick="multiBackToRoom()" style="background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%); margin-bottom: 10px; display: none;">
                    🏠 待機室へ戻る
                </button>
            </div>
            
            <button onclick="multiConfirmLeave('部屋を退出してHOMEに戻りますか？')" class="fixed-round-button fixed-round-button-home">HOME</button>
        </div>
        
        <!-- β用：部屋参加画面 -->
        <div id="betaJoinRoomScreen" class="screen">
            <h2 style="color: #4facfe; margin-bottom: 20px;">🚪 部屋に入る</h2>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px; line-height: 1.6;">
                お相手から教えてもらった<br>部屋番号を入力してください
            </p>
            
            <!-- 部屋番号入力 -->
            <div style="background: #f0f8ff; border: 2px solid #4facfe; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <label for="betaRoomNumberInput" style="display: block; color: #4facfe; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                    🔢 部屋番号
                </label>
                <input 
                    type="text" 
                    id="betaRoomNumberInput" 
                    placeholder="例: 4582"
                    maxlength="4"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    style="
                        width: 100%;
                        padding: 15px;
                        border: 2px solid #4facfe;
                        border-radius: 8px;
                        font-size: 32px;
                        font-weight: bold;
                        text-align: center;
                        letter-spacing: 8px;
                        font-family: 'Courier New', monospace;
                        box-sizing: border-box;
                        outline: none;
                        transition: border-color 0.3s;
                    "
                    onfocus="this.style.borderColor='#00f2fe'"
                    onblur="this.style.borderColor='#4facfe'"
                />
            </div>
            
            <!-- 参加ボタン -->
            <button id="betaJoinRoomButton" onclick="betaJoinRoom()" style="
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                padding: 18px;
                width: 100%;
                border: none;
                border-radius: 12px;
                font-size: 18px;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
                cursor: pointer;
                transition: transform 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                ✨ 参加する
            </button>
            
            <!-- 固定配置の丸型ボタン -->
            <button onclick="showScreen('betaRoleSelectScreen')" class="fixed-round-button fixed-round-button-home">
                戻る
            </button>
        </div>
        
    </div>

    <script>
        // ========================================
        // テーマデータ（29個）
        // ========================================
        const THEMES = [
            // エモーション系（8個）
            '最近、嬉しかったことTOP5',
            '最近、楽しかったことTOP5',
            '最近、感謝を感じたことTOP5',
            '最近、ハマっていることTOP5',
            '最近、悲しかったことTOP5',
            '最近、ムカついたことTOP5',
            '最近、不安なことTOP5',
            '最近、感動したことTOP5',
            
            // ふりかえり系（2個）
            'この1年で、買ってよかったものTOP5',
            'この1年で、行ってよかったお店TOP5',
            
            // 好き・嫌い系（13個）
            '好きな食べ物・料理TOP5',
            '嫌い・苦手な食べ物・料理TOP5',
            '好きな飲食店TOP5',
            '好きな映画TOP5',
            '好きな漫画・アニメTOP5',
            '好きなゲームTOP5',
            '好きな歌手TOP5',
            '好きな曲・歌TOP5',
            '好きな地域・エリアTOP5',
            '好きな本・書籍TOP5',
            '好きな言葉・名言TOP5',
            '好きな休日の過ごし方TOP5',
            '尊敬している人TOP5',
            
            // if・問いかけ系（6個）
            '何でも叶うなら実現したいことTOP5',
            '何でも買えるならほしいものTOP5',
            '誰にでも会えるなら会いたい人TOP5',
            '無人島に行くなら持っていく物TOP5',
            '手に入れたいチカラ・超能力TOP5',
            '何でも叶うなら住みたい場所TOP5'
        ];
        
        // ========================================
        // グローバル変数
        // ========================================
        const LIFF_ID = '2008911809-CBLKsbT1';
        let currentTheme = '';
        let userProfile = null;
        let currentUser = null; // Firebase上のユーザー情報（フェーズ4で追加）
        
        // リアルタイムゲーム用変数（フェーズ5-Aで追加）
        let currentGameSession = null;  // 現在のゲームセッション情報
        let currentSessionRef = null;   // Firebase監視リスナーのref
        
        // 振り返り予想用変数（テスト機能）
        let currentReviewRanking = null;  // 現在振り返り中のランキング
        let reviewCorrectAnswer = null;   // 正解データ
        
        // SortableJSインスタンス（ふたりであそぶ用）
        let gameSortableInstance = null;  // 予想画面用
        let gameInputSortableInstance = null;  // 回答入力用
        
        // ========================================
        // Firebase 設定（フェーズ3で追加）
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDf8Yn-r5W1i6YptJ9DXch7i14JRi9bAf0",
            authDomain: "test-futari-no-ranking.firebaseapp.com",
            databaseURL: "https://test-futari-no-ranking-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-futari-no-ranking",
            storageBucket: "test-futari-no-ranking.firebasestorage.app",
            messagingSenderId: "802679547612",
            appId: "1:802679547612:web:1582d3e0176282ede43619",
            measurementId: "G-N364EXJQV8"
        };
        
        // Firebase初期化
        let firebaseApp = null;
        let database = null;
        
        function initializeFirebase() {
            try {
                // Firebase初期化
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('✅ Firebase接続成功！');
                return true;
            } catch (error) {
                console.error('❌ Firebase接続エラー:', error);
                return false;
            }
        }
        
        // ========================================
        // Analytics機能（簡易版）
        // ========================================
        function trackEvent(eventName, eventData = {}) {
            if (!database || !currentUser) return;
            
            try {
                const eventRef = database.ref('analytics/events');
                eventRef.push({
                    event: eventName,
                    userId: currentUser.userId,
                    displayName: userProfile?.displayName || 'unknown',
                    data: eventData,
                    timestamp: Date.now(),
                    date: new Date().toISOString()
                });
            } catch (error) {
                console.error('Analytics記録エラー:', error);
            }
        }
        
        // 日次統計の更新
        function updateDailyStats(statType) {
            if (!database) return;
            
            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const statsRef = database.ref(`analytics/daily/${today}/${statType}`);
                
                statsRef.transaction((current) => {
                    return (current || 0) + 1;
                });
            } catch (error) {
                console.error('統計更新エラー:', error);
            }
        }
        
        // ========================================
        // LIFF初期化
        // ========================================
        window.onload = function() {
            initializeLiff();
            setupEnterKeyNavigation();
            setupVisibilityChangeHandler();
        };
        
        function initializeLiff() {
            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login();
                }
            })
            .catch((err) => {
                console.error('LIFFの初期化に失敗しました:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = 
                    '<p><strong>エラー:</strong> ' + err.message + '</p>';
            });
        }
        
        function getUserProfile() {
            liff.getProfile()
                .then(profile => {
                    userProfile = profile;
                    
                    // Firebaseを初期化（フェーズ3で追加）
                    initializeFirebase();
                    
                    // Firebase匿名認証（Phase 6追加：Security Rules対応）
                    return firebase.auth().signInAnonymously();
                })
                .then(() => {
                    console.log('✅ Firebase認証成功');
                    
                    // ユーザー情報をFirebaseに保存・取得（フェーズ4で追加）
                    initializeUser();
                    
                    // URLパラメータをチェック（招待URL処理）
                    checkUrlParameters();
                    
                    document.getElementById('loading').style.display = 'none';
                    showScreen('mainScreen');
                })
                .catch((err) => {
                    console.error('認証エラー:', err);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').innerHTML = 
                        '<p><strong>エラー:</strong> ' + err.message + '</p>';
                });
        }
        
        // LIFFが閉じられた時の処理（現在は何もしない）
        // ユーザーが他のアプリを見ることを許可するため、自動削除はしない
        // 古いセッションは起動時に自動クリーンアップされる
        function setupVisibilityChangeHandler() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('📱 LIFFがバックグラウンドに移行しました（セッションは保持）');
                } else {
                    console.log('📱 LIFFがフォアグラウンドに復帰しました');
                }
            });
        }
        
        // ========================================
        // ペア機能（フェーズ4で追加）
        // ========================================
        
        // ペアコード生成（6桁のランダム英数字）
        function generatePairCode() {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // 紛らわしい文字を除外（I,O,0,1など）
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }
        
        // ユーザー情報の初期化（Firebaseに保存）
        function initializeUser() {
            if (!database || !userProfile) {
                console.error('❌ データベースまたはユーザー情報が未初期化');
                return;
            }
            
            const userId = userProfile.userId;
            const userRef = database.ref('users/' + userId);
            
            // ユーザー情報を取得
            userRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // 既存ユーザー：情報を更新
                        currentUser = snapshot.val();
                        
                        // 最終ログイン日時を更新
                        userRef.update({
                            displayName: userProfile.displayName,
                            pictureUrl: userProfile.pictureUrl || '',
                            lastLoginAt: new Date().toISOString()
                        });
                        
                        // Analytics: ユーザーログイン
                        trackEvent('user_login', {
                            userId: currentUser.userId
                        });
                        updateDailyStats('logins');
                        
                        console.log('✅ 既存ユーザー情報取得:', currentUser);
                    } else {
                        // 新規ユーザー：ペアコードを生成して保存
                        const newPairCode = generatePairCode();
                        const newUser = {
                            userId: userId,
                            displayName: userProfile.displayName,
                            pictureUrl: userProfile.pictureUrl || '',
                            pairCode: newPairCode,
                            partnerId: null,
                            createdAt: new Date().toISOString(),
                            lastLoginAt: new Date().toISOString()
                        };
                        
                        userRef.set(newUser)
                            .then(() => {
                                currentUser = newUser;
                                console.log('✅ 新規ユーザー作成:', currentUser);
                                
                                // Analytics: 新規ユーザー登録
                                trackEvent('user_registered', {
                                    userId: currentUser.userId,
                                    displayName: currentUser.displayName
                                });
                                updateDailyStats('newUsers');
                                
                                updatePairStatus();
                                
                                // ペア設定のリアルタイム監視を開始
                                setupPairListener();
                            })
                            .catch((error) => {
                                console.error('❌ ユーザー作成エラー:', error);
                            });
                        
                        return; // 新規作成の場合はここで終了
                    }
                    
                    // ペア状態を更新
                    updatePairStatus();
                    
                    // 古いセッションのクリーンアップと状態復元
                    cleanupAndRestoreSessions();
                    
                    // ペア設定のリアルタイム監視を開始
                    setupPairListener();
                })
                .catch((error) => {
                    console.error('❌ ユーザー情報取得エラー:', error);
                });
        }
        
        // ペア設定のリアルタイム監視
        let pairListenerInitialized = false;
        let skipNextPairNotification = false;  // 操作直後の通知をスキップするフラグ
        
        function setupPairListener() {
            if (!userProfile || !database) return;
            
            const userRef = database.ref('users/' + userProfile.userId + '/partnerId');
            
            userRef.on('value', (snapshot) => {
                const newPartnerId = snapshot.val();
                
                // 初回実行（起動時）はスキップ
                if (!pairListenerInitialized) {
                    pairListenerInitialized = true;
                    if (currentUser) {
                        currentUser.partnerId = newPartnerId;
                    }
                    return;
                }
                
                const oldPartnerId = currentUser ? currentUser.partnerId : null;
                
                // 値が変わっていない場合はスキップ
                if (oldPartnerId === newPartnerId) {
                    return;
                }
                
                // 操作直後のフラグが立っている場合はスキップ
                if (skipNextPairNotification) {
                    console.log('⏭️ 操作直後のため通知をスキップ');
                    skipNextPairNotification = false;
                    if (currentUser) {
                        currentUser.partnerId = newPartnerId;
                    }
                    return;
                }
                
                // ペア設定が変更された
                console.log('🔔 ペア設定が変更されました:', oldPartnerId, '->', newPartnerId);
                
                // currentUser を更新
                if (currentUser) {
                    currentUser.partnerId = newPartnerId;
                }
                
                // ゲーム中かどうかをチェック
                const currentScreen = document.querySelector('.screen[style*="display: block"]');
                const screenId = currentScreen ? currentScreen.id : '';
                const isInGame = ['gameInputScreen', 'guessScreen', 'waitingRoomScreen', 'resultScreen'].includes(screenId);
                
                // ゲーム中でない場合のみ通知
                if (!isInGame) {
                    if (newPartnerId) {
                        // ペア成立
                        database.ref('users/' + newPartnerId).once('value')
                            .then((partnerSnapshot) => {
                                if (partnerSnapshot.exists()) {
                                    const partner = partnerSnapshot.val();
                                    alert(`✨ ペアが成立しました！\n\n${partner.displayName}さんとペアになりました。`);
                                    
                                    // HOME画面の場合はリフレッシュ
                                    if (screenId === 'mainScreen') {
                                        updatePairStatus();
                                    } else if (screenId === 'pairScreen') {
                                        // ペア設定画面の場合はHOME画面に戻る
                                        showScreen('mainScreen');
                                        updatePairStatus();
                                    }
                                }
                            });
                    } else {
                        // ペア解除
                        alert('❌ ペアが解除されました。');
                        
                        // HOME画面またはペア設定画面の場合はリフレッシュ
                        if (screenId === 'mainScreen') {
                            updatePairStatus();
                        } else if (screenId === 'pairScreen') {
                            showPairScreen();
                        }
                    }
                }
            });
        }
        
        // ペア状態の表示更新
        function updatePairStatus() {
            const statusContent = document.getElementById('pairStatusContent');
            const realtimeGameButton = document.getElementById('realtimeGameButton');
            
            if (!currentUser) {
                statusContent.innerHTML = '<p style="color: #999; font-size: 14px;">ユーザー情報を読み込み中...</p>';
                return;
            }
            
            if (currentUser.partnerId) {
                // パートナーがいる場合：パートナーの名前を取得して表示
                const partnerRef = database.ref('users/' + currentUser.partnerId);
                partnerRef.once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            statusContent.innerHTML = 
                                '<p style="color: #50C878; font-size: 15px; font-weight: bold;">✅ ペア成立</p>' +
                                '<p style="color: #666; font-size: 14px; margin-top: 5px;">お相手: ' + partner.displayName + '</p>';
                            
                            // ボタンを有効化
                            if (realtimeGameButton) {
                                realtimeGameButton.style.opacity = '1';
                                realtimeGameButton.style.cursor = 'pointer';
                                realtimeGameButton.style.background = 'linear-gradient(135deg, #FF6B9D, #4A90E2)';
                                realtimeGameButton.style.filter = 'none';
                            }
                        } else {
                            statusContent.innerHTML = '<p style="color: #ff6b6b; font-size: 14px;">⚠️ お相手の情報が見つかりません</p>';
                            
                            // ボタンをグレーアウト
                            if (realtimeGameButton) {
                                realtimeGameButton.style.opacity = '0.5';
                                realtimeGameButton.style.cursor = 'not-allowed';
                                realtimeGameButton.style.background = '#999';
                                realtimeGameButton.style.filter = 'grayscale(80%)';
                            }
                        }
                    })
                    .catch((error) => {
                        console.error('❌ パートナー情報取得エラー:', error);
                        statusContent.innerHTML = '<p style="color: #ff6b6b; font-size: 14px;">❌ 情報取得エラー</p>';
                        
                        // ボタンをグレーアウト
                        if (realtimeGameButton) {
                            realtimeGameButton.style.opacity = '0.5';
                            realtimeGameButton.style.cursor = 'not-allowed';
                            realtimeGameButton.style.background = '#999';
                            realtimeGameButton.style.filter = 'grayscale(80%)';
                        }
                    });
            } else {
                // パートナーがいない場合
                statusContent.innerHTML = 
                    '<p style="color: #999; font-size: 14px;">まだペアが設定されていません</p>' +
                    '<p style="color: #9B59B6; font-size: 13px; margin-top: 5px;">下の「ペアを設定する」ボタンから始めましょう</p>';
                
                // ボタンをグレーアウト（disabledは使わない - クリック時にメッセージ表示）
                if (realtimeGameButton) {
                    realtimeGameButton.style.opacity = '0.5';
                    realtimeGameButton.style.cursor = 'not-allowed';
                    realtimeGameButton.style.background = '#999';
                    realtimeGameButton.style.filter = 'grayscale(80%)';
                }
            }
        }
        
        // 古いセッションのクリーンアップと状態復元
        async function cleanupAndRestoreSessions() {
            try {
                console.log('🧹 古いセッションのクリーンアップを開始...');
                
                const sessionsRef = database.ref('gameSessions');
                const snapshot = await sessionsRef.once('value');
                
                if (!snapshot.exists()) {
                    console.log('📭 セッションが存在しません');
                    return;
                }
                
                const now = Date.now();
                const WAITING_TIMEOUT = 10 * 60 * 1000;  // 10分
                const GAMING_TIMEOUT = 30 * 60 * 1000;   // 30分
                
                let myActiveSession = null;  // 自分の進行中セッション
                let isTimeout = false;       // タイムアウトフラグ
                let timeoutMessage = '';     // タイムアウトメッセージ
                
                const deletePromises = [];
                
                snapshot.forEach((childSnapshot) => {
                    const sessionId = childSnapshot.key;
                    const session = childSnapshot.val();
                    
                    // 自分が参加しているセッションか確認
                    const isMySession = session.players && session.players[userProfile.userId];
                    
                    if (!isMySession) {
                        // 自分のセッションではない → スキップ
                        return;
                    }
                    
                    // タイムアウトチェック
                    const lastActivity = session.lastActivityAt || new Date(session.createdAt).getTime();
                    const elapsed = now - lastActivity;
                    const elapsedMinutes = Math.floor(elapsed / 60000);
                    
                    let timeoutLimit;
                    let timeoutType;
                    
                    if (session.gameStatus === 'waiting') {
                        timeoutLimit = WAITING_TIMEOUT;
                        timeoutType = '待機室';
                    } else if (['inputting', 'guessing'].includes(session.gameStatus)) {
                        timeoutLimit = GAMING_TIMEOUT;
                        timeoutType = 'ゲーム';
                    } else if (session.gameStatus === 'finished') {
                        // 結果画面は1時間で削除
                        timeoutLimit = 60 * 60 * 1000;
                        timeoutType = '結果';
                    }
                    
                    if (elapsed > timeoutLimit) {
                        // タイムアウト → 削除
                        console.log(`⏰ タイムアウト: ${timeoutType}（${elapsedMinutes}分経過）`);
                        deletePromises.push(childSnapshot.ref.remove());
                        
                        // タイムアウトメッセージを設定
                        isTimeout = true;
                        timeoutMessage = `${elapsedMinutes}分間操作がなかったため、${timeoutType}は無効となりました。`;
                    } else {
                        // タイムアウトしていない → 復元対象
                        myActiveSession = {
                            id: sessionId,
                            data: session
                        };
                    }
                });
                
                // 古いセッションを削除
                if (deletePromises.length > 0) {
                    await Promise.all(deletePromises);
                    console.log(`✅ ${deletePromises.length}件の古いセッションを削除しました`);
                }
                
                // タイムアウトメッセージを表示
                if (isTimeout) {
                    alert('⏰ ' + timeoutMessage);
                }
                
                // 進行中のセッションがあれば復元
                if (myActiveSession) {
                    console.log('🔄 進行中のセッションを復元:', myActiveSession.id);
                    resumeSession(myActiveSession);
                } else {
                    console.log('✅ 進行中のセッションはありません（ホーム画面を表示）');
                }
                
            } catch (error) {
                console.error('❌ クリーンアップエラー:', error);
            }
        }
        
        // セッションを復元
        function resumeSession(session) {
            const sessionId = session.id;
            const sessionData = session.data;
            
            // ホスト or ゲスト判定（明示的なhostIdを使用）
            const hostId = sessionData.hostId || Object.keys(sessionData.players)[0];
            const role = (hostId === userProfile.userId) ? 'host' : 'guest';
            
            currentGameSession = {
                id: sessionId,
                data: sessionData,
                role: role
            };
            
            console.log('🔄 セッション復元:', sessionData.gameStatus, 'role:', role, 'hostId:', hostId, 'userId:', userProfile.userId);
            
            // ステータスに応じて画面を表示
            switch (sessionData.gameStatus) {
                case 'waiting':
                    showWaitingRoom(sessionId, sessionData, role);
                    break;
                    
                case 'inputting':
                    showGameInputScreen(sessionData);
                    startSessionListener(sessionId);
                    break;
                    
                case 'guessing':
                    showGuessScreen(sessionData);
                    startSessionListener(sessionId);
                    break;
                    
                case 'finished':
                    showResultScreen(sessionData);
                    startSessionListener(sessionId);
                    break;
                    
                default:
                    console.warn('⚠️ 不明なゲームステータス:', sessionData.gameStatus);
                    currentGameSession = null;
                    showScreen('mainScreen');
            }
        }
        
        // ペア設定画面を表示
        function showPairScreen() {
            if (!currentUser) {
                alert('❌ ユーザー情報が読み込まれていません。\nしばらくしてからもう一度お試しください。');
                return;
            }
            
            // 「あなたのペアコード」セクションを再表示（招待URLから入った場合に非表示になっているため）
            const myPairCodeSection = document.querySelector('#pairScreen > div:first-of-type');
            if (myPairCodeSection) {
                myPairCodeSection.style.display = 'block';
            }
            
            // 自分のペアコードを表示
            document.getElementById('myPairCode').textContent = currentUser.pairCode;
            
            // パートナー情報を表示
            if (currentUser.partnerId) {
                // パートナーがいる場合
                const partnerRef = database.ref('users/' + currentUser.partnerId);
                partnerRef.once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            document.getElementById('partnerName').textContent = partner.displayName;
                            document.getElementById('currentPairInfo').style.display = 'block';
                        }
                    })
                    .catch((error) => {
                        console.error('❌ パートナー情報取得エラー:', error);
                    });
            } else {
                // パートナーがいない場合
                document.getElementById('currentPairInfo').style.display = 'none';
            }
            
            // 入力欄をクリア
            document.getElementById('partnerCodeInput').value = '';
            
            // 画面切り替え
            showScreen('pairScreen');
        }
        
        // ペアコードをコピー
        function copyPairCode() {
            const code = currentUser.pairCode;
            
            // クリップボードにコピー
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        alert('✅ ペアコードをコピーしました！\n\nコード: ' + code + '\n\nお相手にこのコードを送ってください。');
                    })
                    .catch(() => {
                        // コピー失敗時
                        alert('ペアコード: ' + code + '\n\nこのコードをお相手に送ってください。');
                    });
            } else {
                // クリップボードAPIが使えない場合
                alert('ペアコード: ' + code + '\n\nこのコードをお相手に送ってください。');
            }
        }
        
        // パートナーとペアになる
        function connectWithPartner() {
            const partnerCode = document.getElementById('partnerCodeInput').value.trim().toUpperCase();
            
            // 入力チェック
            if (partnerCode === '') {
                alert('❌ ペアコードを入力してください。');
                return;
            }
            
            if (partnerCode.length !== 6) {
                alert('❌ ペアコードは6文字です。');
                return;
            }
            
            // 自分のコードと同じでないかチェック
            if (partnerCode === currentUser.pairCode) {
                alert('❌ 自分のペアコードは入力できません。\nお相手のコードを入力してください。');
                return;
            }
            
            // Firebaseでペアコードを検索
            const usersRef = database.ref('users');
            usersRef.orderByChild('pairCode').equalTo(partnerCode).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('❌ このペアコードは見つかりませんでした。\n\nコードが正しいか確認してください。');
                        return;
                    }
                    
                    // パートナーを見つけた
                    let partnerId = null;
                    let partnerData = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        partnerId = childSnapshot.key;
                        partnerData = childSnapshot.val();
                    });
                    
                    if (!partnerId || !partnerData) {
                        alert('❌ お相手の情報の取得に失敗しました。');
                        return;
                    }
                    
                    // 既にペアがいる場合は確認
                    if (currentUser.partnerId) {
                        if (!confirm('既にペアが設定されています。\n新しいお相手に変更しますか？')) {
                            return;
                        }
                    }
                    
                    // 自分のパートナーIDを更新
                    const myUserRef = database.ref('users/' + userProfile.userId);
                    myUserRef.update({
                        partnerId: partnerId
                    })
                        .then(() => {
                            // 相手のパートナーIDも更新
                            const partnerUserRef = database.ref('users/' + partnerId);
                            return partnerUserRef.update({
                                partnerId: userProfile.userId
                            });
                        })
                        .then(() => {
                            // 成功
                            currentUser.partnerId = partnerId;
                            
                            // リアルタイム通知をスキップするフラグを立てる
                            skipNextPairNotification = true;
                            setTimeout(() => {
                                skipNextPairNotification = false;
                            }, 3000);
                            
                            // Analytics: ペア設定完了
                            trackEvent('pair_connected', {
                                partnerId: partnerId,
                                partnerName: partnerData.displayName
                            });
                            updateDailyStats('pairConnections');
                            
                            alert('✅ ペア設定完了！\n\nお相手: ' + partnerData.displayName + '\n\nこれでお互いのランキングを共有できます。');
                            
                            // 表示を更新
                            updatePairStatus();
                            showPairScreen();
                        })
                        .catch((error) => {
                            alert('❌ ペア設定エラー:\n' + error.message);
                            console.error('❌ ペア設定エラー:', error);
                        });
                })
                .catch((error) => {
                    alert('❌ コード検索エラー:\n' + error.message);
                    console.error('❌ コード検索エラー:', error);
                });
        }
        
        // ペアを解除
        function disconnectPair() {
            if (!confirm('ペアを解除しますか？\n\nお互いのランキングが見えなくなります。')) {
                return;
            }
            
            if (!currentUser.partnerId) {
                alert('❌ ペアが設定されていません。');
                return;
            }
            
            const partnerId = currentUser.partnerId;
            
            // 自分のパートナーIDをクリア
            const myUserRef = database.ref('users/' + userProfile.userId);
            myUserRef.update({
                partnerId: null
            })
                .then(() => {
                    // 相手のパートナーIDもクリア
                    const partnerUserRef = database.ref('users/' + partnerId);
                    return partnerUserRef.update({
                        partnerId: null
                    });
                })
                .then(() => {
                    // 成功
                    currentUser.partnerId = null;
                    
                    // リアルタイム通知をスキップするフラグを立てる
                    skipNextPairNotification = true;
                    setTimeout(() => {
                        skipNextPairNotification = false;
                    }, 3000);
                    
                    alert('✅ ペアを解除しました。');
                    
                    // 表示を更新
                    updatePairStatus();
                    showPairScreen();
                })
                .catch((error) => {
                    alert('❌ ペア解除エラー:\n' + error.message);
                    console.error('❌ ペア解除エラー:', error);
                });
        }
        
        // ========================================
        // リアルタイムゲーム機能（フェーズ5-Aで追加）
        // ========================================
        
        // リアルタイムゲーム開始を試みる（ペアチェック付き）
        function tryStartRealtimeGame() {
            if (!currentUser || !currentUser.partnerId) {
                alert('❌ まずペアを設定してください\n\n下の「⚙️ ペアを設定する」ボタンからお相手とペアになってください。');
                return;
            }
            startRealtimeGame();
        }
        
        // リアルタイムゲーム開始
        function startRealtimeGame() {
            // 既存のセッションをチェック（ゲスト参加判定）
            // 既存セッションがあれば自動参加、なければホストとして待機室作成
            checkExistingSession();
        }
        
        // ========================================
        // テーマモード選択機能（拡張性を考慮）
        // 将来の拡張：投票モード、時間制限モードなど
        // ========================================
        
        // グローバル変数：選択されたテーマモードを保持
        let selectedThemeMode = null;  // 'random' | 'custom' | 将来的には 'vote' など
        let customThemeText = null;    // カスタムテーマのテキスト
        
        // テーマモードを選択（ホストのみ）
        function selectThemeMode(mode) {
            selectedThemeMode = mode;
            
            if (mode === 'random') {
                // ランダムモード：直接ゲーム開始
                console.log('🎲 ランダムモード選択：ゲーム開始');
                startGameWithTheme();
            } else if (mode === 'custom') {
                // カスタムモード：テーマ入力画面へ
                console.log('✏️ カスタムモード選択：テーマ入力画面へ');
                showScreen('customThemeInputScreen');
                
                // 入力欄をクリア
                document.getElementById('customThemeInput').value = '';
                document.getElementById('customThemeCount').textContent = '0';
                
                // 文字数カウンター設定
                const input = document.getElementById('customThemeInput');
                input.addEventListener('input', function() {
                    document.getElementById('customThemeCount').textContent = this.value.length;
                });
            }
            // 将来の拡張ポイント
            // else if (mode === 'vote') {
            //     showScreen('themeVoteScreen');
            // }
        }
        
        // テーマを決定してゲーム開始
        function startGameWithTheme() {
            if (!currentGameSession) {
                alert('❌ セッション情報がありません。');
                return;
            }
            
            // テーマを決定
            let theme;
            let themeMode = selectedThemeMode || 'random';
            
            if (themeMode === 'random') {
                theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            } else if (themeMode === 'custom') {
                theme = customThemeText;
            }
            
            // セッションを更新してゲーム開始
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updates = {
                theme: theme,
                themeMode: themeMode,
                gameStatus: 'inputting',
                rankings: null,               // ランキングをクリア
                guesses: null,                // 予想をクリア
                results: null,                // 結果をクリア
                finishedAt: null,             // 終了時刻をクリア
                lastActivityAt: Date.now(),
                updatedAt: new Date().toISOString()
            };
            
            // 全プレイヤーの状態を 'inputting' に更新
            const players = Object.keys(currentGameSession.data.players);
            players.forEach(playerId => {
                updates['players/' + playerId + '/status'] = 'inputting';
            });
            
            sessionRef.update(updates)
                .then(() => {
                    console.log('✅ テーマ決定、ゲーム開始');
                    // リスナーが自動的に入力画面を表示
                })
                .catch((error) => {
                    console.error('❌ ゲーム開始エラー:', error);
                    alert('❌ ゲーム開始エラー:\n' + error.message);
                });
        }
        
        // カスタムテーマを確定（ホストのみ）
        function confirmCustomTheme() {
            const input = document.getElementById('customThemeInput');
            const theme = input.value.trim();
            
            // ホスト権限チェック（もう一度あそぶの場合）
            if (currentGameSession) {
                const isHost = currentGameSession.data.hostId === userProfile.userId;
                
                if (!isHost) {
                    alert('❌ テーマの入力はホストのみ可能です。');
                    return;
                }
            }
            
            // バリデーション
            if (!theme) {
                alert('❌ テーマを入力してください。');
                return;
            }
            
            if (theme.length < 3) {
                alert('❌ テーマは3文字以上で入力してください。');
                return;
            }
            
            if (theme.length > 50) {
                alert('❌ テーマは50文字以内で入力してください。');
                return;
            }
            
            // カスタムテーマを保存
            customThemeText = theme;
            
            // テーマを決定してゲーム開始
            console.log('✨ カスタムテーマでゲーム開始');
            startGameWithTheme();
        }
        
        // カスタムテーマで「もう一度あそぶ」を続行
        async function playAgainWithCustomTheme() {
            try {
                const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                
                const updates = {
                    theme: customThemeText,       // 新しいカスタムテーマ
                    themeMode: 'custom',          // モードを保持
                    gameStatus: 'inputting',      // 入力フェーズに戻る
                    rankings: null,               // ランキングをクリア
                    guesses: null,                // 予想をクリア
                    results: null,                // 結果をクリア
                    finishedAt: null,             // 終了時刻をクリア
                    lastActivityAt: Date.now(),   // 活動時刻を更新
                    updatedAt: new Date().toISOString()
                };
                
                // 全プレイヤーの状態をリセット
                const players = Object.keys(currentGameSession.data.players);
                players.forEach(playerId => {
                    updates['players/' + playerId + '/status'] = 'inputting';
                });
                
                await sessionRef.update(updates);
                console.log('✅ カスタムテーマでセッションをリセットしました');
                
                // リスナーが自動的に入力画面を表示してくれる
            } catch (error) {
                console.error('❌ playAgainWithCustomTheme エラー:', error);
                alert('エラーが発生しました。ホーム画面に戻ります。');
                backToMain();
            }
        }
        
        // モード選択画面に戻る
        function backToThemeModeSelect() {
            showScreen('themeModeSelectScreen');
        }
        
        // ゲストとして既存セッションに参加
        function joinExistingSession(sessionId, sessionData) {
            console.log('🎮 ゲストとして参加処理開始:', sessionId);
            
            const sessionRef = database.ref('gameSessions/' + sessionId);
            
            // ゲスト情報を追加
            sessionRef.child('players/' + userProfile.userId).set({
                displayName: userProfile.displayName,
                status: 'waiting'
            })
            .then(() => {
                console.log('✅ ゲスト参加成功');
                // 待機室を表示
                showWaitingRoom(sessionId, sessionData, 'guest');
            })
            .catch((error) => {
                console.error('❌ ゲスト参加エラー:', error);
                alert('❌ 参加エラー:\n' + error.message);
            });
        }
        
        // 既存のセッションをチェック
        function checkExistingSession() {
            const sessionsRef = database.ref('gameSessions');
            
            // 自分またはパートナーが関わっている待機中のセッションを検索
            sessionsRef.orderByChild('gameStatus').equalTo('waiting').once('value')
                .then((snapshot) => {
                    let existingSession = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        const session = childSnapshot.val();
                        const sessionId = childSnapshot.key;
                        
                        // 明示的なhostIdを使用してホスト判定
                        const hostId = session.hostId || Object.keys(session.players || {})[0];
                        const isHost = (hostId === userProfile.userId);
                        
                        // このセッションに自分が関わっているか確認
                        if (isHost) {
                            // 自分がホストのセッション
                            existingSession = {
                                id: sessionId,
                                data: session,
                                role: 'host'
                            };
                        } else if (session.partnerId === userProfile.userId) {
                            // パートナーが作成したセッション（自分はゲスト）
                            existingSession = {
                                id: sessionId,
                                data: session,
                                role: 'guest'
                            };
                        }
                    });
                    
                    if (existingSession) {
                        // 既存のセッションがある
                        console.log('🔍 既存セッション発見 - role:', existingSession.role, 'hostId:', existingSession.data.hostId, 'userId:', userProfile.userId);
                        
                        if (existingSession.role === 'host') {
                            // ホスト：既存の待機室を表示
                            showWaitingRoom(existingSession.id, existingSession.data, 'host');
                        } else {
                            // ゲスト：自動的に待機室に参加
                            console.log('🎮 ゲストとして既存セッションに参加します');
                            joinExistingSession(existingSession.id, existingSession.data);
                        }
                    } else {
                        // 新しくセッションを作成（ホストのみ）
                        // 直接待機室を作成（テーマ・モード未定）
                        console.log('🎮 新規ホストとして待機室を作成');
                        createWaitingSession();
                    }
                })
                .catch((error) => {
                    console.error('❌ セッション検索エラー:', error);
                    alert('❌ セッション確認エラー:\n' + error.message);
                });
        }
        
        // 待機セッション作成（テーマ・モード未定）
        function createWaitingSession() {
            // セッションデータ作成（テーマ・モード未定）
            const sessionData = {
                mode: 'realtime',
                theme: null,  // 後でモード選択後に決定
                themeMode: null,  // 後でモード選択後に決定
                hostId: userProfile.userId,
                gameStatus: 'waiting',  // waiting → waiting-guest → inputting → guessing → finished
                createdAt: new Date().toISOString(),
                lastActivityAt: Date.now(),
                players: {}
            };
            
            // 自分（ホスト）を追加
            sessionData.players[userProfile.userId] = {
                displayName: userProfile.displayName,
                status: 'waiting'
            };
            
            // パートナー情報を保存
            sessionData.partnerId = currentUser.partnerId;
            
            // Firebaseに保存
            const sessionsRef = database.ref('gameSessions');
            const newSessionRef = sessionsRef.push();
            
            newSessionRef.set(sessionData)
                .then(() => {
                    console.log('✅ 待機セッション作成成功:', newSessionRef.key);
                    showWaitingRoom(newSessionRef.key, sessionData, 'host');
                })
                .catch((error) => {
                    console.error('❌ セッション作成エラー:', error);
                    alert('❌ ゲーム作成エラー:\n' + error.message);
                });
        }
        
        // ゲームセッション作成（モード選択後）
        function createGameSession() {
            // テーマを決定（モードに応じて）
            let theme;
            let themeMode = selectedThemeMode || 'random';  // デフォルトはランダム
            
            if (themeMode === 'random') {
                // ランダムモード：プリセットテーマから選択
                theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            } else if (themeMode === 'custom') {
                // カスタムモード：ユーザー入力テーマ
                theme = customThemeText;
            }
            // 将来の拡張ポイント
            // else if (themeMode === 'vote') {
            //     theme = selectedVoteTheme;  // 投票で選ばれたテーマ
            // }
            
            // セッションデータ作成（拡張性を考慮した構造）
            const sessionData = {
                mode: 'realtime',
                theme: theme,
                themeMode: themeMode,  // ← 将来の分析・機能拡張のため
                hostId: userProfile.userId,  // ホストIDを明示的に保存（重要）
                gameStatus: 'waiting',  // waiting → inputting → guessing → finished
                createdAt: new Date().toISOString(),
                lastActivityAt: Date.now(),  // 最後の操作時刻（タイムアウト判定用）
                players: {}
            };
            
            // 自分（ホスト）を追加
            sessionData.players[userProfile.userId] = {
                displayName: userProfile.displayName,
                status: 'waiting'  // waiting → inputting → completed
            };
            
            // パートナー情報を保存（参加時に追加される）
            sessionData.partnerId = currentUser.partnerId;
            
            // Firebaseに保存
            const sessionsRef = database.ref('gameSessions');
            const newSessionRef = sessionsRef.push();
            
            newSessionRef.set(sessionData)
                .then(() => {
                    console.log('✅ ゲームセッション作成成功:', newSessionRef.key);
                    
                    // Analytics: ゲーム開始
                    trackEvent('game_started', {
                        sessionId: newSessionRef.key,
                        mode: sessionData.mode,
                        theme: theme,
                        themeMode: themeMode
                    });
                    updateDailyStats('gamesStarted');
                    
                    showWaitingRoom(newSessionRef.key, sessionData, 'host');
                })
                .catch((error) => {
                    console.error('❌ セッション作成エラー:', error);
                    alert('❌ ゲーム作成エラー:\n' + error.message);
                });
        }
        
        // 待機ルーム表示
        function showWaitingRoom(sessionId, sessionData, role) {
            currentGameSession = {
                id: sessionId,
                data: sessionData,
                role: role  // 'host' または 'guest'
            };
            
            if (role === 'host') {
                // ホスト：待機画面
                document.getElementById('waitingArea').style.display = 'block';
                document.getElementById('joinArea').style.display = 'none';
                
                // URLコピーボタンを表示
                const copyButton = document.getElementById('copySessionUrlButton');
                if (copyButton) copyButton.style.display = 'block';
                
                // パートナー名を取得
                database.ref('users/' + currentUser.partnerId).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            document.getElementById('waitingMessage').textContent = 
                                partner.displayName + 'さん（ゲスト）を待っています...\n\nあなた：' + userProfile.displayName + '（ホスト）';
                        }
                    });
            } else {
                // ゲスト：参加確認画面
                document.getElementById('waitingArea').style.display = 'none';
                document.getElementById('joinArea').style.display = 'block';
                
                // URLコピーボタンを非表示
                const copyButton = document.getElementById('copySessionUrlButton');
                if (copyButton) copyButton.style.display = 'none';
                
                // ホスト名を取得
                const hostId = sessionData.hostId || Object.keys(sessionData.players)[0];
                database.ref('users/' + hostId).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const host = snapshot.val();
                            document.getElementById('joinMessage').textContent = 
                                host.displayName + 'さん（ホスト）が待っています！\n\nあなた：' + userProfile.displayName + '（ゲスト）';
                        }
                    });
            }
            
            // 画面切り替え
            showScreen('waitingRoomScreen');
            
            // セッション監視開始
            startSessionListener(sessionId);
        }
        
        // ゲームに参加
        function joinGame() {
            if (!currentGameSession) {
                alert('❌ ゲームセッション情報がありません。');
                return;
            }
            
            // ゲストを players に追加 & ゲームステータスを更新
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            
            const updates = {
                gameStatus: 'waiting-guest',  // ゲスト参加済み、ホストのモード選択待ち
                lastActivityAt: Date.now()
            };
            
            // 自分（ゲスト）をplayersに追加
            updates['players/' + userProfile.userId] = {
                displayName: userProfile.displayName,
                status: 'waiting'
            };
            
            sessionRef.update(updates)
                .then(() => {
                    console.log('✅ ゲーム参加成功（ホストのモード選択待ち）');
                    // ホストのモード選択を待つ（リスナーが自動的に反応）
                })
                .catch((error) => {
                    console.error('❌ ゲーム参加エラー:', error);
                    alert('❌ 参加エラー:\n' + error.message);
                });
        }
        
        // セッション監視開始
        function startSessionListener(sessionId) {
            // 既存のリスナーがあれば解除
            if (currentSessionRef) {
                currentSessionRef.off();
                currentSessionRef = null;
            }
            
            currentSessionRef = database.ref('gameSessions/' + sessionId);
            
            currentSessionRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    console.log('⚠️ セッションが削除されました');
                    
                    // リスナー解除
                    if (currentSessionRef) {
                        currentSessionRef.off();
                        currentSessionRef = null;
                    }
                    
                    // セッションが削除された場合、ホーム画面に戻る
                    currentGameSession = null;
                    alert('ゲームがキャンセルされました。ホーム画面に戻ります。');
                    showScreen('mainScreen');
                    return;
                }
                
                const sessionData = snapshot.val();
                currentGameSession.data = sessionData;
                
                console.log('📡 セッション更新:', sessionData.gameStatus);
                
                // ゲームが中断された場合の処理
                if (sessionData.gameAborted && sessionData.abortedBy !== userProfile.userId) {
                    console.log('⚠️ 相手がゲームを中断しました');
                    
                    // リスナー解除
                    if (currentSessionRef) {
                        currentSessionRef.off();
                        currentSessionRef = null;
                    }
                    
                    currentGameSession = null;
                    alert('お相手がゲームを終了しました。ホーム画面に戻ります。');
                    showScreen('mainScreen');
                    return;
                }
                
                // ステータスに応じて画面を切り替え
                switch (sessionData.gameStatus) {
                    case 'waiting':
                        // 待機中（何もしない）
                        break;
                        
                    case 'waiting-guest':
                        // ゲスト参加済み、ホストのモード選択待ち
                        if (currentGameSession.role === 'host') {
                            // ホスト：モード選択画面を表示
                            console.log('🎲 ゲスト参加完了、ホストにモード選択画面を表示');
                            showScreen('themeModeSelectScreen');
                        } else {
                            // ゲスト：待機画面を表示
                            console.log('⏳ ゲスト：ホストのモード選択を待機中');
                            // 待機画面に「ホストがお題を選択中...」と表示
                            document.getElementById('waitingArea').style.display = 'block';
                            document.getElementById('joinArea').style.display = 'none';
                            document.getElementById('waitingMessage').textContent = 
                                'ホストがお題を選択中...\n\nしばらくお待ちください';
                            showScreen('waitingRoomScreen');
                        }
                        break;
                        
                    case 'inputting':
                        // 入力フェーズ
                        // 既に入力画面が表示されている場合は、進行状況だけ更新
                        const currentScreen = document.querySelector('.screen[style*="display: block"]');
                        if (currentScreen && currentScreen.id === 'gameInputScreen') {
                            // 進行状況のみ更新（入力欄はそのまま）
                            updateGameProgress(sessionData);
                        } else {
                            // 初回表示時のみ画面全体を表示
                            showGameInputScreen(sessionData);
                        }
                        break;
                        
                    case 'guessing':
                        // 予想フェーズ
                        // 既に予想画面が表示されている場合は、進行状況だけ更新
                        const currentGuessScreen = document.querySelector('.screen[style*="display: block"]');
                        if (currentGuessScreen && currentGuessScreen.id === 'guessScreen') {
                            // 進行状況のみ更新（予想内容はそのまま）
                            updateGameProgress(sessionData);
                        } else {
                            // 初回表示時のみ画面全体を表示
                            showGuessScreen(sessionData);
                        }
                        break;
                        
                    case 'finished':
                        // 結果表示
                        showResultScreen(sessionData);
                        break;
                }
            });
        }
        
        // 待機ルームをキャンセル
        async function cancelWaitingRoom() {
            try {
                console.log('⏹️ キャンセルボタンが押されました');
                
                // リスナー解除
                if (currentSessionRef) {
                    currentSessionRef.off();
                    currentSessionRef = null;
                }
                
                // ホストの場合はセッション削除（非同期処理を待つ）
                if (currentGameSession && currentGameSession.role === 'host') {
                    const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                    await sessionRef.remove();
                    console.log('✅ セッション削除成功');
                }
                
                currentGameSession = null;
                
                // ホーム画面に戻る
                showScreen('mainScreen');
            } catch (error) {
                console.error('❌ cancelWaitingRoom エラー:', error);
                alert('キャンセル中にエラーが発生しました。');
                // エラー時もホーム画面に戻る
                showScreen('mainScreen');
            }
        }
        
        // ゲーム入力画面を表示
        function showGameInputScreen(sessionData) {
            // テーマを表示
            document.getElementById('gameTheme').textContent = sessionData.theme;
            
            // 進行状況を更新
            updateGameProgress(sessionData);
            
            // DOM順序をリセット（バグ修正：2ゲーム目で順位が保持される問題）
            resetGameInputOrder();
            
            // 入力欄をクリア
            const container = document.getElementById('gameRankingForm');
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.value = '';
                }
            }
            
            // 送信ボタンをリセット
            const submitButton = document.getElementById('submitGameRankingButton');
            submitButton.textContent = '💾 ランキングを送信';
            submitButton.disabled = false;
            submitButton.style.background = '';
            submitButton.style.cursor = '';
            submitButton.style.opacity = '';
            
            // 画面切り替え
            showScreen('gameInputScreen');
            
            // SortableJSを初期化（スワイプで並び替え可能に）
            initGameInputSortable();
            
            // 自分が既に入力済みかチェック
            if (sessionData.rankings && sessionData.rankings[userProfile.userId]) {
                // 入力済みの場合は、入力内容を表示（正しい順位で設定）
                const myRanking = sessionData.rankings[userProfile.userId];
                
                for (let i = 0; i < items.length; i++) {
                    const input = items[i].querySelector('.rank-input');
                    if (input) {
                        input.value = myRanking[(i + 1).toString()] || '';
                    }
                }
                
                // 送信済みの場合は、ボタンを「待機中」状態に
                submitButton.textContent = '⏳ お相手の回答待ち...';
                submitButton.disabled = true;
                submitButton.style.background = '#999';
                submitButton.style.cursor = 'not-allowed';
                submitButton.style.opacity = '0.6';
                
                // 🔒 送信済みの場合は、編集をロック（バグ修正）
                // SortableJS初期化後にロックする（setTimeout で少し遅延）
                setTimeout(() => {
                    lockGameInput();
                }, 100);
            } else {
                // 送信済みでない場合は、必ずロックを解除（前回の状態をクリア）
                setTimeout(() => {
                    unlockGameInput();
                }, 100);
            }
            
            // 1位の入力欄にフォーカス（DOM順序でフォーカス）
            setTimeout(() => {
                const firstInput = container.children[0]?.querySelector('.rank-input');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        // DOM順序をリセット（正しい順番に並べ直す）
        function resetGameInputOrder() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            // 全ての要素を取得
            const items = Array.from(container.children);
            
            // data-rank属性でソート（正しい順序：1, 2, 3, 4, 5）
            items.sort((a, b) => {
                const rankA = parseInt(a.getAttribute('data-rank')) || 0;
                const rankB = parseInt(b.getAttribute('data-rank')) || 0;
                return rankA - rankB;
            });
            
            // DOMから一旦削除
            items.forEach(item => item.remove());
            
            // 正しい順序で再追加
            items.forEach(item => container.appendChild(item));
            
            // 順位番号とプレースホルダーを更新
            updateGameInputRankNumbers();
            
            console.log('✅ DOM順序をリセット完了');
        }
        
        // 回答入力画面でSortableJSを初期化（スワイプで並び替え）
        function initGameInputSortable() {
            const container = document.getElementById('gameRankingForm');
            
            if (!container) {
                console.error('❌ gameRankingForm が見つかりません');
                return;
            }
            
            // 既存のSortableインスタンスを破棄
            if (gameInputSortableInstance) {
                gameInputSortableInstance.destroy();
                gameInputSortableInstance = null;
            }
            
            // SortableJS初期化
            gameInputSortableInstance = new Sortable(container, {
                animation: 150,                    // アニメーション速度
                delay: 50,                         // 50ms長押しでドラッグ開始
                delayOnTouchOnly: true,            // スマホのみ長押し判定
                forceFallback: true,               // カスタムドラッグ有効化
                fallbackOnBody: true,              // body要素に追加（指に追従）
                swapThreshold: 0.65,               // 入れ替え感度（0.65 = 65%）
                handle: '.drag-handle',            // ≡アイコンだけでドラッグ可能
                ghostClass: 'sortable-ghost',      // ドラッグ中のスタイル
                chosenClass: 'sortable-chosen',    // 選択中のスタイル
                dragClass: 'sortable-drag',        // ドラッグ中の要素スタイル
                fallbackClass: 'sortable-fallback',// フォールバック時のスタイル
                
                // ドラッグ終了時に順位番号を更新
                onEnd: function() {
                    updateGameInputRankNumbers();
                }
            });
            
            console.log('✅ SortableJS 初期化完了（回答入力）');
        }
        
        // 回答入力画面の順位番号を更新
        function updateGameInputRankNumbers() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const rankLabel = items[i].querySelector('.rank-label');
                if (rankLabel) {
                    rankLabel.textContent = (i + 1) + '位';
                }
                
                // プレースホルダーも更新（バグ修正）
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.placeholder = (i + 1) + '位を入力（50文字まで）';
                }
                
                // data-rank属性も更新
                items[i].setAttribute('data-rank', i + 1);
            }
        }
        
        // 回答入力をロック（送信後の編集防止）
        function lockGameInput() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            // SortableJSを無効化
            if (gameInputSortableInstance) {
                gameInputSortableInstance.option("disabled", true);
                console.log('✅ 回答入力のスワイプを無効化');
            }
            
            // 全ての入力欄をdisabled
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.disabled = true;
                    input.style.background = '#f0f0f0';
                    input.style.color = '#999';
                }
                
                // ドラッグハンドルを非表示
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = 'none';
                }
            }
            
            console.log('✅ 回答入力をロック完了');
        }
        
        // 回答入力のロックを解除（新しいゲーム開始時）
        function unlockGameInput() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            // SortableJSを有効化
            if (gameInputSortableInstance) {
                gameInputSortableInstance.option("disabled", false);
                console.log('✅ 回答入力のスワイプを有効化');
            }
            
            // 全ての入力欄を有効化
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.disabled = false;
                    input.style.background = '';
                    input.style.color = '';
                }
                
                // ドラッグハンドルを表示
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = '';
                }
            }
            
            console.log('✅ 回答入力のロックを解除完了');
        }
        
        // 進行状況を更新
        function updateGameProgress(sessionData) {
            const players = sessionData.players || {};
            const playerIds = Object.keys(players);
            
            let progressHtml = '';
            
            playerIds.forEach((playerId) => {
                const player = players[playerId];
                const isMe = playerId === userProfile.userId;
                const displayName = isMe ? 'あなた' : player.displayName;
                
                let statusIcon = '';
                let statusText = '';
                let statusColor = '#999';
                
                if (sessionData.gameStatus === 'inputting') {
                    if (sessionData.rankings && sessionData.rankings[playerId]) {
                        statusIcon = '✅';
                        statusText = '入力完了';
                        statusColor = '#50C878';
                    } else {
                        statusIcon = '⏳';
                        statusText = '入力中...';
                        statusColor = '#FF9800';
                    }
                } else if (sessionData.gameStatus === 'guessing') {
                    if (sessionData.guesses && sessionData.guesses[playerId]) {
                        statusIcon = '✅';
                        statusText = '予想完了';
                        statusColor = '#50C878';
                    } else {
                        statusIcon = '🤔';
                        statusText = '予想中...';
                        statusColor = '#FF9800';
                    }
                }
                
                progressHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0;">';
                progressHtml += '<span style="color: #666; font-size: 14px;">' + statusIcon + ' ' + displayName + '</span>';
                progressHtml += '<span style="color: ' + statusColor + '; font-size: 13px; font-weight: bold;">' + statusText + '</span>';
                progressHtml += '</div>';
            });
            
            const contentId = sessionData.gameStatus === 'inputting' ? 'gameProgressContent' : 'guessProgressContent';
            document.getElementById(contentId).innerHTML = progressHtml;
        }
        
        // ランキング送信
        function submitGameRanking() {
            // 並び替え後のDOM順序で入力値を取得
            const container = document.getElementById('gameRankingForm');
            const items = container.children;
            const rankings = [];
            
            // 各項目の入力値をチェック
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                const value = input ? input.value.trim() : '';
                
                if (value === '') {
                    alert((i + 1) + '位を入力してください！');
                    if (input) input.focus();
                    return;
                }
                rankings.push(value);
            }
            
            // ランキングデータを作成（並び替え後の順序）
            const rankingData = {
                "1": rankings[0],
                "2": rankings[1],
                "3": rankings[2],
                "4": rankings[3],
                "5": rankings[4]
            };
            
            // Firebaseに保存
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updateData = {};
            updateData['rankings/' + userProfile.userId] = rankingData;
            updateData['players/' + userProfile.userId + '/status'] = 'completed';
            updateData['lastActivityAt'] = Date.now();  // 活動時刻を更新
            
            sessionRef.update(updateData)
                .then(() => {
                    console.log('✅ ランキング送信成功');
                    
                    // ボタンを「待機中」状態に変更
                    const button = document.getElementById('submitGameRankingButton');
                    button.textContent = '⏳ お相手の回答待ち...';
                    button.disabled = true;
                    button.style.background = '#999';
                    button.style.cursor = 'not-allowed';
                    button.style.opacity = '0.6';
                    
                    // 🔒 送信後は編集をロック（バグ修正）
                    lockGameInput();
                    
                    // 両者が入力完了したかチェック
                    return sessionRef.once('value');
                })
                .then((snapshot) => {
                    const sessionData = snapshot.val();
                    const rankings = sessionData.rankings || {};
                    const players = Object.keys(sessionData.players);
                    
                    // 全員が入力完了したか
                    if (players.every(playerId => rankings[playerId])) {
                        // 予想フェーズへ移行
                        return sessionRef.update({
                            gameStatus: 'guessing',
                            lastActivityAt: Date.now()  // 活動時刻を更新
                        });
                    }
                })
                .catch((error) => {
                    console.error('❌ ランキング送信エラー:', error);
                    alert('❌ 送信エラー:\n' + error.message);
                });
        }
        
        // 予想画面を表示
        function showGuessScreen(sessionData) {
            // テーマを表示
            document.getElementById('guessTheme').textContent = sessionData.theme;
            
            // パートナー名を取得
            const partnerId = currentUser.partnerId;
            database.ref('users/' + partnerId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const partner = snapshot.val();
                        document.getElementById('guessPartnerName').textContent = partner.displayName;
                    }
                });
            
            // 進行状況を更新
            updateGameProgress(sessionData);
            
            // 送信ボタンをリセット
            const submitButton = document.getElementById('submitGuessButton');
            submitButton.textContent = '✅ 予想を送信';
            submitButton.disabled = false;
            submitButton.style.background = '';
            submitButton.style.cursor = '';
            submitButton.style.opacity = '';
            
            // 自分が既に予想済みかチェック
            const alreadySubmitted = sessionData.guesses && sessionData.guesses[userProfile.userId];
            if (alreadySubmitted) {
                // 送信済みの場合は、ボタンを「待機中」状態に
                submitButton.textContent = '⏳ お相手の回答待ち...';
                submitButton.disabled = true;
                submitButton.style.background = '#999';
                submitButton.style.cursor = 'not-allowed';
                submitButton.style.opacity = '0.6';
            }
            
            // パートナーのランキング項目を取得
            const partnerRanking = sessionData.rankings[partnerId];
            if (!partnerRanking) {
                alert('❌ お相手のランキングが見つかりません。');
                return;
            }
            
            // 項目をシャッフル
            const items = [];
            for (let i = 1; i <= 5; i++) {
                items.push(partnerRanking[i.toString()]);
            }
            
            // シャッフル（Fisher-Yates アルゴリズム）
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }
            
            // 並び替えエリアを生成
            createGuessRankingUI(items);
            
            // 🔒 送信済みの場合は、スワイプをロック（バグ修正）
            if (alreadySubmitted) {
                setTimeout(() => {
                    lockGuessInput();
                }, 100);
            } else {
                // 送信済みでない場合は、ロックを解除（前回の状態をクリア）
                setTimeout(() => {
                    unlockGuessInput();
                }, 100);
            }
            
            // 画面切り替え
            showScreen('guessScreen');
        }
        
        // 予想ランキングUIを生成（ドラッグ&ドロップ対応・SortableJS使用）
        function createGuessRankingUI(items) {
            const container = document.getElementById('guessRankingArea');
            container.innerHTML = '';
            
            // 既存のSortableインスタンスを破棄
            if (gameSortableInstance) {
                gameSortableInstance.destroy();
                gameSortableInstance = null;
            }
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-item', item);
                itemDiv.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // 順位番号
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + '位';
                rankSpan.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // テキスト
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ドラッグハンドル（≡アイコン）を右端に配置
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = '≡';
                handleSpan.style.cssText = 'margin-left: auto; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(handleSpan);
                
                container.appendChild(itemDiv);
            });
            
            // 🌟 SortableJS を初期化
            gameSortableInstance = new Sortable(container, {
                animation: 150,                    // アニメーション速度
                delay: 50,                         // 50ms長押しでドラッグ開始
                delayOnTouchOnly: true,            // スマホのみ長押し判定
                forceFallback: true,               // カスタムドラッグ有効化
                fallbackOnBody: true,              // body要素に追加（指に追従）
                swapThreshold: 0.65,               // 入れ替え感度（0.65 = 65%）
                handle: '.drag-handle',            // ≡アイコンだけでドラッグ可能
                ghostClass: 'sortable-ghost',      // ドラッグ中のスタイル
                chosenClass: 'sortable-chosen',    // 選択中のスタイル
                dragClass: 'sortable-drag',        // ドラッグ中の要素スタイル
                fallbackClass: 'sortable-fallback',// フォールバック時のスタイル
                
                // 要素移動中にリアルタイムで順位更新
                onChange: function(evt) {
                    updateGameRankNumbers();
                },
                
                // ドラッグ終了時に順位番号を更新
                onEnd: function() {
                    updateGameRankNumbers();
                }
            });
            
            console.log('✅ SortableJS 初期化完了（ふたりであそぶ）');
            
            // 現在の項目リストを保存（後方互換性のため残す）
            container.setAttribute('data-items', JSON.stringify(items));
        }
        
        // 順位番号を更新（ゲーム用・SortableJS対応）
        function updateGameRankNumbers() {
            const container = document.getElementById('guessRankingArea');
            if (!container) return;
            
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const rankSpan = items[i].querySelector('.rank-number');
                if (rankSpan) {
                    rankSpan.textContent = (i + 1) + '位';
                }
            }
        }
        
        // 予想入力をロック（送信後の編集防止）
        function lockGuessInput() {
            const container = document.getElementById('guessRankingArea');
            if (!container) return;
            
            // SortableJSを無効化
            if (gameSortableInstance) {
                gameSortableInstance.option("disabled", true);
                console.log('✅ 予想のスワイプを無効化');
            }
            
            // 全てのドラッグハンドルを非表示
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = 'none';
                }
                
                // 項目全体を「ロック済み」の見た目に
                items[i].style.opacity = '0.6';
            }
            
            console.log('✅ 予想入力をロック完了');
        }
        
        // 予想入力のロックを解除（新しいゲーム開始時）
        function unlockGuessInput() {
            const container = document.getElementById('guessRankingArea');
            if (!container) return;
            
            // SortableJSを有効化
            if (gameSortableInstance) {
                gameSortableInstance.option("disabled", false);
                console.log('✅ 予想のスワイプを有効化');
            }
            
            // 全てのドラッグハンドルを表示
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = '';
                }
                
                // 項目の見た目を元に戻す
                items[i].style.opacity = '';
            }
            
            console.log('✅ 予想入力のロックを解除完了');
        }
        
        // 項目を移動（ボタン用）
        function moveItem(index, direction) {
            const container = document.getElementById('guessRankingArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            const newIndex = index + direction;
            
            // 範囲チェック
            if (newIndex < 0 || newIndex >= items.length) {
                return;
            }
            
            // 入れ替え
            [items[index], items[newIndex]] = [items[newIndex], items[index]];
            
            // UIを再生成
            createGuessRankingUI(items);
        }
        
        // 予想を送信
        function submitGuess() {
            const container = document.getElementById('guessRankingArea');
            
            // SortableJS対応：container.childrenから直接取得
            const itemElements = container.children;
            const items = [];
            for (let i = 0; i < itemElements.length; i++) {
                items.push(itemElements[i].getAttribute('data-item'));
            }
            
            if (!items || items.length !== 5) {
                alert('❌ 予想データが正しくありません。');
                return;
            }
            
            if (!confirm('この順番で送信しますか？\n\n' + 
                         '1位: ' + items[0] + '\n' +
                         '2位: ' + items[1] + '\n' +
                         '3位: ' + items[2] + '\n' +
                         '4位: ' + items[3] + '\n' +
                         '5位: ' + items[4])) {
                return;
            }
            
            // 予想データを作成
            const guessData = {
                "1": items[0],
                "2": items[1],
                "3": items[2],
                "4": items[3],
                "5": items[4]
            };
            
            // Firebaseに保存
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updateData = {};
            updateData['guesses/' + userProfile.userId] = guessData;
            updateData['players/' + userProfile.userId + '/status'] = 'completed';
            updateData['lastActivityAt'] = Date.now();  // 活動時刻を更新
            
            sessionRef.update(updateData)
                .then(() => {
                    console.log('✅ 予想送信成功');
                    
                    // ボタンを「待機中」状態に変更
                    const button = document.getElementById('submitGuessButton');
                    button.textContent = '⏳ お相手の回答待ち...';
                    button.disabled = true;
                    button.style.background = '#999';
                    button.style.cursor = 'not-allowed';
                    button.style.opacity = '0.6';
                    
                    // 🔒 送信後はスワイプをロック（バグ修正）
                    lockGuessInput();
                    
                    // 両者が予想完了したかチェック
                    return sessionRef.once('value');
                })
                .then((snapshot) => {
                    const sessionData = snapshot.val();
                    const guesses = sessionData.guesses || {};
                    const players = Object.keys(sessionData.players);
                    
                    // 全員が予想完了したか
                    if (players.every(playerId => guesses[playerId])) {
                        // スコアを計算
                        const results = calculateScores(sessionData);
                        
                        // 結果を保存して完了状態へ
                        return sessionRef.update({
                            gameStatus: 'finished',
                            results: results,
                            finishedAt: new Date().toISOString(),
                            lastActivityAt: Date.now()  // 活動時刻を更新
                        });
                    }
                })
                .catch((error) => {
                    console.error('❌ 予想送信エラー:', error);
                    alert('❌ 送信エラー:\n' + error.message);
                });
        }
        
        // スコアを計算（新方式：完全一致=2点、±1=1点）
        function calculateScores(sessionData) {
            const rankings = sessionData.rankings;
            const guesses = sessionData.guesses;
            const players = Object.keys(sessionData.players);
            const results = {};
            
            players.forEach((playerId) => {
                // このプレイヤーの予想スコアを計算
                const partnerId = players.find(id => id !== playerId);
                const partnerRanking = rankings[partnerId];  // 正解
                const myGuess = guesses[playerId];            // 予想
                
                let score = 0;           // 合計スコア
                let perfectCount = 0;    // 完全一致の数
                let closeCount = 0;      // ±1の数
                
                // 各予想位置について、正解での順位を探して比較
                for (let guessRank = 1; guessRank <= 5; guessRank++) {
                    const guessedItem = myGuess[guessRank.toString()];
                    
                    // この項目が正解で何位なのか探す
                    let correctRank = 0;
                    for (let rank = 1; rank <= 5; rank++) {
                        if (partnerRanking[rank.toString()] === guessedItem) {
                            correctRank = rank;
                            break;
                        }
                    }
                    
                    // 順位の差を計算
                    if (correctRank > 0) {
                        const diff = Math.abs(guessRank - correctRank);
                        if (diff === 0) {
                            // 完全一致
                            score += 2;
                            perfectCount++;
                        } else if (diff === 1) {
                            // ±1（おしい）
                            score += 1;
                            closeCount++;
                        }
                    }
                }
                
                results[playerId] = {
                    score: score,               // 最大10点
                    perfectCount: perfectCount, // 完全一致数
                    closeCount: closeCount      // ±1の数
                };
            });
            
            return results;
        }
        
        // 結果画面を表示
        function showResultScreen(sessionData) {
            const rankings = sessionData.rankings;
            const guesses = sessionData.guesses;
            const results = sessionData.results;
            const players = Object.keys(sessionData.players);
            
            const myId = userProfile.userId;
            const partnerId = players.find(id => id !== myId);
            
            const myScore = results[myId];
            const partnerScore = results[partnerId];
            
            // 勝敗判定
            let resultTitle = '';
            let resultEmoji = '';
            if (myScore.score > partnerScore.score) {
                resultTitle = 'あなたの勝ち！';
                resultEmoji = '🎉';
            } else if (myScore.score < partnerScore.score) {
                resultTitle = 'お相手の勝ち！';
                resultEmoji = '😄';
            } else {
                resultTitle = '引き分け！';
                resultEmoji = '🤝';
            }
            
            // パートナー名を取得
            database.ref('users/' + partnerId).once('value')
                .then((snapshot) => {
                    const partnerName = snapshot.exists() ? snapshot.val().displayName : 'お相手';
                    
                    // 結果HTMLを生成
                    let html = '';
                    
                    // 勝敗表示
                    html += '<div style="text-align: center; margin-bottom: 30px;">';
                    html += '<p style="font-size: 64px; margin-bottom: 10px;">' + resultEmoji + '</p>';
                    html += '<h3 style="color: #FF6B9D; font-size: 24px; margin-bottom: 10px;">' + resultTitle + '</h3>';
                    html += '</div>';
                    
            // 競争型：個別スコア表示
            html += '<div style="background: #F0F8FF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">';
            html += '<h3 style="color: #4A90E2; font-size: 16px; margin-bottom: 15px;">🏆 対戦成績</h3>';
            html += '<div style="display: flex; justify-content: space-around; text-align: center;">';
            
            // ホスト/ゲスト判定
            const isHost = sessionData.hostId === myId;
            const isPartnerHost = sessionData.hostId === partnerId;
            
            // 自分のスコア
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px; margin-bottom: 5px;">あなた</p>';
            html += '<p style="color: #FF6B9D; font-size: 32px; font-weight: bold;">' + myScore.score + '<span style="font-size: 16px; color: #999;"> / 10</span><span style="font-size: 13px; color: #999;">pt</span></p>';
            html += '<p style="color: #999; font-size: 12px;">あたり！（2pt）×' + (myScore.perfectCount || 0) + '個</p>';
            html += '<p style="color: #999; font-size: 12px;">おしい！（1pt）×' + (myScore.closeCount || 0) + '個</p>';
            html += '</div>';
            
            // ペア相手のスコア
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px; margin-bottom: 5px;">お相手</p>';
            html += '<p style="color: #4A90E2; font-size: 32px; font-weight: bold;">' + partnerScore.score + '<span style="font-size: 16px; color: #999;"> / 10</span><span style="font-size: 13px; color: #999;">pt</span></p>';
            html += '<p style="color: #999; font-size: 12px;">あたり！（2pt）×' + (partnerScore.perfectCount || 0) + '個</p>';
            html += '<p style="color: #999; font-size: 12px;">おしい！（1pt）×' + (partnerScore.closeCount || 0) + '個</p>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // 協力型：合計スコア表示
            const totalScore = myScore.score + partnerScore.score;
            const maxScore = 20;
            let cooperativeEmoji = '';
            let cooperativeMessage = '';
            
            if (totalScore === 20) {
                cooperativeEmoji = '🎉';
                cooperativeMessage = 'パーフェクト！完璧なコンビネーション！';
            } else if (totalScore >= 18) {
                cooperativeEmoji = '😊';
                cooperativeMessage = '素晴らしい！ほぼ完璧！';
            } else if (totalScore >= 15) {
                cooperativeEmoji = '👍';
                cooperativeMessage = 'いい感じ！お互いをよく知ってる！';
            } else if (totalScore >= 12) {
                cooperativeEmoji = '🤔';
                cooperativeMessage = 'まだまだ伸びしろあり！';
            } else if (totalScore >= 8) {
                cooperativeEmoji = '💪';
                cooperativeMessage = '次は頑張ろう！';
            } else {
                cooperativeEmoji = '😅';
                cooperativeMessage = 'もっと話そう！';
            }
            
            html += '<div style="background: #F0FFF4; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<h3 style="color: #50C878; font-size: 16px; margin-bottom: 15px;">🤝 ふたりの成績</h3>';
            html += '<p style="font-size: 48px; margin-bottom: 10px;">' + cooperativeEmoji + '</p>';
            html += '<p style="color: #50C878; font-size: 32px; font-weight: bold; margin-bottom: 5px;">' + totalScore + '<span style="font-size: 16px; color: #999;"> / ' + maxScore + '</span><span style="font-size: 13px; color: #999;">pt</span></p>';
            html += '<p style="color: #666; font-size: 16px; font-weight: bold;">' + cooperativeMessage + '</p>';
            html += '</div>';
                    
                    // あなたの成績（正解&結果）
                    html += '<div style="background: #F5F5F5; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
                    html += '<h3 style="color: #4A90E2; font-size: 16px; margin-bottom: 15px;">あなたの成績（正解&結果）</h3>';
                    
                    // ヘッダー行（1行構造）
                    html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 8px; background: #E3F2FD; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 11px; color: #666; align-items: center;">';
                    html += '<div style="grid-column: 1 / 3; text-align: center;">正しい順位</div>';
                    html += '<div style="text-align: center; line-height: 1.4;">あなたの<br>予想</div>';
                    html += '<div style="text-align: center;">評価</div>';
                    html += '<div style="text-align: center;">得点</div>';
                    html += '</div>';
                    
                    // データ行（正解順位でソート）
                    const partnerRanking = rankings[partnerId];
                    const myGuess = guesses[myId];
                    
                    for (let correctRank = 1; correctRank <= 5; correctRank++) {
                        const correctItem = partnerRanking[correctRank.toString()];
                        
                        // この項目をあなたが何位に予想したか探す
                        let guessRank = 0;
                        for (let rank = 1; rank <= 5; rank++) {
                            if (myGuess[rank.toString()] === correctItem) {
                                guessRank = rank;
                                break;
                            }
                        }
                        
                        // 順位の差を計算
                        let icon = '';
                        let bgColor = 'transparent';
                        let pointEarned = 0;
                        if (guessRank > 0) {
                            const diff = Math.abs(guessRank - correctRank);
                            if (diff === 0) {
                                icon = '○';
                                bgColor = '#F0FFF4';
                                pointEarned = 2;
                            } else if (diff === 1) {
                                icon = '△';
                                bgColor = '#FFF8F0';
                                pointEarned = 1;
                            } else {
                                icon = '×';
                            }
                        } else {
                            icon = '×';
                        }
                        
                        const guessRankText = guessRank > 0 ? guessRank + '位' : '-';
                        
                        html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + correctRank + '位</div>';
                        html += '<div style="color: #333; word-break: break-word; overflow-wrap: break-word; font-size: 12px;">' + correctItem + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + guessRankText + '</div>';
                        html += '<div style="text-align: center; font-size: 16px;">' + icon + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: ' + (pointEarned > 0 ? '#50C878' : '#999') + '; font-size: 11px;">' + pointEarned + 'pt</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    // お相手の成績（正解&結果）
                    html += '<div style="background: #F5F5F5; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
                    html += '<h3 style="color: #FF9800; font-size: 16px; margin-bottom: 15px;">お相手の成績（正解&結果）</h3>';
                    
                    // ヘッダー行（1行構造）
                    html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 8px; background: #FFE4CC; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 11px; color: #666; align-items: center;">';
                    html += '<div style="grid-column: 1 / 3; text-align: center;">正しい順位</div>';
                    html += '<div style="text-align: center; line-height: 1.4;">お相手の<br>予想</div>';
                    html += '<div style="text-align: center;">評価</div>';
                    html += '<div style="text-align: center;">得点</div>';
                    html += '</div>';
                    
                    // データ行（正解順位でソート）
                    const myRanking = rankings[myId];
                    const partnerGuess = guesses[partnerId];
                    
                    for (let correctRank = 1; correctRank <= 5; correctRank++) {
                        const correctItem = myRanking[correctRank.toString()];
                        
                        // この項目をお相手が何位に予想したか探す
                        let guessRank = 0;
                        for (let rank = 1; rank <= 5; rank++) {
                            if (partnerGuess[rank.toString()] === correctItem) {
                                guessRank = rank;
                                break;
                            }
                        }
                        
                        // 順位の差を計算
                        let icon = '';
                        let bgColor = 'transparent';
                        let pointEarned = 0;
                        if (guessRank > 0) {
                            const diff = Math.abs(guessRank - correctRank);
                            if (diff === 0) {
                                icon = '○';
                                bgColor = '#F0FFF4';
                                pointEarned = 2;
                            } else if (diff === 1) {
                                icon = '△';
                                bgColor = '#FFF8F0';
                                pointEarned = 1;
                            } else {
                                icon = '×';
                            }
                        } else {
                            icon = '×';
                        }
                        
                        const guessRankText = guessRank > 0 ? guessRank + '位' : '-';
                        
                        html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + correctRank + '位</div>';
                        html += '<div style="color: #333; word-break: break-word; overflow-wrap: break-word; font-size: 12px;">' + correctItem + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + guessRankText + '</div>';
                        html += '<div style="text-align: center; font-size: 16px;">' + icon + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: ' + (pointEarned > 0 ? '#50C878' : '#999') + '; font-size: 11px;">' + pointEarned + 'pt</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    document.getElementById('resultContent').innerHTML = html;
                });
            
            // 画面切り替え
            showScreen('resultScreen');
        }
        
        // もう一度遊ぶ
        async function playAgain() {
            try {
                console.log('🎮 もう一度遊ぶボタンが押されました');
                
                if (!currentGameSession) {
                    alert('❌ セッション情報がありません。');
                    backToMain();
                    return;
                }
                
                // ホストかゲストかを判定（全モード共通）
                const isHost = currentGameSession.data.hostId === userProfile.userId;
                
                const currentThemeMode = currentGameSession.data.themeMode || 'random';
                
                // ゲストの場合：ホストの操作を待つ（全モード共通）
                if (!isHost) {
                    console.log('⏳ ゲスト：ホストの操作を待機中');
                    alert('⏳ ホストが新しいゲームを開始するまでお待ちください。');
                    return;  // ゲストは何もせず待機（リスナーが自動的に次の画面へ）
                }
                
                // ========================================
                // ここから先はホストのみ実行
                // ========================================
                
                // グローバル変数をリセット
                selectedThemeMode = null;
                customThemeText = null;
                
                // ホスト：モード選択画面へ
                console.log('🎲 ホスト：モード選択画面へ');
                showScreen('themeModeSelectScreen')
            } catch (error) {
                console.error('❌ playAgain エラー:', error);
                alert('エラーが発生しました。ホーム画面に戻ります。');
                backToMain();
            }
        }
        
        // ========================================
        // 振り返り予想機能（テスト用・一人プレイ）
        // ========================================
        
        // 振り返り予想：ランダムに選択して開始
        function showReviewList() {
            // Firebaseから自分のランキングデータを取得
            if (!database || !userProfile) {
                alert('❌ データ取得エラー');
                return;
            }
            
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // データを配列に変換
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDを追加
                        rankings.push(data);
                    });
                    
                    // ランキングがない場合
                    if (rankings.length === 0) {
                        alert('❌ まだランキングがありません\n先に「新しいテーマでランキングを作る」で遊んでみましょう！');
                        return;
                    }
                    
                    // ランダムに1つ選ぶ
                    const randomIndex = Math.floor(Math.random() * rankings.length);
                    const selectedRanking = rankings[randomIndex];
                    
                    console.log('✅ ランダム選択:', selectedRanking.theme);
                    
                    // 選択したランキングで予想開始
                    startReviewGuess(selectedRanking.id);
                })
                .catch((error) => {
                    alert('❌ データ取得エラー:\n' + error.message);
                    console.error('❌ ランキング取得エラー:', error);
                });
        }
        
        // 振り返り予想：並び替え開始
        function startReviewGuess(rankingId) {
            // ランキングデータを取得
            const rankingRef = database.ref('rankings/' + rankingId);
            
            rankingRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('❌ ランキングが見つかりません。');
                        return;
                    }
                    
                    const rankingData = snapshot.val();
                    currentReviewRanking = {
                        id: rankingId,
                        data: rankingData
                    };
                    
                    // 正解を保存
                    reviewCorrectAnswer = rankingData.ranking;
                    
                    // テーマを表示
                    document.getElementById('reviewTheme').textContent = rankingData.theme;
                    
                    // 項目を取得してシャッフル
                    const items = [];
                    for (let i = 1; i <= 5; i++) {
                        items.push(rankingData.ranking[i.toString()]);
                    }
                    
                    // シャッフル（Fisher-Yates アルゴリズム）
                    for (let i = items.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [items[i], items[j]] = [items[j], items[i]];
                    }
                    
                    // UIを生成
                    createReviewGuessUI(items);
                    
                    // 画面切り替え
                    showScreen('reviewGuessScreen');
                })
                .catch((error) => {
                    console.error('❌ ランキング取得エラー:', error);
                    alert('❌ データ取得エラー:\n' + error.message);
                });
        }
        
        // 振り返り予想：UIを生成（ドラッグ&ドロップ対応）
        function createReviewGuessUI(items) {
            const container = document.getElementById('reviewGuessArea');
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-index', index);
                itemDiv.setAttribute('data-item', item);
                itemDiv.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // 順位番号
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + '位';
                rankSpan.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // テキスト
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ドラッグハンドル（≡アイコン）を右端に配置
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = '≡';
                handleSpan.style.cssText = 'margin-left: auto; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(handleSpan);
                
                container.appendChild(itemDiv);
            });
            
            // 現在の項目リストを保存
            container.setAttribute('data-items', JSON.stringify(items));
        }
        
        // 振り返り予想：答え合わせ（新方式：完全一致=2点、±1=1点）
        function submitReviewGuess() {
            const container = document.getElementById('reviewGuessArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            if (!items || items.length !== 5) {
                alert('❌ データが正しくありません。');
                return;
            }
            
            // スコアを計算（新方式）
            let score = 0;           // 合計スコア
            let perfectCount = 0;    // 完全一致の数
            let closeCount = 0;      // ±1の数
            const details = [];      // 詳細情報
            
            // 各予想位置について、正解での順位を探して比較
            for (let guessRank = 1; guessRank <= 5; guessRank++) {
                const guessedItem = items[guessRank - 1];
                
                // この項目が正解で何位なのか探す
                let correctRank = 0;
                for (let rank = 1; rank <= 5; rank++) {
                    if (reviewCorrectAnswer[rank.toString()] === guessedItem) {
                        correctRank = rank;
                        break;
                    }
                }
                
                // 順位の差を計算
                let pointEarned = 0;
                let matchType = '';
                if (correctRank > 0) {
                    const diff = Math.abs(guessRank - correctRank);
                    if (diff === 0) {
                        // 完全一致
                        pointEarned = 2;
                        perfectCount++;
                        matchType = 'perfect';
                    } else if (diff === 1) {
                        // ±1（おしい）
                        pointEarned = 1;
                        closeCount++;
                        matchType = 'close';
                    }
                }
                score += pointEarned;
                
                details.push({
                    guessRank: guessRank,
                    correctRank: correctRank,
                    item: guessedItem,
                    matchType: matchType,
                    point: pointEarned
                });
            }
            
            // 結果を表示
            showReviewResult(items, perfectCount, closeCount, score, details);
        }
        
        // 振り返り予想：結果表示（表形式に統一）
        function showReviewResult(guessedItems, perfectCount, closeCount, totalScore, details) {
            let html = '';
            
            // 評価メッセージ（5段階）
            let emoji = '';
            let message = '';
            if (totalScore === 10) {
                emoji = '🎉';
                message = 'パーフェクト！';
            } else if (totalScore >= 8) {
                emoji = '😊';
                message = 'すごい！';
            } else if (totalScore >= 6) {
                emoji = '👍';
                message = 'いい感じ！';
            } else if (totalScore >= 4) {
                emoji = '🤔';
                message = 'おしい！';
            } else {
                emoji = '💪';
                message = '次は頑張ろう！';
            }
            
            // メッセージ表示
            html += '<div style="text-align: center; margin-bottom: 30px;">';
            html += '<p style="font-size: 64px; margin-bottom: 10px;">' + emoji + '</p>';
            html += '<h3 style="color: #9B59B6; font-size: 24px; margin-bottom: 10px;">' + message + '</h3>';
            html += '</div>';
            
            // スコア詳細
            html += '<div style="background: #F8F4FF; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<p style="color: #9B59B6; font-size: 48px; font-weight: bold; margin-bottom: 10px;">' + totalScore + '点<span style="font-size: 24px; color: #999;"> / 10点</span></p>';
            html += '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">完全一致</p>';
            html += '<p style="color: #9B59B6; font-size: 24px; font-weight: bold;">' + perfectCount + '個</p>';
            html += '<p style="color: #999; font-size: 12px;">×2点</p>';
            html += '</div>';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">おしい（±1）</p>';
            html += '<p style="color: #9B59B6; font-size: 24px; font-weight: bold;">' + closeCount + '個</p>';
            html += '<p style="color: #999; font-size: 12px;">×1点</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // 答え合わせ詳細（表形式に変更）
            html += '<div style="background: #FFF8F0; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
            html += '<h3 style="color: #FF9800; font-size: 16px; margin-bottom: 15px;">✨ 答え合わせ</h3>';
            
            // タイトル行
            html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 8px; background: #FFE4CC; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 12px; color: #666;">';
            html += '<div style="text-align: center;">予想</div>';
            html += '<div>項目</div>';
            html += '<div style="text-align: center;">正解順位</div>';
            html += '<div style="text-align: center;">評価</div>';
            html += '<div style="text-align: center;">得点</div>';
            html += '</div>';
            
            // データ行
            for (let i = 0; i < details.length; i++) {
                const detail = details[i];
                const matchType = detail.matchType;
                let icon = '';
                let bgColor = 'transparent';
                let evalText = '';
                
                if (matchType === 'perfect') {
                    icon = '○';
                    bgColor = '#F0FFF4';
                    evalText = '完全一致';
                } else if (matchType === 'close') {
                    icon = '△';
                    bgColor = '#FFF8F0';
                    evalText = 'おしい';
                } else {
                    icon = '✕';
                    evalText = '';
                }
                
                const correctRankText = detail.correctRank > 0 ? detail.correctRank + '位' : '-';
                
                html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + detail.guessRank + '位</div>';
                html += '<div style="color: #333;">' + detail.item + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + correctRankText + '</div>';
                html += '<div style="text-align: center; font-size: 18px;">' + icon + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: ' + (detail.point > 0 ? '#50C878' : '#999') + ';">' + detail.point + 'pt</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('reviewResultContent').innerHTML = html;
            
            // 画面切り替え
            showScreen('reviewResultScreen');
        }
        
        // 振り返り予想：キャンセル
        function cancelReview() {
            currentReviewRanking = null;
            reviewCorrectAnswer = null;
            showScreen('mainScreen');
        }
        
        // ========================================
        // Enterキーで次の入力欄に移動
        // ========================================
        function setupEnterKeyNavigation() {
            // 通常のランキング入力
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById('rank' + i);
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (i < 5) {
                            // 次の入力欄にフォーカス
                            document.getElementById('rank' + (i + 1)).focus();
                        } else {
                            // 5位の場合は保存ボタンにフォーカス
                            this.blur();
                        }
                    }
                });
            }
            
            // ゲーム入力（バグ修正：DOM順序ベースに変更）
            const container = document.getElementById('gameRankingForm');
            if (container) {
                container.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && event.target.classList.contains('rank-input')) {
                        event.preventDefault();
                        
                        // 現在のinputの親要素（rank-item）を取得
                        const currentItem = event.target.closest('.rank-item');
                        if (!currentItem) return;
                        
                        // 次の要素を取得（DOM順序）
                        const nextItem = currentItem.nextElementSibling;
                        
                        if (nextItem) {
                            // 次の入力欄にフォーカス
                            const nextInput = nextItem.querySelector('.rank-input');
                            if (nextInput) nextInput.focus();
                        } else {
                            // 最後の場合はフォーカスを外す
                            event.target.blur();
                        }
                    }
                });
            }
            
            // β用ゲーム入力（DOM順序ベース）
            const betaContainer = document.getElementById('betaGameRankingForm');
            if (betaContainer) {
                betaContainer.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && event.target.classList.contains('rank-input')) {
                        event.preventDefault();
                        const currentItem = event.target.closest('.rank-item');
                        if (!currentItem) return;
                        const nextItem = currentItem.nextElementSibling;
                        if (nextItem) {
                            const nextInput = nextItem.querySelector('.rank-input');
                            if (nextInput) nextInput.focus();
                        } else {
                            event.target.blur();
                        }
                    }
                });
            }
            
            // multi用ゲーム入力（DOM順序ベース）
            const multiContainer = document.getElementById('multiGameRankingForm');
            if (multiContainer) {
                multiContainer.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && event.target.classList.contains('rank-input')) {
                        event.preventDefault();
                        const currentItem = event.target.closest('.rank-item');
                        if (!currentItem) return;
                        const nextItem = currentItem.nextElementSibling;
                        if (nextItem) {
                            const nextInput = nextItem.querySelector('.rank-input');
                            if (nextInput) nextInput.focus();
                        } else {
                            event.target.blur();
                        }
                    }
                });
            }
        }
        
        // ========================================
        // 画面切り替え
        // ========================================
        function showScreen(screenId) {
            // すべての画面を非表示
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            
            // 指定された画面を表示
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.style.display = 'block';
            }
        }
        
        // HOME画面に戻る（確認ダイアログ付き）
        function confirmBackToMain(message) {
            if (confirm(message || 'HOMEに戻りますか？')) {
                backToMain();
            }
        }
        
        // ========================================
        // LINE招待機能
        // ========================================
        
        // 待機室のURLをコピー
        function copySessionUrl() {
            if (!currentGameSession || !currentGameSession.id) {
                alert('❌ セッション情報がありません。');
                return;
            }
            
            const liffUrl = `https://liff.line.me/${LIFF_ID}`;
            const sessionUrl = `${liffUrl}?session=${currentGameSession.id}`;
            
            // URLをクリップボードにコピー
            navigator.clipboard.writeText(sessionUrl)
                .then(() => {
                    alert('📋 待機室のURLをコピーしました！\nLINEでお相手に送信してください。');
                    console.log('✅ URLコピー成功:', sessionUrl);
                })
                .catch((error) => {
                    console.error('❌ URLコピーエラー:', error);
                    alert('❌ URLのコピーに失敗しました。');
                });
        }
        
        // ペア設定用のURLをコピー
        function copyPairUrl() {
            if (!currentUser || !currentUser.pairCode) {
                alert('❌ ペアコード情報がありません。');
                return;
            }
            
            const liffUrl = `https://liff.line.me/${LIFF_ID}`;
            const pairUrl = `${liffUrl}?pairCode=${currentUser.pairCode}`;
            
            // URLをクリップボードにコピー
            navigator.clipboard.writeText(pairUrl)
                .then(() => {
                    alert('📋 ペア設定用のURLをコピーしました！\nLINEでお相手に送信してください。');
                    console.log('✅ URLコピー成功:', pairUrl);
                })
                .catch((error) => {
                    console.error('❌ URLコピーエラー:', error);
                    alert('❌ URLのコピーに失敗しました。');
                });
        }
        
        // ペアコード入力時にパートナー名をプレビュー表示
        function updatePartnerNamePreview() {
            const input = document.getElementById('partnerCodeInput');
            const preview = document.getElementById('partnerNamePreview');
            const previewText = document.getElementById('partnerNamePreviewText');
            const pairCode = input.value.trim().toUpperCase();
            
            // 6文字入力された場合のみ表示
            if (pairCode.length === 6) {
                // 全ユーザーを検索してペアコードが一致するユーザーを探す
                database.ref('users').orderByChild('pairCode').equalTo(pairCode).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            // 最初に見つかったユーザーを取得
                            let foundUser = null;
                            snapshot.forEach((childSnapshot) => {
                                if (!foundUser) {
                                    foundUser = childSnapshot.val();
                                }
                            });
                            
                            if (foundUser) {
                                previewText.textContent = foundUser.displayName;
                                preview.style.display = 'block';
                            } else {
                                preview.style.display = 'none';
                            }
                        } else {
                            // ペアコードが存在しない
                            preview.style.display = 'none';
                        }
                    })
                    .catch((error) => {
                        console.error('❌ パートナー名取得エラー:', error);
                        preview.style.display = 'none';
                    });
            } else {
                // 6文字未満の場合は非表示
                preview.style.display = 'none';
            }
        }
        
        // URLパラメータをチェック（招待URL処理）
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // セッション招待URLの場合
            const sessionId = urlParams.get('session');
            if (sessionId) {
                console.log('🎮 セッション招待URLを検出:', sessionId);
                handleSessionInvite(sessionId);
                return;
            }
            
            // ペアコード招待URLの場合
            const pairCode = urlParams.get('pairCode');
            if (pairCode) {
                console.log('💑 ペアコード招待URLを検出:', pairCode);
                handlePairCodeInvite(pairCode);
                return;
            }
        }
        
        // セッション招待を処理
        function handleSessionInvite(sessionId) {
            // ユーザー初期化完了後に実行
            const checkUserReady = setInterval(() => {
                if (currentUser) {
                    clearInterval(checkUserReady);
                    
                    // セッション情報を取得
                    const sessionRef = database.ref('gameSessions/' + sessionId);
                    sessionRef.once('value')
                        .then((snapshot) => {
                            if (snapshot.exists()) {
                                const sessionData = snapshot.val();
                                const hostId = sessionData.hostId;
                                const partnerId = sessionData.partnerId;
                                const myUserId = userProfile.userId;
                                
                                // ホスト本人の場合
                                if (myUserId === hostId) {
                                    console.log('🎮 ホスト本人：待機室を表示');
                                    showWaitingRoom(sessionId, sessionData, 'host');
                                    return;
                                }
                                
                                // ペアの場合
                                if (myUserId === partnerId) {
                                    console.log('🎮 ペア：参加確認画面を表示');
                                    showWaitingRoom(sessionId, sessionData, 'guest');
                                    return;
                                }
                                
                                // ペア以外の場合
                                alert('❌ この招待はあなた宛てではありません。\n\nこのゲームはペア専用です。');
                                showScreen('mainScreen');
                            } else {
                                alert('このゲームセッションは既に終了しています。');
                                showScreen('mainScreen');
                            }
                        })
                        .catch((error) => {
                            console.error('❌ セッション取得エラー:', error);
                            alert('セッション情報の取得に失敗しました。');
                            showScreen('mainScreen');
                        });
                }
            }, 100);
            
            // タイムアウト（10秒）
            setTimeout(() => {
                clearInterval(checkUserReady);
            }, 10000);
        }
        
        // ペアコード招待を処理
        function handlePairCodeInvite(pairCode) {
            // ユーザー初期化完了後に実行
            const checkUserReady = setInterval(() => {
                if (currentUser) {
                    clearInterval(checkUserReady);
                    
                    // 自分のペアコードの場合は、通常通りHOME画面へ
                    if (pairCode.toUpperCase() === currentUser.pairCode) {
                        console.log('🏠 自分のペアコード：HOME画面を表示');
                        showScreen('mainScreen');
                        return;
                    }
                    
                    // 既にペア設定済みかチェック（users から検索）
                    database.ref('users').orderByChild('pairCode').equalTo(pairCode.toUpperCase()).once('value')
                        .then((snapshot) => {
                            let inviterUserId = null;
                            
                            if (snapshot.exists()) {
                                // ペアコードの持ち主を取得
                                snapshot.forEach((childSnapshot) => {
                                    if (!inviterUserId) {
                                        inviterUserId = childSnapshot.key;
                                    }
                                });
                            }
                            
                            // 既にこのユーザーとペア設定済みの場合
                            if (inviterUserId && currentUser.partnerId === inviterUserId) {
                                console.log('🏠 既にペア設定済み：HOME画面を表示');
                                showScreen('mainScreen');
                                return;
                            }
                            
                            // ペア設定画面を表示し、ペアコードを入力
                            showScreen('pairScreen');
                            document.getElementById('partnerCodeInput').value = pairCode.toUpperCase();
                            
                            // 「あなたのペアコード」セクションを非表示
                            const myPairCodeSection = document.querySelector('#pairScreen > div:first-of-type');
                            if (myPairCodeSection) {
                                myPairCodeSection.style.display = 'none';
                            }
                            
                            // パートナー名をプレビュー表示
                            updatePartnerNamePreview();
                        })
                        .catch((error) => {
                            console.error('❌ ペア設定確認エラー:', error);
                            showScreen('mainScreen');
                        });
                }
            }, 100);
            
            // タイムアウト（10秒）
            setTimeout(() => {
                clearInterval(checkUserReady);
            }, 10000);
        }
        
        // HOME画面に戻る（ゲーム終了処理）
        async function backToMain() {
            try {
                console.log('🏠 HOMEボタンが押されました');
                
                // 現在の画面を確認
                const currentScreen = document.querySelector('.screen.active');
                const screenId = currentScreen ? currentScreen.id : '';
                
                // 画面タイプを判定
                const isWaitingRoom = screenId === 'waitingRoomScreen';
                const isGameInProgress = ['gameInputScreen', 'guessScreen'].includes(screenId);
                const isResultScreen = screenId === 'resultScreen';
                
                // 待機室からの退出処理
                if (isWaitingRoom && currentGameSession) {
                    // ホストの場合は、待機室を削除（相手に「セッションが削除されました」と通知）
                    if (currentGameSession.role === 'host') {
                        const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                        await sessionRef.remove();
                        console.log('✅ ホストが待機室を削除しました');
                    } else {
                        // ゲストの場合は、自分だけ退出（待機室は維持）
                        console.log('✅ ゲストが待機室を退出しました（待機室は維持）');
                    }
                }
                
                // ゲーム中にHOMEを押した場合、相手にも通知
                if (isGameInProgress && currentGameSession) {
                    const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                    await sessionRef.update({
                        gameAborted: true,
                        abortedBy: userProfile.userId,
                        abortedAt: new Date().toISOString()
                    });
                    console.log('✅ ゲーム中断を通知しました');
                    
                    // 少し待ってからセッション削除（相手が通知を受け取れるように）
                    setTimeout(async () => {
                        await sessionRef.remove();
                        console.log('✅ セッション削除成功（ゲーム中断）');
                    }, 1000);
                }
                
                // 結果画面から戻る場合は、セッションを削除
                if (isResultScreen && currentGameSession) {
                    const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                    await sessionRef.remove();
                    console.log('✅ セッション削除成功（結果画面からHOME）');
                }
                
                // セッションリスナーをクリーンアップ
                if (currentSessionRef) {
                    currentSessionRef.off();
                    currentSessionRef = null;
                }
                currentGameSession = null;
                
                showScreen('mainScreen');
            } catch (error) {
                console.error('❌ backToMain エラー:', error);
                alert('エラーが発生しました。ページを再読み込みしてください。');
            }
        }
        
        // ========================================
        // 開発メニューの表示切り替え
        // ========================================
        function toggleDevMenu() {
            const devMenuContent = document.getElementById('devMenuContent');
            const toggleButton = document.getElementById('devMenuToggleButton');
            
            if (devMenuContent.style.display === 'none') {
                devMenuContent.style.display = 'block';
                toggleButton.textContent = '🔧 開発メニュー（閉じる）';
            } else {
                devMenuContent.style.display = 'none';
                toggleButton.textContent = '🔧 開発メニュー';
            }
        }
        
        function toggleHomeDevMenu() {
            const content = document.getElementById('homeDevMenuContent');
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }
        
        // ========================================
        // ランキング作成機能
        // ========================================
        function startRanking() {
            // ランダムにテーマを選ぶ
            currentTheme = THEMES[Math.floor(Math.random() * THEMES.length)];
            document.getElementById('currentTheme').textContent = currentTheme;
            
            // 入力欄をクリア
            for (let i = 1; i <= 5; i++) {
                document.getElementById('rank' + i).value = '';
            }
            
            // ランキング画面に切り替え
            showScreen('rankingScreen');
            
            // 1位の入力欄にフォーカス
            setTimeout(() => {
                document.getElementById('rank1').focus();
            }, 100);
        }
        
        function saveRanking() {
            // 入力値を取得
            const rankings = [];
            for (let i = 1; i <= 5; i++) {
                const value = document.getElementById('rank' + i).value.trim();
                if (value === '') {
                    alert((i) + '位を入力してください！');
                    document.getElementById('rank' + i).focus();
                    return;
                }
                rankings.push(value);
            }
            
            // Firebaseが初期化されているか確認
            if (!database) {
                alert('❌ データベース接続エラー。\nページを再読み込みしてください。');
                return;
            }
            
            if (!userProfile) {
                alert('❌ ユーザー情報が取得できていません。');
                return;
            }
            
            // Firebaseに保存するデータを作成
            const newRanking = {
                userId: userProfile.userId,
                userName: userProfile.displayName,
                theme: currentTheme,
                ranking: {
                    "1": rankings[0],
                    "2": rankings[1],
                    "3": rankings[2],
                    "4": rankings[3],
                    "5": rankings[4]
                },
                createdAt: new Date().toISOString()
            };
            
            // Firebaseに保存（ユニークなIDを自動生成）
            const rankingsRef = database.ref('rankings');
            const newRankingRef = rankingsRef.push();
            
            newRankingRef.set(newRanking)
                .then(() => {
                    alert('✅ ランキングを保存しました！\n\nFirebaseに正常に保存されました。');
                    console.log('✅ ランキング保存成功:', newRanking);
                    backToMain();
                })
                .catch((error) => {
                    alert('❌ 保存エラー:\n' + error.message);
                    console.error('❌ 保存エラー:', error);
                });
        }
        
        // ========================================
        // 履歴表示機能（Firebaseから取得）
        // ========================================
        function showHistory() {
            const historyList = document.getElementById('historyList');
            
            // ローディング表示
            historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px 20px;">読み込み中...</p>';
            
            // 画面切り替え
            showScreen('historyScreen');
            
            // Firebaseが初期化されているか確認
            if (!database) {
                historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">❌ データベース接続エラー<br>ページを再読み込みしてください</p>';
                return;
            }
            
            if (!userProfile) {
                historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">❌ ユーザー情報が取得できていません</p>';
                return;
            }
            
            // Firebaseから自分のランキングデータを取得
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // データを配列に変換
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDを追加
                        rankings.push(data);
                    });
                    
                    // 日付順にソート（新しい順）
                    rankings.sort((a, b) => {
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    });
                    
                    // 表示
                    if (rankings.length === 0) {
                        historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 20px;">まだランキングがありません<br>新しいテーマでランキングを作ってみましょう！</p>';
                    } else {
                        let html = '';
                        rankings.forEach((item) => {
                            const date = new Date(item.createdAt);
                            const dateStr = date.getFullYear() + '年' + 
                                          (date.getMonth() + 1) + '月' + 
                                          date.getDate() + '日 ' + 
                                          date.getHours() + ':' + 
                                          String(date.getMinutes()).padStart(2, '0');
                            
                            html += '<div class="history-item">';
                            html += '<div class="history-theme">' + item.theme + '</div>';
                            html += '<div class="history-date">' + dateStr + ' by ' + item.userName + '</div>';
                            html += '<div class="history-rankings">';
                            
                            // ranking オブジェクトから表示
                            for (let i = 1; i <= 5; i++) {
                                if (item.ranking && item.ranking[i.toString()]) {
                                    html += '<div>' + i + '位: ' + item.ranking[i.toString()] + '</div>';
                                }
                            }
                            
                            html += '</div>';
                            html += '</div>';
                        });
                        historyList.innerHTML = html;
                    }
                    
                    console.log('✅ 履歴取得成功:', rankings.length + '件');
                })
                .catch((error) => {
                    historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">❌ データ取得エラー<br>' + error.message + '</p>';
                    console.error('❌ 履歴取得エラー:', error);
                });
        }
        
        // ========================================
        // Firebase 接続テスト機能（フェーズ3で追加）
        // ========================================
        
        // ========================================
        // 開発用：SortableJS を使った実装
        // ========================================
        
        // グローバル変数（開発用）
        let devCurrentReviewRanking = null;
        let devReviewCorrectAnswer = null;
        let devSortableInstance = null;
        
        // 開発用：ランキング一覧表示
        function showDevReviewList() {
            // Firebaseから自分のランキングデータを取得
            if (!database || !userProfile) {
                alert('❌ データ取得エラー');
                return;
            }
            
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // データを配列に変換
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDを追加
                        rankings.push(data);
                    });
                    
                    // ランキングがない場合
                    if (rankings.length === 0) {
                        alert('❌ まだランキングがありません\n先に「新しいテーマでランキングを作る」で遊んでみましょう！');
                        return;
                    }
                    
                    // ランダムに1つ選ぶ
                    const randomIndex = Math.floor(Math.random() * rankings.length);
                    const selectedRanking = rankings[randomIndex];
                    
                    console.log('✅ 開発用：ランダム選択:', selectedRanking.theme);
                    
                    // 選択したランキングで予想開始
                    startDevReviewGuess(selectedRanking.id);
                })
                .catch((error) => {
                    alert('❌ データ取得エラー:\n' + error.message);
                    console.error('❌ ランキング取得エラー:', error);
                });
        }
        
        // 開発用：並び替え開始
        function startDevReviewGuess(rankingId) {
            // ランキングデータを取得
            const rankingRef = database.ref('rankings/' + rankingId);
            
            rankingRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('❌ ランキングが見つかりません。');
                        return;
                    }
                    
                    const rankingData = snapshot.val();
                    devCurrentReviewRanking = {
                        id: rankingId,
                        data: rankingData
                    };
                    
                    // 正解を保存
                    devReviewCorrectAnswer = rankingData.ranking;
                    
                    // テーマを表示
                    document.getElementById('devReviewTheme').textContent = rankingData.theme;
                    
                    // 項目を取得してシャッフル
                    const items = [];
                    for (let i = 1; i <= 5; i++) {
                        items.push(rankingData.ranking[i.toString()]);
                    }
                    
                    // シャッフル（Fisher-Yates アルゴリズム）
                    for (let i = items.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [items[i], items[j]] = [items[j], items[i]];
                    }
                    
                    // UIを生成（SortableJS使用）
                    createDevReviewGuessUI(items);
                    
                    // 画面切り替え
                    showScreen('devReviewGuessScreen');
                })
                .catch((error) => {
                    console.error('❌ ランキング取得エラー:', error);
                    alert('❌ データ取得エラー:\n' + error.message);
                });
        }
        
        // 開発用：UIを生成（SortableJS使用）
        function createDevReviewGuessUI(items) {
            const container = document.getElementById('devReviewGuessArea');
            container.innerHTML = '';
            
            // 既存のSortableインスタンスを破棄
            if (devSortableInstance) {
                devSortableInstance.destroy();
                devSortableInstance = null;
            }
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-item', item);
                itemDiv.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // 順位番号
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + '位';
                rankSpan.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // テキスト
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ドラッグハンドル（≡アイコン）を右端に配置
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = '≡';
                handleSpan.style.cssText = 'margin-left: auto; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(handleSpan);
                
                container.appendChild(itemDiv);
            });
            
            // 🌟 SortableJS を初期化（ここがポイント！）
            devSortableInstance = new Sortable(container, {
                animation: 150,                    // アニメーション速度
                delay: 50,                         // ✨ 50ms長押しでドラッグ開始（Apple Music並み）
                delayOnTouchOnly: true,            // ✨ スマホのみ長押し判定
                forceFallback: true,               // ✨ カスタムドラッグ有効化
                fallbackOnBody: true,              // ✨ body要素に追加（指に追従）
                swapThreshold: 0.65,               // ✨ 入れ替え感度（0.65 = 65%）
                handle: '.drag-handle',            // ≡アイコンだけでドラッグ可能
                ghostClass: 'sortable-ghost',      // ドラッグ中のスタイル
                chosenClass: 'sortable-chosen',    // 選択中のスタイル
                dragClass: 'sortable-drag',        // ドラッグ中の要素スタイル
                fallbackClass: 'sortable-fallback',// ✨ フォールバック時のスタイル
                
                // ✨ 要素移動中にリアルタイムで順位更新
                onChange: function(evt) {
                    updateDevRankNumbers();
                    
                    // ✨ ドラッグ中の要素の順位も直接更新（forceFallbackで body に移動しているため）
                    if (evt.item && evt.newIndex !== undefined) {
                        const rankSpan = evt.item.querySelector('.rank-number');
                        if (rankSpan) {
                            rankSpan.textContent = (evt.newIndex + 1) + '位';
                        }
                    }
                },
                
                // ドラッグ終了時に順位番号を更新
                onEnd: function() {
                    updateDevRankNumbers();
                }
            });
            
            console.log('✅ SortableJS 初期化完了');
        }
        
        // 開発用：順位番号を更新
        function updateDevRankNumbers() {
            const container = document.getElementById('devReviewGuessArea');
            const items = container.children;
            
            for (let i = 0; i < items.length; i++) {
                const rankSpan = items[i].querySelector('.rank-number');
                if (rankSpan) {
                    rankSpan.textContent = (i + 1) + '位';
                }
            }
        }
        
        // 開発用：予想を送信
        function submitDevReviewGuess() {
            console.log('🔍 submitDevReviewGuess() が呼ばれました');
            console.log('devCurrentReviewRanking:', devCurrentReviewRanking);
            console.log('devReviewCorrectAnswer:', devReviewCorrectAnswer);
            
            if (!devCurrentReviewRanking) {
                alert('❌ エラー：ランキングデータがありません');
                return;
            }
            
            // 現在の並び順を取得
            const container = document.getElementById('devReviewGuessArea');
            const items = container.children;
            
            console.log('items.length:', items.length);
            
            // 全ての項目が正しく入っているか確認
            if (items.length !== 5) {
                alert('❌ データが正しくありません');
                return;
            }
            
            // ユーザーの予想を取得（data-item属性から）
            const userGuessArray = [];
            for (let i = 0; i < items.length; i++) {
                userGuessArray.push(items[i].getAttribute('data-item'));
            }
            
            // スコアを計算（新方式：完全一致=2点、±1=1点）
            let score = 0;           // 合計スコア
            let perfectCount = 0;    // 完全一致の数
            let closeCount = 0;      // ±1の数
            const details = [];      // 詳細情報
            
            // 各予想位置について、正解での順位を探して比較
            for (let guessRank = 1; guessRank <= 5; guessRank++) {
                const guessedItem = userGuessArray[guessRank - 1];
                
                // この項目が正解で何位なのか探す
                let correctRank = 0;
                for (let rank = 1; rank <= 5; rank++) {
                    if (devReviewCorrectAnswer[rank.toString()] === guessedItem) {
                        correctRank = rank;
                        break;
                    }
                }
                
                // 順位の差を計算
                let pointEarned = 0;
                let matchType = '';
                if (correctRank > 0) {
                    const diff = Math.abs(guessRank - correctRank);
                    if (diff === 0) {
                        // 完全一致
                        pointEarned = 2;
                        perfectCount++;
                        matchType = 'perfect';
                    } else if (diff === 1) {
                        // ±1（おしい）
                        pointEarned = 1;
                        closeCount++;
                        matchType = 'close';
                    }
                }
                score += pointEarned;
                
                details.push({
                    guessRank: guessRank,
                    correctRank: correctRank,
                    item: guessedItem,
                    matchType: matchType,
                    point: pointEarned
                });
            }
            
            console.log('スコア計算完了:', { perfectCount, closeCount, score });
            
            // 結果を表示
            showDevReviewResult(userGuessArray, perfectCount, closeCount, score, details);
        }
        
        // 開発用：結果を表示
        function showDevReviewResult(guessedItems, perfectCount, closeCount, totalScore, details) {
            let html = '';
            
            // 評価メッセージ（5段階）
            let emoji = '';
            let message = '';
            if (totalScore === 10) {
                emoji = '🎉';
                message = 'パーフェクト！';
            } else if (totalScore >= 8) {
                emoji = '😊';
                message = 'すごい！';
            } else if (totalScore >= 6) {
                emoji = '👍';
                message = 'いい感じ！';
            } else if (totalScore >= 4) {
                emoji = '🤔';
                message = 'おしい！';
            } else {
                emoji = '💪';
                message = '次は頑張ろう！';
            }
            
            // メッセージ表示
            html += '<div style="text-align: center; margin-bottom: 30px;">';
            html += '<p style="font-size: 64px; margin-bottom: 10px;">' + emoji + '</p>';
            html += '<h3 style="color: #FF6B35; font-size: 24px; margin-bottom: 10px;">' + message + '</h3>';
            html += '</div>';
            
            // スコア詳細
            html += '<div style="background: #FFF8F0; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<p style="color: #FF6B35; font-size: 48px; font-weight: bold; margin-bottom: 10px;">' + totalScore + '点<span style="font-size: 24px; color: #999;"> / 10点</span></p>';
            html += '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">完全一致</p>';
            html += '<p style="color: #FF6B35; font-size: 24px; font-weight: bold;">' + perfectCount + '個</p>';
            html += '<p style="color: #999; font-size: 12px;">×2点</p>';
            html += '</div>';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">おしい（±1）</p>';
            html += '<p style="color: #FF6B35; font-size: 24px; font-weight: bold;">' + closeCount + '個</p>';
            html += '<p style="color: #999; font-size: 12px;">×1点</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // 答え合わせ詳細（表形式）
            html += '<div style="background: white; border: 2px solid #FFD9B3; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
            html += '<h3 style="color: #FF6B35; font-size: 16px; margin-bottom: 15px;">✨ 答え合わせ</h3>';
            
            // タイトル行
            html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 8px; background: #FFE4CC; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 12px; color: #666;">';
            html += '<div style="text-align: center;">予想</div>';
            html += '<div>項目</div>';
            html += '<div style="text-align: center;">正解順位</div>';
            html += '<div style="text-align: center;">評価</div>';
            html += '<div style="text-align: center;">得点</div>';
            html += '</div>';
            
            // データ行
            for (let i = 0; i < details.length; i++) {
                const detail = details[i];
                const matchType = detail.matchType;
                let icon = '';
                let bgColor = 'transparent';
                let evalText = '';
                
                if (matchType === 'perfect') {
                    icon = '○';
                    bgColor = '#F0FFF4';
                    evalText = '完全一致';
                } else if (matchType === 'close') {
                    icon = '△';
                    bgColor = '#FFF8F0';
                    evalText = 'おしい';
                } else {
                    icon = '✕';
                    evalText = '';
                }
                
                const correctRankText = detail.correctRank > 0 ? detail.correctRank + '位' : '-';
                
                html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + detail.guessRank + '位</div>';
                html += '<div style="color: #333;">' + detail.item + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + correctRankText + '</div>';
                html += '<div style="text-align: center; font-size: 18px;">' + icon + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: ' + (detail.point > 0 ? '#50C878' : '#999') + ';">' + detail.point + 'pt</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('devReviewResultContent').innerHTML = html;
            
            // 画面切り替え
            showScreen('devReviewResultScreen');
        }
        
        // 開発用：キャンセル
        function cancelDevReview() {
            if (confirm('ゲームを中止してメイン画面に戻りますか？')) {
                // Sortableインスタンスを破棄
                if (devSortableInstance) {
                    devSortableInstance.destroy();
                    devSortableInstance = null;
                }
                
                devCurrentReviewRanking = null;
                devReviewCorrectAnswer = null;
                showScreen('mainScreen');
            }
        }
        
        // ========================================
        // β用：部屋ベースのゲームフロー（Phase 2a）
        // 既存の「ふたりであそぶ」ロジックとは完全に独立
        // Firebase: gameRooms ノードを使用
        // ========================================
        
        // β用グローバル変数
        let betaCurrentRoom = null;       // { roomId, role, data }
        let betaRoomRef = null;           // Firebase監視リスナーのref
        let betaSelectedThemeMode = 'app'; // 'app' | 'custom'
        let betaGameInputSortable = null; // SortableJS（入力画面）
        let betaGuessSortable = null;     // SortableJS（予想画面）
        
        // ========================================
        // β用：画面遷移
        // ========================================
        
        function showBetaRoleSelect() {
            if (!userProfile) {
                alert('❌ ユーザー情報が読み込まれていません。\nページを再読み込みしてください。');
                return;
            }
            showScreen('betaRoleSelectScreen');
        }
        
        // ========================================
        // β用：部屋の作成・参加・退出
        // ========================================
        
        function betaGenerateRoomId() {
            const min = 1000;
            const max = 9999;
            return String(Math.floor(Math.random() * (max - min + 1)) + min);
        }
        
        async function betaCreateRoom() {
            if (!userProfile || !database) {
                alert('❌ ユーザー情報が読み込まれていません。');
                return;
            }
            
            try {
                const roomsRef = database.ref('gameRooms');
                let roomId = betaGenerateRoomId();
                let retries = 0;
                
                while (retries < 10) {
                    const snapshot = await roomsRef.child(roomId).once('value');
                    if (!snapshot.exists()) break;
                    roomId = betaGenerateRoomId();
                    retries++;
                }
                
                if (retries >= 10) {
                    alert('❌ 部屋番号の生成に失敗しました。もう一度お試しください。');
                    return;
                }
                
                const roomData = {
                    roomId: roomId,
                    hostId: userProfile.userId,
                    hostName: userProfile.displayName,
                    maxPlayers: 2,
                    gameMode: 'duo',
                    status: 'waiting',
                    theme: null,
                    themeMode: null,
                    players: {},
                    createdAt: new Date().toISOString(),
                    lastActivityAt: Date.now()
                };
                
                roomData.players[userProfile.userId] = {
                    displayName: userProfile.displayName,
                    status: 'waiting'
                };
                
                await roomsRef.child(roomId).set(roomData);
                console.log('✅ β部屋作成成功:', roomId);
                
                betaCurrentRoom = { roomId: roomId, role: 'host', data: roomData };
                
                // ホスト用：「部屋を閉じる」ボタンを表示
                document.getElementById('betaCloseRoomButton').style.display = 'block';
                
                betaShowWaitingRoom(roomId);
                betaStartRoomListener(roomId);
                
            } catch (error) {
                console.error('❌ β部屋作成エラー:', error);
                alert('❌ 部屋の作成に失敗しました。\n' + error.message);
            }
        }
        
        function betaShowWaitingRoom(roomId) {
            document.getElementById('betaRoomNumber').textContent = roomId;
            showScreen('betaWaitingRoomScreen');
        }
        
        function betaCopyRoomNumber() {
            if (!betaCurrentRoom) return;
            const roomId = betaCurrentRoom.roomId;
            navigator.clipboard.writeText(roomId)
                .then(() => { alert('📋 部屋番号「' + roomId + '」をコピーしました！'); })
                .catch(() => { alert('部屋番号: ' + roomId + '\n（手動でコピーしてください）'); });
        }
        
        function betaShowJoinRoom() {
            document.getElementById('betaRoomNumberInput').value = '';
            showScreen('betaJoinRoomScreen');
        }
        
        async function betaJoinRoom() {
            if (!userProfile || !database) {
                alert('❌ ユーザー情報が読み込まれていません。');
                return;
            }
            
            const input = document.getElementById('betaRoomNumberInput');
            const roomId = input.value.trim();
            
            if (!roomId || roomId.length !== 4) {
                alert('❌ 4桁の部屋番号を入力してください。');
                input.focus();
                return;
            }
            if (!/^\d+$/.test(roomId)) {
                alert('❌ 部屋番号は数字のみで入力してください。');
                input.focus();
                return;
            }
            
            const joinButton = document.getElementById('betaJoinRoomButton');
            try {
                joinButton.disabled = true;
                joinButton.textContent = '⏳ 接続中...';
                
                const roomRef = database.ref('gameRooms/' + roomId);
                const snapshot = await roomRef.once('value');
                
                if (!snapshot.exists()) {
                    alert('❌ 部屋番号「' + roomId + '」は見つかりませんでした。');
                    joinButton.disabled = false;
                    joinButton.textContent = '✨ 参加する';
                    return;
                }
                
                const roomData = snapshot.val();
                
                if (roomData.hostId === userProfile.userId) {
                    alert('❌ 自分が作成した部屋には参加できません。');
                    joinButton.disabled = false;
                    joinButton.textContent = '✨ 参加する';
                    return;
                }
                
                const playerCount = roomData.players ? Object.keys(roomData.players).length : 0;
                
                // 既に参加済みの場合はそのまま入室
                const alreadyJoined = roomData.players && roomData.players[userProfile.userId];
                
                if (!alreadyJoined && playerCount >= roomData.maxPlayers) {
                    alert('❌ この部屋は満員です。');
                    joinButton.disabled = false;
                    joinButton.textContent = '✨ 参加する';
                    return;
                }
                
                if (!alreadyJoined) {
                    const updates = {};
                    updates['players/' + userProfile.userId] = {
                        displayName: userProfile.displayName,
                        status: 'waiting'
                    };
                    updates['lastActivityAt'] = Date.now();
                    await roomRef.update(updates);
                }
                
                console.log('✅ β部屋参加成功:', roomId);
                
                betaCurrentRoom = { roomId: roomId, role: 'guest', data: roomData };
                
                // ゲスト用：「部屋を閉じる」ボタンを非表示
                document.getElementById('betaCloseRoomButton').style.display = 'none';
                
                joinButton.disabled = false;
                joinButton.textContent = '✨ 参加する';
                
                betaShowWaitingRoom(roomId);
                betaStartRoomListener(roomId);
                
            } catch (error) {
                console.error('❌ β部屋参加エラー:', error);
                alert('❌ 部屋への参加に失敗しました。\n' + error.message);
                joinButton.disabled = false;
                joinButton.textContent = '✨ 参加する';
            }
        }
        
        // β用：一時退出（部屋は残る）
        function betaConfirmLeaveRoom(message) {
            if (confirm(message || 'HOMEに戻りますか？')) {
                betaCleanupRoom();
                showScreen('mainScreen');
            }
        }
        
        // β用：部屋を閉じる（ホスト専用・部屋を削除）
        async function betaCloseRoom() {
            if (!confirm('部屋を閉じますか？\n全員が退出され、部屋番号は無効になります。')) return;
            
            try {
                if (betaCurrentRoom && database) {
                    await database.ref('gameRooms/' + betaCurrentRoom.roomId).remove();
                    console.log('✅ βホストが部屋を閉じました');
                }
                betaCleanupRoom();
                showScreen('mainScreen');
            } catch (error) {
                console.error('❌ β部屋削除エラー:', error);
                betaCleanupRoom();
                showScreen('mainScreen');
            }
        }
        
        function betaCleanupRoom() {
            if (betaRoomRef) {
                betaRoomRef.off();
                betaRoomRef = null;
            }
            if (betaGameInputSortable) {
                betaGameInputSortable.destroy();
                betaGameInputSortable = null;
            }
            if (betaGuessSortable) {
                betaGuessSortable.destroy();
                betaGuessSortable = null;
            }
            betaCurrentRoom = null;
        }
        
        // ========================================
        // β用：部屋のリアルタイム監視（状態遷移エンジン）
        // ========================================
        
        function betaStartRoomListener(roomId) {
            if (betaRoomRef) {
                betaRoomRef.off();
                betaRoomRef = null;
            }
            
            betaRoomRef = database.ref('gameRooms/' + roomId);
            
            betaRoomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    console.log('⚠️ β部屋が削除されました');
                    betaCleanupRoom();
                    alert('部屋が閉じられました。HOMEに戻ります。');
                    showScreen('mainScreen');
                    return;
                }
                
                const roomData = snapshot.val();
                const role = betaCurrentRoom ? betaCurrentRoom.role : (roomData.hostId === userProfile.userId ? 'host' : 'guest');
                betaCurrentRoom = { roomId: roomId, role: role, data: roomData };
                
                // 現在表示中の画面を取得
                const activeScreen = document.querySelector('.screen.active');
                const activeScreenId = activeScreen ? activeScreen.id : '';
                
                // 状態遷移
                switch (roomData.status) {
                    case 'waiting':
                        betaUpdatePlayersDisplay(roomData);
                        // 全員揃ったらホストが自動的にsettingに遷移
                        const playerCount = Object.keys(roomData.players || {}).length;
                        if (playerCount >= roomData.maxPlayers && role === 'host') {
                            database.ref('gameRooms/' + roomId).update({ status: 'setting', lastActivityAt: Date.now() });
                        }
                        break;
                        
                    case 'setting':
                        if (role === 'host') {
                            if (activeScreenId !== 'betaGameSettingsScreen') {
                                betaShowGameSettingsScreen();
                            }
                        } else {
                            if (activeScreenId !== 'betaGuestWaitingScreen') {
                                showScreen('betaGuestWaitingScreen');
                            }
                        }
                        break;
                        
                    case 'inputting':
                        if (activeScreenId !== 'betaGameInputScreen') {
                            betaShowGameInputScreen(roomData);
                        } else {
                            betaUpdateProgressDisplay(roomData);
                        }
                        break;
                        
                    case 'guessing':
                        if (activeScreenId !== 'betaGuessScreen') {
                            betaShowGuessScreen(roomData);
                        } else {
                            betaUpdateProgressDisplay(roomData);
                        }
                        break;
                        
                    case 'finished':
                        if (activeScreenId !== 'betaResultScreen') {
                            betaShowResultScreen(roomData);
                        }
                        break;
                }
            });
        }
        
        // β用：参加状況表示を更新
        function betaUpdatePlayersDisplay(roomData) {
            const playersArea = document.getElementById('betaRoomPlayersArea');
            if (!playersArea) return;
            
            const players = roomData.players || {};
            const playerList = Object.values(players);
            const playerCount = playerList.length;
            const maxPlayers = roomData.maxPlayers || 2;
            
            let html = '<p style="color: #4A90E2; font-size: 16px; font-weight: bold; margin-bottom: 10px;">' + playerCount + ' / ' + maxPlayers + ' 人参加中</p>';
            playerList.forEach((player) => {
                html += '<p style="color: #333; font-size: 14px; margin-bottom: 4px;">👤 ' + player.displayName + '</p>';
            });
            
            if (playerCount < maxPlayers) {
                html += '<p style="color: #999; font-size: 13px; margin-top: 10px;">⏳ お相手の参加を待っています...</p>';
            } else {
                html += '<p style="color: #11998e; font-size: 14px; font-weight: bold; margin-top: 10px;">✅ 全員揃いました！</p>';
            }
            playersArea.innerHTML = html;
        }
        
        // ========================================
        // β用：ゲーム設定画面
        // ========================================
        
        function betaShowGameSettingsScreen() {
            // 初期状態：アプリ内テーマモードを選択、ランダムテーマを設定
            betaSelectThemeMode('app');
            betaRandomizeTheme();
            
            // カスタムテーマ入力の文字数カウンター
            const customInput = document.getElementById('betaCustomThemeInput');
            customInput.value = '';
            document.getElementById('betaCustomThemeCount').textContent = '0';
            customInput.oninput = function() {
                document.getElementById('betaCustomThemeCount').textContent = this.value.length;
            };
            
            showScreen('betaGameSettingsScreen');
        }
        
        function betaSelectThemeMode(mode) {
            betaSelectedThemeMode = mode;
            const appBtn = document.getElementById('betaThemeModeApp');
            const customBtn = document.getElementById('betaThemeModeCustom');
            const appArea = document.getElementById('betaAppThemeArea');
            const customArea = document.getElementById('betaCustomThemeArea');
            
            if (mode === 'app') {
                appBtn.style.background = '#4A90E2';
                appBtn.style.color = 'white';
                appBtn.style.borderColor = '#4A90E2';
                customBtn.style.background = 'white';
                customBtn.style.color = '#333';
                customBtn.style.borderColor = '#ddd';
                appArea.style.display = 'block';
                customArea.style.display = 'none';
            } else {
                customBtn.style.background = '#4A90E2';
                customBtn.style.color = 'white';
                customBtn.style.borderColor = '#4A90E2';
                appBtn.style.background = 'white';
                appBtn.style.color = '#333';
                appBtn.style.borderColor = '#ddd';
                appArea.style.display = 'none';
                customArea.style.display = 'block';
                setTimeout(() => { document.getElementById('betaCustomThemeInput').focus(); }, 100);
            }
        }
        
        function betaRandomizeTheme() {
            const theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            document.getElementById('betaThemeText').textContent = theme;
            // リストが開いていたら閉じる
            document.getElementById('betaThemeListDropdown').style.display = 'none';
            document.getElementById('betaThemeArrow').textContent = '▼';
        }
        
        function betaToggleThemeList() {
            const dropdown = document.getElementById('betaThemeListDropdown');
            const arrow = document.getElementById('betaThemeArrow');
            
            if (dropdown.style.display === 'none') {
                // リストを生成して表示
                let html = '';
                THEMES.forEach((theme) => {
                    html += '<div onclick="betaSelectThemeFromList(\'' + theme.replace(/'/g, "\\'") + '\')" style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; color: #333; transition: background 0.1s;" onmouseover="this.style.background=\'#F0F8FF\'" onmouseout="this.style.background=\'white\'">';
                    html += theme;
                    html += '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                dropdown.style.display = 'none';
                arrow.textContent = '▼';
            }
        }
        
        function betaSelectThemeFromList(theme) {
            document.getElementById('betaThemeText').textContent = theme;
            document.getElementById('betaThemeListDropdown').style.display = 'none';
            document.getElementById('betaThemeArrow').textContent = '▼';
        }
        
        // β用：ゲームスタート
        async function betaStartGame() {
            if (!betaCurrentRoom || betaCurrentRoom.role !== 'host') return;
            
            let theme = '';
            let themeMode = betaSelectedThemeMode;
            
            if (themeMode === 'app') {
                theme = document.getElementById('betaThemeText').textContent;
            } else {
                theme = document.getElementById('betaCustomThemeInput').value.trim();
                if (!theme || theme.length < 3) {
                    alert('❌ テーマを3文字以上で入力してください。');
                    return;
                }
            }
            
            try {
                const roomRef = database.ref('gameRooms/' + betaCurrentRoom.roomId);
                await roomRef.update({
                    status: 'inputting',
                    theme: theme,
                    themeMode: themeMode,
                    rankings: null,
                    guesses: null,
                    results: null,
                    lastActivityAt: Date.now()
                });
                console.log('✅ βゲーム開始:', theme);
            } catch (error) {
                console.error('❌ βゲーム開始エラー:', error);
                alert('❌ ゲームの開始に失敗しました。');
            }
        }
        
        // ========================================
        // β用：ランキング入力
        // ========================================
        
        function betaShowGameInputScreen(roomData) {
            document.getElementById('betaGameTheme').textContent = roomData.theme;
            betaUpdateProgressDisplay(roomData);
            
            // DOM順序リセット
            const container = document.getElementById('betaGameRankingForm');
            const items = Array.from(container.children);
            items.sort((a, b) => (parseInt(a.getAttribute('data-rank')) || 0) - (parseInt(b.getAttribute('data-rank')) || 0));
            items.forEach(item => container.appendChild(item));
            
            // 入力欄クリア + 順位番号リセット
            Array.from(container.children).forEach((item, i) => {
                const input = item.querySelector('.rank-input');
                if (input) { input.value = ''; input.disabled = false; input.style.background = ''; input.style.color = ''; }
                const label = item.querySelector('.rank-label');
                if (label) label.textContent = (i + 1) + '位';
                const handle = item.querySelector('.drag-handle');
                if (handle) handle.style.display = '';
                item.setAttribute('data-rank', i + 1);
            });
            
            // 送信ボタンリセット
            const btn = document.getElementById('betaSubmitRankingButton');
            btn.textContent = '💾 ランキングを送信';
            btn.disabled = false;
            btn.style.background = '';
            btn.style.opacity = '';
            
            showScreen('betaGameInputScreen');
            
            // SortableJS初期化
            if (betaGameInputSortable) { betaGameInputSortable.destroy(); betaGameInputSortable = null; }
            betaGameInputSortable = new Sortable(container, {
                animation: 150, delay: 50, delayOnTouchOnly: true,
                forceFallback: true, fallbackOnBody: true, swapThreshold: 0.65,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag', fallbackClass: 'sortable-fallback',
                onEnd: function() {
                    Array.from(container.children).forEach((item, i) => {
                        const label = item.querySelector('.rank-label');
                        if (label) label.textContent = (i + 1) + '位';
                        const input = item.querySelector('.rank-input');
                        if (input) input.placeholder = (i + 1) + '位を入力（50文字まで）';
                        item.setAttribute('data-rank', i + 1);
                    });
                }
            });
            
            // 自分が既に送信済みならロック
            if (roomData.rankings && roomData.rankings[userProfile.userId]) {
                const myRanking = roomData.rankings[userProfile.userId];
                Array.from(container.children).forEach((item, i) => {
                    const input = item.querySelector('.rank-input');
                    if (input) { input.value = myRanking[(i + 1).toString()] || ''; input.disabled = true; input.style.background = '#f0f0f0'; input.style.color = '#999'; }
                    const handle = item.querySelector('.drag-handle');
                    if (handle) handle.style.display = 'none';
                });
                if (betaGameInputSortable) betaGameInputSortable.option('disabled', true);
                btn.textContent = '⏳ お相手の回答待ち...';
                btn.disabled = true;
                btn.style.background = '#999';
                btn.style.opacity = '0.6';
            }
            
            setTimeout(() => { const first = container.children[0]?.querySelector('.rank-input'); if (first && !first.disabled) first.focus(); }, 100);
        }
        
        async function betaSubmitRanking() {
            if (!betaCurrentRoom) return;
            
            const container = document.getElementById('betaGameRankingForm');
            const rankingData = {};
            
            for (let i = 0; i < container.children.length; i++) {
                const input = container.children[i].querySelector('.rank-input');
                const value = input ? input.value.trim() : '';
                if (!value) {
                    alert((i + 1) + '位を入力してください！');
                    if (input) input.focus();
                    return;
                }
                rankingData[(i + 1).toString()] = value;
            }
            
            try {
                const roomRef = database.ref('gameRooms/' + betaCurrentRoom.roomId);
                const updates = {};
                updates['rankings/' + userProfile.userId] = rankingData;
                updates['players/' + userProfile.userId + '/status'] = 'completed';
                updates['lastActivityAt'] = Date.now();
                await roomRef.update(updates);
                
                // 送信ボタンをロック
                const btn = document.getElementById('betaSubmitRankingButton');
                btn.textContent = '⏳ お相手の回答待ち...';
                btn.disabled = true;
                btn.style.background = '#999';
                btn.style.opacity = '0.6';
                
                // 入力欄をロック
                Array.from(container.children).forEach((item) => {
                    const input = item.querySelector('.rank-input');
                    if (input) { input.disabled = true; input.style.background = '#f0f0f0'; input.style.color = '#999'; }
                    const handle = item.querySelector('.drag-handle');
                    if (handle) handle.style.display = 'none';
                });
                if (betaGameInputSortable) betaGameInputSortable.option('disabled', true);
                
                // 全員入力完了チェック
                const snap = await roomRef.once('value');
                const data = snap.val();
                const allPlayers = Object.keys(data.players || {});
                const allSubmitted = allPlayers.every(id => data.rankings && data.rankings[id]);
                if (allSubmitted) {
                    await roomRef.update({ status: 'guessing', lastActivityAt: Date.now() });
                }
            } catch (error) {
                console.error('❌ βランキング送信エラー:', error);
                alert('❌ 送信エラー:\n' + error.message);
            }
        }
        
        // ========================================
        // β用：予想画面
        // ========================================
        
        function betaShowGuessScreen(roomData) {
            document.getElementById('betaGuessTheme').textContent = roomData.theme;
            betaUpdateProgressDisplay(roomData);
            
            // 相手のIDと名前を特定
            const players = Object.keys(roomData.players || {});
            const partnerId = players.find(id => id !== userProfile.userId);
            const partnerName = roomData.players[partnerId]?.displayName || 'お相手';
            document.getElementById('betaGuessPartnerName').textContent = partnerName;
            
            // 相手のランキング項目をシャッフル
            const partnerRanking = roomData.rankings[partnerId];
            if (!partnerRanking) { alert('❌ お相手のランキングが見つかりません。'); return; }
            
            const items = [];
            for (let i = 1; i <= 5; i++) { items.push(partnerRanking[i.toString()]); }
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }
            
            // 予想UIを生成
            const container = document.getElementById('betaGuessRankingArea');
            container.innerHTML = '';
            if (betaGuessSortable) { betaGuessSortable.destroy(); betaGuessSortable = null; }
            
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'draggable-item';
                div.setAttribute('data-item', item);
                div.style.cssText = '-webkit-user-select:none; user-select:none; -webkit-touch-callout:none;';
                
                const rank = document.createElement('span');
                rank.className = 'rank-number';
                rank.textContent = (index + 1) + '位';
                rank.style.cssText = '-webkit-user-select:none; user-select:none;';
                
                const text = document.createElement('span');
                text.textContent = item;
                text.style.cssText = 'color:#333; font-size:15px; flex:1; padding:0 10px; -webkit-user-select:none; user-select:none;';
                
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '≡';
                handle.style.cssText = 'margin-left:auto; -webkit-user-select:none; user-select:none;';
                
                div.appendChild(rank);
                div.appendChild(text);
                div.appendChild(handle);
                container.appendChild(div);
            });
            
            betaGuessSortable = new Sortable(container, {
                animation: 150, delay: 50, delayOnTouchOnly: true,
                forceFallback: true, fallbackOnBody: true, swapThreshold: 0.65,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag', fallbackClass: 'sortable-fallback',
                onChange: function() { betaUpdateGuessRankNumbers(); },
                onEnd: function() { betaUpdateGuessRankNumbers(); }
            });
            
            // 送信済みならロック
            if (roomData.guesses && roomData.guesses[userProfile.userId]) {
                setTimeout(() => {
                    if (betaGuessSortable) betaGuessSortable.option('disabled', true);
                    Array.from(container.children).forEach(item => {
                        item.style.opacity = '0.6';
                        const h = item.querySelector('.drag-handle');
                        if (h) h.style.display = 'none';
                    });
                }, 100);
            }
            
            showScreen('betaGuessScreen');
        }
        
        function betaUpdateGuessRankNumbers() {
            const container = document.getElementById('betaGuessRankingArea');
            if (!container) return;
            Array.from(container.children).forEach((item, i) => {
                const rank = item.querySelector('.rank-number');
                if (rank) rank.textContent = (i + 1) + '位';
            });
        }
        
        async function betaSubmitGuess() {
            if (!betaCurrentRoom) return;
            
            const container = document.getElementById('betaGuessRankingArea');
            const guessItems = Array.from(container.children).map(el => el.getAttribute('data-item'));
            
            if (guessItems.length !== 5) {
                alert('❌ 予想データが正しくありません。');
                return;
            }
            
            if (!confirm('この順番で送信しますか？\n\n' +
                '1位: ' + guessItems[0] + '\n' +
                '2位: ' + guessItems[1] + '\n' +
                '3位: ' + guessItems[2] + '\n' +
                '4位: ' + guessItems[3] + '\n' +
                '5位: ' + guessItems[4])) {
                return;
            }
            
            const guessData = {};
            guessItems.forEach((item, i) => { guessData[(i + 1).toString()] = item; });
            
            try {
                const roomRef = database.ref('gameRooms/' + betaCurrentRoom.roomId);
                const updates = {};
                updates['guesses/' + userProfile.userId] = guessData;
                updates['players/' + userProfile.userId + '/status'] = 'guessed';
                updates['lastActivityAt'] = Date.now();
                await roomRef.update(updates);
                
                // ロック
                if (betaGuessSortable) betaGuessSortable.option('disabled', true);
                Array.from(container.children).forEach(item => {
                    item.style.opacity = '0.6';
                    const h = item.querySelector('.drag-handle');
                    if (h) h.style.display = 'none';
                });
                
                // 全員完了チェック → スコア計算 → finished
                const snap = await roomRef.once('value');
                const data = snap.val();
                const allPlayers = Object.keys(data.players || {});
                const allGuessed = allPlayers.every(id => data.guesses && data.guesses[id]);
                if (allGuessed) {
                    const results = betaCalculateScores(data);
                    await roomRef.update({
                        status: 'finished',
                        results: results,
                        finishedAt: new Date().toISOString(),
                        lastActivityAt: Date.now()
                    });
                }
            } catch (error) {
                console.error('❌ β予想送信エラー:', error);
                alert('❌ 送信エラー:\n' + error.message);
            }
        }
        
        // ========================================
        // β用：スコア計算
        // ========================================
        
        function betaCalculateScores(roomData) {
            const rankings = roomData.rankings;
            const guesses = roomData.guesses;
            const players = Object.keys(roomData.players);
            const results = {};
            
            players.forEach((playerId) => {
                const partnerId = players.find(id => id !== playerId);
                const correctRanking = rankings[partnerId];
                const myGuess = guesses[playerId];
                
                let score = 0, perfectCount = 0, closeCount = 0;
                const details = [];
                
                for (let guessRank = 1; guessRank <= 5; guessRank++) {
                    const guessedItem = myGuess[guessRank.toString()];
                    let correctRank = 0;
                    for (let r = 1; r <= 5; r++) {
                        if (correctRanking[r.toString()] === guessedItem) { correctRank = r; break; }
                    }
                    
                    let matchType = 'miss', point = 0;
                    if (correctRank > 0) {
                        const diff = Math.abs(guessRank - correctRank);
                        if (diff === 0) { matchType = 'perfect'; point = 2; perfectCount++; }
                        else if (diff === 1) { matchType = 'close'; point = 1; closeCount++; }
                    }
                    score += point;
                    details.push({ guessRank, item: guessedItem, correctRank, matchType, point });
                }
                
                results[playerId] = { score, perfectCount, closeCount, details };
            });
            
            return results;
        }
        
        // ========================================
        // β用：結果画面
        // ========================================
        
        function betaShowResultScreen(roomData) {
            const players = Object.keys(roomData.players || {});
            const myId = userProfile.userId;
            const partnerId = players.find(id => id !== myId);
            const partnerName = roomData.players[partnerId]?.displayName || 'お相手';
            
            const myResult = roomData.results[myId] || { score: 0, perfectCount: 0, closeCount: 0 };
            const partnerResult = roomData.results[partnerId] || { score: 0, perfectCount: 0, closeCount: 0 };
            
            // 勝敗判定
            let resultEmoji, resultTitle;
            if (myResult.score > partnerResult.score) { resultEmoji = '🎉'; resultTitle = 'あなたの勝ち！'; }
            else if (myResult.score < partnerResult.score) { resultEmoji = '😄'; resultTitle = partnerName + 'さんの勝ち！'; }
            else { resultEmoji = '🤝'; resultTitle = '引き分け！'; }
            
            let html = '';
            
            // 勝敗
            html += '<div style="text-align:center; margin-bottom:30px;">';
            html += '<p style="font-size:64px; margin-bottom:10px;">' + resultEmoji + '</p>';
            html += '<h3 style="color:#11998e; font-size:24px;">' + resultTitle + '</h3>';
            html += '</div>';
            
            // 対戦成績
            html += '<div style="background:#F0F8FF; border-radius:10px; padding:20px; margin-bottom:20px;">';
            html += '<h3 style="color:#4A90E2; font-size:16px; margin-bottom:15px;">🏆 対戦成績</h3>';
            html += '<div style="display:flex; justify-content:space-around; text-align:center;">';
            html += '<div><p style="color:#666; font-size:13px; margin-bottom:5px;">あなた</p>';
            html += '<p style="color:#11998e; font-size:32px; font-weight:bold;">' + myResult.score + '<span style="font-size:16px; color:#999;"> / 10</span><span style="font-size:13px; color:#999;">pt</span></p>';
            html += '<p style="color:#999; font-size:12px;">あたり！（2pt）×' + (myResult.perfectCount || 0) + '個</p>';
            html += '<p style="color:#999; font-size:12px;">おしい！（1pt）×' + (myResult.closeCount || 0) + '個</p></div>';
            html += '<div><p style="color:#666; font-size:13px; margin-bottom:5px;">' + partnerName + '</p>';
            html += '<p style="color:#4A90E2; font-size:32px; font-weight:bold;">' + partnerResult.score + '<span style="font-size:16px; color:#999;"> / 10</span><span style="font-size:13px; color:#999;">pt</span></p>';
            html += '<p style="color:#999; font-size:12px;">あたり！（2pt）×' + (partnerResult.perfectCount || 0) + '個</p>';
            html += '<p style="color:#999; font-size:12px;">おしい！（1pt）×' + (partnerResult.closeCount || 0) + '個</p></div>';
            html += '</div></div>';
            
            // ふたりの成績
            const totalScore = myResult.score + partnerResult.score;
            let coopEmoji, coopMsg;
            if (totalScore === 20) { coopEmoji = '🎉'; coopMsg = 'パーフェクト！完璧なコンビネーション！'; }
            else if (totalScore >= 18) { coopEmoji = '😊'; coopMsg = '素晴らしい！ほぼ完璧！'; }
            else if (totalScore >= 15) { coopEmoji = '👍'; coopMsg = 'いい感じ！お互いをよく知ってる！'; }
            else if (totalScore >= 12) { coopEmoji = '🤔'; coopMsg = 'まだまだ伸びしろあり！'; }
            else if (totalScore >= 8) { coopEmoji = '💪'; coopMsg = '次は頑張ろう！'; }
            else { coopEmoji = '😅'; coopMsg = 'もっと話そう！'; }
            
            html += '<div style="background:#F0FFF4; border-radius:10px; padding:20px; margin-bottom:20px; text-align:center;">';
            html += '<h3 style="color:#50C878; font-size:16px; margin-bottom:15px;">🤝 ふたりの成績</h3>';
            html += '<p style="font-size:48px; margin-bottom:10px;">' + coopEmoji + '</p>';
            html += '<p style="color:#50C878; font-size:32px; font-weight:bold; margin-bottom:5px;">' + totalScore + '<span style="font-size:16px; color:#999;"> / 20pt</span></p>';
            html += '<p style="color:#666; font-size:16px; font-weight:bold;">' + coopMsg + '</p>';
            html += '</div>';
            
            // 答え合わせ（自分の成績）
            html += betaBuildAnswerTable('あなたの成績', roomData.rankings[partnerId], roomData.guesses[myId], '#4A90E2', '#E3F2FD');
            
            // 答え合わせ（相手の成績）
            html += betaBuildAnswerTable(partnerName + 'の成績', roomData.rankings[myId], roomData.guesses[partnerId], '#FF9800', '#FFE4CC');
            
            document.getElementById('betaResultContent').innerHTML = html;
            
            // ホストのみ「もう一度遊ぶ」ボタン表示
            const playAgainBtn = document.getElementById('betaPlayAgainButton');
            playAgainBtn.style.display = (betaCurrentRoom && betaCurrentRoom.role === 'host') ? 'block' : 'none';
            
            showScreen('betaResultScreen');
        }
        
        // β用：答え合わせテーブルを生成
        function betaBuildAnswerTable(title, correctRanking, guessData, accentColor, headerBg) {
            let html = '<div style="background:#F5F5F5; border-radius:10px; padding:20px; margin-bottom:20px; overflow-x:auto;">';
            html += '<h3 style="color:' + accentColor + '; font-size:16px; margin-bottom:15px;">' + title + '</h3>';
            
            // ヘッダー
            html += '<div style="display:grid; grid-template-columns:35px 2fr 50px 35px 40px; gap:6px; padding:8px; background:' + headerBg + '; border-radius:6px; margin-bottom:8px; font-weight:bold; font-size:11px; color:#666; align-items:center;">';
            html += '<div style="grid-column:1/3; text-align:center;">正しい順位</div>';
            html += '<div style="text-align:center; line-height:1.4;">予想</div>';
            html += '<div style="text-align:center;">評価</div>';
            html += '<div style="text-align:center;">得点</div>';
            html += '</div>';
            
            for (let correctRank = 1; correctRank <= 5; correctRank++) {
                const correctItem = correctRanking[correctRank.toString()];
                let guessRank = 0;
                for (let r = 1; r <= 5; r++) {
                    if (guessData[r.toString()] === correctItem) { guessRank = r; break; }
                }
                
                let icon = '×', bgColor = 'transparent', point = 0;
                if (guessRank > 0) {
                    const diff = Math.abs(guessRank - correctRank);
                    if (diff === 0) { icon = '○'; bgColor = '#F0FFF4'; point = 2; }
                    else if (diff === 1) { icon = '△'; bgColor = '#FFF8F0'; point = 1; }
                }
                
                html += '<div style="display:grid; grid-template-columns:35px 2fr 50px 35px 40px; gap:6px; padding:10px; border-radius:6px; background:' + bgColor + '; align-items:center; font-size:13px;">';
                html += '<div style="text-align:center; font-weight:bold; color:#666; font-size:12px;">' + correctRank + '位</div>';
                html += '<div style="color:#333; word-break:break-word; font-size:12px;">' + correctItem + '</div>';
                html += '<div style="text-align:center; font-weight:bold; color:#666; font-size:12px;">' + (guessRank > 0 ? guessRank + '位' : '-') + '</div>';
                html += '<div style="text-align:center; font-size:16px;">' + icon + '</div>';
                html += '<div style="text-align:center; font-weight:bold; color:' + (point > 0 ? '#50C878' : '#999') + '; font-size:11px;">' + point + 'pt</div>';
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // ========================================
        // β用：もう一度遊ぶ
        // ========================================
        
        async function betaPlayAgain() {
            if (!betaCurrentRoom || betaCurrentRoom.role !== 'host') return;
            
            try {
                const roomRef = database.ref('gameRooms/' + betaCurrentRoom.roomId);
                await roomRef.update({
                    status: 'setting',
                    theme: null,
                    themeMode: null,
                    rankings: null,
                    guesses: null,
                    results: null,
                    finishedAt: null,
                    lastActivityAt: Date.now()
                });
                console.log('✅ βもう一度遊ぶ：ゲーム設定画面へ');
            } catch (error) {
                console.error('❌ βもう一度遊ぶエラー:', error);
                alert('❌ エラーが発生しました。');
            }
        }
        
        // ========================================
        // β用：進行状況表示の更新
        // ========================================
        
        function betaUpdateProgressDisplay(roomData) {
            const players = roomData.players || {};
            const playerIds = Object.keys(players);
            
            let html = '';
            playerIds.forEach((playerId) => {
                const player = players[playerId];
                const isMe = playerId === userProfile.userId;
                const name = isMe ? 'あなた' : player.displayName;
                
                let icon = '⏳', text = '---', color = '#999';
                
                if (roomData.status === 'inputting') {
                    if (roomData.rankings && roomData.rankings[playerId]) {
                        icon = '✅'; text = '入力完了'; color = '#50C878';
                    } else {
                        icon = '⏳'; text = '入力中...'; color = '#FF9800';
                    }
                } else if (roomData.status === 'guessing') {
                    if (roomData.guesses && roomData.guesses[playerId]) {
                        icon = '✅'; text = '予想完了'; color = '#50C878';
                    } else {
                        icon = '🤔'; text = '予想中...'; color = '#FF9800';
                    }
                }
                
                html += '<div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0;">';
                html += '<span style="color:#666; font-size:14px;">' + icon + ' ' + name + '</span>';
                html += '<span style="color:' + color + '; font-size:13px; font-weight:bold;">' + text + '</span>';
                html += '</div>';
            });
            
            // 入力画面と予想画面の両方の進行状況エリアを更新
            const inputProgress = document.getElementById('betaGameProgressContent');
            const guessProgress = document.getElementById('betaGuessProgressContent');
            if (inputProgress) inputProgress.innerHTML = html;
            if (guessProgress) guessProgress.innerHTML = html;
        }
        
        // ========================================
        // ========================================
        // みんなであそぶ（multi）用 JavaScript
        // ========================================
        // ========================================
        
        let multiCurrentRoom = null;       // { roomId, role, data }
        let multiRoomRef = null;
        let multiSelectedThemeMode = 'app';
        let multiGameInputSortable = null;
        let multiGuessSortable = null;
        let multiGuessTargets = [];        // 予想対象のプレイヤーID一覧
        let multiCurrentGuessIndex = 0;    // 現在の予想対象インデックス
        let multiGuessData = {};           // { targetId: { "1": "...", ... }, ... }
        
        // ========================================
        // multi：画面遷移・部屋管理
        // ========================================
        
        function showMultiRoleSelect() {
            if (!userProfile) { alert('❌ ユーザー情報が読み込まれていません。'); return; }
            showScreen('multiRoleSelectScreen');
        }
        
        function multiGenerateRoomId() {
            return String(Math.floor(Math.random() * 90000) + 10000);
        }
        
        async function multiCreateRoom() {
            if (!userProfile || !database) { alert('❌ ユーザー情報が読み込まれていません。'); return; }
            try {
                const roomsRef = database.ref('gameRooms');
                let roomId = multiGenerateRoomId();
                let retries = 0;
                while (retries < 10) {
                    const snap = await roomsRef.child(roomId).once('value');
                    if (!snap.exists()) break;
                    roomId = multiGenerateRoomId();
                    retries++;
                }
                if (retries >= 10) { alert('❌ 部屋番号の生成に失敗しました。'); return; }
                
                const roomData = {
                    roomId: roomId, hostId: userProfile.userId, hostName: userProfile.displayName,
                    maxPlayers: 8, gameMode: 'multi', status: 'waiting',
                    theme: null, themeMode: null, players: {},
                    createdAt: new Date().toISOString(), lastActivityAt: Date.now()
                };
                roomData.players[userProfile.userId] = { displayName: userProfile.displayName, status: 'waiting' };
                await roomsRef.child(roomId).set(roomData);
                
                multiCurrentRoom = { roomId, role: 'host', data: roomData };
                document.getElementById('multiCloseRoomButton').style.display = 'block';
                document.getElementById('multiDummyArea').style.display = 'block';
                document.getElementById('multiRoomNumber').textContent = roomId;
                showScreen('multiWaitingRoomScreen');
                multiStartRoomListener(roomId);
            } catch (error) {
                console.error('❌ multi部屋作成エラー:', error);
                alert('❌ 部屋の作成に失敗しました。');
            }
        }
        
        function multiCopyRoomNumber() {
            if (!multiCurrentRoom) return;
            const roomId = multiCurrentRoom.roomId;
            navigator.clipboard.writeText(roomId)
                .then(() => { alert('📋 部屋番号「' + roomId + '」をコピーしました！'); })
                .catch(() => { alert('部屋番号: ' + roomId); });
        }
        
        function multiShowJoinRoom() {
            document.getElementById('multiRoomNumberInput').value = '';
            showScreen('multiJoinRoomScreen');
        }
        
        async function multiJoinRoom() {
            if (!userProfile || !database) { alert('❌ ユーザー情報が読み込まれていません。'); return; }
            const input = document.getElementById('multiRoomNumberInput');
            const roomId = input.value.trim();
            if (!roomId || roomId.length !== 5 || !/^\d+$/.test(roomId)) {
                alert('❌ 5桁の部屋番号を入力してください。'); input.focus(); return;
            }
            
            const joinBtn = document.getElementById('multiJoinRoomButton');
            try {
                joinBtn.disabled = true; joinBtn.textContent = '⏳ 接続中...';
                const roomRef = database.ref('gameRooms/' + roomId);
                const snap = await roomRef.once('value');
                if (!snap.exists()) { alert('❌ 部屋番号「' + roomId + '」は見つかりませんでした。'); joinBtn.disabled = false; joinBtn.textContent = '✨ 参加する'; return; }
                
                const roomData = snap.val();
                if (roomData.hostId === userProfile.userId) { alert('❌ 自分が作成した部屋には参加できません。'); joinBtn.disabled = false; joinBtn.textContent = '✨ 参加する'; return; }
                
                const alreadyJoined = roomData.players && roomData.players[userProfile.userId];
                const playerCount = roomData.players ? Object.keys(roomData.players).length : 0;
                if (!alreadyJoined && playerCount >= roomData.maxPlayers) { alert('❌ この部屋は満員です。'); joinBtn.disabled = false; joinBtn.textContent = '✨ 参加する'; return; }
                
                if (!alreadyJoined) {
                    await roomRef.update({ ['players/' + userProfile.userId]: { displayName: userProfile.displayName, status: 'waiting' }, lastActivityAt: Date.now() });
                }
                
                multiCurrentRoom = { roomId, role: 'guest', data: roomData };
                document.getElementById('multiCloseRoomButton').style.display = 'none';
                joinBtn.disabled = false; joinBtn.textContent = '✨ 参加する';
                document.getElementById('multiRoomNumber').textContent = roomId;
                showScreen('multiWaitingRoomScreen');
                multiStartRoomListener(roomId);
            } catch (error) {
                console.error('❌ multi参加エラー:', error);
                alert('❌ 参加に失敗しました。');
                joinBtn.disabled = false; joinBtn.textContent = '✨ 参加する';
            }
        }
        
        function multiConfirmLeave(msg) {
            if (confirm(msg || 'HOMEに戻りますか？')) { multiCleanup(); showScreen('mainScreen'); }
        }
        
        async function multiCloseRoom() {
            if (!confirm('部屋を閉じますか？\n全員が退出され、部屋番号は無効になります。')) return;
            try {
                if (multiCurrentRoom && database) await database.ref('gameRooms/' + multiCurrentRoom.roomId).remove();
                multiCleanup(); showScreen('mainScreen');
            } catch (error) { multiCleanup(); showScreen('mainScreen'); }
        }
        
        function multiCleanup() {
            if (multiRoomRef) { multiRoomRef.off(); multiRoomRef = null; }
            if (multiGameInputSortable) { multiGameInputSortable.destroy(); multiGameInputSortable = null; }
            if (multiGuessSortable) { multiGuessSortable.destroy(); multiGuessSortable = null; }
            multiCurrentRoom = null; multiGuessTargets = []; multiCurrentGuessIndex = 0; multiGuessData = {};
        }
        
        // ========================================
        // multi：リアルタイム監視（状態遷移エンジン）
        // ========================================
        
        function multiStartRoomListener(roomId) {
            if (multiRoomRef) { multiRoomRef.off(); multiRoomRef = null; }
            multiRoomRef = database.ref('gameRooms/' + roomId);
            
            multiRoomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    multiCleanup();
                    alert('部屋が閉じられました。HOMEに戻ります。');
                    showScreen('mainScreen'); return;
                }
                const roomData = snapshot.val();
                const role = multiCurrentRoom ? multiCurrentRoom.role : (roomData.hostId === userProfile.userId ? 'host' : 'guest');
                multiCurrentRoom = { roomId, role, data: roomData };
                
                const active = document.querySelector('.screen.active');
                const activeId = active ? active.id : '';
                
                // 締め切りでプレイヤーリストから除外された場合
                const myPlayers = roomData.players || {};
                if (roomData.status !== 'waiting' && !myPlayers[userProfile.userId]) {
                    alert('回答の締め切りに間に合わなかったため、ゲームから退出しました。\n\n次のゲーム開始まで待機室でお待ちください。');
                    // プレイヤーとして再追加して待機状態に
                    database.ref('gameRooms/' + multiCurrentRoom.roomId + '/players/' + userProfile.userId).set({
                        displayName: userProfile.displayName || 'ゲスト', joinedAt: Date.now(), status: 'waiting'
                    });
                    document.getElementById('multiRoomNumber').textContent = roomId;
                    showScreen('multiWaitingRoomScreen');
                    return;
                }
                
                switch (roomData.status) {
                    case 'waiting':
                        multiUpdatePlayersDisplay(roomData);
                        if (role === 'host') {
                            const pCount = Object.keys(roomData.players || {}).length;
                            const startBtn = document.getElementById('multiStartGameButton');
                            startBtn.style.display = 'block';
                            if (pCount >= 3) {
                                startBtn.disabled = false;
                                startBtn.style.background = 'linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%)';
                                startBtn.style.cursor = 'pointer';
                                startBtn.style.boxShadow = '0 4px 15px rgba(108,92,231,0.3)';
                            } else {
                                startBtn.disabled = true;
                                startBtn.style.background = '#ccc';
                                startBtn.style.cursor = 'not-allowed';
                                startBtn.style.boxShadow = 'none';
                            }
                        }
                        // 結果画面や他の画面から戻ってきた場合は待機室を表示
                        if (activeId !== 'multiWaitingRoomScreen' && activeId !== 'multiRoleSelectScreen' && activeId !== 'multiJoinRoomScreen') {
                            document.getElementById('multiRoomNumber').textContent = roomId;
                            showScreen('multiWaitingRoomScreen');
                        }
                        break;
                    case 'setting':
                        if (role === 'host') {
                            if (activeId !== 'multiGameSettingsScreen') multiShowGameSettings();
                        } else {
                            if (activeId !== 'multiGuestWaitingScreen') showScreen('multiGuestWaitingScreen');
                        }
                        break;
                    case 'inputting':
                        if (activeId !== 'multiGameInputScreen') multiShowGameInput(roomData);
                        else multiUpdateInputProgress(roomData);
                        // ホスト：自分が送信済みなら送信ボタンを締め切りボタンに入れ替え
                        if (role === 'host' && roomData.rankings && roomData.rankings[userProfile.userId]) {
                            document.getElementById('multiSubmitRankingButton').style.display = 'none';
                            document.getElementById('multiCutoffInputButton').style.display = 'block';
                        }
                        break;
                    case 'guessing':
                        if (activeId !== 'multiGuessScreen') multiShowGuessScreen(roomData);
                        else multiUpdateGuessProgress(roomData);
                        // ホスト：自分が送信済みなら送信ボタンを締め切りボタンに入れ替え
                        if (role === 'host' && roomData.guesses && roomData.guesses[userProfile.userId]) {
                            document.getElementById('multiSubmitAllGuessButton').style.display = 'none';
                            document.getElementById('multiCutoffGuessButton').style.display = 'block';
                        }
                        break;
                    case 'finished':
                        if (activeId !== 'multiResultScreen') multiShowResultScreen(roomData);
                        break;
                }
            });
        }
        
        function multiUpdatePlayersDisplay(roomData) {
            const area = document.getElementById('multiRoomPlayersArea');
            if (!area) return;
            const players = roomData.players || {};
            const list = Object.values(players);
            const count = list.length;
            
            let html = '<p style="color: #6C5CE7; font-size: 16px; font-weight: bold; margin-bottom: 10px;">' + count + ' 人参加中</p>';
            list.forEach(p => { html += '<p style="color: #333; font-size: 14px; margin-bottom: 4px;">👤 ' + p.displayName + '</p>'; });
            if (count < 3) html += '<p style="color: #999; font-size: 13px; margin-top: 10px;">⏳ メンバーの参加を待っています...（3人以上で開始できます）</p>';
            else html += '<p style="color: #6C5CE7; font-size: 13px; margin-top: 10px;">✅ ゲーム開始可能です！</p>';
            area.innerHTML = html;
        }
        
        // ========================================
        // multi：ゲーム設定→開始
        // ========================================
        
        function multiGoToSettings() {
            if (!multiCurrentRoom || multiCurrentRoom.role !== 'host') return;
            const players = Object.keys(multiCurrentRoom.data.players || {});
            if (players.length < 3) return;
            database.ref('gameRooms/' + multiCurrentRoom.roomId).update({ status: 'setting', lastActivityAt: Date.now() });
        }
        
        function multiShowGameSettings() {
            multiSelectThemeMode('app');
            multiRandomizeTheme();
            const ci = document.getElementById('multiCustomThemeInput');
            ci.value = ''; document.getElementById('multiCustomThemeCount').textContent = '0';
            ci.oninput = function() { document.getElementById('multiCustomThemeCount').textContent = this.value.length; };
            showScreen('multiGameSettingsScreen');
        }
        
        function multiSelectThemeMode(mode) {
            multiSelectedThemeMode = mode;
            const appBtn = document.getElementById('multiThemeModeApp');
            const cusBtn = document.getElementById('multiThemeModeCustom');
            const appArea = document.getElementById('multiAppThemeArea');
            const cusArea = document.getElementById('multiCustomThemeArea');
            if (mode === 'app') {
                appBtn.style.background = '#4A90E2'; appBtn.style.color = 'white'; appBtn.style.borderColor = '#4A90E2';
                cusBtn.style.background = 'white'; cusBtn.style.color = '#333'; cusBtn.style.borderColor = '#ddd';
                appArea.style.display = 'block'; cusArea.style.display = 'none';
            } else {
                cusBtn.style.background = '#4A90E2'; cusBtn.style.color = 'white'; cusBtn.style.borderColor = '#4A90E2';
                appBtn.style.background = 'white'; appBtn.style.color = '#333'; appBtn.style.borderColor = '#ddd';
                appArea.style.display = 'none'; cusArea.style.display = 'block';
                setTimeout(() => { document.getElementById('multiCustomThemeInput').focus(); }, 100);
            }
        }
        
        function multiRandomizeTheme() {
            document.getElementById('multiThemeText').textContent = THEMES[Math.floor(Math.random() * THEMES.length)];
            document.getElementById('multiThemeListDropdown').style.display = 'none';
            document.getElementById('multiThemeArrow').textContent = '▼';
        }
        
        function multiToggleThemeList() {
            const dd = document.getElementById('multiThemeListDropdown');
            const arrow = document.getElementById('multiThemeArrow');
            if (dd.style.display === 'none') {
                let html = '';
                THEMES.forEach(t => {
                    html += '<div onclick="multiSelectThemeItem(\'' + t.replace(/'/g, "\\'") + '\')" style="padding:12px 15px; cursor:pointer; border-bottom:1px solid #eee; font-size:14px; color:#333;" onmouseover="this.style.background=\'#F0F8FF\'" onmouseout="this.style.background=\'white\'">' + t + '</div>';
                });
                dd.innerHTML = html; dd.style.display = 'block'; arrow.textContent = '▲';
            } else { dd.style.display = 'none'; arrow.textContent = '▼'; }
        }
        
        function multiSelectThemeItem(theme) {
            document.getElementById('multiThemeText').textContent = theme;
            document.getElementById('multiThemeListDropdown').style.display = 'none';
            document.getElementById('multiThemeArrow').textContent = '▼';
        }
        
        async function multiStartGame() {
            if (!multiCurrentRoom || multiCurrentRoom.role !== 'host') return;
            let theme = '', themeMode = multiSelectedThemeMode;
            if (themeMode === 'app') { theme = document.getElementById('multiThemeText').textContent; }
            else { theme = document.getElementById('multiCustomThemeInput').value.trim(); if (!theme || theme.length < 3) { alert('❌ テーマを3文字以上で入力してください。'); return; } }
            
            try {
                await database.ref('gameRooms/' + multiCurrentRoom.roomId).update({
                    status: 'inputting', theme, themeMode, rankings: null, guesses: null, results: null, lastActivityAt: Date.now()
                });
            } catch (error) { alert('❌ ゲームの開始に失敗しました。'); }
        }
        
        // ========================================
        // multi：ランキング入力
        // ========================================
        
        function multiShowGameInput(roomData) {
            document.getElementById('multiGameTheme').textContent = roomData.theme;
            multiUpdateInputProgress(roomData);
            
            const container = document.getElementById('multiGameRankingForm');
            const items = Array.from(container.children);
            items.sort((a, b) => (parseInt(a.getAttribute('data-rank')) || 0) - (parseInt(b.getAttribute('data-rank')) || 0));
            items.forEach(item => container.appendChild(item));
            
            Array.from(container.children).forEach((item, i) => {
                const input = item.querySelector('.rank-input');
                if (input) { input.value = ''; input.disabled = false; input.style.background = ''; input.style.color = ''; }
                const label = item.querySelector('.rank-label');
                if (label) label.textContent = (i + 1) + '位';
                const handle = item.querySelector('.drag-handle');
                if (handle) handle.style.display = '';
                item.setAttribute('data-rank', i + 1);
            });
            
            const btn = document.getElementById('multiSubmitRankingButton');
            btn.textContent = '💾 ランキングを送信'; btn.disabled = false; btn.style.background = ''; btn.style.opacity = ''; btn.style.display = '';
            document.getElementById('multiCutoffInputButton').style.display = 'none';
            
            showScreen('multiGameInputScreen');
            
            if (multiGameInputSortable) { multiGameInputSortable.destroy(); multiGameInputSortable = null; }
            multiGameInputSortable = new Sortable(container, {
                animation: 150, delay: 50, delayOnTouchOnly: true, forceFallback: true, fallbackOnBody: true, swapThreshold: 0.65,
                handle: '.drag-handle', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', dragClass: 'sortable-drag', fallbackClass: 'sortable-fallback',
                onEnd: function() {
                    Array.from(container.children).forEach((item, i) => {
                        const l = item.querySelector('.rank-label'); if (l) l.textContent = (i + 1) + '位';
                        const inp = item.querySelector('.rank-input'); if (inp) inp.placeholder = (i + 1) + '位を入力（50文字まで）';
                        item.setAttribute('data-rank', i + 1);
                    });
                }
            });
            
            if (roomData.rankings && roomData.rankings[userProfile.userId]) {
                const my = roomData.rankings[userProfile.userId];
                Array.from(container.children).forEach((item, i) => {
                    const inp = item.querySelector('.rank-input');
                    if (inp) { inp.value = my[(i + 1).toString()] || ''; inp.disabled = true; inp.style.background = '#f0f0f0'; inp.style.color = '#999'; }
                    const h = item.querySelector('.drag-handle'); if (h) h.style.display = 'none';
                });
                if (multiGameInputSortable) multiGameInputSortable.option('disabled', true);
                btn.textContent = '⏳ 他のメンバーの回答待ち...'; btn.disabled = true; btn.style.background = '#999'; btn.style.opacity = '0.6';
            }
            
            setTimeout(() => { const f = container.children[0]?.querySelector('.rank-input'); if (f && !f.disabled) f.focus(); }, 100);
        }
        
        function multiUpdateInputProgress(roomData) {
            const players = roomData.players || {};
            let html = '';
            Object.keys(players).forEach(id => {
                const name = id === userProfile.userId ? 'あなた' : players[id].displayName;
                const done = roomData.rankings && roomData.rankings[id];
                html += '<div style="display:flex; justify-content:space-between; align-items:center; margin:6px 0;">';
                html += '<span style="color:#666; font-size:13px;">' + (done ? '✅' : '⏳') + ' ' + name + '</span>';
                html += '<span style="color:' + (done ? '#50C878' : '#FF9800') + '; font-size:12px; font-weight:bold;">' + (done ? '入力完了' : '入力中...') + '</span>';
                html += '</div>';
            });
            const el = document.getElementById('multiInputProgressContent');
            if (el) el.innerHTML = html;
        }
        
        async function multiSubmitRanking() {
            if (!multiCurrentRoom) return;
            const container = document.getElementById('multiGameRankingForm');
            const rankingData = {};
            for (let i = 0; i < container.children.length; i++) {
                const inp = container.children[i].querySelector('.rank-input');
                const val = inp ? inp.value.trim() : '';
                if (!val) { alert((i + 1) + '位を入力してください！'); if (inp) inp.focus(); return; }
                rankingData[(i + 1).toString()] = val;
            }
            try {
                const ref = database.ref('gameRooms/' + multiCurrentRoom.roomId);
                await ref.update({ ['rankings/' + userProfile.userId]: rankingData, ['players/' + userProfile.userId + '/status']: 'completed', lastActivityAt: Date.now() });
                
                const btn = document.getElementById('multiSubmitRankingButton');
                btn.textContent = '⏳ 他のメンバーの回答待ち...'; btn.disabled = true; btn.style.background = '#999'; btn.style.opacity = '0.6';
                Array.from(container.children).forEach(item => {
                    const inp = item.querySelector('.rank-input'); if (inp) { inp.disabled = true; inp.style.background = '#f0f0f0'; inp.style.color = '#999'; }
                    const h = item.querySelector('.drag-handle'); if (h) h.style.display = 'none';
                });
                if (multiGameInputSortable) multiGameInputSortable.option('disabled', true);
                
                // 全員完了チェック
                const snap = await ref.once('value');
                const d = snap.val();
                const allPlayers = Object.keys(d.players || {});
                if (allPlayers.every(id => d.rankings && d.rankings[id])) {
                    await ref.update({ status: 'guessing', lastActivityAt: Date.now() });
                }
            } catch (error) { alert('❌ 送信エラー:\n' + error.message); }
        }
        
        // ホスト用：回答を締め切る（入力フェーズ）
        async function multiCutoffInput() {
            if (!confirm('現時点での回答情報のみでゲームを進めますが、よろしいですか？\n（最後まで参加できなかったゲストの情報は反映されません。）')) return;
            try {
                const ref = database.ref('gameRooms/' + multiCurrentRoom.roomId);
                const snap = await ref.once('value');
                const d = snap.val();
                // ランキング未提出のプレイヤーを削除
                const allPlayers = Object.keys(d.players || {});
                const updates = { status: 'guessing', lastActivityAt: Date.now() };
                allPlayers.forEach(id => {
                    if (!d.rankings || !d.rankings[id]) {
                        updates['players/' + id] = null;
                    }
                });
                await ref.update(updates);
            } catch (error) { alert('❌ 締め切りエラー'); }
        }
        
        // ========================================
        // multi：予想フェーズ（N-1人分を順番に）
        // ========================================
        
        function multiShowGuessScreen(roomData) {
            document.getElementById('multiGuessTheme').textContent = roomData.theme;
            document.getElementById('multiCutoffGuessButton').style.display = 'none';
            const submitGuessBtn = document.getElementById('multiSubmitAllGuessButton');
            submitGuessBtn.style.display = 'block';
            submitGuessBtn.textContent = '📤 全員分の予想を送信';
            submitGuessBtn.disabled = false;
            submitGuessBtn.style.background = 'linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%)';
            submitGuessBtn.style.opacity = '1';
            submitGuessBtn.style.boxShadow = '0 4px 15px rgba(108,92,231,0.3)';
            
            // 予想対象リスト（自分以外の全員）
            const allPlayers = Object.keys(roomData.players || {});
            multiGuessTargets = allPlayers.filter(id => id !== userProfile.userId);
            multiCurrentGuessIndex = 0;
            multiGuessData = {};
            
            // 既に送信済みの予想があれば復元
            if (roomData.guesses && roomData.guesses[userProfile.userId]) {
                multiGuessData = roomData.guesses[userProfile.userId];
            }
            
            // タブを生成
            multiBuildGuessTabs(roomData);
            multiUpdateGuessProgress(roomData);
            
            showScreen('multiGuessScreen');
            
            // 最初の未完了ターゲットを表示
            multiShowGuessForTarget(roomData);
        }
        
        function multiBuildGuessTabs(roomData) {
            const tabArea = document.getElementById('multiGuessTabArea');
            let html = '';
            multiGuessTargets.forEach((targetId, i) => {
                const name = roomData.players[targetId]?.displayName || '---';
                const isDone = multiGuessData[targetId] != null;
                const isActive = i === multiCurrentGuessIndex;
                const bg = isActive ? '#6C5CE7' : (isDone ? '#E8E5FF' : '#f0f0f0');
                const color = isActive ? 'white' : (isDone ? '#6C5CE7' : '#555');
                const border = isActive ? '#6C5CE7' : 'transparent';
                html += '<button onclick="multiSwitchGuessTarget(' + i + ')" style="flex-shrink:0; width:auto; margin:0; padding:8px 16px; border-radius:8px; font-size:13px; font-weight:' + (isActive ? 'bold' : 'normal') + '; border:2px solid ' + border + '; background:' + bg + '; color:' + color + '; cursor:pointer; white-space:nowrap;">';
                html += (isDone ? '✅ ' : '') + name;
                html += '</button>';
            });
            tabArea.innerHTML = html;
        }
        
        function multiSwitchGuessTarget(index) {
            if (!multiCurrentRoom) return;
            // 現在のソート状態を保存（未送信の場合）
            multiSaveCurrentGuessState();
            multiCurrentGuessIndex = index;
            multiShowGuessForTarget(multiCurrentRoom.data);
        }
        
        function multiSaveCurrentGuessState() {
            // 現在の予想UIから並び順を取得して一時保存
            const container = document.getElementById('multiGuessRankingArea');
            if (!container || container.children.length === 0) return;
            const targetId = multiGuessTargets[multiCurrentGuessIndex];
            if (!targetId) return;
            
            // 既にFirebaseに送信済みなら上書きしない
            if (multiGuessData[targetId] && multiCurrentRoom.data.guesses && multiCurrentRoom.data.guesses[userProfile.userId] && multiCurrentRoom.data.guesses[userProfile.userId][targetId]) return;
            
            const items = Array.from(container.children).map(el => el.getAttribute('data-item'));
            if (items.length === 5) {
                const temp = {};
                items.forEach((item, i) => { temp[(i + 1).toString()] = item; });
                multiGuessData[targetId] = temp;
            }
        }
        
        function multiShowGuessForTarget(roomData) {
            const targetId = multiGuessTargets[multiCurrentGuessIndex];
            if (!targetId) return;
            
            // タブのアクティブ状態を更新
            multiBuildGuessTabs(roomData);
            
            // 相手のランキング項目を取得
            const targetRanking = roomData.rankings[targetId];
            if (!targetRanking) { document.getElementById('multiGuessRankingArea').innerHTML = '<p style="color:#999; text-align:center;">この方のランキングはありません。</p>'; return; }
            
            let items = [];
            for (let i = 1; i <= 5; i++) items.push(targetRanking[i.toString()]);
            
            // 既に一時保存されている並び順があれば復元、なければシャッフル
            if (multiGuessData[targetId]) {
                const saved = multiGuessData[targetId];
                items = [];
                for (let i = 1; i <= 5; i++) items.push(saved[i.toString()]);
            } else {
                for (let i = items.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [items[i], items[j]] = [items[j], items[i]];
                }
            }
            
            // UI生成
            const container = document.getElementById('multiGuessRankingArea');
            container.innerHTML = '';
            if (multiGuessSortable) { multiGuessSortable.destroy(); multiGuessSortable = null; }
            
            const alreadySubmitted = multiCurrentRoom.data.guesses && multiCurrentRoom.data.guesses[userProfile.userId] && multiCurrentRoom.data.guesses[userProfile.userId][targetId];
            
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'draggable-item'; div.setAttribute('data-item', item);
                div.style.cssText = '-webkit-user-select:none; user-select:none;';
                const rank = document.createElement('span'); rank.className = 'rank-number'; rank.textContent = (index + 1) + '位';
                const text = document.createElement('span'); text.textContent = item; text.style.cssText = 'color:#333; font-size:15px; flex:1; padding:0 10px;';
                const handle = document.createElement('span'); handle.className = 'drag-handle'; handle.textContent = '≡';
                div.appendChild(rank); div.appendChild(text); div.appendChild(handle);
                container.appendChild(div);
            });
            
            multiGuessSortable = new Sortable(container, {
                animation: 150, delay: 50, delayOnTouchOnly: true, forceFallback: true, fallbackOnBody: true, swapThreshold: 0.65,
                handle: '.drag-handle', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', dragClass: 'sortable-drag', fallbackClass: 'sortable-fallback',
                onChange: function() { multiUpdateGuessRankNums(); },
                onEnd: function() { multiUpdateGuessRankNums(); }
            });
            
            if (alreadySubmitted) {
                setTimeout(() => {
                    if (multiGuessSortable) multiGuessSortable.option('disabled', true);
                    Array.from(container.children).forEach(item => { item.style.opacity = '0.6'; const h = item.querySelector('.drag-handle'); if (h) h.style.display = 'none'; });
                }, 100);
            }
        }
        
        function multiUpdateGuessRankNums() {
            const container = document.getElementById('multiGuessRankingArea');
            if (!container) return;
            Array.from(container.children).forEach((item, i) => {
                const r = item.querySelector('.rank-number'); if (r) r.textContent = (i + 1) + '位';
            });
        }
        
        function multiUpdateGuessProgress(roomData) {
            const players = roomData.players || {};
            let html = '';
            Object.keys(players).forEach(id => {
                const name = id === userProfile.userId ? 'あなた' : players[id].displayName;
                const done = roomData.guesses && roomData.guesses[id];
                html += '<div style="display:flex; justify-content:space-between; align-items:center; margin:6px 0;">';
                html += '<span style="color:#666; font-size:13px;">' + (done ? '✅' : '🤔') + ' ' + name + '</span>';
                html += '<span style="color:' + (done ? '#50C878' : '#FF9800') + '; font-size:12px; font-weight:bold;">' + (done ? '予想完了' : '予想中...') + '</span>';
                html += '</div>';
            });
            const el = document.getElementById('multiGuessProgressContent');
            if (el) el.innerHTML = html;
        }
        
        // NEXT/SENDボタン
        async function multiSubmitCurrentGuess() {
            if (!multiCurrentRoom) return;
            
            // 現在の並び順を保存
            multiSaveCurrentGuessState();
            
            // 全員分の予想が揃っているかチェック
            const allTargetsDone = multiGuessTargets.every(tid => multiGuessData[tid] != null);
            
            if (!allTargetsDone) {
                // 未完了のターゲットを特定してアラート
                const missing = multiGuessTargets.filter(tid => !multiGuessData[tid]).map(tid => multiCurrentRoom.data.players[tid]?.displayName || '---');
                alert('まだ全員分の予想が完了していません。\n\n未完了: ' + missing.join('、'));
                return;
            }
            
            // 全員分揃ったので送信確認
            let confirmMsg = '全員分の予想を送信しますか？\n\n';
            multiGuessTargets.forEach(tid => {
                const name = multiCurrentRoom.data.players[tid]?.displayName || '---';
                const g = multiGuessData[tid];
                confirmMsg += '【' + name + 'さん】\n';
                for (let r = 1; r <= 5; r++) confirmMsg += '  ' + r + '位: ' + (g[r.toString()] || '---') + '\n';
                confirmMsg += '\n';
            });
            
            if (!confirm(confirmMsg)) return;
            
            // Firebase送信
            try {
                const ref = database.ref('gameRooms/' + multiCurrentRoom.roomId);
                const updates = { ['guesses/' + userProfile.userId]: multiGuessData, ['players/' + userProfile.userId + '/status']: 'guessed', lastActivityAt: Date.now() };
                await ref.update(updates);
                
                // UIをロック
                const submitBtn = document.getElementById('multiSubmitAllGuessButton');
                submitBtn.textContent = '⏳ 他のメンバーの予想待ち...';
                submitBtn.disabled = true;
                submitBtn.style.background = '#999';
                submitBtn.style.opacity = '0.6';
                submitBtn.style.boxShadow = 'none';
                
                if (multiGuessSortable) multiGuessSortable.option('disabled', true);
                const container = document.getElementById('multiGuessRankingArea');
                Array.from(container.children).forEach(item => { item.style.opacity = '0.6'; const h = item.querySelector('.drag-handle'); if (h) h.style.display = 'none'; });
                
                // 全員完了チェック
                const snap = await ref.once('value');
                const d = snap.val();
                const allPlayers = Object.keys(d.players || {});
                if (allPlayers.every(id => d.guesses && d.guesses[id])) {
                    const results = multiCalculateScores(d);
                    await ref.update({ status: 'finished', results, finishedAt: new Date().toISOString(), lastActivityAt: Date.now() });
                }
            } catch (error) { alert('❌ 送信エラー:\n' + error.message); }
        }
        
        // ホスト用：予想を締め切る
        async function multiCutoffGuess() {
            if (!confirm('現時点での回答情報のみでゲームを進めますが、よろしいですか？\n（最後まで参加できなかったゲストの情報は反映されません。）')) return;
            try {
                const ref = database.ref('gameRooms/' + multiCurrentRoom.roomId);
                const snap = await ref.once('value');
                const d = snap.val();
                const allPlayers = Object.keys(d.players || {});
                // 予想未提出のプレイヤーを除外
                const updates = { lastActivityAt: Date.now() };
                allPlayers.forEach(id => { if (!d.guesses || !d.guesses[id]) updates['players/' + id] = null; });
                // スコア計算（残ったプレイヤーのみ）
                const updatedSnap = await ref.update(updates).then(() => ref.once('value'));
                const ud = (await ref.once('value')).val();
                const results = multiCalculateScores(ud);
                await ref.update({ status: 'finished', results, finishedAt: new Date().toISOString(), lastActivityAt: Date.now() });
            } catch (error) { alert('❌ 締め切りエラー'); }
        }
        
        // ========================================
        // multi：スコア計算
        // ========================================
        
        function multiCalculateScores(roomData) {
            const rankings = roomData.rankings || {};
            const guesses = roomData.guesses || {};
            const players = Object.keys(roomData.players || {});
            const results = { players: {}, pairs: {} };
            
            players.forEach(playerId => {
                let totalScore = 0, totalPerfect = 0, totalClose = 0;
                const targets = players.filter(id => id !== playerId);
                
                targets.forEach(targetId => {
                    const correctRanking = rankings[targetId];
                    const myGuess = guesses[playerId] ? guesses[playerId][targetId] : null;
                    
                    let score = 0, perfectCount = 0, closeCount = 0;
                    
                    if (correctRanking && myGuess) {
                        for (let gRank = 1; gRank <= 5; gRank++) {
                            const guessedItem = myGuess[gRank.toString()];
                            let cRank = 0;
                            for (let r = 1; r <= 5; r++) { if (correctRanking[r.toString()] === guessedItem) { cRank = r; break; } }
                            if (cRank > 0) {
                                const diff = Math.abs(gRank - cRank);
                                if (diff === 0) { score += 2; perfectCount++; }
                                else if (diff === 1) { score += 1; closeCount++; }
                            }
                        }
                    }
                    
                    totalScore += score; totalPerfect += perfectCount; totalClose += closeCount;
                    
                    // ペア結果を保存
                    const pairKey = playerId + '_' + targetId;
                    results.pairs[pairKey] = { guesserId: playerId, targetId: targetId, score, perfectCount, closeCount };
                });
                
                results.players[playerId] = { totalScore, totalPerfect, totalClose, targetCount: targets.length };
            });
            
            return results;
        }
        
        // ========================================
        // multi：結果画面
        // ========================================
        
        function multiShowResultScreen(roomData) {
            const results = roomData.results || {};
            const players = Object.keys(roomData.players || {});
            
            // === 理解力ランキング（常時表示） ===
            const sorted = players.map(id => ({
                id, name: roomData.players[id]?.displayName || '---',
                ...(results.players[id] || { totalScore: 0, totalPerfect: 0, totalClose: 0, targetCount: 0 })
            })).sort((a, b) => b.totalScore - a.totalScore);
            
            const maxPossible = sorted[0]?.targetCount ? sorted[0].targetCount * 10 : 10;
            const avgScore = sorted.length > 0 ? (sorted.reduce((s, p) => s + p.totalScore, 0) / sorted.length) : 0;
            
            let rankHtml = '<div style="background:#f0edff; border-radius:12px; padding:20px;">';
            rankHtml += '<h3 style="color:#6C5CE7; font-size:16px; margin-bottom:15px; text-align:center;">🏆 みんなの理解力ランキング</h3>';
            sorted.forEach((p, i) => {
                const medal = i === 0 ? '🥇' : (i === 1 ? '🥈' : (i === 2 ? '🥉' : (i + 1) + '位'));
                const isMe = p.id === userProfile.userId;
                rankHtml += '<div style="display:flex; align-items:center; padding:12px; background:' + (isMe ? '#FFFDE7' : 'white') + '; border-radius:8px; margin-bottom:6px;' + (isMe ? ' border:2px solid #FFD54F;' : '') + '">';
                rankHtml += '<span style="font-size:20px; margin-right:12px; min-width:32px; text-align:center;">' + medal + '</span>';
                rankHtml += '<span style="flex:1; font-size:14px; color:#333; font-weight:' + (isMe ? 'bold' : 'normal') + ';">' + p.name + (isMe ? '（あなた）' : '') + '</span>';
                rankHtml += '<span style="font-size:18px; font-weight:bold; color:#6C5CE7;">' + p.totalScore + '<span style="font-size:12px; color:#999;">/' + maxPossible + 'pt</span></span>';
                rankHtml += '</div>';
            });
            rankHtml += '<p style="color:#999; font-size:12px; text-align:center; margin-top:12px;">みんなの平均 <span style="color:#6C5CE7; font-size:16px; font-weight:bold;">' + avgScore.toFixed(1) + '</span>/' + maxPossible + 'pt</p>';
            rankHtml += '</div>';
            document.getElementById('multiResultRanking').innerHTML = rankHtml;
            
            // === ひとりずつの予想＆結果タブ ===
            let tabHtml = '';
            players.forEach((targetId, i) => {
                const name = targetId === userProfile.userId ? 'あなた' : (roomData.players[targetId]?.displayName || '---');
                const isFirst = i === 0;
                tabHtml += '<button onclick="multiShowPersonResult(\'' + targetId + '\')" id="multiPersonTab_' + targetId + '" style="';
                tabHtml += 'width:auto; margin:0; padding:8px 16px; border-radius:8px; font-size:13px; cursor:pointer; ';
                tabHtml += 'border:2px solid ' + (isFirst ? '#6C5CE7' : 'transparent') + '; ';
                tabHtml += 'background:' + (isFirst ? '#6C5CE7' : '#f0f0f0') + '; ';
                tabHtml += 'color:' + (isFirst ? 'white' : '#555') + '; ';
                tabHtml += 'font-weight:' + (isFirst ? 'bold' : 'normal') + ';">';
                tabHtml += name + '</button>';
            });
            document.getElementById('multiResultPersonTabs').innerHTML = tabHtml;
            
            // 最初のプレイヤーの結果を表示
            if (players.length > 0) multiShowPersonResult(players[0]);
            
            // 待機室へ戻るボタン
            document.getElementById('multiBackToRoomButton').style.display = (multiCurrentRoom && multiCurrentRoom.role === 'host') ? 'block' : 'none';
            
            showScreen('multiResultScreen');
        }
        
        function multiShowPersonResult(targetId) {
            if (!multiCurrentRoom) return;
            const roomData = multiCurrentRoom.data;
            const results = roomData.results || {};
            const players = Object.keys(roomData.players || {});
            const tName = targetId === userProfile.userId ? 'あなた' : (roomData.players[targetId]?.displayName || '---');
            
            // タブのアクティブ状態を切替
            document.querySelectorAll('#multiResultPersonTabs button').forEach(btn => {
                btn.style.background = '#f0f0f0'; btn.style.color = '#555'; btn.style.borderColor = 'transparent'; btn.style.fontWeight = 'normal';
            });
            const activeBtn = document.getElementById('multiPersonTab_' + targetId);
            if (activeBtn) { activeBtn.style.background = '#6C5CE7'; activeBtn.style.color = 'white'; activeBtn.style.borderColor = '#6C5CE7'; activeBtn.style.fontWeight = 'bold'; }
            
            const correctRanking = roomData.rankings[targetId];
            if (!correctRanking) { document.getElementById('multiResultPersonContent').innerHTML = '<p style="color:#999; text-align:center;">データなし</p>'; return; }
            
            const guessers = players.filter(id => id !== targetId);
            
            let html = '<div style="background:#F5F5F5; border-radius:12px; padding:15px;">';
            html += '<p style="color:#6C5CE7; font-weight:bold; font-size:14px; margin-bottom:12px; text-align:center;">' + tName + 'さんの正解ランキング</p>';
            
            for (let rank = 1; rank <= 5; rank++) {
                const item = correctRanking[rank.toString()];
                html += '<div style="background:white; border-radius:8px; padding:12px; margin-bottom:8px;">';
                html += '<div style="display:flex; align-items:center; margin-bottom:8px;">';
                html += '<span style="background:#6C5CE7; color:white; font-size:12px; font-weight:bold; padding:4px 10px; border-radius:12px; margin-right:10px;">' + rank + '位</span>';
                html += '<span style="color:#333; font-size:14px; font-weight:bold;">' + item + '</span>';
                html += '</div>';
                
                // 各予想者がこの項目を何位に予想したか
                html += '<div style="padding-left:8px;">';
                guessers.forEach(gId => {
                    const gName = gId === userProfile.userId ? 'あなた' : (roomData.players[gId]?.displayName || '---');
                    const guess = roomData.guesses[gId]?.[targetId];
                    let gRank = 0;
                    if (guess) { for (let r = 1; r <= 5; r++) { if (guess[r.toString()] === item) { gRank = r; break; } } }
                    
                    let icon = '×', color = '#999', pt = 0;
                    if (gRank > 0) {
                        const diff = Math.abs(gRank - rank);
                        if (diff === 0) { icon = '○'; color = '#50C878'; pt = 2; }
                        else if (diff === 1) { icon = '△'; color = '#FF9800'; pt = 1; }
                    }
                    
                    html += '<div style="display:flex; align-items:center; font-size:12px; margin:3px 0; color:#666;">';
                    html += '<span style="width:14px; text-align:center; color:' + color + '; font-weight:bold; margin-right:6px;">' + icon + '</span>';
                    html += '<span style="flex:1;">' + gName + '</span>';
                    html += '<span style="color:' + color + '; margin-right:8px;">' + (gRank > 0 ? gRank + '位' : '-') + '</span>';
                    html += '<span style="color:' + color + '; font-weight:bold; min-width:28px; text-align:right;">' + pt + 'pt</span>';
                    html += '</div>';
                });
                html += '</div></div>';
            }
            
            html += '</div>';
            document.getElementById('multiResultPersonContent').innerHTML = html;
        }
        
        // コンパクトな答え合わせテーブル
        function multiBuildCompactTable(correctRanking, guessData) {
            if (!correctRanking || !guessData) return '<p style="color:#999; font-size:12px;">データなし</p>';
            let html = '<div style="font-size:12px;">';
            for (let cRank = 1; cRank <= 5; cRank++) {
                const item = correctRanking[cRank.toString()];
                let gRank = 0;
                for (let r = 1; r <= 5; r++) { if (guessData[r.toString()] === item) { gRank = r; break; } }
                let icon = '×', bg = 'transparent', pt = 0;
                if (gRank > 0) {
                    const diff = Math.abs(gRank - cRank);
                    if (diff === 0) { icon = '○'; bg = '#F0FFF4'; pt = 2; }
                    else if (diff === 1) { icon = '△'; bg = '#FFF8F0'; pt = 1; }
                }
                html += '<div style="display:grid; grid-template-columns:30px 2fr 40px 25px 30px; gap:4px; padding:6px; border-radius:4px; background:' + bg + '; align-items:center;">';
                html += '<div style="text-align:center; color:#666;">' + cRank + '位</div>';
                html += '<div style="color:#333; word-break:break-word;">' + item + '</div>';
                html += '<div style="text-align:center; color:#666;">' + (gRank > 0 ? gRank + '位' : '-') + '</div>';
                html += '<div style="text-align:center;">' + icon + '</div>';
                html += '<div style="text-align:center; color:' + (pt > 0 ? '#50C878' : '#999') + ';">' + pt + 'pt</div>';
                html += '</div>';
            }
            html += '</div>';
            return html;
        }
        
        // ========================================
        // multi：待機室へ戻る
        // ========================================
        
        async function multiBackToRoom() {
            if (!multiCurrentRoom || multiCurrentRoom.role !== 'host') return;
            if (!confirm('待機室へ戻りますか？\nこのゲームの結果は失われます。')) return;
            try {
                const ref = database.ref('gameRooms/' + multiCurrentRoom.roomId);
                await ref.update({
                    status: 'waiting', theme: null, themeMode: null,
                    rankings: null, guesses: null, results: null, finishedAt: null,
                    lastActivityAt: Date.now()
                });
                // プレイヤーのstatusもリセット
                const players = Object.keys(multiCurrentRoom.data.players || {});
                const updates = {};
                players.forEach(id => { updates['players/' + id + '/status'] = 'waiting'; });
                await ref.update(updates);
            } catch (error) { alert('❌ エラーが発生しました。'); }
        }
        
        // ========================================
        // 開発用：ダミープレイヤー
        // ========================================
        
        const DUMMY_NAMES = ['テスト太郎', 'テスト花子', 'テスト次郎', 'テスト美咲', 'テスト翔太', 'テスト葵', 'テスト蓮'];
        let multiDummyCount = 0;
        
        async function multiAddDummyPlayer() {
            if (!multiCurrentRoom || !database) return;
            const roomRef = database.ref('gameRooms/' + multiCurrentRoom.roomId);
            const snap = await roomRef.once('value');
            const data = snap.val();
            const playerCount = Object.keys(data.players || {}).length;
            
            if (playerCount >= data.maxPlayers) { alert('❌ 部屋は満員です。'); return; }
            
            const dummyId = 'dummy_' + Date.now() + '_' + multiDummyCount;
            const name = DUMMY_NAMES[multiDummyCount % DUMMY_NAMES.length];
            multiDummyCount++;
            
            await roomRef.update({
                ['players/' + dummyId]: { displayName: name, status: 'waiting', isDummy: true },
                lastActivityAt: Date.now()
            });
            
            console.log('🤖 ダミープレイヤー追加:', name, dummyId);
            
            // ダミープレイヤーの自動応答リスナーを開始
            multiStartDummyListener(dummyId, roomRef);
        }
        
        function multiStartDummyListener(dummyId, roomRef) {
            const listener = roomRef.on('value', async (snapshot) => {
                if (!snapshot.exists()) { roomRef.off('value', listener); return; }
                const data = snapshot.val();
                
                // ダミーが削除された場合
                if (!data.players || !data.players[dummyId]) { roomRef.off('value', listener); return; }
                
                if (data.status === 'inputting') {
                    // ランキング未送信なら自動送信
                    if (!data.rankings || !data.rankings[dummyId]) {
                        await multiDummySubmitRanking(dummyId, roomRef, data);
                    }
                }
                
                if (data.status === 'guessing') {
                    // 予想未送信なら自動送信
                    if (!data.guesses || !data.guesses[dummyId]) {
                        await multiDummySubmitGuess(dummyId, roomRef, data);
                    }
                }
            });
        }
        
        async function multiDummySubmitRanking(dummyId, roomRef, data) {
            // ランダムなランキングを生成（テーマに合わせた固定リストから）
            const dummyItems = [
                ['ラーメン', 'カレー', '寿司', 'ハンバーグ', '焼肉'],
                ['旅行', '読書', 'ゲーム', '映画', '料理'],
                ['猫', '犬', 'うさぎ', 'ハムスター', '鳥'],
                ['海', '山', '温泉', 'テーマパーク', 'カフェ'],
                ['チョコ', 'アイス', 'ケーキ', 'プリン', 'クッキー']
            ];
            const items = dummyItems[Math.floor(Math.random() * dummyItems.length)];
            // シャッフル
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }
            
            const ranking = {};
            items.forEach((item, i) => { ranking[(i + 1).toString()] = item; });
            
            // 少し遅延してから送信（リアルっぽく）
            setTimeout(async () => {
                try {
                    await roomRef.update({
                        ['rankings/' + dummyId]: ranking,
                        ['players/' + dummyId + '/status']: 'completed',
                        lastActivityAt: Date.now()
                    });
                    console.log('🤖 ダミーランキング送信:', dummyId);
                    
                    // 全員完了チェック
                    const snap = await roomRef.once('value');
                    const d = snap.val();
                    const allPlayers = Object.keys(d.players || {});
                    if (allPlayers.every(id => d.rankings && d.rankings[id])) {
                        await roomRef.update({ status: 'guessing', lastActivityAt: Date.now() });
                    }
                } catch (e) { console.error('🤖 ダミーランキング送信エラー:', e); }
            }, 1500 + Math.random() * 2000);
        }
        
        async function multiDummySubmitGuess(dummyId, roomRef, data) {
            const allPlayers = Object.keys(data.players || {});
            const targets = allPlayers.filter(id => id !== dummyId);
            const guessData = {};
            
            targets.forEach(targetId => {
                const correctRanking = data.rankings[targetId];
                if (!correctRanking) return;
                
                // 正解をシャッフルして予想とする（ランダムな精度）
                const items = [];
                for (let i = 1; i <= 5; i++) items.push(correctRanking[i.toString()]);
                for (let i = items.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [items[i], items[j]] = [items[j], items[i]];
                }
                const guess = {};
                items.forEach((item, i) => { guess[(i + 1).toString()] = item; });
                guessData[targetId] = guess;
            });
            
            setTimeout(async () => {
                try {
                    await roomRef.update({
                        ['guesses/' + dummyId]: guessData,
                        ['players/' + dummyId + '/status']: 'guessed',
                        lastActivityAt: Date.now()
                    });
                    console.log('🤖 ダミー予想送信:', dummyId);
                    
                    // 全員完了チェック
                    const snap = await roomRef.once('value');
                    const d = snap.val();
                    const allPlayers = Object.keys(d.players || {});
                    if (allPlayers.every(id => d.guesses && d.guesses[id])) {
                        const results = multiCalculateScores(d);
                        await roomRef.update({ status: 'finished', results, finishedAt: new Date().toISOString(), lastActivityAt: Date.now() });
                    }
                } catch (e) { console.error('🤖 ダミー予想送信エラー:', e); }
            }, 2000 + Math.random() * 3000);
        }
    </script>
</body>
</html>
