<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãµãŸã‚Šã®ã‚‰ã‚“ãã‚“ã</title>
    
    <!-- LIFFã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã‚€ï¼ˆLINEãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ï¼‰ -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- ========================================
         Firebase SDK ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
         ======================================== -->
    <!-- Firebase App (ã‚³ã‚¢æ©Ÿèƒ½) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- ========================================
         SortableJS ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
         ======================================== -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        /* ========================================
           ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š
           ======================================== */
        
        /* å…¨ä½“ã®ãƒªã‚»ãƒƒãƒˆ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FF 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.15);
        }
        
        h1 {
            color: #4A90E2;
            text-align: center;
            margin-bottom: 10px;
            font-size: 26px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 25px;
            padding: 0 10px;
        }
        
        .theme-box {
            background: linear-gradient(135deg, #F0F8FF 0%, #E8F4F8 100%);
            border: 3px solid #4A90E2;
            border-radius: 15px;
            padding: 20px 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .theme-box h2 {
            color: #4A90E2;
            font-size: 18px;
            margin: 0 0 10px 0;
        }
        
        .theme-text {
            color: #333;
            font-size: 16px;
            font-weight: bold;
            line-height: 1.6;
            word-break: break-all;
        }
        
        .ranking-form {
            margin: 20px 0;
        }
        
        .rank-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            gap: 10px;
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªå›ç­”å…¥åŠ›é …ç›® */
        .ranking-form .draggable-item {
            background: white;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            padding: 10px;
            cursor: default;
            
            /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠç„¡åŠ¹åŒ–ï¼ˆãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠé˜²æ­¢ï¼‰ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ãŸã ã—ã€inputè¦ç´ å†…ã¯æ–‡å­—é¸æŠå¯èƒ½ */
        .ranking-form .draggable-item input {
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ï¼ˆâ‰¡ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */
        .ranking-form .drag-handle {
            font-size: 24px;
            color: #999;
            cursor: grab;
            margin-left: 10px;
            padding: 0 5px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            flex-shrink: 0;
        }
        
        .ranking-form .drag-handle:active {
            cursor: grabbing;
        }
        
        .rank-label {
            background: linear-gradient(135deg, #4A90E2, #7AB8F5);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            font-size: 15px;
            flex-shrink: 0;
        }
        
        .rank-input {
            flex: 1;
            padding: 12px 12px;
            border: 2px solid #B8D9F0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            width: 100%;
            min-width: 0;
        }
        
        .rank-input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:hover {
            background: #3A7BC8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:focus {
            outline: none;
        }
        
        .secondary-button {
            background: #50C878;
        }
        
        .secondary-button:hover {
            background: #3FB869;
        }
        
        .history-list {
            margin: 20px 0;
        }
        
        .history-item {
            background: #f8f9fa;
            border-left: 4px solid #4A90E2;
            border-radius: 8px;
            padding: 15px;
            margin: 12px 0;
        }
        
        .history-theme {
            color: #4A90E2;
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            word-break: break-all;
        }
        
        .history-date {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .history-rankings {
            color: #555;
            font-size: 14px;
            line-height: 1.8;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .error {
            background: #ffe0e0;
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            color: #c92a2a;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .draggable-item {
            background: #f8f9fa;
            border: 2px solid #B8D9F0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            touch-action: pan-y;  /* âœ¨ ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
            transition: all 0.2s ease;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            position: relative;
        }
        
        .draggable-item * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        .draggable-item.dragging {
            opacity: 0.95;
            transform: scale(1.08);
            background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FF 100%);
            border: 2px solid #4A90E2;
            cursor: grabbing;
            box-shadow: 0 12px 30px rgba(74, 144, 226, 0.5);
            z-index: 1000;
        }
        
        .draggable-item.drag-over {
            border-top: 3px solid #FF6B9D;
        }
        
        .rank-number {
            background: linear-gradient(135deg, #4A90E2, #7AB8F5);
            color: white;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 45px;
            text-align: center;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .drag-handle {
            color: #999;
            font-size: 20px;
            padding: 10px 20px;  /* âœ¨ ã‚¿ãƒƒãƒç¯„å›²ã‚’æ‹¡å¤§ï¼ˆä¸Šä¸‹å·¦å³ï¼‰ */
            cursor: grab;
            touch-action: none;  /* âœ¨ ãƒ‰ãƒ©ãƒƒã‚°å„ªå…ˆï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ï¼‰ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .dragging .drag-handle {
            cursor: grabbing;
        }
        
        /* ========================================
           SortableJS ç”¨ã‚¹ã‚¿ã‚¤ãƒ«
           ======================================== */
        
        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚´ãƒ¼ã‚¹ãƒˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ */
        .sortable-ghost {
            opacity: 0.4;
            background: #E8F4F8;
            border: 2px dashed #4A90E2;
        }
        
        /* é¸æŠä¸­ã®è¦ç´ ï¼ˆé•·æŠ¼ã—ä¸­ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ */
        .sortable-chosen {
            cursor: grabbing;
            border: 3px solid #4A90E2 !important;  /* âœ¨ è¼ªéƒ­ã‚’å¤ªãæ¿ƒã */
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4) !important;  /* âœ¨ å½±ã‚’è¿½åŠ  */
            transform: scale(1.02);  /* âœ¨ å°‘ã—æ‹¡å¤§ */
            background: linear-gradient(135deg, #F0F8FF 0%, #E8F4F8 100%) !important;  /* âœ¨ èƒŒæ™¯ã‚’æ˜ã‚‹ã */
            transition: all 0.1s ease;  /* âœ¨ ã‚¹ãƒ ãƒ¼ã‚ºãªå¤‰åŒ– */
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´  */
        .sortable-drag {
            opacity: 1;
            transform: scale(1.05);
            background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FF 100%);
            border: 2px solid #4A90E2;
            box-shadow: 0 12px 30px rgba(74, 144, 226, 0.5);
            cursor: grabbing;
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®è¦ç´ ï¼ˆæŒ‡ã«è¿½å¾“ã™ã‚‹è¦ç´ ï¼‰ */
        .sortable-fallback {
            opacity: 1;
            transform: scale(1.08) rotate(3deg);
            background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FF 100%);
            border: 3px solid #4A90E2;
            box-shadow: 0 15px 40px rgba(74, 144, 226, 0.6);
            cursor: grabbing;
            z-index: 9999;
            transition: none;
        }
        
        /* ä¸¸å‹å›ºå®šãƒœã‚¿ãƒ³ */
        .fixed-round-button {
            position: fixed;
            bottom: 20px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: none;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            padding: 5px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .fixed-round-button:focus {
            outline: none;
        }
        
        .fixed-round-button:active {
            transform: none;
        }
        
        .fixed-round-button-home {
            left: 20px;
            background: #95A5A6 !important;
            color: white;
        }
        
        .fixed-round-button-home:active {
            background: #95A5A6 !important;
        }
        
        .fixed-round-button-home:focus {
            background: #95A5A6 !important;
        }
        
        .fixed-round-button-home:hover {
            background: #95A5A6 !important;
        }
        
        .fixed-round-button-submit {
            right: 20px;
            background: linear-gradient(135deg, #50C878, #3AA65D);
            color: white;
        }
        
        /* ã‚¹ãƒãƒ›æœ€é©åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .theme-box {
                padding: 15px 12px;
            }
            
            .theme-box h2 {
                font-size: 16px;
            }
            
            .theme-text {
                font-size: 15px;
            }
            
            .rank-label {
                min-width: 45px;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .rank-input {
                padding: 10px;
                font-size: 16px;
            }
            
            button {
                padding: 14px 18px;
                font-size: 15px;
            }
        }
        
        /* æ¥µå°ç”»é¢å¯¾å¿œ */
        @media (max-width: 360px) {
            .rank-item {
                gap: 8px;
            }
            
            .rank-label {
                min-width: 40px;
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .rank-input {
                padding: 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ãµãŸã‚Šã®ã‚‰ã‚“ãã‚“ã</h1>
        <p class="subtitle">ç­”ãˆã¯ç›¸æ‰‹ã®å¿ƒã®ä¸­ã«ï¼<br>ã‚„ã‚Œã°ã‚„ã‚‹ã»ã©ä»²ãŒæ·±ã¾ã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ </p>
        
        <!-- èª­ã¿è¾¼ã¿ä¸­ã®è¡¨ç¤º -->
        <div id="loading" class="loading">
            <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        
        <!-- LINEã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error" class="error" style="display: none;">
            <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ã“ã®ã‚¢ãƒ—ãƒªã¯LINEã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚</p>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="mainScreen" class="screen">
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãµãŸã‚Šã§ã‚ãã¶ï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰ -->
            <div style="margin-bottom: 20px;">
                <button id="realtimeGameButton" onclick="tryStartRealtimeGame()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); font-size: 17px; padding: 18px 20px;">
                    ğŸ® ãµãŸã‚Šã§ã‚ãã¶
                </button>
            </div>
            
            <!-- ãƒšã‚¢çŠ¶æ…‹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="pairStatus" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 30px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">ğŸ‘¥ ãƒšã‚¢ã®è¨­å®šçŠ¶æ…‹</p>
                <div id="pairStatusContent">
                    <p style="color: #999; font-size: 14px;">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <!-- ãƒšã‚¢è¨­å®šãƒœã‚¿ãƒ³ã‚’æ å†…ã«é…ç½® -->
                <button id="pairSettingButton" onclick="showPairScreen()" style="background: #9B59B6; margin-top: 10px; font-size: 14px; padding: 10px 15px;">
                    âš™ï¸ ãƒšã‚¢ã‚’è¨­å®šã™ã‚‹
                </button>
            </div>
            
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ -->
            <div style="padding-top: 20px; border-top: 2px dashed #ddd;">
                <button id="devMenuToggleButton" onclick="toggleDevMenu()" style="background: #666; font-size: 13px; padding: 10px;">
                    ğŸ”§ é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼
                </button>
                
                <!-- é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸­èº«ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
                <div id="devMenuContent" style="display: none; margin-top: 10px;">
                    <button onclick="startRanking()" style="background: #666;">
                        ğŸ“ ã²ã¨ã‚Šã§ã‚ãã¶
                    </button>
                    <button onclick="showDevReviewList()" style="background: #FF6B35;">
                        ğŸ§ª ã²ã¨ã‚Šã§ã‚ãã¶ï¼ˆé–‹ç™ºç”¨ï¼‰
                    </button>
                    <button onclick="showHistory()" style="background: #666;">
                        ğŸ“‹ éå»ã®å›ç­”å±¥æ­´ã‚’è¦‹ã‚‹
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ========================================
             ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ï¼ˆæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼‰
             å°†æ¥ã®æ‹¡å¼µï¼šæŠ•ç¥¨ãƒ¢ãƒ¼ãƒ‰ã€æ™‚é–“åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ãªã©
             ======================================== -->
        <div id="themeModeSelectScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ® ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px; line-height: 1.6;">
                ã©ã®ãƒ¢ãƒ¼ãƒ‰ã§ã‚ãã³ã¾ã™ã‹ï¼Ÿ
            </p>
            
            <!-- ãƒ©ãƒ³ãƒ€ãƒ ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰ -->
            <button onclick="selectThemeMode('random')" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                margin-bottom: 15px;
                border: none;
                border-radius: 15px;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ†ãƒ¼ãƒ
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        ãŠã™ã™ã‚ãƒ†ãƒ¼ãƒã‹ã‚‰è‡ªå‹•é¸æŠ
                    </div>
                </div>
                <div style="font-size: 24px;">â†’</div>
            </button>
            
            <!-- ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰ -->
            <button onclick="selectThemeMode('custom')" style="
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 25px;
                margin-bottom: 15px;
                border: none;
                border-radius: 15px;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="text-align: left;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        âœï¸ ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ†ãƒ¼ãƒ
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        è‡ªç”±ã«ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›
                    </div>
                </div>
                <div style="font-size: 24px;">â†’</div>
            </button>
            
            <!-- å°†æ¥ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼šæŠ•ç¥¨ãƒ¢ãƒ¼ãƒ‰ãªã©
            <button onclick="selectThemeMode('vote')" style="opacity: 0.5; pointer-events: none;">
                <div>ğŸ—³ï¸ æŠ•ç¥¨ãƒ¢ãƒ¼ãƒ‰ï¼ˆæº–å‚™ä¸­ï¼‰</div>
                <div style="font-size: 13px;">3ã¤ã®ãƒ†ãƒ¼ãƒã‹ã‚‰é¸ã¶</div>
            </button>
            -->
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ========================================
             ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒå…¥åŠ›ç”»é¢
             å°†æ¥ã®æ‹¡å¼µï¼šãƒ†ãƒ¼ãƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€å±¥æ­´ã‹ã‚‰é¸æŠãªã©
             ======================================== -->
        <div id="customThemeInputScreen" class="screen">
            <h2 style="color: #f5576c; margin-bottom: 20px;">âœï¸ ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›</h2>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px; line-height: 1.6;">
                ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ãƒ†ãƒ¼ãƒã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„
            </p>
            
            <!-- ãƒ†ãƒ¼ãƒå…¥åŠ›æ¬„ -->
            <div style="background: #FFF0F5; border: 2px solid #f5576c; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <label for="customThemeInput" style="display: block; color: #f5576c; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                    ğŸ“Œ ãƒ†ãƒ¼ãƒ
                </label>
                <input 
                    type="text" 
                    id="customThemeInput" 
                    placeholder="ä¾‹ï¼šã‚ãŸã—ã®å¥½ããªéŸ³æ¥½TOP5"
                    maxlength="50"
                    style="
                        width: 100%;
                        padding: 15px;
                        border: 2px solid #f5576c;
                        border-radius: 8px;
                        font-size: 16px;
                        box-sizing: border-box;
                        outline: none;
                        transition: border-color 0.3s;
                    "
                    onfocus="this.style.borderColor='#ff1744'"
                    onblur="this.style.borderColor='#f5576c'"
                />
                <p style="color: #999; font-size: 12px; margin-top: 8px; text-align: right;">
                    <span id="customThemeCount">0</span> / 50æ–‡å­—
                </p>
            </div>
            
            <!-- å°†æ¥ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ
            <div style="margin-bottom: 20px;">
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">ğŸ’¡ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰é¸ã¶</p>
                <button onclick="useTemplate('ã‚ãŸã—ã®å¥½ããªâ—‹â—‹TOP5')">å¥½ããªâ—‹â—‹</button>
                <button onclick="useTemplate('ã‚ãŸã—ã®è¡ŒããŸã„â—‹â—‹TOP5')">è¡ŒããŸã„â—‹â—‹</button>
            </div>
            -->
            
            <!-- æ±ºå®šãƒœã‚¿ãƒ³ -->
            <button onclick="confirmCustomTheme()" style="
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                padding: 18px;
                width: 100%;
                border: none;
                border-radius: 12px;
                font-size: 18px;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
                cursor: pointer;
                transition: transform 0.2s;
            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                âœ… ã“ã®ãƒ†ãƒ¼ãƒã§æ±ºå®š
            </button>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="backToThemeModeSelect()" class="fixed-round-button fixed-round-button-home">
                æˆ»ã‚‹
            </button>
        </div>
        
        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥åŠ›ç”»é¢ -->
        <div id="rankingScreen" class="screen">
            <div class="theme-box">
                <h2>ğŸ“Œ ä»Šå›ã®ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="currentTheme">---</p>
            </div>
            
            <div class="ranking-form">
                <div class="rank-item">
                    <div class="rank-label">1ä½</div>
                    <input type="text" class="rank-input" id="rank1" placeholder="1ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">2ä½</div>
                    <input type="text" class="rank-input" id="rank2" placeholder="2ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">3ä½</div>
                    <input type="text" class="rank-input" id="rank3" placeholder="3ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">4ä½</div>
                    <input type="text" class="rank-input" id="rank4" placeholder="4ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                </div>
                <div class="rank-item">
                    <div class="rank-label">5ä½</div>
                    <input type="text" class="rank-input" id="rank5" placeholder="5ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                </div>
            </div>
            
            <button onclick="saveRanking()" style="margin-bottom: 80px;">
                ğŸ’¾ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¿å­˜ã™ã‚‹
            </button>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- å±¥æ­´è¡¨ç¤ºç”»é¢ -->
        <div id="historyScreen" class="screen">
            <h2 style="color: #4A90E2; margin-bottom: 20px;">ğŸ“‹ éå»ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            
            <div id="historyList" class="history-list" style="padding-bottom: 80px;">
                <!-- ã“ã“ã«å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ãƒšã‚¢è¨­å®šç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰ -->
        <div id="pairScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ’‘ ãƒšã‚¢è¨­å®š</h2>
            
            <!-- è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div style="background: #F8F4FF; border: 2px solid #9B59B6; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #9B59B6; font-size: 16px; margin-bottom: 10px;">ğŸ“Œ ã‚ãªãŸã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«æ•™ãˆã¦ãã ã•ã„</p>
                <div style="background: white; border: 2px dashed #9B59B6; border-radius: 8px; padding: 15px; text-align: center;">
                    <p id="myPairCode" style="font-size: 32px; font-weight: bold; color: #9B59B6; letter-spacing: 4px; font-family: 'Courier New', monospace;">------</p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="copyPairCode()" style="background: #9B59B6; font-size: 14px; padding: 10px; flex: 1;">
                        ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                    <button onclick="sharePairCodeToLine()" style="background: #06C755; font-size: 14px; padding: 10px; flex: 1;">
                        ğŸ“± LINEã§é€ã‚‹
                    </button>
                </div>
            </div>
            
            <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
            <div style="background: #FFF8F0; border: 2px solid #FF9800; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #FF9800; font-size: 16px; margin-bottom: 10px;">ğŸ”— ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ãƒšã‚¢ã«ãªã‚‹</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <input type="text" id="partnerCodeInput" placeholder="ABC123" maxlength="6" 
                    style="width: 100%; padding: 15px; border: 2px solid #FF9800; border-radius: 8px; font-size: 24px; font-weight: bold; text-align: center; letter-spacing: 4px; text-transform: uppercase; font-family: 'Courier New', monospace; margin-bottom: 10px;">
                <button onclick="connectWithPartner()" style="background: #FF9800;">
                    âœ¨ ãƒšã‚¢ã«ãªã‚‹
                </button>
            </div>
            
            <!-- ç¾åœ¨ã®ãƒšã‚¢æƒ…å ± -->
            <div id="currentPairInfo" style="background: #F0FFF4; border: 2px solid #50C878; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: none;">
                <h3 style="color: #50C878; font-size: 16px; margin-bottom: 10px;">âœ… ãƒšã‚¢æˆç«‹ä¸­</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 8px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: <span id="partnerName" style="font-weight: bold; color: #333;">---</span></p>
                <button onclick="disconnectPair()" style="background: #ff6b6b; font-size: 14px; padding: 10px;">
                    âŒ ãƒšã‚¢ã‚’è§£é™¤
                </button>
            </div>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- å¾…æ©Ÿãƒ«ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="waitingRoomScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ® ãµãŸã‚Šã§ã‚ãã¶</h2>
            
            <!-- å¾…æ©Ÿä¸­ã®è¡¨ç¤º -->
            <div id="waitingArea" style="text-align: center; padding: 40px 20px;">
                <div style="background: linear-gradient(135deg, #FFF0F5, #F0F8FF); border: 3px solid #FF6B9D; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">â³</p>
                    <p id="waitingMessage" style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã‚¢ãƒ—ãƒªã‚’é–‹ãã¨<br>è‡ªå‹•çš„ã«ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã™</p>
                </div>
                
                <button onclick="shareSessionToLine()" style="background: #06C755; font-size: 16px; padding: 15px 20px; margin-bottom: 20px;">
                    ğŸ“± LINEã§æ‹›å¾…ã‚’é€ã‚‹
                </button>
            </div>
            
            <!-- å‚åŠ ç¢ºèªã®è¡¨ç¤º -->
            <div id="joinArea" style="text-align: center; padding: 40px 20px; display: none;">
                <div style="background: linear-gradient(135deg, #FFF0F5, #F0F8FF); border: 3px solid #4A90E2; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">ğŸ‰</p>
                    <p id="joinMessage" style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">---ã•ã‚“ãŒå¾…ã£ã¦ã„ã¾ã™ï¼</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">ä¸€ç·’ã«ã‚²ãƒ¼ãƒ ã‚’ã—ã¾ã™ã‹ï¼Ÿ</p>
                </div>
                
                <button onclick="joinGame()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); font-size: 17px; padding: 18px 20px;">
                    âœ¨ å‚åŠ ã™ã‚‹
                </button>
            </div>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="confirmBackToMain('å¾…æ©Ÿå®¤ã‚’é€€å‡ºã—ã¦HOMEã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ã‚²ãƒ¼ãƒ å…¥åŠ›ç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="gameInputScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ® ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥åŠ›</h2>
            
            <div class="theme-box">
                <h2>ğŸ“Œ ä»Šå›ã®ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="gameTheme">---</p>
            </div>
            
            <!-- é€²è¡ŒçŠ¶æ³è¡¨ç¤º -->
            <div id="gameProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">ğŸ“Š é€²è¡ŒçŠ¶æ³</p>
                <div id="gameProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <div class="ranking-form" id="gameRankingForm">
                <div class="rank-item draggable-item" data-rank="1">
                    <div class="rank-label">1ä½</div>
                    <input type="text" class="rank-input" id="gameRank1" placeholder="1ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                    <span class="drag-handle">â‰¡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="2">
                    <div class="rank-label">2ä½</div>
                    <input type="text" class="rank-input" id="gameRank2" placeholder="2ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                    <span class="drag-handle">â‰¡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="3">
                    <div class="rank-label">3ä½</div>
                    <input type="text" class="rank-input" id="gameRank3" placeholder="3ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                    <span class="drag-handle">â‰¡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="4">
                    <div class="rank-label">4ä½</div>
                    <input type="text" class="rank-input" id="gameRank4" placeholder="4ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                    <span class="drag-handle">â‰¡</span>
                </div>
                <div class="rank-item draggable-item" data-rank="5">
                    <div class="rank-label">5ä½</div>
                    <input type="text" class="rank-input" id="gameRank5" placeholder="5ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰" maxlength="50">
                    <span class="drag-handle">â‰¡</span>
                </div>
            </div>
            
            <button id="submitGameRankingButton" onclick="submitGameRanking()">
                ğŸ’¾ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é€ä¿¡
            </button>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="confirmBackToMain('HOMEã«æˆ»ã‚‹ã¨ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- äºˆæƒ³ç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="guessScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ¤” ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’äºˆæƒ³</h2>
            
            <div style="background: #FFF0F5; border: 2px solid #FF6B9D; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; line-height: 1.8; text-align: center;">
                    <span id="guessPartnerName" style="font-weight: bold; color: #FF6B9D;">---</span>ã•ã‚“ã®<br>
                    ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ­£ã—ã„é †ç•ªã«ä¸¦ã¹ã¦ãã ã•ã„
                </p>
            </div>
            
            <div class="theme-box" style="margin-bottom: 20px;">
                <h2>ğŸ“Œ ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="guessTheme">---</p>
            </div>
            
            <!-- é€²è¡ŒçŠ¶æ³è¡¨ç¤º -->
            <div id="guessProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">ğŸ“Š é€²è¡ŒçŠ¶æ³</p>
                <div id="guessProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <!-- ä¸¦ã³æ›¿ãˆã‚¨ãƒªã‚¢ -->
            <div id="guessRankingArea" style="margin: 20px 0;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button id="submitGuessButton" onclick="submitGuess()">
                âœ… äºˆæƒ³ã‚’é€ä¿¡
            </button>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="confirmBackToMain('HOMEã«æˆ»ã‚‹ã¨ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- çµæœç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="resultScreen" class="screen" style="padding-bottom: 40px;">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ‰ çµæœç™ºè¡¨</h2>
            
            <div id="resultContent" style="margin: 20px 0;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button id="playAgainButton" onclick="playAgain()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); width: 100%;">
                ğŸ® æ–°ã—ã„ãƒ†ãƒ¼ãƒã§ã‚‚ã†ä¸€åº¦ã‚ãã¶
            </button>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button id="resultHomeButton" onclick="confirmBackToMain('HOMEã«æˆ»ã‚‹ã¨ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°é¸æŠç”»é¢ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰ -->
        <div id="reviewListScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ”„ æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³</h2>
            
            <p style="color: #666; font-size: 14px; line-height: 1.8; text-align: center; margin-bottom: 20px; padding: 15px; background: #F8F4FF; border-radius: 10px;">
                éå»ã«ä½œã£ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é¸ã‚“ã§<br>
                ã‚‚ã†ä¸€åº¦ä¸¦ã¹ã¦ã¿ã¾ã—ã‚‡ã†ï¼
            </p>
            
            <div id="reviewRankingList" class="history-list">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button onclick="backToMain()" class="secondary-button">
                â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
        
        <!-- æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šä¸¦ã³æ›¿ãˆç”»é¢ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰ -->
        <div id="reviewGuessScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ”„ ä¸¦ã³æ›¿ãˆã¦ã¿ã‚ˆã†</h2>
            
            <div class="theme-box" style="margin-bottom: 20px;">
                <h2>ğŸ“Œ ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="reviewTheme">---</p>
            </div>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px;">
                æ­£ã—ã„é †ç•ªã«ä¸¦ã¹ã¦ãã ã•ã„
            </p>
            
            <!-- ä¸¦ã³æ›¿ãˆã‚¨ãƒªã‚¢ -->
            <div id="reviewGuessArea" style="margin: 20px 0; padding-bottom: 80px;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="cancelReview()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
            
            <button onclick="submitReviewGuess()" class="fixed-round-button fixed-round-button-submit">
                ANSWER
            </button>
        </div>
        
        <!-- æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šçµæœç”»é¢ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰ -->
        <div id="reviewResultScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ‰ çµæœ</h2>
            
            <div id="reviewResultContent" style="margin: 20px 0;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button onclick="showReviewList()" style="background: #9B59B6; margin-bottom: 80px;">
                ğŸ”„ åˆ¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§æŒ‘æˆ¦
            </button>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
        
        <!-- ========================================
             é–‹ç™ºç”¨ï¼šSortableJS ãƒ†ã‚¹ãƒˆç”»é¢
             ======================================== -->
        
        <!-- é–‹ç™ºç”¨ï¼šä¸¦ã³æ›¿ãˆç”»é¢ -->
        <div id="devReviewGuessScreen" class="screen">
            <h2 style="color: #FF6B35; margin-bottom: 20px;">ğŸ§ª ä¸¦ã³æ›¿ãˆã¦ã¿ã‚ˆã†ï¼ˆé–‹ç™ºç”¨ï¼‰</h2>
            
            <div class="theme-box" style="margin-bottom: 20px; border-color: #FF6B35;">
                <h2 style="color: #FF6B35;">ğŸ“Œ ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="devReviewTheme">---</p>
            </div>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px;">
                æ­£ã—ã„é †ç•ªã«ä¸¦ã¹ã¦ãã ã•ã„
            </p>
            
            <!-- ä¸¦ã³æ›¿ãˆã‚¨ãƒªã‚¢ï¼ˆSortableJSä½¿ç”¨ï¼‰ -->
            <div id="devReviewGuessArea" style="margin: 20px 0; padding-bottom: 80px;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="cancelDevReview()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
            
            <button onclick="submitDevReviewGuess()" class="fixed-round-button fixed-round-button-submit">
                ANSWER
            </button>
        </div>
        
        <!-- é–‹ç™ºç”¨ï¼šçµæœç”»é¢ -->
        <div id="devReviewResultScreen" class="screen">
            <h2 style="color: #FF6B35; margin-bottom: 20px;">ğŸ‰ çµæœï¼ˆé–‹ç™ºç”¨ï¼‰</h2>
            
            <div id="devReviewResultContent" style="margin: 20px 0;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button onclick="showDevReviewList()" style="background: #FF6B35; margin-bottom: 80px;">
                ğŸ”„ åˆ¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§æŒ‘æˆ¦
            </button>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="backToMain()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
        </div>
    </div>

    <script>
        // ========================================
        // ãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ï¼ˆ28å€‹ï¼‰
        // ========================================
        const THEMES = [
            // ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ç³»ï¼ˆ8å€‹ï¼‰
            'æœ€è¿‘ã€å¬‰ã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ¥½ã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ„Ÿè¬ã‚’æ„Ÿã˜ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ„›ã‚’æ„Ÿã˜ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€ãƒãƒã£ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ‚²ã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€ãƒ ã‚«ã¤ã„ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€ä¸å®‰ã«æ„Ÿã˜ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿ',
            
            // Yearç³»ï¼ˆ2å€‹ï¼‰
            'ã“ã®1å¹´ã§ã€è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚‚ã®ã¯ï¼Ÿ',
            'ã“ã®1å¹´ã§ã€è¡Œã£ã¦ã‚ˆã‹ã£ãŸãŠåº—ã¯ï¼Ÿ',
            
            // ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ç³»ï¼ˆ15å€‹ï¼‰
            'ã‚ãŸã—ã®å¥½ããªé£Ÿã¹ç‰©ãƒ»æ–™ç†TOP5',
            'ã‚ãŸã—ã®å«Œã„ãƒ»è‹¦æ‰‹ãªé£Ÿã¹ç‰©ãƒ»æ–™ç†TOP5',
            'ã‚ãŸã—ã®å¥½ããªé£²é£Ÿåº—TOP5',
            'ã‚ãŸã—ã®å¥½ããªæ˜ ç”»TOP5',
            'ã‚ãŸã—ã®å¥½ããªæ¼«ç”»ãƒ»ã‚¢ãƒ‹ãƒ¡TOP5',
            'ã‚ãŸã—ã®å¥½ããªã‚²ãƒ¼ãƒ TOP5',
            'ã‚ãŸã—ã®å¥½ããªåœ°åŸŸãƒ»ã‚¨ãƒªã‚¢TOP5',
            'ã‚ãŸã—ã®å¶ãˆãŸã„å¤¢ãƒ»ç›®æ¨™TOP5',
            'ã‚ãŸã—ã®å®ç‰©TOP5',
            'ã‚ãŸã—ã®å¥½ããªæœ¬TOP5',
            'ã‚ãŸã—ã®æ¬²ã—ã„ã‚‚ã®TOP5',
            'ã‚ãŸã—ã®ä¼šã£ã¦ã¿ãŸã„äººTOP5',
            'ã‚ãŸã—ã®å°Šæ•¬ã™ã‚‹äººTOP5',
            'ã‚ãŸã—ã®å­¦ç”Ÿæ™‚ä»£ã®å¾—æ„ç§‘ç›®TOP5',
            'ã‚ãŸã—ã®å­¦ç”Ÿæ™‚ä»£ã®è‹¦æ‰‹ç§‘ç›®TOP5',
            
            // ã‚«ãƒƒãƒ—ãƒ«ç³»ï¼ˆ3å€‹ï¼‰
            'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®å¥½ããªã¨ã“ã‚TOP5',
            'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«æ„Ÿè¬ã‚’ã—ãŸå ´é¢ãƒ»ã‚·ãƒ¼ãƒ³TOP5',
            'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’ç´ æ•µã¨æ„Ÿã˜ãŸå ´é¢ãƒ»ã‚·ãƒ¼ãƒ³TOP5'
        ];
        
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        const LIFF_ID = '2008911809-CBLKsbT1';
        let currentTheme = '';
        let userProfile = null;
        let currentUser = null; // Firebaseä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ç”¨å¤‰æ•°ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰
        let currentGameSession = null;  // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
        let currentSessionRef = null;   // Firebaseç›£è¦–ãƒªã‚¹ãƒŠãƒ¼ã®ref
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ç”¨å¤‰æ•°ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰
        let currentReviewRanking = null;  // ç¾åœ¨æŒ¯ã‚Šè¿”ã‚Šä¸­ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        let reviewCorrectAnswer = null;   // æ­£è§£ãƒ‡ãƒ¼ã‚¿
        
        // SortableJSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆãµãŸã‚Šã§ã‚ãã¶ç”¨ï¼‰
        let gameSortableInstance = null;  // äºˆæƒ³ç”»é¢ç”¨
        let gameInputSortableInstance = null;  // å›ç­”å…¥åŠ›ç”¨
        
        // ========================================
        // Firebase è¨­å®šï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDf8Yn-r5W1i6YptJ9DXch7i14JRi9bAf0",
            authDomain: "test-futari-no-ranking.firebaseapp.com",
            databaseURL: "https://test-futari-no-ranking-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-futari-no-ranking",
            storageBucket: "test-futari-no-ranking.firebasestorage.app",
            messagingSenderId: "802679547612",
            appId: "1:802679547612:web:1582d3e0176282ede43619",
            measurementId: "G-N364EXJQV8"
        };
        
        // FirebaseåˆæœŸåŒ–
        let firebaseApp = null;
        let database = null;
        
        function initializeFirebase() {
            try {
                // FirebaseåˆæœŸåŒ–
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('âœ… Firebaseæ¥ç¶šæˆåŠŸï¼');
                return true;
            } catch (error) {
                console.error('âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // ========================================
        // LIFFåˆæœŸåŒ–
        // ========================================
        window.onload = function() {
            initializeLiff();
            setupEnterKeyNavigation();
            setupVisibilityChangeHandler();
        };
        
        function initializeLiff() {
            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login();
                }
            })
            .catch((err) => {
                console.error('LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = 
                    '<p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + err.message + '</p>';
            });
        }
        
        function getUserProfile() {
            liff.getProfile()
                .then(profile => {
                    userProfile = profile;
                    
                    // Firebaseã‚’åˆæœŸåŒ–ï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
                    initializeFirebase();
                    
                    // FirebaseåŒ¿åèªè¨¼ï¼ˆPhase 6è¿½åŠ ï¼šSecurity Ruleså¯¾å¿œï¼‰
                    return firebase.auth().signInAnonymously();
                })
                .then(() => {
                    console.log('âœ… Firebaseèªè¨¼æˆåŠŸ');
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’Firebaseã«ä¿å­˜ãƒ»å–å¾—ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰
                    initializeUser();
                    
                    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ‹›å¾…URLå‡¦ç†ï¼‰
                    checkUrlParameters();
                    
                    document.getElementById('loading').style.display = 'none';
                    showScreen('mainScreen');
                })
                .catch((err) => {
                    console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', err);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').innerHTML = 
                        '<p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + err.message + '</p>';
                });
        }
        
        // LIFFãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆç¾åœ¨ã¯ä½•ã‚‚ã—ãªã„ï¼‰
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚’è¦‹ã‚‹ã“ã¨ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã€è‡ªå‹•å‰Šé™¤ã¯ã—ãªã„
        // å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯èµ·å‹•æ™‚ã«è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹
        function setupVisibilityChangeHandler() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('ğŸ“± LIFFãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»è¡Œã—ã¾ã—ãŸï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä¿æŒï¼‰');
                } else {
                    console.log('ğŸ“± LIFFãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å¾©å¸°ã—ã¾ã—ãŸ');
                }
            });
        }
        
        // ========================================
        // ãƒšã‚¢æ©Ÿèƒ½ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰
        // ========================================
        
        // ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆ6æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ è‹±æ•°å­—ï¼‰
        function generatePairCode() {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // ç´›ã‚‰ã‚ã—ã„æ–‡å­—ã‚’é™¤å¤–ï¼ˆI,O,0,1ãªã©ï¼‰
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®åˆæœŸåŒ–ï¼ˆFirebaseã«ä¿å­˜ï¼‰
        function initializeUser() {
            if (!database || !userProfile) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæœªåˆæœŸåŒ–');
                return;
            }
            
            const userId = userProfile.userId;
            const userRef = database.ref('users/' + userId);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            userRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šæƒ…å ±ã‚’æ›´æ–°
                        currentUser = snapshot.val();
                        
                        // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ›´æ–°
                        userRef.update({
                            displayName: userProfile.displayName,
                            pictureUrl: userProfile.pictureUrl || '',
                            lastLoginAt: new Date().toISOString()
                        });
                        
                        console.log('âœ… æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—:', currentUser);
                    } else {
                        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ä¿å­˜
                        const newPairCode = generatePairCode();
                        const newUser = {
                            userId: userId,
                            displayName: userProfile.displayName,
                            pictureUrl: userProfile.pictureUrl || '',
                            pairCode: newPairCode,
                            partnerId: null,
                            createdAt: new Date().toISOString(),
                            lastLoginAt: new Date().toISOString()
                        };
                        
                        userRef.set(newUser)
                            .then(() => {
                                currentUser = newUser;
                                console.log('âœ… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ:', currentUser);
                                updatePairStatus();
                            })
                            .catch((error) => {
                                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                            });
                        
                        return; // æ–°è¦ä½œæˆã®å ´åˆã¯ã“ã“ã§çµ‚äº†
                    }
                    
                    // ãƒšã‚¢çŠ¶æ…‹ã‚’æ›´æ–°
                    updatePairStatus();
                    
                    // å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨çŠ¶æ…‹å¾©å…ƒ
                    cleanupAndRestoreSessions();
                })
                .catch((error) => {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ãƒšã‚¢çŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
        function updatePairStatus() {
            const statusContent = document.getElementById('pairStatusContent');
            const realtimeGameButton = document.getElementById('realtimeGameButton');
            
            if (!currentUser) {
                statusContent.innerHTML = '<p style="color: #999; font-size: 14px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
                return;
            }
            
            if (currentUser.partnerId) {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ã‚‹å ´åˆï¼šãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®åå‰ã‚’å–å¾—ã—ã¦è¡¨ç¤º
                const partnerRef = database.ref('users/' + currentUser.partnerId);
                partnerRef.once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            statusContent.innerHTML = 
                                '<p style="color: #50C878; font-size: 15px; font-weight: bold;">âœ… ãƒšã‚¢æˆç«‹</p>' +
                                '<p style="color: #666; font-size: 14px; margin-top: 5px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ' + partner.displayName + '</p>';
                            
                            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                            if (realtimeGameButton) {
                                realtimeGameButton.style.opacity = '1';
                                realtimeGameButton.style.cursor = 'pointer';
                                realtimeGameButton.style.background = 'linear-gradient(135deg, #FF6B9D, #4A90E2)';
                                realtimeGameButton.style.filter = 'none';
                            }
                        } else {
                            statusContent.innerHTML = '<p style="color: #ff6b6b; font-size: 14px;">âš ï¸ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                            
                            // ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
                            if (realtimeGameButton) {
                                realtimeGameButton.style.opacity = '0.5';
                                realtimeGameButton.style.cursor = 'not-allowed';
                                realtimeGameButton.style.background = '#999';
                                realtimeGameButton.style.filter = 'grayscale(80%)';
                            }
                        }
                    })
                    .catch((error) => {
                        console.error('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                        statusContent.innerHTML = '<p style="color: #ff6b6b; font-size: 14px;">âŒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼</p>';
                        
                        // ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
                        if (realtimeGameButton) {
                            realtimeGameButton.style.opacity = '0.5';
                            realtimeGameButton.style.cursor = 'not-allowed';
                            realtimeGameButton.style.background = '#999';
                            realtimeGameButton.style.filter = 'grayscale(80%)';
                        }
                    });
            } else {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ãªã„å ´åˆ
                statusContent.innerHTML = 
                    '<p style="color: #999; font-size: 14px;">ã¾ã ãƒšã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>' +
                    '<p style="color: #9B59B6; font-size: 13px; margin-top: 5px;">ä¸‹ã®ã€Œãƒšã‚¢ã‚’è¨­å®šã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</p>';
                
                // ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼ˆdisabledã¯ä½¿ã‚ãªã„ - ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼‰
                if (realtimeGameButton) {
                    realtimeGameButton.style.opacity = '0.5';
                    realtimeGameButton.style.cursor = 'not-allowed';
                    realtimeGameButton.style.background = '#999';
                    realtimeGameButton.style.filter = 'grayscale(80%)';
                }
            }
        }
        
        // å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨çŠ¶æ…‹å¾©å…ƒ
        async function cleanupAndRestoreSessions() {
            try {
                console.log('ğŸ§¹ å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹...');
                
                const sessionsRef = database.ref('gameSessions');
                const snapshot = await sessionsRef.once('value');
                
                if (!snapshot.exists()) {
                    console.log('ğŸ“­ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    return;
                }
                
                const now = Date.now();
                const WAITING_TIMEOUT = 10 * 60 * 1000;  // 10åˆ†
                const GAMING_TIMEOUT = 30 * 60 * 1000;   // 30åˆ†
                
                let myActiveSession = null;  // è‡ªåˆ†ã®é€²è¡Œä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³
                let isTimeout = false;       // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ•ãƒ©ã‚°
                let timeoutMessage = '';     // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                
                const deletePromises = [];
                
                snapshot.forEach((childSnapshot) => {
                    const sessionId = childSnapshot.key;
                    const session = childSnapshot.val();
                    
                    // è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ç¢ºèª
                    const isMySession = session.players && session.players[userProfile.userId];
                    
                    if (!isMySession) {
                        // è‡ªåˆ†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ãªã„ â†’ ã‚¹ã‚­ãƒƒãƒ—
                        return;
                    }
                    
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
                    const lastActivity = session.lastActivityAt || new Date(session.createdAt).getTime();
                    const elapsed = now - lastActivity;
                    const elapsedMinutes = Math.floor(elapsed / 60000);
                    
                    let timeoutLimit;
                    let timeoutType;
                    
                    if (session.gameStatus === 'waiting') {
                        timeoutLimit = WAITING_TIMEOUT;
                        timeoutType = 'å¾…æ©Ÿå®¤';
                    } else if (['inputting', 'guessing'].includes(session.gameStatus)) {
                        timeoutLimit = GAMING_TIMEOUT;
                        timeoutType = 'ã‚²ãƒ¼ãƒ ';
                    } else if (session.gameStatus === 'finished') {
                        // çµæœç”»é¢ã¯1æ™‚é–“ã§å‰Šé™¤
                        timeoutLimit = 60 * 60 * 1000;
                        timeoutType = 'çµæœ';
                    }
                    
                    if (elapsed > timeoutLimit) {
                        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ å‰Šé™¤
                        console.log(`â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${timeoutType}ï¼ˆ${elapsedMinutes}åˆ†çµŒéï¼‰`);
                        deletePromises.push(childSnapshot.ref.remove());
                        
                        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
                        isTimeout = true;
                        timeoutMessage = `${elapsedMinutes}åˆ†é–“æ“ä½œãŒãªã‹ã£ãŸãŸã‚ã€${timeoutType}ã¯ç„¡åŠ¹ã¨ãªã‚Šã¾ã—ãŸã€‚`;
                    } else {
                        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã„ãªã„ â†’ å¾©å…ƒå¯¾è±¡
                        myActiveSession = {
                            id: sessionId,
                            data: session
                        };
                    }
                });
                
                // å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
                if (deletePromises.length > 0) {
                    await Promise.all(deletePromises);
                    console.log(`âœ… ${deletePromises.length}ä»¶ã®å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                }
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (isTimeout) {
                    alert('â° ' + timeoutMessage);
                }
                
                // é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å¾©å…ƒ
                if (myActiveSession) {
                    console.log('ğŸ”„ é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒ:', myActiveSession.id);
                    resumeSession(myActiveSession);
                } else {
                    console.log('âœ… é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤ºï¼‰');
                }
                
            } catch (error) {
                console.error('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒ
        function resumeSession(session) {
            const sessionId = session.id;
            const sessionData = session.data;
            
            // ãƒ›ã‚¹ãƒˆ or ã‚²ã‚¹ãƒˆåˆ¤å®šï¼ˆæ˜ç¤ºçš„ãªhostIdã‚’ä½¿ç”¨ï¼‰
            const hostId = sessionData.hostId || Object.keys(sessionData.players)[0];
            const role = (hostId === userProfile.userId) ? 'host' : 'guest';
            
            currentGameSession = {
                id: sessionId,
                data: sessionData,
                role: role
            };
            
            console.log('ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ:', sessionData.gameStatus, 'role:', role, 'hostId:', hostId, 'userId:', userProfile.userId);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ç”»é¢ã‚’è¡¨ç¤º
            switch (sessionData.gameStatus) {
                case 'waiting':
                    showWaitingRoom(sessionId, sessionData, role);
                    break;
                    
                case 'inputting':
                    showGameInputScreen(sessionData);
                    startSessionListener(sessionId);
                    break;
                    
                case 'guessing':
                    showGuessScreen(sessionData);
                    startSessionListener(sessionId);
                    break;
                    
                case 'finished':
                    showResultScreen(sessionData);
                    startSessionListener(sessionId);
                    break;
                    
                default:
                    console.warn('âš ï¸ ä¸æ˜ãªã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', sessionData.gameStatus);
                    currentGameSession = null;
                    showScreen('mainScreen');
            }
        }
        
        // ãƒšã‚¢è¨­å®šç”»é¢ã‚’è¡¨ç¤º
        function showPairScreen() {
            if (!currentUser) {
                alert('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }
            
            // ã€Œã‚ãªãŸã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†è¡¨ç¤ºï¼ˆæ‹›å¾…URLã‹ã‚‰å…¥ã£ãŸå ´åˆã«éè¡¨ç¤ºã«ãªã£ã¦ã„ã‚‹ãŸã‚ï¼‰
            const myPairCodeSection = document.querySelector('#pairScreen > div:first-of-type');
            if (myPairCodeSection) {
                myPairCodeSection.style.display = 'block';
            }
            
            // è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            document.getElementById('myPairCode').textContent = currentUser.pairCode;
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            if (currentUser.partnerId) {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ã‚‹å ´åˆ
                const partnerRef = database.ref('users/' + currentUser.partnerId);
                partnerRef.once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            document.getElementById('partnerName').textContent = partner.displayName;
                            document.getElementById('currentPairInfo').style.display = 'block';
                        }
                    })
                    .catch((error) => {
                        console.error('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    });
            } else {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ãªã„å ´åˆ
                document.getElementById('currentPairInfo').style.display = 'none';
            }
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('partnerCodeInput').value = '';
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('pairScreen');
        }
        
        // ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
        function copyPairCode() {
            const code = currentUser.pairCode;
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        alert('âœ… ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nã‚³ãƒ¼ãƒ‰: ' + code + '\n\nãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ã£ã¦ãã ã•ã„ã€‚');
                    })
                    .catch(() => {
                        // ã‚³ãƒ”ãƒ¼å¤±æ•—æ™‚
                        alert('ãƒšã‚¢ã‚³ãƒ¼ãƒ‰: ' + code + '\n\nã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«é€ã£ã¦ãã ã•ã„ã€‚');
                    });
            } else {
                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆãªã„å ´åˆ
                alert('ãƒšã‚¢ã‚³ãƒ¼ãƒ‰: ' + code + '\n\nã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«é€ã£ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ãƒšã‚¢ã«ãªã‚‹
        function connectWithPartner() {
            const partnerCode = document.getElementById('partnerCodeInput').value.trim().toUpperCase();
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (partnerCode === '') {
                alert('âŒ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (partnerCode.length !== 6) {
                alert('âŒ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã¯6æ–‡å­—ã§ã™ã€‚');
                return;
            }
            
            // è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (partnerCode === currentUser.pairCode) {
                alert('âŒ è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã¯å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚\nãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // Firebaseã§ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢
            const usersRef = database.ref('users');
            usersRef.orderByChild('pairCode').equalTo(partnerCode).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('âŒ ã“ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¦‹ã¤ã‘ãŸ
                    let partnerId = null;
                    let partnerData = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        partnerId = childSnapshot.key;
                        partnerData = childSnapshot.val();
                    });
                    
                    if (!partnerId || !partnerData) {
                        alert('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        return;
                    }
                    
                    // æ—¢ã«ãƒšã‚¢ãŒã„ã‚‹å ´åˆã¯ç¢ºèª
                    if (currentUser.partnerId) {
                        if (!confirm('æ—¢ã«ãƒšã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚\næ–°ã—ã„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                            return;
                        }
                    }
                    
                    // è‡ªåˆ†ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’æ›´æ–°
                    const myUserRef = database.ref('users/' + userProfile.userId);
                    myUserRef.update({
                        partnerId: partnerId
                    })
                        .then(() => {
                            // ç›¸æ‰‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚‚æ›´æ–°
                            const partnerUserRef = database.ref('users/' + partnerId);
                            return partnerUserRef.update({
                                partnerId: userProfile.userId
                            });
                        })
                        .then(() => {
                            // æˆåŠŸ
                            currentUser.partnerId = partnerId;
                            alert('âœ… ãƒšã‚¢è¨­å®šå®Œäº†ï¼\n\nãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ' + partnerData.displayName + '\n\nã“ã‚Œã§ãŠäº’ã„ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å…±æœ‰ã§ãã¾ã™ã€‚');
                            
                            // è¡¨ç¤ºã‚’æ›´æ–°
                            updatePairStatus();
                            showPairScreen();
                        })
                        .catch((error) => {
                            alert('âŒ ãƒšã‚¢è¨­å®šã‚¨ãƒ©ãƒ¼:\n' + error.message);
                            console.error('âŒ ãƒšã‚¢è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                        });
                })
                .catch((error) => {
                    alert('âŒ ã‚³ãƒ¼ãƒ‰æ¤œç´¢ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ã‚³ãƒ¼ãƒ‰æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ãƒšã‚¢ã‚’è§£é™¤
        function disconnectPair() {
            if (!confirm('ãƒšã‚¢ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãŠäº’ã„ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¦‹ãˆãªããªã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            if (!currentUser.partnerId) {
                alert('âŒ ãƒšã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            const partnerId = currentUser.partnerId;
            
            // è‡ªåˆ†ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’ã‚¯ãƒªã‚¢
            const myUserRef = database.ref('users/' + userProfile.userId);
            myUserRef.update({
                partnerId: null
            })
                .then(() => {
                    // ç›¸æ‰‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚‚ã‚¯ãƒªã‚¢
                    const partnerUserRef = database.ref('users/' + partnerId);
                    return partnerUserRef.update({
                        partnerId: null
                    });
                })
                .then(() => {
                    // æˆåŠŸ
                    currentUser.partnerId = null;
                    alert('âœ… ãƒšã‚¢ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
                    
                    // è¡¨ç¤ºã‚’æ›´æ–°
                    updatePairStatus();
                    showPairScreen();
                })
                .catch((error) => {
                    alert('âŒ ãƒšã‚¢è§£é™¤ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ãƒšã‚¢è§£é™¤ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ========================================
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰
        // ========================================
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’è©¦ã¿ã‚‹ï¼ˆãƒšã‚¢ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        function tryStartRealtimeGame() {
            if (!currentUser || !currentUser.partnerId) {
                alert('âŒ ã¾ãšãƒšã‚¢ã‚’è¨­å®šã—ã¦ãã ã•ã„\n\nä¸‹ã®ã€Œâš™ï¸ ãƒšã‚¢ã‚’è¨­å®šã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ãƒšã‚¢ã«ãªã£ã¦ãã ã•ã„ã€‚');
                return;
            }
            startRealtimeGame();
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ é–‹å§‹
        function startRealtimeGame() {
            // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚²ã‚¹ãƒˆå‚åŠ åˆ¤å®šï¼‰
            // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°è‡ªå‹•å‚åŠ ã€ãªã‘ã‚Œã°ãƒ›ã‚¹ãƒˆã¨ã—ã¦å¾…æ©Ÿå®¤ä½œæˆ
            checkExistingSession();
        }
        
        // ========================================
        // ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰é¸æŠæ©Ÿèƒ½ï¼ˆæ‹¡å¼µæ€§ã‚’è€ƒæ…®ï¼‰
        // å°†æ¥ã®æ‹¡å¼µï¼šæŠ•ç¥¨ãƒ¢ãƒ¼ãƒ‰ã€æ™‚é–“åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ãªã©
        // ========================================
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šé¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰ã‚’ä¿æŒ
        let selectedThemeMode = null;  // 'random' | 'custom' | å°†æ¥çš„ã«ã¯ 'vote' ãªã©
        let customThemeText = null;    // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒã®ãƒ†ã‚­ã‚¹ãƒˆ
        
        // ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
        function selectThemeMode(mode) {
            selectedThemeMode = mode;
            
            if (mode === 'random') {
                // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šç›´æ¥ã‚²ãƒ¼ãƒ é–‹å§‹
                console.log('ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼šã‚²ãƒ¼ãƒ é–‹å§‹');
                startGameWithTheme();
            } else if (mode === 'custom') {
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ†ãƒ¼ãƒå…¥åŠ›ç”»é¢ã¸
                console.log('âœï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼šãƒ†ãƒ¼ãƒå…¥åŠ›ç”»é¢ã¸');
                showScreen('customThemeInputScreen');
                
                // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('customThemeInput').value = '';
                document.getElementById('customThemeCount').textContent = '0';
                
                // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¨­å®š
                const input = document.getElementById('customThemeInput');
                input.addEventListener('input', function() {
                    document.getElementById('customThemeCount').textContent = this.value.length;
                });
            }
            // å°†æ¥ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ
            // else if (mode === 'vote') {
            //     showScreen('themeVoteScreen');
            // }
        }
        
        // ãƒ†ãƒ¼ãƒã‚’æ±ºå®šã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGameWithTheme() {
            if (!currentGameSession) {
                alert('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ãƒ†ãƒ¼ãƒã‚’æ±ºå®š
            let theme;
            let themeMode = selectedThemeMode || 'random';
            
            if (themeMode === 'random') {
                theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            } else if (themeMode === 'custom') {
                theme = customThemeText;
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updates = {
                theme: theme,
                themeMode: themeMode,
                gameStatus: 'inputting',
                rankings: null,               // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã‚¯ãƒªã‚¢
                guesses: null,                // äºˆæƒ³ã‚’ã‚¯ãƒªã‚¢
                results: null,                // çµæœã‚’ã‚¯ãƒªã‚¢
                finishedAt: null,             // çµ‚äº†æ™‚åˆ»ã‚’ã‚¯ãƒªã‚¢
                lastActivityAt: Date.now(),
                updatedAt: new Date().toISOString()
            };
            
            // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’ 'inputting' ã«æ›´æ–°
            const players = Object.keys(currentGameSession.data.players);
            players.forEach(playerId => {
                updates['players/' + playerId + '/status'] = 'inputting';
            });
            
            sessionRef.update(updates)
                .then(() => {
                    console.log('âœ… ãƒ†ãƒ¼ãƒæ±ºå®šã€ã‚²ãƒ¼ãƒ é–‹å§‹');
                    // ãƒªã‚¹ãƒŠãƒ¼ãŒè‡ªå‹•çš„ã«å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
                })
                .catch((error) => {
                    console.error('âŒ ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒã‚’ç¢ºå®šï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
        function confirmCustomTheme() {
            const input = document.getElementById('customThemeInput');
            const theme = input.value.trim();
            
            // ãƒ›ã‚¹ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆã‚‚ã†ä¸€åº¦ã‚ãã¶ã®å ´åˆï¼‰
            if (currentGameSession) {
                const isHost = currentGameSession.data.hostId === userProfile.userId;
                
                if (!isHost) {
                    alert('âŒ ãƒ†ãƒ¼ãƒã®å…¥åŠ›ã¯ãƒ›ã‚¹ãƒˆã®ã¿å¯èƒ½ã§ã™ã€‚');
                    return;
                }
            }
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!theme) {
                alert('âŒ ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (theme.length < 3) {
                alert('âŒ ãƒ†ãƒ¼ãƒã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (theme.length > 50) {
                alert('âŒ ãƒ†ãƒ¼ãƒã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒã‚’ä¿å­˜
            customThemeText = theme;
            
            // ãƒ†ãƒ¼ãƒã‚’æ±ºå®šã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹
            console.log('âœ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒã§ã‚²ãƒ¼ãƒ é–‹å§‹');
            startGameWithTheme();
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒã§ã€Œã‚‚ã†ä¸€åº¦ã‚ãã¶ã€ã‚’ç¶šè¡Œ
        async function playAgainWithCustomTheme() {
            try {
                const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                
                const updates = {
                    theme: customThemeText,       // æ–°ã—ã„ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒ
                    themeMode: 'custom',          // ãƒ¢ãƒ¼ãƒ‰ã‚’ä¿æŒ
                    gameStatus: 'inputting',      // å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚ºã«æˆ»ã‚‹
                    rankings: null,               // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã‚¯ãƒªã‚¢
                    guesses: null,                // äºˆæƒ³ã‚’ã‚¯ãƒªã‚¢
                    results: null,                // çµæœã‚’ã‚¯ãƒªã‚¢
                    finishedAt: null,             // çµ‚äº†æ™‚åˆ»ã‚’ã‚¯ãƒªã‚¢
                    lastActivityAt: Date.now(),   // æ´»å‹•æ™‚åˆ»ã‚’æ›´æ–°
                    updatedAt: new Date().toISOString()
                };
                
                // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                const players = Object.keys(currentGameSession.data.players);
                players.forEach(playerId => {
                    updates['players/' + playerId + '/status'] = 'inputting';
                });
                
                await sessionRef.update(updates);
                console.log('âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                
                // ãƒªã‚¹ãƒŠãƒ¼ãŒè‡ªå‹•çš„ã«å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤ºã—ã¦ãã‚Œã‚‹
            } catch (error) {
                console.error('âŒ playAgainWithCustomTheme ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                backToMain();
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã«æˆ»ã‚‹
        function backToThemeModeSelect() {
            showScreen('themeModeSelectScreen');
        }
        
        // ã‚²ã‚¹ãƒˆã¨ã—ã¦æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ 
        function joinExistingSession(sessionId, sessionData) {
            console.log('ğŸ® ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ å‡¦ç†é–‹å§‹:', sessionId);
            
            const sessionRef = database.ref('gameSessions/' + sessionId);
            
            // ã‚²ã‚¹ãƒˆæƒ…å ±ã‚’è¿½åŠ 
            sessionRef.child('players/' + userProfile.userId).set({
                displayName: userProfile.displayName,
                status: 'waiting'
            })
            .then(() => {
                console.log('âœ… ã‚²ã‚¹ãƒˆå‚åŠ æˆåŠŸ');
                // å¾…æ©Ÿå®¤ã‚’è¡¨ç¤º
                showWaitingRoom(sessionId, sessionData, 'guest');
            })
            .catch((error) => {
                console.error('âŒ ã‚²ã‚¹ãƒˆå‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ å‚åŠ ã‚¨ãƒ©ãƒ¼:\n' + error.message);
            });
        }
        
        // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        function checkExistingSession() {
            const sessionsRef = database.ref('gameSessions');
            
            // è‡ªåˆ†ã¾ãŸã¯ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒé–¢ã‚ã£ã¦ã„ã‚‹å¾…æ©Ÿä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
            sessionsRef.orderByChild('gameStatus').equalTo('waiting').once('value')
                .then((snapshot) => {
                    let existingSession = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        const session = childSnapshot.val();
                        const sessionId = childSnapshot.key;
                        
                        // æ˜ç¤ºçš„ãªhostIdã‚’ä½¿ç”¨ã—ã¦ãƒ›ã‚¹ãƒˆåˆ¤å®š
                        const hostId = session.hostId || Object.keys(session.players || {})[0];
                        const isHost = (hostId === userProfile.userId);
                        
                        // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è‡ªåˆ†ãŒé–¢ã‚ã£ã¦ã„ã‚‹ã‹ç¢ºèª
                        if (isHost) {
                            // è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
                            existingSession = {
                                id: sessionId,
                                data: session,
                                role: 'host'
                            };
                        } else if (session.partnerId === userProfile.userId) {
                            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒä½œæˆã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆè‡ªåˆ†ã¯ã‚²ã‚¹ãƒˆï¼‰
                            existingSession = {
                                id: sessionId,
                                data: session,
                                role: 'guest'
                            };
                        }
                    });
                    
                    if (existingSession) {
                        // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹
                        console.log('ğŸ” æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™ºè¦‹ - role:', existingSession.role, 'hostId:', existingSession.data.hostId, 'userId:', userProfile.userId);
                        
                        if (existingSession.role === 'host') {
                            // ãƒ›ã‚¹ãƒˆï¼šæ—¢å­˜ã®å¾…æ©Ÿå®¤ã‚’è¡¨ç¤º
                            showWaitingRoom(existingSession.id, existingSession.data, 'host');
                        } else {
                            // ã‚²ã‚¹ãƒˆï¼šè‡ªå‹•çš„ã«å¾…æ©Ÿå®¤ã«å‚åŠ 
                            console.log('ğŸ® ã‚²ã‚¹ãƒˆã¨ã—ã¦æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ã¾ã™');
                            joinExistingSession(existingSession.id, existingSession.data);
                        }
                    } else {
                        // æ–°ã—ãã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
                        // ç›´æ¥å¾…æ©Ÿå®¤ã‚’ä½œæˆï¼ˆãƒ†ãƒ¼ãƒãƒ»ãƒ¢ãƒ¼ãƒ‰æœªå®šï¼‰
                        console.log('ğŸ® æ–°è¦ãƒ›ã‚¹ãƒˆã¨ã—ã¦å¾…æ©Ÿå®¤ã‚’ä½œæˆ');
                        createWaitingSession();
                    }
                })
                .catch((error) => {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // å¾…æ©Ÿã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆãƒ†ãƒ¼ãƒãƒ»ãƒ¢ãƒ¼ãƒ‰æœªå®šï¼‰
        function createWaitingSession() {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆãƒ†ãƒ¼ãƒãƒ»ãƒ¢ãƒ¼ãƒ‰æœªå®šï¼‰
            const sessionData = {
                mode: 'realtime',
                theme: null,  // å¾Œã§ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾Œã«æ±ºå®š
                themeMode: null,  // å¾Œã§ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾Œã«æ±ºå®š
                hostId: userProfile.userId,
                gameStatus: 'waiting',  // waiting â†’ waiting-guest â†’ inputting â†’ guessing â†’ finished
                createdAt: new Date().toISOString(),
                lastActivityAt: Date.now(),
                players: {}
            };
            
            // è‡ªåˆ†ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã‚’è¿½åŠ 
            sessionData.players[userProfile.userId] = {
                displayName: userProfile.displayName,
                status: 'waiting'
            };
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã‚’ä¿å­˜
            sessionData.partnerId = currentUser.partnerId;
            
            // Firebaseã«ä¿å­˜
            const sessionsRef = database.ref('gameSessions');
            const newSessionRef = sessionsRef.push();
            
            newSessionRef.set(sessionData)
                .then(() => {
                    console.log('âœ… å¾…æ©Ÿã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ:', newSessionRef.key);
                    showWaitingRoom(newSessionRef.key, sessionData, 'host');
                })
                .catch((error) => {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚²ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆãƒ¢ãƒ¼ãƒ‰é¸æŠå¾Œï¼‰
        function createGameSession() {
            // ãƒ†ãƒ¼ãƒã‚’æ±ºå®šï¼ˆãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ï¼‰
            let theme;
            let themeMode = selectedThemeMode || 'random';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ©ãƒ³ãƒ€ãƒ 
            
            if (themeMode === 'random') {
                // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ—ãƒªã‚»ãƒƒãƒˆãƒ†ãƒ¼ãƒã‹ã‚‰é¸æŠ
                theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            } else if (themeMode === 'custom') {
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ†ãƒ¼ãƒ
                theme = customThemeText;
            }
            // å°†æ¥ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ
            // else if (themeMode === 'vote') {
            //     theme = selectedVoteTheme;  // æŠ•ç¥¨ã§é¸ã°ã‚ŒãŸãƒ†ãƒ¼ãƒ
            // }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆæ‹¡å¼µæ€§ã‚’è€ƒæ…®ã—ãŸæ§‹é€ ï¼‰
            const sessionData = {
                mode: 'realtime',
                theme: theme,
                themeMode: themeMode,  // â† å°†æ¥ã®åˆ†æãƒ»æ©Ÿèƒ½æ‹¡å¼µã®ãŸã‚
                hostId: userProfile.userId,  // ãƒ›ã‚¹ãƒˆIDã‚’æ˜ç¤ºçš„ã«ä¿å­˜ï¼ˆé‡è¦ï¼‰
                gameStatus: 'waiting',  // waiting â†’ inputting â†’ guessing â†’ finished
                createdAt: new Date().toISOString(),
                lastActivityAt: Date.now(),  // æœ€å¾Œã®æ“ä½œæ™‚åˆ»ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¤å®šç”¨ï¼‰
                players: {}
            };
            
            // è‡ªåˆ†ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã‚’è¿½åŠ 
            sessionData.players[userProfile.userId] = {
                displayName: userProfile.displayName,
                status: 'waiting'  // waiting â†’ inputting â†’ completed
            };
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã‚’ä¿å­˜ï¼ˆå‚åŠ æ™‚ã«è¿½åŠ ã•ã‚Œã‚‹ï¼‰
            sessionData.partnerId = currentUser.partnerId;
            
            // Firebaseã«ä¿å­˜
            const sessionsRef = database.ref('gameSessions');
            const newSessionRef = sessionsRef.push();
            
            newSessionRef.set(sessionData)
                .then(() => {
                    console.log('âœ… ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ:', newSessionRef.key);
                    showWaitingRoom(newSessionRef.key, sessionData, 'host');
                })
                .catch((error) => {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚²ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // å¾…æ©Ÿãƒ«ãƒ¼ãƒ è¡¨ç¤º
        function showWaitingRoom(sessionId, sessionData, role) {
            currentGameSession = {
                id: sessionId,
                data: sessionData,
                role: role  // 'host' ã¾ãŸã¯ 'guest'
            };
            
            if (role === 'host') {
                // ãƒ›ã‚¹ãƒˆï¼šå¾…æ©Ÿç”»é¢
                document.getElementById('waitingArea').style.display = 'block';
                document.getElementById('joinArea').style.display = 'none';
                
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åã‚’å–å¾—
                database.ref('users/' + currentUser.partnerId).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            document.getElementById('waitingMessage').textContent = 
                                partner.displayName + 'ã•ã‚“ï¼ˆã‚²ã‚¹ãƒˆï¼‰ã‚’å¾…ã£ã¦ã„ã¾ã™...\n\nã‚ãªãŸï¼š' + userProfile.displayName + 'ï¼ˆãƒ›ã‚¹ãƒˆï¼‰';
                        }
                    });
            } else {
                // ã‚²ã‚¹ãƒˆï¼šå‚åŠ ç¢ºèªç”»é¢
                document.getElementById('waitingArea').style.display = 'none';
                document.getElementById('joinArea').style.display = 'block';
                
                // ãƒ›ã‚¹ãƒˆåã‚’å–å¾—
                const hostId = sessionData.hostId || Object.keys(sessionData.players)[0];
                database.ref('users/' + hostId).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const host = snapshot.val();
                            document.getElementById('joinMessage').textContent = 
                                host.displayName + 'ã•ã‚“ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ãŒå¾…ã£ã¦ã„ã¾ã™ï¼\n\nã‚ãªãŸï¼š' + userProfile.displayName + 'ï¼ˆã‚²ã‚¹ãƒˆï¼‰';
                        }
                    });
            }
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('waitingRoomScreen');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–é–‹å§‹
            startSessionListener(sessionId);
        }
        
        // ã‚²ãƒ¼ãƒ ã«å‚åŠ 
        function joinGame() {
            if (!currentGameSession) {
                alert('âŒ ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ã‚²ã‚¹ãƒˆã‚’ players ã«è¿½åŠ  & ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            
            const updates = {
                gameStatus: 'waiting-guest',  // ã‚²ã‚¹ãƒˆå‚åŠ æ¸ˆã¿ã€ãƒ›ã‚¹ãƒˆã®ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾…ã¡
                lastActivityAt: Date.now()
            };
            
            // è‡ªåˆ†ï¼ˆã‚²ã‚¹ãƒˆï¼‰ã‚’playersã«è¿½åŠ 
            updates['players/' + userProfile.userId] = {
                displayName: userProfile.displayName,
                status: 'waiting'
            };
            
            sessionRef.update(updates)
                .then(() => {
                    console.log('âœ… ã‚²ãƒ¼ãƒ å‚åŠ æˆåŠŸï¼ˆãƒ›ã‚¹ãƒˆã®ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾…ã¡ï¼‰');
                    // ãƒ›ã‚¹ãƒˆã®ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚’å¾…ã¤ï¼ˆãƒªã‚¹ãƒŠãƒ¼ãŒè‡ªå‹•çš„ã«åå¿œï¼‰
                })
                .catch((error) => {
                    console.error('âŒ ã‚²ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ å‚åŠ ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–é–‹å§‹
        function startSessionListener(sessionId) {
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°è§£é™¤
            if (currentSessionRef) {
                currentSessionRef.off();
                currentSessionRef = null;
            }
            
            currentSessionRef = database.ref('gameSessions/' + sessionId);
            
            currentSessionRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    console.log('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    
                    // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
                    if (currentSessionRef) {
                        currentSessionRef.off();
                        currentSessionRef = null;
                    }
                    
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
                    currentGameSession = null;
                    alert('ã‚²ãƒ¼ãƒ ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                    showScreen('mainScreen');
                    return;
                }
                
                const sessionData = snapshot.val();
                currentGameSession.data = sessionData;
                
                console.log('ğŸ“¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°:', sessionData.gameStatus);
                
                // ã‚²ãƒ¼ãƒ ãŒä¸­æ–­ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
                if (sessionData.gameAborted && sessionData.abortedBy !== userProfile.userId) {
                    console.log('âš ï¸ ç›¸æ‰‹ãŒã‚²ãƒ¼ãƒ ã‚’ä¸­æ–­ã—ã¾ã—ãŸ');
                    
                    // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
                    if (currentSessionRef) {
                        currentSessionRef.off();
                        currentSessionRef = null;
                    }
                    
                    currentGameSession = null;
                    alert('ãŠç›¸æ‰‹ãŒã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                    showScreen('mainScreen');
                    return;
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
                switch (sessionData.gameStatus) {
                    case 'waiting':
                        // å¾…æ©Ÿä¸­ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
                        break;
                        
                    case 'waiting-guest':
                        // ã‚²ã‚¹ãƒˆå‚åŠ æ¸ˆã¿ã€ãƒ›ã‚¹ãƒˆã®ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾…ã¡
                        if (currentGameSession.role === 'host') {
                            // ãƒ›ã‚¹ãƒˆï¼šãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã‚’è¡¨ç¤º
                            console.log('ğŸ² ã‚²ã‚¹ãƒˆå‚åŠ å®Œäº†ã€ãƒ›ã‚¹ãƒˆã«ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã‚’è¡¨ç¤º');
                            showScreen('themeModeSelectScreen');
                        } else {
                            // ã‚²ã‚¹ãƒˆï¼šå¾…æ©Ÿç”»é¢ã‚’è¡¨ç¤º
                            console.log('â³ ã‚²ã‚¹ãƒˆï¼šãƒ›ã‚¹ãƒˆã®ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚’å¾…æ©Ÿä¸­');
                            // å¾…æ©Ÿç”»é¢ã«ã€Œãƒ›ã‚¹ãƒˆãŒãŠé¡Œã‚’é¸æŠä¸­...ã€ã¨è¡¨ç¤º
                            document.getElementById('waitingArea').style.display = 'block';
                            document.getElementById('joinArea').style.display = 'none';
                            document.getElementById('waitingMessage').textContent = 
                                'ãƒ›ã‚¹ãƒˆãŒãŠé¡Œã‚’é¸æŠä¸­...\n\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
                            showScreen('waitingRoomScreen');
                        }
                        break;
                        
                    case 'inputting':
                        // å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º
                        // æ—¢ã«å…¥åŠ›ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€é€²è¡ŒçŠ¶æ³ã ã‘æ›´æ–°
                        const currentScreen = document.querySelector('.screen[style*="display: block"]');
                        if (currentScreen && currentScreen.id === 'gameInputScreen') {
                            // é€²è¡ŒçŠ¶æ³ã®ã¿æ›´æ–°ï¼ˆå…¥åŠ›æ¬„ã¯ãã®ã¾ã¾ï¼‰
                            updateGameProgress(sessionData);
                        } else {
                            // åˆå›è¡¨ç¤ºæ™‚ã®ã¿ç”»é¢å…¨ä½“ã‚’è¡¨ç¤º
                            showGameInputScreen(sessionData);
                        }
                        break;
                        
                    case 'guessing':
                        // äºˆæƒ³ãƒ•ã‚§ãƒ¼ã‚º
                        // æ—¢ã«äºˆæƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€é€²è¡ŒçŠ¶æ³ã ã‘æ›´æ–°
                        const currentGuessScreen = document.querySelector('.screen[style*="display: block"]');
                        if (currentGuessScreen && currentGuessScreen.id === 'guessScreen') {
                            // é€²è¡ŒçŠ¶æ³ã®ã¿æ›´æ–°ï¼ˆäºˆæƒ³å†…å®¹ã¯ãã®ã¾ã¾ï¼‰
                            updateGameProgress(sessionData);
                        } else {
                            // åˆå›è¡¨ç¤ºæ™‚ã®ã¿ç”»é¢å…¨ä½“ã‚’è¡¨ç¤º
                            showGuessScreen(sessionData);
                        }
                        break;
                        
                    case 'finished':
                        // çµæœè¡¨ç¤º
                        showResultScreen(sessionData);
                        break;
                }
            });
        }
        
        // å¾…æ©Ÿãƒ«ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        async function cancelWaitingRoom() {
            try {
                console.log('â¹ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                
                // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
                if (currentSessionRef) {
                    currentSessionRef.off();
                    currentSessionRef = null;
                }
                
                // ãƒ›ã‚¹ãƒˆã®å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆéåŒæœŸå‡¦ç†ã‚’å¾…ã¤ï¼‰
                if (currentGameSession && currentGameSession.role === 'host') {
                    const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                    await sessionRef.remove();
                    console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤æˆåŠŸ');
                }
                
                currentGameSession = null;
                
                // ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
                showScreen('mainScreen');
            } catch (error) {
                console.error('âŒ cancelWaitingRoom ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
                showScreen('mainScreen');
            }
        }
        
        // ã‚²ãƒ¼ãƒ å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
        function showGameInputScreen(sessionData) {
            // ãƒ†ãƒ¼ãƒã‚’è¡¨ç¤º
            document.getElementById('gameTheme').textContent = sessionData.theme;
            
            // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
            updateGameProgress(sessionData);
            
            // DOMé †åºã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒã‚°ä¿®æ­£ï¼š2ã‚²ãƒ¼ãƒ ç›®ã§é †ä½ãŒä¿æŒã•ã‚Œã‚‹å•é¡Œï¼‰
            resetGameInputOrder();
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            const container = document.getElementById('gameRankingForm');
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.value = '';
                }
            }
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const submitButton = document.getElementById('submitGameRankingButton');
            submitButton.textContent = 'ğŸ’¾ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é€ä¿¡';
            submitButton.disabled = false;
            submitButton.style.background = '';
            submitButton.style.cursor = '';
            submitButton.style.opacity = '';
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('gameInputScreen');
            
            // SortableJSã‚’åˆæœŸåŒ–ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ã§ä¸¦ã³æ›¿ãˆå¯èƒ½ã«ï¼‰
            initGameInputSortable();
            
            // è‡ªåˆ†ãŒæ—¢ã«å…¥åŠ›æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (sessionData.rankings && sessionData.rankings[userProfile.userId]) {
                // å…¥åŠ›æ¸ˆã¿ã®å ´åˆã¯ã€å…¥åŠ›å†…å®¹ã‚’è¡¨ç¤ºï¼ˆæ­£ã—ã„é †ä½ã§è¨­å®šï¼‰
                const myRanking = sessionData.rankings[userProfile.userId];
                
                for (let i = 0; i < items.length; i++) {
                    const input = items[i].querySelector('.rank-input');
                    if (input) {
                        input.value = myRanking[(i + 1).toString()] || '';
                    }
                }
                
                // é€ä¿¡æ¸ˆã¿ã®å ´åˆã¯ã€ãƒœã‚¿ãƒ³ã‚’ã€Œå¾…æ©Ÿä¸­ã€çŠ¶æ…‹ã«
                submitButton.textContent = 'â³ ãŠç›¸æ‰‹ã®å›ç­”å¾…ã¡...';
                submitButton.disabled = true;
                submitButton.style.background = '#999';
                submitButton.style.cursor = 'not-allowed';
                submitButton.style.opacity = '0.6';
                
                // ğŸ”’ é€ä¿¡æ¸ˆã¿ã®å ´åˆã¯ã€ç·¨é›†ã‚’ãƒ­ãƒƒã‚¯ï¼ˆãƒã‚°ä¿®æ­£ï¼‰
                // SortableJSåˆæœŸåŒ–å¾Œã«ãƒ­ãƒƒã‚¯ã™ã‚‹ï¼ˆsetTimeout ã§å°‘ã—é…å»¶ï¼‰
                setTimeout(() => {
                    lockGameInput();
                }, 100);
            } else {
                // é€ä¿¡æ¸ˆã¿ã§ãªã„å ´åˆã¯ã€å¿…ãšãƒ­ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆå‰å›ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ï¼‰
                setTimeout(() => {
                    unlockGameInput();
                }, 100);
            }
            
            // 1ä½ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆDOMé †åºã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‰
            setTimeout(() => {
                const firstInput = container.children[0]?.querySelector('.rank-input');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        // DOMé †åºã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ­£ã—ã„é †ç•ªã«ä¸¦ã¹ç›´ã™ï¼‰
        function resetGameInputOrder() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            // å…¨ã¦ã®è¦ç´ ã‚’å–å¾—
            const items = Array.from(container.children);
            
            // data-rankå±æ€§ã§ã‚½ãƒ¼ãƒˆï¼ˆæ­£ã—ã„é †åºï¼š1, 2, 3, 4, 5ï¼‰
            items.sort((a, b) => {
                const rankA = parseInt(a.getAttribute('data-rank')) || 0;
                const rankB = parseInt(b.getAttribute('data-rank')) || 0;
                return rankA - rankB;
            });
            
            // DOMã‹ã‚‰ä¸€æ—¦å‰Šé™¤
            items.forEach(item => item.remove());
            
            // æ­£ã—ã„é †åºã§å†è¿½åŠ 
            items.forEach(item => container.appendChild(item));
            
            // é †ä½ç•ªå·ã¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°
            updateGameInputRankNumbers();
            
            console.log('âœ… DOMé †åºã‚’ãƒªã‚»ãƒƒãƒˆå®Œäº†');
        }
        
        // å›ç­”å…¥åŠ›ç”»é¢ã§SortableJSã‚’åˆæœŸåŒ–ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ã§ä¸¦ã³æ›¿ãˆï¼‰
        function initGameInputSortable() {
            const container = document.getElementById('gameRankingForm');
            
            if (!container) {
                console.error('âŒ gameRankingForm ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ—¢å­˜ã®Sortableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
            if (gameInputSortableInstance) {
                gameInputSortableInstance.destroy();
                gameInputSortableInstance = null;
            }
            
            // SortableJSåˆæœŸåŒ–
            gameInputSortableInstance = new Sortable(container, {
                animation: 150,                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦
                delay: 50,                         // 50msé•·æŠ¼ã—ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                delayOnTouchOnly: true,            // ã‚¹ãƒãƒ›ã®ã¿é•·æŠ¼ã—åˆ¤å®š
                forceFallback: true,               // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ©ãƒƒã‚°æœ‰åŠ¹åŒ–
                fallbackOnBody: true,              // bodyè¦ç´ ã«è¿½åŠ ï¼ˆæŒ‡ã«è¿½å¾“ï¼‰
                swapThreshold: 0.65,               // å…¥ã‚Œæ›¿ãˆæ„Ÿåº¦ï¼ˆ0.65 = 65%ï¼‰
                handle: '.drag-handle',            // â‰¡ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã§ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
                ghostClass: 'sortable-ghost',      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                chosenClass: 'sortable-chosen',    // é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                dragClass: 'sortable-drag',        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã‚¹ã‚¿ã‚¤ãƒ«
                fallbackClass: 'sortable-fallback',// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«
                
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«é †ä½ç•ªå·ã‚’æ›´æ–°
                onEnd: function() {
                    updateGameInputRankNumbers();
                }
            });
            
            console.log('âœ… SortableJS åˆæœŸåŒ–å®Œäº†ï¼ˆå›ç­”å…¥åŠ›ï¼‰');
        }
        
        // å›ç­”å…¥åŠ›ç”»é¢ã®é †ä½ç•ªå·ã‚’æ›´æ–°
        function updateGameInputRankNumbers() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const rankLabel = items[i].querySelector('.rank-label');
                if (rankLabel) {
                    rankLabel.textContent = (i + 1) + 'ä½';
                }
                
                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚‚æ›´æ–°ï¼ˆãƒã‚°ä¿®æ­£ï¼‰
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.placeholder = (i + 1) + 'ä½ã‚’å…¥åŠ›ï¼ˆ50æ–‡å­—ã¾ã§ï¼‰';
                }
                
                // data-rankå±æ€§ã‚‚æ›´æ–°
                items[i].setAttribute('data-rank', i + 1);
            }
        }
        
        // å›ç­”å…¥åŠ›ã‚’ãƒ­ãƒƒã‚¯ï¼ˆé€ä¿¡å¾Œã®ç·¨é›†é˜²æ­¢ï¼‰
        function lockGameInput() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            // SortableJSã‚’ç„¡åŠ¹åŒ–
            if (gameInputSortableInstance) {
                gameInputSortableInstance.option("disabled", true);
                console.log('âœ… å›ç­”å…¥åŠ›ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹åŒ–');
            }
            
            // å…¨ã¦ã®å…¥åŠ›æ¬„ã‚’disabled
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.disabled = true;
                    input.style.background = '#f0f0f0';
                    input.style.color = '#999';
                }
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’éè¡¨ç¤º
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = 'none';
                }
            }
            
            console.log('âœ… å›ç­”å…¥åŠ›ã‚’ãƒ­ãƒƒã‚¯å®Œäº†');
        }
        
        // å›ç­”å…¥åŠ›ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆæ–°ã—ã„ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ï¼‰
        function unlockGameInput() {
            const container = document.getElementById('gameRankingForm');
            if (!container) return;
            
            // SortableJSã‚’æœ‰åŠ¹åŒ–
            if (gameInputSortableInstance) {
                gameInputSortableInstance.option("disabled", false);
                console.log('âœ… å›ç­”å…¥åŠ›ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’æœ‰åŠ¹åŒ–');
            }
            
            // å…¨ã¦ã®å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹åŒ–
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                if (input) {
                    input.disabled = false;
                    input.style.background = '';
                    input.style.color = '';
                }
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’è¡¨ç¤º
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = '';
                }
            }
            
            console.log('âœ… å›ç­”å…¥åŠ›ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤å®Œäº†');
        }
        
        // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
        function updateGameProgress(sessionData) {
            const players = sessionData.players || {};
            const playerIds = Object.keys(players);
            
            let progressHtml = '';
            
            playerIds.forEach((playerId) => {
                const player = players[playerId];
                const isMe = playerId === userProfile.userId;
                const displayName = isMe ? 'ã‚ãªãŸ' : player.displayName;
                
                let statusIcon = '';
                let statusText = '';
                let statusColor = '#999';
                
                if (sessionData.gameStatus === 'inputting') {
                    if (sessionData.rankings && sessionData.rankings[playerId]) {
                        statusIcon = 'âœ…';
                        statusText = 'å…¥åŠ›å®Œäº†';
                        statusColor = '#50C878';
                    } else {
                        statusIcon = 'â³';
                        statusText = 'å…¥åŠ›ä¸­...';
                        statusColor = '#FF9800';
                    }
                } else if (sessionData.gameStatus === 'guessing') {
                    if (sessionData.guesses && sessionData.guesses[playerId]) {
                        statusIcon = 'âœ…';
                        statusText = 'äºˆæƒ³å®Œäº†';
                        statusColor = '#50C878';
                    } else {
                        statusIcon = 'ğŸ¤”';
                        statusText = 'äºˆæƒ³ä¸­...';
                        statusColor = '#FF9800';
                    }
                }
                
                progressHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0;">';
                progressHtml += '<span style="color: #666; font-size: 14px;">' + statusIcon + ' ' + displayName + '</span>';
                progressHtml += '<span style="color: ' + statusColor + '; font-size: 13px; font-weight: bold;">' + statusText + '</span>';
                progressHtml += '</div>';
            });
            
            const contentId = sessionData.gameStatus === 'inputting' ? 'gameProgressContent' : 'guessProgressContent';
            document.getElementById(contentId).innerHTML = progressHtml;
        }
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡
        function submitGameRanking() {
            // ä¸¦ã³æ›¿ãˆå¾Œã®DOMé †åºã§å…¥åŠ›å€¤ã‚’å–å¾—
            const container = document.getElementById('gameRankingForm');
            const items = container.children;
            const rankings = [];
            
            // å„é …ç›®ã®å…¥åŠ›å€¤ã‚’ãƒã‚§ãƒƒã‚¯
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('.rank-input');
                const value = input ? input.value.trim() : '';
                
                if (value === '') {
                    alert((i + 1) + 'ä½ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                    if (input) input.focus();
                    return;
                }
                rankings.push(value);
            }
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆä¸¦ã³æ›¿ãˆå¾Œã®é †åºï¼‰
            const rankingData = {
                "1": rankings[0],
                "2": rankings[1],
                "3": rankings[2],
                "4": rankings[3],
                "5": rankings[4]
            };
            
            // Firebaseã«ä¿å­˜
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updateData = {};
            updateData['rankings/' + userProfile.userId] = rankingData;
            updateData['players/' + userProfile.userId + '/status'] = 'completed';
            updateData['lastActivityAt'] = Date.now();  // æ´»å‹•æ™‚åˆ»ã‚’æ›´æ–°
            
            sessionRef.update(updateData)
                .then(() => {
                    console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡æˆåŠŸ');
                    
                    // ãƒœã‚¿ãƒ³ã‚’ã€Œå¾…æ©Ÿä¸­ã€çŠ¶æ…‹ã«å¤‰æ›´
                    const button = document.getElementById('submitGameRankingButton');
                    button.textContent = 'â³ ãŠç›¸æ‰‹ã®å›ç­”å¾…ã¡...';
                    button.disabled = true;
                    button.style.background = '#999';
                    button.style.cursor = 'not-allowed';
                    button.style.opacity = '0.6';
                    
                    // ğŸ”’ é€ä¿¡å¾Œã¯ç·¨é›†ã‚’ãƒ­ãƒƒã‚¯ï¼ˆãƒã‚°ä¿®æ­£ï¼‰
                    lockGameInput();
                    
                    // ä¸¡è€…ãŒå…¥åŠ›å®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    return sessionRef.once('value');
                })
                .then((snapshot) => {
                    const sessionData = snapshot.val();
                    const rankings = sessionData.rankings || {};
                    const players = Object.keys(sessionData.players);
                    
                    // å…¨å“¡ãŒå…¥åŠ›å®Œäº†ã—ãŸã‹
                    if (players.every(playerId => rankings[playerId])) {
                        // äºˆæƒ³ãƒ•ã‚§ãƒ¼ã‚ºã¸ç§»è¡Œ
                        return sessionRef.update({
                            gameStatus: 'guessing',
                            lastActivityAt: Date.now()  // æ´»å‹•æ™‚åˆ»ã‚’æ›´æ–°
                        });
                    }
                })
                .catch((error) => {
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // äºˆæƒ³ç”»é¢ã‚’è¡¨ç¤º
        function showGuessScreen(sessionData) {
            // ãƒ†ãƒ¼ãƒã‚’è¡¨ç¤º
            document.getElementById('guessTheme').textContent = sessionData.theme;
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åã‚’å–å¾—
            const partnerId = currentUser.partnerId;
            database.ref('users/' + partnerId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const partner = snapshot.val();
                        document.getElementById('guessPartnerName').textContent = partner.displayName;
                    }
                });
            
            // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
            updateGameProgress(sessionData);
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const submitButton = document.getElementById('submitGuessButton');
            submitButton.textContent = 'âœ… äºˆæƒ³ã‚’é€ä¿¡';
            submitButton.disabled = false;
            submitButton.style.background = '';
            submitButton.style.cursor = '';
            submitButton.style.opacity = '';
            
            // è‡ªåˆ†ãŒæ—¢ã«äºˆæƒ³æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            const alreadySubmitted = sessionData.guesses && sessionData.guesses[userProfile.userId];
            if (alreadySubmitted) {
                // é€ä¿¡æ¸ˆã¿ã®å ´åˆã¯ã€ãƒœã‚¿ãƒ³ã‚’ã€Œå¾…æ©Ÿä¸­ã€çŠ¶æ…‹ã«
                submitButton.textContent = 'â³ ãŠç›¸æ‰‹ã®å›ç­”å¾…ã¡...';
                submitButton.disabled = true;
                submitButton.style.background = '#999';
                submitButton.style.cursor = 'not-allowed';
                submitButton.style.opacity = '0.6';
            }
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°é …ç›®ã‚’å–å¾—
            const partnerRanking = sessionData.rankings[partnerId];
            if (!partnerRanking) {
                alert('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // é …ç›®ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const items = [];
            for (let i = 1; i <= 5; i++) {
                items.push(partnerRanking[i.toString()]);
            }
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yates ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }
            
            // ä¸¦ã³æ›¿ãˆã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
            createGuessRankingUI(items);
            
            // ğŸ”’ é€ä¿¡æ¸ˆã¿ã®å ´åˆã¯ã€ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ãƒ­ãƒƒã‚¯ï¼ˆãƒã‚°ä¿®æ­£ï¼‰
            if (alreadySubmitted) {
                setTimeout(() => {
                    lockGuessInput();
                }, 100);
            } else {
                // é€ä¿¡æ¸ˆã¿ã§ãªã„å ´åˆã¯ã€ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆå‰å›ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ï¼‰
                setTimeout(() => {
                    unlockGuessInput();
                }, 100);
            }
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('guessScreen');
        }
        
        // äºˆæƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°UIã‚’ç”Ÿæˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œãƒ»SortableJSä½¿ç”¨ï¼‰
        function createGuessRankingUI(items) {
            const container = document.getElementById('guessRankingArea');
            container.innerHTML = '';
            
            // æ—¢å­˜ã®Sortableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
            if (gameSortableInstance) {
                gameSortableInstance.destroy();
                gameSortableInstance = null;
            }
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-item', item);
                itemDiv.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // é †ä½ç•ªå·
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + 'ä½';
                rankSpan.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ãƒ†ã‚­ã‚¹ãƒˆ
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ï¼ˆâ‰¡ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’å³ç«¯ã«é…ç½®
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = 'â‰¡';
                handleSpan.style.cssText = 'margin-left: auto; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(handleSpan);
                
                container.appendChild(itemDiv);
            });
            
            // ğŸŒŸ SortableJS ã‚’åˆæœŸåŒ–
            gameSortableInstance = new Sortable(container, {
                animation: 150,                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦
                delay: 50,                         // 50msé•·æŠ¼ã—ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                delayOnTouchOnly: true,            // ã‚¹ãƒãƒ›ã®ã¿é•·æŠ¼ã—åˆ¤å®š
                forceFallback: true,               // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ©ãƒƒã‚°æœ‰åŠ¹åŒ–
                fallbackOnBody: true,              // bodyè¦ç´ ã«è¿½åŠ ï¼ˆæŒ‡ã«è¿½å¾“ï¼‰
                swapThreshold: 0.65,               // å…¥ã‚Œæ›¿ãˆæ„Ÿåº¦ï¼ˆ0.65 = 65%ï¼‰
                handle: '.drag-handle',            // â‰¡ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã§ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
                ghostClass: 'sortable-ghost',      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                chosenClass: 'sortable-chosen',    // é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                dragClass: 'sortable-drag',        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã‚¹ã‚¿ã‚¤ãƒ«
                fallbackClass: 'sortable-fallback',// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«
                
                // è¦ç´ ç§»å‹•ä¸­ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é †ä½æ›´æ–°
                onChange: function(evt) {
                    updateGameRankNumbers();
                },
                
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«é †ä½ç•ªå·ã‚’æ›´æ–°
                onEnd: function() {
                    updateGameRankNumbers();
                }
            });
            
            console.log('âœ… SortableJS åˆæœŸåŒ–å®Œäº†ï¼ˆãµãŸã‚Šã§ã‚ãã¶ï¼‰');
            
            // ç¾åœ¨ã®é …ç›®ãƒªã‚¹ãƒˆã‚’ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
            container.setAttribute('data-items', JSON.stringify(items));
        }
        
        // é †ä½ç•ªå·ã‚’æ›´æ–°ï¼ˆã‚²ãƒ¼ãƒ ç”¨ãƒ»SortableJSå¯¾å¿œï¼‰
        function updateGameRankNumbers() {
            const container = document.getElementById('guessRankingArea');
            if (!container) return;
            
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const rankSpan = items[i].querySelector('.rank-number');
                if (rankSpan) {
                    rankSpan.textContent = (i + 1) + 'ä½';
                }
            }
        }
        
        // äºˆæƒ³å…¥åŠ›ã‚’ãƒ­ãƒƒã‚¯ï¼ˆé€ä¿¡å¾Œã®ç·¨é›†é˜²æ­¢ï¼‰
        function lockGuessInput() {
            const container = document.getElementById('guessRankingArea');
            if (!container) return;
            
            // SortableJSã‚’ç„¡åŠ¹åŒ–
            if (gameSortableInstance) {
                gameSortableInstance.option("disabled", true);
                console.log('âœ… äºˆæƒ³ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹åŒ–');
            }
            
            // å…¨ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’éè¡¨ç¤º
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = 'none';
                }
                
                // é …ç›®å…¨ä½“ã‚’ã€Œãƒ­ãƒƒã‚¯æ¸ˆã¿ã€ã®è¦‹ãŸç›®ã«
                items[i].style.opacity = '0.6';
            }
            
            console.log('âœ… äºˆæƒ³å…¥åŠ›ã‚’ãƒ­ãƒƒã‚¯å®Œäº†');
        }
        
        // äºˆæƒ³å…¥åŠ›ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆæ–°ã—ã„ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ï¼‰
        function unlockGuessInput() {
            const container = document.getElementById('guessRankingArea');
            if (!container) return;
            
            // SortableJSã‚’æœ‰åŠ¹åŒ–
            if (gameSortableInstance) {
                gameSortableInstance.option("disabled", false);
                console.log('âœ… äºˆæƒ³ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’æœ‰åŠ¹åŒ–');
            }
            
            // å…¨ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’è¡¨ç¤º
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const handle = items[i].querySelector('.drag-handle');
                if (handle) {
                    handle.style.display = '';
                }
                
                // é …ç›®ã®è¦‹ãŸç›®ã‚’å…ƒã«æˆ»ã™
                items[i].style.opacity = '';
            }
            
            console.log('âœ… äºˆæƒ³å…¥åŠ›ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤å®Œäº†');
        }
        
        // é …ç›®ã‚’ç§»å‹•ï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰
        function moveItem(index, direction) {
            const container = document.getElementById('guessRankingArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            const newIndex = index + direction;
            
            // ç¯„å›²ãƒã‚§ãƒƒã‚¯
            if (newIndex < 0 || newIndex >= items.length) {
                return;
            }
            
            // å…¥ã‚Œæ›¿ãˆ
            [items[index], items[newIndex]] = [items[newIndex], items[index]];
            
            // UIã‚’å†ç”Ÿæˆ
            createGuessRankingUI(items);
        }
        
        // äºˆæƒ³ã‚’é€ä¿¡
        function submitGuess() {
            const container = document.getElementById('guessRankingArea');
            
            // SortableJSå¯¾å¿œï¼šcontainer.childrenã‹ã‚‰ç›´æ¥å–å¾—
            const itemElements = container.children;
            const items = [];
            for (let i = 0; i < itemElements.length; i++) {
                items.push(itemElements[i].getAttribute('data-item'));
            }
            
            if (!items || items.length !== 5) {
                alert('âŒ äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (!confirm('ã“ã®é †ç•ªã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\n' + 
                         '1ä½: ' + items[0] + '\n' +
                         '2ä½: ' + items[1] + '\n' +
                         '3ä½: ' + items[2] + '\n' +
                         '4ä½: ' + items[3] + '\n' +
                         '5ä½: ' + items[4])) {
                return;
            }
            
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const guessData = {
                "1": items[0],
                "2": items[1],
                "3": items[2],
                "4": items[3],
                "5": items[4]
            };
            
            // Firebaseã«ä¿å­˜
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updateData = {};
            updateData['guesses/' + userProfile.userId] = guessData;
            updateData['players/' + userProfile.userId + '/status'] = 'completed';
            updateData['lastActivityAt'] = Date.now();  // æ´»å‹•æ™‚åˆ»ã‚’æ›´æ–°
            
            sessionRef.update(updateData)
                .then(() => {
                    console.log('âœ… äºˆæƒ³é€ä¿¡æˆåŠŸ');
                    
                    // ãƒœã‚¿ãƒ³ã‚’ã€Œå¾…æ©Ÿä¸­ã€çŠ¶æ…‹ã«å¤‰æ›´
                    const button = document.getElementById('submitGuessButton');
                    button.textContent = 'â³ ãŠç›¸æ‰‹ã®å›ç­”å¾…ã¡...';
                    button.disabled = true;
                    button.style.background = '#999';
                    button.style.cursor = 'not-allowed';
                    button.style.opacity = '0.6';
                    
                    // ğŸ”’ é€ä¿¡å¾Œã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ãƒ­ãƒƒã‚¯ï¼ˆãƒã‚°ä¿®æ­£ï¼‰
                    lockGuessInput();
                    
                    // ä¸¡è€…ãŒäºˆæƒ³å®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    return sessionRef.once('value');
                })
                .then((snapshot) => {
                    const sessionData = snapshot.val();
                    const guesses = sessionData.guesses || {};
                    const players = Object.keys(sessionData.players);
                    
                    // å…¨å“¡ãŒäºˆæƒ³å®Œäº†ã—ãŸã‹
                    if (players.every(playerId => guesses[playerId])) {
                        // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                        const results = calculateScores(sessionData);
                        
                        // çµæœã‚’ä¿å­˜ã—ã¦å®Œäº†çŠ¶æ…‹ã¸
                        return sessionRef.update({
                            gameStatus: 'finished',
                            results: results,
                            finishedAt: new Date().toISOString(),
                            lastActivityAt: Date.now()  // æ´»å‹•æ™‚åˆ»ã‚’æ›´æ–°
                        });
                    }
                })
                .catch((error) => {
                    console.error('âŒ äºˆæƒ³é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆæ–°æ–¹å¼ï¼šå®Œå…¨ä¸€è‡´=2ç‚¹ã€Â±1=1ç‚¹ï¼‰
        function calculateScores(sessionData) {
            const rankings = sessionData.rankings;
            const guesses = sessionData.guesses;
            const players = Object.keys(sessionData.players);
            const results = {};
            
            players.forEach((playerId) => {
                // ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®äºˆæƒ³ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                const partnerId = players.find(id => id !== playerId);
                const partnerRanking = rankings[partnerId];  // æ­£è§£
                const myGuess = guesses[playerId];            // äºˆæƒ³
                
                let score = 0;           // åˆè¨ˆã‚¹ã‚³ã‚¢
                let perfectCount = 0;    // å®Œå…¨ä¸€è‡´ã®æ•°
                let closeCount = 0;      // Â±1ã®æ•°
                
                // å„äºˆæƒ³ä½ç½®ã«ã¤ã„ã¦ã€æ­£è§£ã§ã®é †ä½ã‚’æ¢ã—ã¦æ¯”è¼ƒ
                for (let guessRank = 1; guessRank <= 5; guessRank++) {
                    const guessedItem = myGuess[guessRank.toString()];
                    
                    // ã“ã®é …ç›®ãŒæ­£è§£ã§ä½•ä½ãªã®ã‹æ¢ã™
                    let correctRank = 0;
                    for (let rank = 1; rank <= 5; rank++) {
                        if (partnerRanking[rank.toString()] === guessedItem) {
                            correctRank = rank;
                            break;
                        }
                    }
                    
                    // é †ä½ã®å·®ã‚’è¨ˆç®—
                    if (correctRank > 0) {
                        const diff = Math.abs(guessRank - correctRank);
                        if (diff === 0) {
                            // å®Œå…¨ä¸€è‡´
                            score += 2;
                            perfectCount++;
                        } else if (diff === 1) {
                            // Â±1ï¼ˆãŠã—ã„ï¼‰
                            score += 1;
                            closeCount++;
                        }
                    }
                }
                
                results[playerId] = {
                    score: score,               // æœ€å¤§10ç‚¹
                    perfectCount: perfectCount, // å®Œå…¨ä¸€è‡´æ•°
                    closeCount: closeCount      // Â±1ã®æ•°
                };
            });
            
            return results;
        }
        
        // çµæœç”»é¢ã‚’è¡¨ç¤º
        function showResultScreen(sessionData) {
            const rankings = sessionData.rankings;
            const guesses = sessionData.guesses;
            const results = sessionData.results;
            const players = Object.keys(sessionData.players);
            
            const myId = userProfile.userId;
            const partnerId = players.find(id => id !== myId);
            
            const myScore = results[myId];
            const partnerScore = results[partnerId];
            
            // å‹æ•—åˆ¤å®š
            let resultTitle = '';
            let resultEmoji = '';
            if (myScore.score > partnerScore.score) {
                resultTitle = 'ã‚ãªãŸã®å‹ã¡ï¼';
                resultEmoji = 'ğŸ‰';
            } else if (myScore.score < partnerScore.score) {
                resultTitle = 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®å‹ã¡ï¼';
                resultEmoji = 'ğŸ˜„';
            } else {
                resultTitle = 'å¼•ãåˆ†ã‘ï¼';
                resultEmoji = 'ğŸ¤';
            }
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åã‚’å–å¾—
            database.ref('users/' + partnerId).once('value')
                .then((snapshot) => {
                    const partnerName = snapshot.exists() ? snapshot.val().displayName : 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼';
                    
                    // çµæœHTMLã‚’ç”Ÿæˆ
                    let html = '';
                    
                    // å‹æ•—è¡¨ç¤º
                    html += '<div style="text-align: center; margin-bottom: 30px;">';
                    html += '<p style="font-size: 64px; margin-bottom: 10px;">' + resultEmoji + '</p>';
                    html += '<h3 style="color: #FF6B9D; font-size: 24px; margin-bottom: 10px;">' + resultTitle + '</h3>';
                    html += '</div>';
                    
            // ç«¶äº‰å‹ï¼šå€‹åˆ¥ã‚¹ã‚³ã‚¢è¡¨ç¤º
            html += '<div style="background: #F0F8FF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">';
            html += '<h3 style="color: #4A90E2; font-size: 16px; margin-bottom: 15px;">ğŸ† å¯¾æˆ¦æˆç¸¾</h3>';
            html += '<div style="display: flex; justify-content: space-around; text-align: center;">';
            
            // ãƒ›ã‚¹ãƒˆ/ã‚²ã‚¹ãƒˆåˆ¤å®š
            const isHost = sessionData.hostId === myId;
            const isPartnerHost = sessionData.hostId === partnerId;
            
            // è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px; margin-bottom: 5px;">ã‚ãªãŸ</p>';
            html += '<p style="color: #FF6B9D; font-size: 32px; font-weight: bold;">' + myScore.score + '<span style="font-size: 16px; color: #999;"> / 10</span><span style="font-size: 13px; color: #999;">pt</span></p>';
            html += '<p style="color: #999; font-size: 12px;">ã‚ãŸã‚Šï¼ï¼ˆ2ptï¼‰Ã—' + (myScore.perfectCount || 0) + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">ãŠã—ã„ï¼ï¼ˆ1ptï¼‰Ã—' + (myScore.closeCount || 0) + 'å€‹</p>';
            html += '</div>';
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ã‚¹ã‚³ã‚¢
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px; margin-bottom: 5px;">ãŠç›¸æ‰‹</p>';
            html += '<p style="color: #4A90E2; font-size: 32px; font-weight: bold;">' + partnerScore.score + '<span style="font-size: 16px; color: #999;"> / 10</span><span style="font-size: 13px; color: #999;">pt</span></p>';
            html += '<p style="color: #999; font-size: 12px;">ã‚ãŸã‚Šï¼ï¼ˆ2ptï¼‰Ã—' + (partnerScore.perfectCount || 0) + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">ãŠã—ã„ï¼ï¼ˆ1ptï¼‰Ã—' + (partnerScore.closeCount || 0) + 'å€‹</p>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // å”åŠ›å‹ï¼šåˆè¨ˆã‚¹ã‚³ã‚¢è¡¨ç¤º
            const totalScore = myScore.score + partnerScore.score;
            const maxScore = 20;
            let cooperativeEmoji = '';
            let cooperativeMessage = '';
            
            if (totalScore === 20) {
                cooperativeEmoji = 'ğŸ‰';
                cooperativeMessage = 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼å®Œç’§ãªã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼';
            } else if (totalScore >= 18) {
                cooperativeEmoji = 'ğŸ˜Š';
                cooperativeMessage = 'ç´ æ™´ã‚‰ã—ã„ï¼ã»ã¼å®Œç’§ï¼';
            } else if (totalScore >= 15) {
                cooperativeEmoji = 'ğŸ‘';
                cooperativeMessage = 'ã„ã„æ„Ÿã˜ï¼ãŠäº’ã„ã‚’ã‚ˆãçŸ¥ã£ã¦ã‚‹ï¼';
            } else if (totalScore >= 12) {
                cooperativeEmoji = 'ğŸ¤”';
                cooperativeMessage = 'ã¾ã ã¾ã ä¼¸ã³ã—ã‚ã‚ã‚Šï¼';
            } else if (totalScore >= 8) {
                cooperativeEmoji = 'ğŸ’ª';
                cooperativeMessage = 'æ¬¡ã¯é ‘å¼µã‚ã†ï¼';
            } else {
                cooperativeEmoji = 'ğŸ˜…';
                cooperativeMessage = 'ã‚‚ã£ã¨è©±ãã†ï¼';
            }
            
            html += '<div style="background: #F0FFF4; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<h3 style="color: #50C878; font-size: 16px; margin-bottom: 15px;">ğŸ’‘ ãµãŸã‚Šã®æˆç¸¾</h3>';
            html += '<p style="font-size: 48px; margin-bottom: 10px;">' + cooperativeEmoji + '</p>';
            html += '<p style="color: #50C878; font-size: 32px; font-weight: bold; margin-bottom: 5px;">' + totalScore + '<span style="font-size: 16px; color: #999;"> / ' + maxScore + '</span><span style="font-size: 13px; color: #999;">pt</span></p>';
            html += '<p style="color: #666; font-size: 16px; font-weight: bold;">' + cooperativeMessage + '</p>';
            html += '</div>';
                    
                    // ã‚ãªãŸã®æˆç¸¾ï¼ˆæ­£è§£&çµæœï¼‰
                    html += '<div style="background: #F5F5F5; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
                    html += '<h3 style="color: #4A90E2; font-size: 16px; margin-bottom: 15px;">ã‚ãªãŸã®æˆç¸¾ï¼ˆæ­£è§£&çµæœï¼‰</h3>';
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ1è¡Œæ§‹é€ ï¼‰
                    html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 8px; background: #E3F2FD; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 11px; color: #666; align-items: center;">';
                    html += '<div style="grid-column: 1 / 3; text-align: center;">æ­£ã—ã„é †ä½</div>';
                    html += '<div style="text-align: center; line-height: 1.4;">ã‚ãªãŸã®<br>äºˆæƒ³</div>';
                    html += '<div style="text-align: center;">è©•ä¾¡</div>';
                    html += '<div style="text-align: center;">å¾—ç‚¹</div>';
                    html += '</div>';
                    
                    // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆæ­£è§£é †ä½ã§ã‚½ãƒ¼ãƒˆï¼‰
                    const partnerRanking = rankings[partnerId];
                    const myGuess = guesses[myId];
                    
                    for (let correctRank = 1; correctRank <= 5; correctRank++) {
                        const correctItem = partnerRanking[correctRank.toString()];
                        
                        // ã“ã®é …ç›®ã‚’ã‚ãªãŸãŒä½•ä½ã«äºˆæƒ³ã—ãŸã‹æ¢ã™
                        let guessRank = 0;
                        for (let rank = 1; rank <= 5; rank++) {
                            if (myGuess[rank.toString()] === correctItem) {
                                guessRank = rank;
                                break;
                            }
                        }
                        
                        // é †ä½ã®å·®ã‚’è¨ˆç®—
                        let icon = '';
                        let bgColor = 'transparent';
                        let pointEarned = 0;
                        if (guessRank > 0) {
                            const diff = Math.abs(guessRank - correctRank);
                            if (diff === 0) {
                                icon = 'â—‹';
                                bgColor = '#F0FFF4';
                                pointEarned = 2;
                            } else if (diff === 1) {
                                icon = 'â–³';
                                bgColor = '#FFF8F0';
                                pointEarned = 1;
                            } else {
                                icon = 'Ã—';
                            }
                        } else {
                            icon = 'Ã—';
                        }
                        
                        const guessRankText = guessRank > 0 ? guessRank + 'ä½' : '-';
                        
                        html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + correctRank + 'ä½</div>';
                        html += '<div style="color: #333; word-break: break-word; overflow-wrap: break-word; font-size: 12px;">' + correctItem + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + guessRankText + '</div>';
                        html += '<div style="text-align: center; font-size: 16px;">' + icon + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: ' + (pointEarned > 0 ? '#50C878' : '#999') + '; font-size: 11px;">' + pointEarned + 'pt</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    // ãŠç›¸æ‰‹ã®æˆç¸¾ï¼ˆæ­£è§£&çµæœï¼‰
                    html += '<div style="background: #F5F5F5; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
                    html += '<h3 style="color: #FF9800; font-size: 16px; margin-bottom: 15px;">ãŠç›¸æ‰‹ã®æˆç¸¾ï¼ˆæ­£è§£&çµæœï¼‰</h3>';
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ1è¡Œæ§‹é€ ï¼‰
                    html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 8px; background: #FFE4CC; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 11px; color: #666; align-items: center;">';
                    html += '<div style="grid-column: 1 / 3; text-align: center;">æ­£ã—ã„é †ä½</div>';
                    html += '<div style="text-align: center; line-height: 1.4;">ãŠç›¸æ‰‹ã®<br>äºˆæƒ³</div>';
                    html += '<div style="text-align: center;">è©•ä¾¡</div>';
                    html += '<div style="text-align: center;">å¾—ç‚¹</div>';
                    html += '</div>';
                    
                    // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆæ­£è§£é †ä½ã§ã‚½ãƒ¼ãƒˆï¼‰
                    const myRanking = rankings[myId];
                    const partnerGuess = guesses[partnerId];
                    
                    for (let correctRank = 1; correctRank <= 5; correctRank++) {
                        const correctItem = myRanking[correctRank.toString()];
                        
                        // ã“ã®é …ç›®ã‚’ãŠç›¸æ‰‹ãŒä½•ä½ã«äºˆæƒ³ã—ãŸã‹æ¢ã™
                        let guessRank = 0;
                        for (let rank = 1; rank <= 5; rank++) {
                            if (partnerGuess[rank.toString()] === correctItem) {
                                guessRank = rank;
                                break;
                            }
                        }
                        
                        // é †ä½ã®å·®ã‚’è¨ˆç®—
                        let icon = '';
                        let bgColor = 'transparent';
                        let pointEarned = 0;
                        if (guessRank > 0) {
                            const diff = Math.abs(guessRank - correctRank);
                            if (diff === 0) {
                                icon = 'â—‹';
                                bgColor = '#F0FFF4';
                                pointEarned = 2;
                            } else if (diff === 1) {
                                icon = 'â–³';
                                bgColor = '#FFF8F0';
                                pointEarned = 1;
                            } else {
                                icon = 'Ã—';
                            }
                        } else {
                            icon = 'Ã—';
                        }
                        
                        const guessRankText = guessRank > 0 ? guessRank + 'ä½' : '-';
                        
                        html += '<div style="display: grid; grid-template-columns: 35px 2fr 50px 35px 40px; gap: 6px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + correctRank + 'ä½</div>';
                        html += '<div style="color: #333; word-break: break-word; overflow-wrap: break-word; font-size: 12px;">' + correctItem + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: #666; font-size: 12px;">' + guessRankText + '</div>';
                        html += '<div style="text-align: center; font-size: 16px;">' + icon + '</div>';
                        html += '<div style="text-align: center; font-weight: bold; color: ' + (pointEarned > 0 ? '#50C878' : '#999') + '; font-size: 11px;">' + pointEarned + 'pt</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    document.getElementById('resultContent').innerHTML = html;
                });
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('resultScreen');
        }
        
        // ã‚‚ã†ä¸€åº¦éŠã¶
        async function playAgain() {
            try {
                console.log('ğŸ® ã‚‚ã†ä¸€åº¦éŠã¶ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                
                if (!currentGameSession) {
                    alert('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    backToMain();
                    return;
                }
                
                // ãƒ›ã‚¹ãƒˆã‹ã‚²ã‚¹ãƒˆã‹ã‚’åˆ¤å®šï¼ˆå…¨ãƒ¢ãƒ¼ãƒ‰å…±é€šï¼‰
                const isHost = currentGameSession.data.hostId === userProfile.userId;
                
                const currentThemeMode = currentGameSession.data.themeMode || 'random';
                
                // ã‚²ã‚¹ãƒˆã®å ´åˆï¼šãƒ›ã‚¹ãƒˆã®æ“ä½œã‚’å¾…ã¤ï¼ˆå…¨ãƒ¢ãƒ¼ãƒ‰å…±é€šï¼‰
                if (!isHost) {
                    console.log('â³ ã‚²ã‚¹ãƒˆï¼šãƒ›ã‚¹ãƒˆã®æ“ä½œã‚’å¾…æ©Ÿä¸­');
                    alert('â³ ãƒ›ã‚¹ãƒˆãŒæ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚');
                    return;  // ã‚²ã‚¹ãƒˆã¯ä½•ã‚‚ã›ãšå¾…æ©Ÿï¼ˆãƒªã‚¹ãƒŠãƒ¼ãŒè‡ªå‹•çš„ã«æ¬¡ã®ç”»é¢ã¸ï¼‰
                }
                
                // ========================================
                // ã“ã“ã‹ã‚‰å…ˆã¯ãƒ›ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
                // ========================================
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                selectedThemeMode = null;
                customThemeText = null;
                
                // ãƒ›ã‚¹ãƒˆï¼šãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã¸
                console.log('ğŸ² ãƒ›ã‚¹ãƒˆï¼šãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã¸');
                showScreen('themeModeSelectScreen')
            } catch (error) {
                console.error('âŒ playAgain ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                backToMain();
            }
        }
        
        // ========================================
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³æ©Ÿèƒ½ï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ»ä¸€äººãƒ—ãƒ¬ã‚¤ï¼‰
        // ========================================
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¦é–‹å§‹
        function showReviewList() {
            // Firebaseã‹ã‚‰è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (!database || !userProfile) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
                return;
            }
            
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDã‚’è¿½åŠ 
                        rankings.push(data);
                    });
                    
                    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒãªã„å ´åˆ
                    if (rankings.length === 0) {
                        alert('âŒ ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“\nå…ˆã«ã€Œæ–°ã—ã„ãƒ†ãƒ¼ãƒã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã‚‹ã€ã§éŠã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼');
                        return;
                    }
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
                    const randomIndex = Math.floor(Math.random() * rankings.length);
                    const selectedRanking = rankings[randomIndex];
                    
                    console.log('âœ… ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ:', selectedRanking.theme);
                    
                    // é¸æŠã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§äºˆæƒ³é–‹å§‹
                    startReviewGuess(selectedRanking.id);
                })
                .catch((error) => {
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šä¸¦ã³æ›¿ãˆé–‹å§‹
        function startReviewGuess(rankingId) {
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const rankingRef = database.ref('rankings/' + rankingId);
            
            rankingRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                        return;
                    }
                    
                    const rankingData = snapshot.val();
                    currentReviewRanking = {
                        id: rankingId,
                        data: rankingData
                    };
                    
                    // æ­£è§£ã‚’ä¿å­˜
                    reviewCorrectAnswer = rankingData.ranking;
                    
                    // ãƒ†ãƒ¼ãƒã‚’è¡¨ç¤º
                    document.getElementById('reviewTheme').textContent = rankingData.theme;
                    
                    // é …ç›®ã‚’å–å¾—ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    const items = [];
                    for (let i = 1; i <= 5; i++) {
                        items.push(rankingData.ranking[i.toString()]);
                    }
                    
                    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yates ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
                    for (let i = items.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [items[i], items[j]] = [items[j], items[i]];
                    }
                    
                    // UIã‚’ç”Ÿæˆ
                    createReviewGuessUI(items);
                    
                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    showScreen('reviewGuessScreen');
                })
                .catch((error) => {
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šUIã‚’ç”Ÿæˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼‰
        function createReviewGuessUI(items) {
            const container = document.getElementById('reviewGuessArea');
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-index', index);
                itemDiv.setAttribute('data-item', item);
                itemDiv.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // é †ä½ç•ªå·
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + 'ä½';
                rankSpan.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ãƒ†ã‚­ã‚¹ãƒˆ
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ï¼ˆâ‰¡ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’å³ç«¯ã«é…ç½®
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = 'â‰¡';
                handleSpan.style.cssText = 'margin-left: auto; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(handleSpan);
                
                container.appendChild(itemDiv);
            });
            
            // ç¾åœ¨ã®é …ç›®ãƒªã‚¹ãƒˆã‚’ä¿å­˜
            container.setAttribute('data-items', JSON.stringify(items));
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šç­”ãˆåˆã‚ã›ï¼ˆæ–°æ–¹å¼ï¼šå®Œå…¨ä¸€è‡´=2ç‚¹ã€Â±1=1ç‚¹ï¼‰
        function submitReviewGuess() {
            const container = document.getElementById('reviewGuessArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            if (!items || items.length !== 5) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆæ–°æ–¹å¼ï¼‰
            let score = 0;           // åˆè¨ˆã‚¹ã‚³ã‚¢
            let perfectCount = 0;    // å®Œå…¨ä¸€è‡´ã®æ•°
            let closeCount = 0;      // Â±1ã®æ•°
            const details = [];      // è©³ç´°æƒ…å ±
            
            // å„äºˆæƒ³ä½ç½®ã«ã¤ã„ã¦ã€æ­£è§£ã§ã®é †ä½ã‚’æ¢ã—ã¦æ¯”è¼ƒ
            for (let guessRank = 1; guessRank <= 5; guessRank++) {
                const guessedItem = items[guessRank - 1];
                
                // ã“ã®é …ç›®ãŒæ­£è§£ã§ä½•ä½ãªã®ã‹æ¢ã™
                let correctRank = 0;
                for (let rank = 1; rank <= 5; rank++) {
                    if (reviewCorrectAnswer[rank.toString()] === guessedItem) {
                        correctRank = rank;
                        break;
                    }
                }
                
                // é †ä½ã®å·®ã‚’è¨ˆç®—
                let pointEarned = 0;
                let matchType = '';
                if (correctRank > 0) {
                    const diff = Math.abs(guessRank - correctRank);
                    if (diff === 0) {
                        // å®Œå…¨ä¸€è‡´
                        pointEarned = 2;
                        perfectCount++;
                        matchType = 'perfect';
                    } else if (diff === 1) {
                        // Â±1ï¼ˆãŠã—ã„ï¼‰
                        pointEarned = 1;
                        closeCount++;
                        matchType = 'close';
                    }
                }
                score += pointEarned;
                
                details.push({
                    guessRank: guessRank,
                    correctRank: correctRank,
                    item: guessedItem,
                    matchType: matchType,
                    point: pointEarned
                });
            }
            
            // çµæœã‚’è¡¨ç¤º
            showReviewResult(items, perfectCount, closeCount, score, details);
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šçµæœè¡¨ç¤ºï¼ˆè¡¨å½¢å¼ã«çµ±ä¸€ï¼‰
        function showReviewResult(guessedItems, perfectCount, closeCount, totalScore, details) {
            let html = '';
            
            // è©•ä¾¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ5æ®µéšï¼‰
            let emoji = '';
            let message = '';
            if (totalScore === 10) {
                emoji = 'ğŸ‰';
                message = 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼';
            } else if (totalScore >= 8) {
                emoji = 'ğŸ˜Š';
                message = 'ã™ã”ã„ï¼';
            } else if (totalScore >= 6) {
                emoji = 'ğŸ‘';
                message = 'ã„ã„æ„Ÿã˜ï¼';
            } else if (totalScore >= 4) {
                emoji = 'ğŸ¤”';
                message = 'ãŠã—ã„ï¼';
            } else {
                emoji = 'ğŸ’ª';
                message = 'æ¬¡ã¯é ‘å¼µã‚ã†ï¼';
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            html += '<div style="text-align: center; margin-bottom: 30px;">';
            html += '<p style="font-size: 64px; margin-bottom: 10px;">' + emoji + '</p>';
            html += '<h3 style="color: #9B59B6; font-size: 24px; margin-bottom: 10px;">' + message + '</h3>';
            html += '</div>';
            
            // ã‚¹ã‚³ã‚¢è©³ç´°
            html += '<div style="background: #F8F4FF; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<p style="color: #9B59B6; font-size: 48px; font-weight: bold; margin-bottom: 10px;">' + totalScore + 'ç‚¹<span style="font-size: 24px; color: #999;"> / 10ç‚¹</span></p>';
            html += '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">å®Œå…¨ä¸€è‡´</p>';
            html += '<p style="color: #9B59B6; font-size: 24px; font-weight: bold;">' + perfectCount + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">Ã—2ç‚¹</p>';
            html += '</div>';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">ãŠã—ã„ï¼ˆÂ±1ï¼‰</p>';
            html += '<p style="color: #9B59B6; font-size: 24px; font-weight: bold;">' + closeCount + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">Ã—1ç‚¹</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // ç­”ãˆåˆã‚ã›è©³ç´°ï¼ˆè¡¨å½¢å¼ã«å¤‰æ›´ï¼‰
            html += '<div style="background: #FFF8F0; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
            html += '<h3 style="color: #FF9800; font-size: 16px; margin-bottom: 15px;">âœ¨ ç­”ãˆåˆã‚ã›</h3>';
            
            // ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
            html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 8px; background: #FFE4CC; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 12px; color: #666;">';
            html += '<div style="text-align: center;">äºˆæƒ³</div>';
            html += '<div>é …ç›®</div>';
            html += '<div style="text-align: center;">æ­£è§£é †ä½</div>';
            html += '<div style="text-align: center;">è©•ä¾¡</div>';
            html += '<div style="text-align: center;">å¾—ç‚¹</div>';
            html += '</div>';
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            for (let i = 0; i < details.length; i++) {
                const detail = details[i];
                const matchType = detail.matchType;
                let icon = '';
                let bgColor = 'transparent';
                let evalText = '';
                
                if (matchType === 'perfect') {
                    icon = 'â—‹';
                    bgColor = '#F0FFF4';
                    evalText = 'å®Œå…¨ä¸€è‡´';
                } else if (matchType === 'close') {
                    icon = 'â–³';
                    bgColor = '#FFF8F0';
                    evalText = 'ãŠã—ã„';
                } else {
                    icon = 'âœ•';
                    evalText = '';
                }
                
                const correctRankText = detail.correctRank > 0 ? detail.correctRank + 'ä½' : '-';
                
                html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + detail.guessRank + 'ä½</div>';
                html += '<div style="color: #333;">' + detail.item + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + correctRankText + '</div>';
                html += '<div style="text-align: center; font-size: 18px;">' + icon + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: ' + (detail.point > 0 ? '#50C878' : '#999') + ';">' + detail.point + 'pt</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('reviewResultContent').innerHTML = html;
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('reviewResultScreen');
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelReview() {
            currentReviewRanking = null;
            reviewCorrectAnswer = null;
            showScreen('mainScreen');
        }
        
        // ========================================
        // Enterã‚­ãƒ¼ã§æ¬¡ã®å…¥åŠ›æ¬„ã«ç§»å‹•
        // ========================================
        function setupEnterKeyNavigation() {
            // é€šå¸¸ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥åŠ›
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById('rank' + i);
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (i < 5) {
                            // æ¬¡ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                            document.getElementById('rank' + (i + 1)).focus();
                        } else {
                            // 5ä½ã®å ´åˆã¯ä¿å­˜ãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                            this.blur();
                        }
                    }
                });
            }
            
            // ã‚²ãƒ¼ãƒ å…¥åŠ›ï¼ˆãƒã‚°ä¿®æ­£ï¼šDOMé †åºãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ï¼‰
            const container = document.getElementById('gameRankingForm');
            if (container) {
                container.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && event.target.classList.contains('rank-input')) {
                        event.preventDefault();
                        
                        // ç¾åœ¨ã®inputã®è¦ªè¦ç´ ï¼ˆrank-itemï¼‰ã‚’å–å¾—
                        const currentItem = event.target.closest('.rank-item');
                        if (!currentItem) return;
                        
                        // æ¬¡ã®è¦ç´ ã‚’å–å¾—ï¼ˆDOMé †åºï¼‰
                        const nextItem = currentItem.nextElementSibling;
                        
                        if (nextItem) {
                            // æ¬¡ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                            const nextInput = nextItem.querySelector('.rank-input');
                            if (nextInput) nextInput.focus();
                        } else {
                            // æœ€å¾Œã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
                            event.target.blur();
                        }
                    }
                });
            }
        }
        
        // ========================================
        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        function showScreen(screenId) {
            // ã™ã¹ã¦ã®ç”»é¢ã‚’éè¡¨ç¤º
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            
            // æŒ‡å®šã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤º
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.style.display = 'block';
            }
        }
        
        // HOMEç”»é¢ã«æˆ»ã‚‹ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãï¼‰
        function confirmBackToMain(message) {
            if (confirm(message || 'HOMEã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                backToMain();
            }
        }
        
        // ========================================
        // LINEæ‹›å¾…æ©Ÿèƒ½
        // ========================================
        
        // å¾…æ©Ÿå®¤ã‹ã‚‰LINEã§æ‹›å¾…ã‚’é€ã‚‹
        function shareSessionToLine() {
            if (!currentGameSession || !currentGameSession.id) {
                alert('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const liffUrl = `https://liff.line.me/${LIFF_ID}`;
            const sessionUrl = `${liffUrl}?session=${currentGameSession.id}`;
            
            // shareTargetPicker API ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if (!liff.isApiAvailable('shareTargetPicker')) {
                console.warn('âš ï¸ shareTargetPicker API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆå¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯LIFFãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„ï¼‰');
                // APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                navigator.clipboard.writeText(sessionUrl)
                    .then(() => {
                        alert('ğŸ“‹ æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
                    })
                    .catch(() => {
                        alert('âŒ URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    });
                return;
            }
            
            // LINEé€ä¿¡å…ˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
            liff.shareTargetPicker([{
                type: 'text',
                text: `ä¸€ç·’ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚²ãƒ¼ãƒ ã§éŠã¼ã†ï¼ğŸ®\n\nå‚åŠ ã¯ã“ã¡ã‚‰ã‹ã‚‰ğŸ‘‡\n${sessionUrl}`
            }])
            .then(() => {
                console.log('âœ… LINEæ‹›å¾…é€ä¿¡æˆåŠŸ');
            })
            .catch((error) => {
                console.error('âŒ LINEæ‹›å¾…ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    message: error.message,
                    code: error.code,
                    name: error.name
                });
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                navigator.clipboard.writeText(sessionUrl)
                    .then(() => {
                        alert('ğŸ“‹ æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
                    })
                    .catch(() => {
                        alert('âŒ æ‹›å¾…ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    });
            });
        }
        
        // ãƒšã‚¢è¨­å®šç”»é¢ã‹ã‚‰LINEã§æ‹›å¾…ã‚’é€ã‚‹
        function sharePairCodeToLine() {
            if (!currentUser || !currentUser.pairCode) {
                alert('âŒ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const liffUrl = `https://liff.line.me/${LIFF_ID}`;
            const pairUrl = `${liffUrl}?pairCode=${currentUser.pairCode}`;
            
            // shareTargetPicker API ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if (!liff.isApiAvailable('shareTargetPicker')) {
                console.warn('âš ï¸ shareTargetPicker API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆå¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯LIFFãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„ï¼‰');
                // APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                navigator.clipboard.writeText(pairUrl)
                    .then(() => {
                        alert('ğŸ“‹ æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
                    })
                    .catch(() => {
                        alert('âŒ URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    });
                return;
            }
            
            // LINEé€ä¿¡å…ˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
            liff.shareTargetPicker([{
                type: 'text',
                text: `ä¸€ç·’ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚²ãƒ¼ãƒ ã®ãƒšã‚¢ã«ãªã‚ã†ï¼ğŸ’‘\n\nãƒšã‚¢ç™»éŒ²ã¯ã“ã¡ã‚‰ã‹ã‚‰ğŸ‘‡\n${pairUrl}`
            }])
            .then(() => {
                console.log('âœ… ãƒšã‚¢ã‚³ãƒ¼ãƒ‰æ‹›å¾…é€ä¿¡æˆåŠŸ');
            })
            .catch((error) => {
                console.error('âŒ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰æ‹›å¾…ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    message: error.message,
                    code: error.code,
                    name: error.name
                });
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                navigator.clipboard.writeText(pairUrl)
                    .then(() => {
                        alert('ğŸ“‹ æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
                    })
                    .catch(() => {
                        alert('âŒ æ‹›å¾…ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    });
            });
        }
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ‹›å¾…URLå‡¦ç†ï¼‰
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‹›å¾…URLã®å ´åˆ
            const sessionId = urlParams.get('session');
            if (sessionId) {
                console.log('ğŸ® ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‹›å¾…URLã‚’æ¤œå‡º:', sessionId);
                handleSessionInvite(sessionId);
                return;
            }
            
            // ãƒšã‚¢ã‚³ãƒ¼ãƒ‰æ‹›å¾…URLã®å ´åˆ
            const pairCode = urlParams.get('pairCode');
            if (pairCode) {
                console.log('ğŸ’‘ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰æ‹›å¾…URLã‚’æ¤œå‡º:', pairCode);
                handlePairCodeInvite(pairCode);
                return;
            }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‹›å¾…ã‚’å‡¦ç†
        function handleSessionInvite(sessionId) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆæœŸåŒ–å®Œäº†å¾Œã«å®Ÿè¡Œ
            const checkUserReady = setInterval(() => {
                if (currentUser) {
                    clearInterval(checkUserReady);
                    
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
                    const sessionRef = database.ref('gameSessions/' + sessionId);
                    sessionRef.once('value')
                        .then((snapshot) => {
                            if (snapshot.exists()) {
                                const sessionData = snapshot.val();
                                const hostId = sessionData.hostId;
                                const partnerId = sessionData.partnerId;
                                const myUserId = userProfile.userId;
                                
                                // ãƒ›ã‚¹ãƒˆæœ¬äººã®å ´åˆ
                                if (myUserId === hostId) {
                                    console.log('ğŸ® ãƒ›ã‚¹ãƒˆæœ¬äººï¼šå¾…æ©Ÿå®¤ã‚’è¡¨ç¤º');
                                    showWaitingRoom(sessionId, sessionData, 'host');
                                    return;
                                }
                                
                                // ãƒšã‚¢ã®å ´åˆ
                                if (myUserId === partnerId) {
                                    console.log('ğŸ® ãƒšã‚¢ï¼šå‚åŠ ç¢ºèªç”»é¢ã‚’è¡¨ç¤º');
                                    showWaitingRoom(sessionId, sessionData, 'guest');
                                    return;
                                }
                                
                                // ãƒšã‚¢ä»¥å¤–ã®å ´åˆ
                                alert('âŒ ã“ã®æ‹›å¾…ã¯ã‚ãªãŸå®›ã¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\nã“ã®ã‚²ãƒ¼ãƒ ã¯ãƒšã‚¢å°‚ç”¨ã§ã™ã€‚');
                                showScreen('mainScreen');
                            } else {
                                alert('ã“ã®ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æ—¢ã«çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚');
                                showScreen('mainScreen');
                            }
                        })
                        .catch((error) => {
                            console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                            alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                            showScreen('mainScreen');
                        });
                }
            }, 100);
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10ç§’ï¼‰
            setTimeout(() => {
                clearInterval(checkUserReady);
            }, 10000);
        }
        
        // ãƒšã‚¢ã‚³ãƒ¼ãƒ‰æ‹›å¾…ã‚’å‡¦ç†
        function handlePairCodeInvite(pairCode) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆæœŸåŒ–å®Œäº†å¾Œã«å®Ÿè¡Œ
            const checkUserReady = setInterval(() => {
                if (currentUser) {
                    clearInterval(checkUserReady);
                    
                    // è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã®å ´åˆã¯ã€é€šå¸¸é€šã‚ŠHOMEç”»é¢ã¸
                    if (pairCode.toUpperCase() === currentUser.pairCode) {
                        console.log('ğŸ  è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ï¼šHOMEç”»é¢ã‚’è¡¨ç¤º');
                        showScreen('mainScreen');
                        return;
                    }
                    
                    // ãƒšã‚¢è¨­å®šç”»é¢ã‚’è¡¨ç¤ºã—ã€ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›
                    showScreen('pairScreen');
                    document.getElementById('partnerCodeInput').value = pairCode.toUpperCase();
                    
                    // ã€Œã‚ãªãŸã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    const myPairCodeSection = document.querySelector('#pairScreen > div:first-of-type');
                    if (myPairCodeSection) {
                        myPairCodeSection.style.display = 'none';
                    }
                    
                    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    alert('âœ¨ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¾ã—ãŸï¼\nã€Œãƒšã‚¢ã«ãªã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
                }
            }, 100);
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10ç§’ï¼‰
            setTimeout(() => {
                clearInterval(checkUserReady);
            }, 10000);
        }
        
        // HOMEç”»é¢ã«æˆ»ã‚‹ï¼ˆã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†ï¼‰
        async function backToMain() {
            try {
                console.log('ğŸ  HOMEãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                
                // ç¾åœ¨ã®ç”»é¢ã‚’ç¢ºèª
                const currentScreen = document.querySelector('.screen.active');
                const screenId = currentScreen ? currentScreen.id : '';
                
                // ç”»é¢ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
                const isWaitingRoom = screenId === 'waitingRoomScreen';
                const isGameInProgress = ['gameInputScreen', 'guessScreen'].includes(screenId);
                const isResultScreen = screenId === 'resultScreen';
                
                // å¾…æ©Ÿå®¤ã‹ã‚‰ã®é€€å‡ºå‡¦ç†
                if (isWaitingRoom && currentGameSession) {
                    // ãƒ›ã‚¹ãƒˆã®å ´åˆã¯ã€å¾…æ©Ÿå®¤ã‚’å‰Šé™¤ï¼ˆç›¸æ‰‹ã«ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€ã¨é€šçŸ¥ï¼‰
                    if (currentGameSession.role === 'host') {
                        const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                        await sessionRef.remove();
                        console.log('âœ… ãƒ›ã‚¹ãƒˆãŒå¾…æ©Ÿå®¤ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    } else {
                        // ã‚²ã‚¹ãƒˆã®å ´åˆã¯ã€è‡ªåˆ†ã ã‘é€€å‡ºï¼ˆå¾…æ©Ÿå®¤ã¯ç¶­æŒï¼‰
                        console.log('âœ… ã‚²ã‚¹ãƒˆãŒå¾…æ©Ÿå®¤ã‚’é€€å‡ºã—ã¾ã—ãŸï¼ˆå¾…æ©Ÿå®¤ã¯ç¶­æŒï¼‰');
                    }
                }
                
                // ã‚²ãƒ¼ãƒ ä¸­ã«HOMEã‚’æŠ¼ã—ãŸå ´åˆã€ç›¸æ‰‹ã«ã‚‚é€šçŸ¥
                if (isGameInProgress && currentGameSession) {
                    const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                    await sessionRef.update({
                        gameAborted: true,
                        abortedBy: userProfile.userId,
                        abortedAt: new Date().toISOString()
                    });
                    console.log('âœ… ã‚²ãƒ¼ãƒ ä¸­æ–­ã‚’é€šçŸ¥ã—ã¾ã—ãŸ');
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆç›¸æ‰‹ãŒé€šçŸ¥ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
                    setTimeout(async () => {
                        await sessionRef.remove();
                        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤æˆåŠŸï¼ˆã‚²ãƒ¼ãƒ ä¸­æ–­ï¼‰');
                    }, 1000);
                }
                
                // çµæœç”»é¢ã‹ã‚‰æˆ»ã‚‹å ´åˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
                if (isResultScreen && currentGameSession) {
                    const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                    await sessionRef.remove();
                    console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤æˆåŠŸï¼ˆçµæœç”»é¢ã‹ã‚‰HOMEï¼‰');
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (currentSessionRef) {
                    currentSessionRef.off();
                    currentSessionRef = null;
                }
                currentGameSession = null;
                
                showScreen('mainScreen');
            } catch (error) {
                console.error('âŒ backToMain ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // ========================================
        // é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        function toggleDevMenu() {
            const devMenuContent = document.getElementById('devMenuContent');
            const toggleButton = document.getElementById('devMenuToggleButton');
            
            if (devMenuContent.style.display === 'none') {
                // é–‹ã
                devMenuContent.style.display = 'block';
                toggleButton.textContent = 'ğŸ”§ é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆé–‰ã˜ã‚‹ï¼‰';
            } else {
                // é–‰ã˜ã‚‹
                devMenuContent.style.display = 'none';
                toggleButton.textContent = 'ğŸ”§ é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼';
            }
        }
        
        // ========================================
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä½œæˆæ©Ÿèƒ½
        // ========================================
        function startRanking() {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ†ãƒ¼ãƒã‚’é¸ã¶
            currentTheme = THEMES[Math.floor(Math.random() * THEMES.length)];
            document.getElementById('currentTheme').textContent = currentTheme;
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            for (let i = 1; i <= 5; i++) {
                document.getElementById('rank' + i).value = '';
            }
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
            showScreen('rankingScreen');
            
            // 1ä½ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                document.getElementById('rank1').focus();
            }, 100);
        }
        
        function saveRanking() {
            // å…¥åŠ›å€¤ã‚’å–å¾—
            const rankings = [];
            for (let i = 1; i <= 5; i++) {
                const value = document.getElementById('rank' + i).value.trim();
                if (value === '') {
                    alert((i) + 'ä½ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                    document.getElementById('rank' + i).focus();
                    return;
                }
                rankings.push(value);
            }
            
            // FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!database) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (!userProfile) {
                alert('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            // Firebaseã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const newRanking = {
                userId: userProfile.userId,
                userName: userProfile.displayName,
                theme: currentTheme,
                ranking: {
                    "1": rankings[0],
                    "2": rankings[1],
                    "3": rankings[2],
                    "4": rankings[3],
                    "5": rankings[4]
                },
                createdAt: new Date().toISOString()
            };
            
            // Firebaseã«ä¿å­˜ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’è‡ªå‹•ç”Ÿæˆï¼‰
            const rankingsRef = database.ref('rankings');
            const newRankingRef = rankingsRef.push();
            
            newRankingRef.set(newRanking)
                .then(() => {
                    alert('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\nFirebaseã«æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
                    console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜æˆåŠŸ:', newRanking);
                    backToMain();
                })
                .catch((error) => {
                    alert('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ========================================
        // å±¥æ­´è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆFirebaseã‹ã‚‰å–å¾—ï¼‰
        // ========================================
        function showHistory() {
            const historyList = document.getElementById('historyList');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('historyScreen');
            
            // FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!database) {
                historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼<br>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            if (!userProfile) {
                historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            // Firebaseã‹ã‚‰è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDã‚’è¿½åŠ 
                        rankings.push(data);
                    });
                    
                    // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                    rankings.sort((a, b) => {
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    });
                    
                    // è¡¨ç¤º
                    if (rankings.length === 0) {
                        historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 20px;">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“<br>æ–°ã—ã„ãƒ†ãƒ¼ãƒã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>';
                    } else {
                        let html = '';
                        rankings.forEach((item) => {
                            const date = new Date(item.createdAt);
                            const dateStr = date.getFullYear() + 'å¹´' + 
                                          (date.getMonth() + 1) + 'æœˆ' + 
                                          date.getDate() + 'æ—¥ ' + 
                                          date.getHours() + ':' + 
                                          String(date.getMinutes()).padStart(2, '0');
                            
                            html += '<div class="history-item">';
                            html += '<div class="history-theme">' + item.theme + '</div>';
                            html += '<div class="history-date">' + dateStr + ' by ' + item.userName + '</div>';
                            html += '<div class="history-rankings">';
                            
                            // ranking ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰è¡¨ç¤º
                            for (let i = 1; i <= 5; i++) {
                                if (item.ranking && item.ranking[i.toString()]) {
                                    html += '<div>' + i + 'ä½: ' + item.ranking[i.toString()] + '</div>';
                                }
                            }
                            
                            html += '</div>';
                            html += '</div>';
                        });
                        historyList.innerHTML = html;
                    }
                    
                    console.log('âœ… å±¥æ­´å–å¾—æˆåŠŸ:', rankings.length + 'ä»¶');
                })
                .catch((error) => {
                    historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼<br>' + error.message + '</p>';
                    console.error('âŒ å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ========================================
        // Firebase æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
        // ========================================
        
        // ========================================
        // é–‹ç™ºç”¨ï¼šSortableJS ã‚’ä½¿ã£ãŸå®Ÿè£…
        // ========================================
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆé–‹ç™ºç”¨ï¼‰
        let devCurrentReviewRanking = null;
        let devReviewCorrectAnswer = null;
        let devSortableInstance = null;
        
        // é–‹ç™ºç”¨ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§è¡¨ç¤º
        function showDevReviewList() {
            // Firebaseã‹ã‚‰è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (!database || !userProfile) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
                return;
            }
            
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDã‚’è¿½åŠ 
                        rankings.push(data);
                    });
                    
                    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒãªã„å ´åˆ
                    if (rankings.length === 0) {
                        alert('âŒ ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“\nå…ˆã«ã€Œæ–°ã—ã„ãƒ†ãƒ¼ãƒã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã‚‹ã€ã§éŠã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼');
                        return;
                    }
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
                    const randomIndex = Math.floor(Math.random() * rankings.length);
                    const selectedRanking = rankings[randomIndex];
                    
                    console.log('âœ… é–‹ç™ºç”¨ï¼šãƒ©ãƒ³ãƒ€ãƒ é¸æŠ:', selectedRanking.theme);
                    
                    // é¸æŠã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§äºˆæƒ³é–‹å§‹
                    startDevReviewGuess(selectedRanking.id);
                })
                .catch((error) => {
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // é–‹ç™ºç”¨ï¼šä¸¦ã³æ›¿ãˆé–‹å§‹
        function startDevReviewGuess(rankingId) {
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const rankingRef = database.ref('rankings/' + rankingId);
            
            rankingRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                        return;
                    }
                    
                    const rankingData = snapshot.val();
                    devCurrentReviewRanking = {
                        id: rankingId,
                        data: rankingData
                    };
                    
                    // æ­£è§£ã‚’ä¿å­˜
                    devReviewCorrectAnswer = rankingData.ranking;
                    
                    // ãƒ†ãƒ¼ãƒã‚’è¡¨ç¤º
                    document.getElementById('devReviewTheme').textContent = rankingData.theme;
                    
                    // é …ç›®ã‚’å–å¾—ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    const items = [];
                    for (let i = 1; i <= 5; i++) {
                        items.push(rankingData.ranking[i.toString()]);
                    }
                    
                    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yates ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
                    for (let i = items.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [items[i], items[j]] = [items[j], items[i]];
                    }
                    
                    // UIã‚’ç”Ÿæˆï¼ˆSortableJSä½¿ç”¨ï¼‰
                    createDevReviewGuessUI(items);
                    
                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    showScreen('devReviewGuessScreen');
                })
                .catch((error) => {
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // é–‹ç™ºç”¨ï¼šUIã‚’ç”Ÿæˆï¼ˆSortableJSä½¿ç”¨ï¼‰
        function createDevReviewGuessUI(items) {
            const container = document.getElementById('devReviewGuessArea');
            container.innerHTML = '';
            
            // æ—¢å­˜ã®Sortableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
            if (devSortableInstance) {
                devSortableInstance.destroy();
                devSortableInstance = null;
            }
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-item', item);
                itemDiv.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // é †ä½ç•ªå·
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + 'ä½';
                rankSpan.style.cssText = '-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ãƒ†ã‚­ã‚¹ãƒˆ
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ï¼ˆâ‰¡ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’å³ç«¯ã«é…ç½®
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = 'â‰¡';
                handleSpan.style.cssText = 'margin-left: auto; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none;';
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(handleSpan);
                
                container.appendChild(itemDiv);
            });
            
            // ğŸŒŸ SortableJS ã‚’åˆæœŸåŒ–ï¼ˆã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼ï¼‰
            devSortableInstance = new Sortable(container, {
                animation: 150,                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦
                delay: 50,                         // âœ¨ 50msé•·æŠ¼ã—ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆApple Musicä¸¦ã¿ï¼‰
                delayOnTouchOnly: true,            // âœ¨ ã‚¹ãƒãƒ›ã®ã¿é•·æŠ¼ã—åˆ¤å®š
                forceFallback: true,               // âœ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ©ãƒƒã‚°æœ‰åŠ¹åŒ–
                fallbackOnBody: true,              // âœ¨ bodyè¦ç´ ã«è¿½åŠ ï¼ˆæŒ‡ã«è¿½å¾“ï¼‰
                swapThreshold: 0.65,               // âœ¨ å…¥ã‚Œæ›¿ãˆæ„Ÿåº¦ï¼ˆ0.65 = 65%ï¼‰
                handle: '.drag-handle',            // â‰¡ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã§ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
                ghostClass: 'sortable-ghost',      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                chosenClass: 'sortable-chosen',    // é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                dragClass: 'sortable-drag',        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã‚¹ã‚¿ã‚¤ãƒ«
                fallbackClass: 'sortable-fallback',// âœ¨ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«
                
                // âœ¨ è¦ç´ ç§»å‹•ä¸­ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é †ä½æ›´æ–°
                onChange: function(evt) {
                    updateDevRankNumbers();
                    
                    // âœ¨ ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã®é †ä½ã‚‚ç›´æ¥æ›´æ–°ï¼ˆforceFallbackã§ body ã«ç§»å‹•ã—ã¦ã„ã‚‹ãŸã‚ï¼‰
                    if (evt.item && evt.newIndex !== undefined) {
                        const rankSpan = evt.item.querySelector('.rank-number');
                        if (rankSpan) {
                            rankSpan.textContent = (evt.newIndex + 1) + 'ä½';
                        }
                    }
                },
                
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«é †ä½ç•ªå·ã‚’æ›´æ–°
                onEnd: function() {
                    updateDevRankNumbers();
                }
            });
            
            console.log('âœ… SortableJS åˆæœŸåŒ–å®Œäº†');
        }
        
        // é–‹ç™ºç”¨ï¼šé †ä½ç•ªå·ã‚’æ›´æ–°
        function updateDevRankNumbers() {
            const container = document.getElementById('devReviewGuessArea');
            const items = container.children;
            
            for (let i = 0; i < items.length; i++) {
                const rankSpan = items[i].querySelector('.rank-number');
                if (rankSpan) {
                    rankSpan.textContent = (i + 1) + 'ä½';
                }
            }
        }
        
        // é–‹ç™ºç”¨ï¼šäºˆæƒ³ã‚’é€ä¿¡
        function submitDevReviewGuess() {
            console.log('ğŸ” submitDevReviewGuess() ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            console.log('devCurrentReviewRanking:', devCurrentReviewRanking);
            console.log('devReviewCorrectAnswer:', devReviewCorrectAnswer);
            
            if (!devCurrentReviewRanking) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ç¾åœ¨ã®ä¸¦ã³é †ã‚’å–å¾—
            const container = document.getElementById('devReviewGuessArea');
            const items = container.children;
            
            console.log('items.length:', items.length);
            
            // å…¨ã¦ã®é …ç›®ãŒæ­£ã—ãå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèª
            if (items.length !== 5) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆæƒ³ã‚’å–å¾—ï¼ˆdata-itemå±æ€§ã‹ã‚‰ï¼‰
            const userGuessArray = [];
            for (let i = 0; i < items.length; i++) {
                userGuessArray.push(items[i].getAttribute('data-item'));
            }
            
            // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆæ–°æ–¹å¼ï¼šå®Œå…¨ä¸€è‡´=2ç‚¹ã€Â±1=1ç‚¹ï¼‰
            let score = 0;           // åˆè¨ˆã‚¹ã‚³ã‚¢
            let perfectCount = 0;    // å®Œå…¨ä¸€è‡´ã®æ•°
            let closeCount = 0;      // Â±1ã®æ•°
            const details = [];      // è©³ç´°æƒ…å ±
            
            // å„äºˆæƒ³ä½ç½®ã«ã¤ã„ã¦ã€æ­£è§£ã§ã®é †ä½ã‚’æ¢ã—ã¦æ¯”è¼ƒ
            for (let guessRank = 1; guessRank <= 5; guessRank++) {
                const guessedItem = userGuessArray[guessRank - 1];
                
                // ã“ã®é …ç›®ãŒæ­£è§£ã§ä½•ä½ãªã®ã‹æ¢ã™
                let correctRank = 0;
                for (let rank = 1; rank <= 5; rank++) {
                    if (devReviewCorrectAnswer[rank.toString()] === guessedItem) {
                        correctRank = rank;
                        break;
                    }
                }
                
                // é †ä½ã®å·®ã‚’è¨ˆç®—
                let pointEarned = 0;
                let matchType = '';
                if (correctRank > 0) {
                    const diff = Math.abs(guessRank - correctRank);
                    if (diff === 0) {
                        // å®Œå…¨ä¸€è‡´
                        pointEarned = 2;
                        perfectCount++;
                        matchType = 'perfect';
                    } else if (diff === 1) {
                        // Â±1ï¼ˆãŠã—ã„ï¼‰
                        pointEarned = 1;
                        closeCount++;
                        matchType = 'close';
                    }
                }
                score += pointEarned;
                
                details.push({
                    guessRank: guessRank,
                    correctRank: correctRank,
                    item: guessedItem,
                    matchType: matchType,
                    point: pointEarned
                });
            }
            
            console.log('ã‚¹ã‚³ã‚¢è¨ˆç®—å®Œäº†:', { perfectCount, closeCount, score });
            
            // çµæœã‚’è¡¨ç¤º
            showDevReviewResult(userGuessArray, perfectCount, closeCount, score, details);
        }
        
        // é–‹ç™ºç”¨ï¼šçµæœã‚’è¡¨ç¤º
        function showDevReviewResult(guessedItems, perfectCount, closeCount, totalScore, details) {
            let html = '';
            
            // è©•ä¾¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ5æ®µéšï¼‰
            let emoji = '';
            let message = '';
            if (totalScore === 10) {
                emoji = 'ğŸ‰';
                message = 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼';
            } else if (totalScore >= 8) {
                emoji = 'ğŸ˜Š';
                message = 'ã™ã”ã„ï¼';
            } else if (totalScore >= 6) {
                emoji = 'ğŸ‘';
                message = 'ã„ã„æ„Ÿã˜ï¼';
            } else if (totalScore >= 4) {
                emoji = 'ğŸ¤”';
                message = 'ãŠã—ã„ï¼';
            } else {
                emoji = 'ğŸ’ª';
                message = 'æ¬¡ã¯é ‘å¼µã‚ã†ï¼';
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            html += '<div style="text-align: center; margin-bottom: 30px;">';
            html += '<p style="font-size: 64px; margin-bottom: 10px;">' + emoji + '</p>';
            html += '<h3 style="color: #FF6B35; font-size: 24px; margin-bottom: 10px;">' + message + '</h3>';
            html += '</div>';
            
            // ã‚¹ã‚³ã‚¢è©³ç´°
            html += '<div style="background: #FFF8F0; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<p style="color: #FF6B35; font-size: 48px; font-weight: bold; margin-bottom: 10px;">' + totalScore + 'ç‚¹<span style="font-size: 24px; color: #999;"> / 10ç‚¹</span></p>';
            html += '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">å®Œå…¨ä¸€è‡´</p>';
            html += '<p style="color: #FF6B35; font-size: 24px; font-weight: bold;">' + perfectCount + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">Ã—2ç‚¹</p>';
            html += '</div>';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">ãŠã—ã„ï¼ˆÂ±1ï¼‰</p>';
            html += '<p style="color: #FF6B35; font-size: 24px; font-weight: bold;">' + closeCount + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">Ã—1ç‚¹</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // ç­”ãˆåˆã‚ã›è©³ç´°ï¼ˆè¡¨å½¢å¼ï¼‰
            html += '<div style="background: white; border: 2px solid #FFD9B3; border-radius: 10px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">';
            html += '<h3 style="color: #FF6B35; font-size: 16px; margin-bottom: 15px;">âœ¨ ç­”ãˆåˆã‚ã›</h3>';
            
            // ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
            html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 8px; background: #FFE4CC; border-radius: 6px; margin-bottom: 8px; font-weight: bold; font-size: 12px; color: #666;">';
            html += '<div style="text-align: center;">äºˆæƒ³</div>';
            html += '<div>é …ç›®</div>';
            html += '<div style="text-align: center;">æ­£è§£é †ä½</div>';
            html += '<div style="text-align: center;">è©•ä¾¡</div>';
            html += '<div style="text-align: center;">å¾—ç‚¹</div>';
            html += '</div>';
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            for (let i = 0; i < details.length; i++) {
                const detail = details[i];
                const matchType = detail.matchType;
                let icon = '';
                let bgColor = 'transparent';
                let evalText = '';
                
                if (matchType === 'perfect') {
                    icon = 'â—‹';
                    bgColor = '#F0FFF4';
                    evalText = 'å®Œå…¨ä¸€è‡´';
                } else if (matchType === 'close') {
                    icon = 'â–³';
                    bgColor = '#FFF8F0';
                    evalText = 'ãŠã—ã„';
                } else {
                    icon = 'âœ•';
                    evalText = '';
                }
                
                const correctRankText = detail.correctRank > 0 ? detail.correctRank + 'ä½' : '-';
                
                html += '<div style="display: grid; grid-template-columns: 45px 1fr 60px 45px 50px; gap: 8px; padding: 10px; border-radius: 6px; background: ' + bgColor + '; align-items: center; font-size: 13px;">';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + detail.guessRank + 'ä½</div>';
                html += '<div style="color: #333;">' + detail.item + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: #666;">' + correctRankText + '</div>';
                html += '<div style="text-align: center; font-size: 18px;">' + icon + '</div>';
                html += '<div style="text-align: center; font-weight: bold; color: ' + (detail.point > 0 ? '#50C878' : '#999') + ';">' + detail.point + 'pt</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('devReviewResultContent').innerHTML = html;
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('devReviewResultScreen');
        }
        
        // é–‹ç™ºç”¨ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelDevReview() {
            if (confirm('ã‚²ãƒ¼ãƒ ã‚’ä¸­æ­¢ã—ã¦ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                // Sortableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
                if (devSortableInstance) {
                    devSortableInstance.destroy();
                    devSortableInstance = null;
                }
                
                devCurrentReviewRanking = null;
                devReviewCorrectAnswer = null;
                showScreen('mainScreen');
            }
        }
    </script>
</body>
</html>
