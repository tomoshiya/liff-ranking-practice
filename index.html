<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãµãŸã‚Šã®ã‚‰ã‚“ãã‚“ã</title>
    
    <!-- LIFFã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã‚€ï¼ˆLINEãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ï¼‰ -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- ========================================
         Firebase SDK ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
         ======================================== -->
    <!-- Firebase App (ã‚³ã‚¢æ©Ÿèƒ½) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* ========================================
           ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š
           ======================================== */
        
        /* å…¨ä½“ã®ãƒªã‚»ãƒƒãƒˆ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FF 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.15);
        }
        
        h1 {
            color: #4A90E2;
            text-align: center;
            margin-bottom: 10px;
            font-size: 26px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 25px;
            padding: 0 10px;
        }
        
        .theme-box {
            background: linear-gradient(135deg, #F0F8FF 0%, #E8F4F8 100%);
            border: 3px solid #4A90E2;
            border-radius: 15px;
            padding: 20px 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .theme-box h2 {
            color: #4A90E2;
            font-size: 18px;
            margin: 0 0 10px 0;
        }
        
        .theme-text {
            color: #333;
            font-size: 16px;
            font-weight: bold;
            line-height: 1.6;
            word-break: break-all;
        }
        
        .ranking-form {
            margin: 20px 0;
        }
        
        .rank-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            gap: 10px;
        }
        
        .rank-label {
            background: linear-gradient(135deg, #4A90E2, #7AB8F5);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            font-size: 15px;
            flex-shrink: 0;
        }
        
        .rank-input {
            flex: 1;
            padding: 12px 12px;
            border: 2px solid #B8D9F0;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.3s;
            width: 100%;
            min-width: 0;
        }
        
        .rank-input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
            touch-action: manipulation;
        }
        
        button:hover {
            background: #3A7BC8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .secondary-button {
            background: #50C878;
        }
        
        .secondary-button:hover {
            background: #3FB869;
        }
        
        .history-list {
            margin: 20px 0;
        }
        
        .history-item {
            background: #f8f9fa;
            border-left: 4px solid #4A90E2;
            border-radius: 8px;
            padding: 15px;
            margin: 12px 0;
        }
        
        .history-theme {
            color: #4A90E2;
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            word-break: break-all;
        }
        
        .history-date {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .history-rankings {
            color: #555;
            font-size: 14px;
            line-height: 1.8;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .error {
            background: #ffe0e0;
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            color: #c92a2a;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .draggable-item {
            background: #f8f9fa;
            border: 2px solid #B8D9F0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            touch-action: none;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
        }
        
        .draggable-item.dragging {
            opacity: 0.95;
            transform: scale(1.08);
            background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FF 100%);
            border: 2px solid #4A90E2;
            cursor: grabbing;
            box-shadow: 0 12px 30px rgba(74, 144, 226, 0.5);
            z-index: 1000;
        }
        
        .draggable-item.drag-over {
            border-top: 3px solid #FF6B9D;
        }
        
        .rank-number {
            background: linear-gradient(135deg, #4A90E2, #7AB8F5);
            color: white;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 45px;
            text-align: center;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .drag-handle {
            color: #999;
            font-size: 20px;
            padding: 0 10px;
            cursor: grab;
        }
        
        .dragging .drag-handle {
            cursor: grabbing;
        }
        
        /* ä¸¸å‹å›ºå®šãƒœã‚¿ãƒ³ */
        .fixed-round-button {
            position: fixed;
            bottom: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .fixed-round-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .fixed-round-button-home {
            left: 20px;
            background: #95A5A6;
            color: white;
        }
        
        .fixed-round-button-submit {
            right: 20px;
            background: linear-gradient(135deg, #50C878, #3AA65D);
            color: white;
        }
        
        /* ã‚¹ãƒãƒ›æœ€é©åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .theme-box {
                padding: 15px 12px;
            }
            
            .theme-box h2 {
                font-size: 16px;
            }
            
            .theme-text {
                font-size: 15px;
            }
            
            .rank-label {
                min-width: 45px;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .rank-input {
                padding: 10px;
                font-size: 14px;
            }
            
            button {
                padding: 14px 18px;
                font-size: 15px;
            }
        }
        
        /* æ¥µå°ç”»é¢å¯¾å¿œ */
        @media (max-width: 360px) {
            .rank-item {
                gap: 8px;
            }
            
            .rank-label {
                min-width: 40px;
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .rank-input {
                padding: 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ãµãŸã‚Šã®ã‚‰ã‚“ãã‚“ã</h1>
        <p class="subtitle">ç­”ãˆã¯ç›¸æ‰‹ã®å¿ƒã®ä¸­ã«ï¼<br>ã‚„ã‚Œã°ã‚„ã‚‹ã»ã©ä»²ãŒæ·±ã¾ã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ </p>
        
        <!-- èª­ã¿è¾¼ã¿ä¸­ã®è¡¨ç¤º -->
        <div id="loading" class="loading">
            <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        
        <!-- LINEã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error" class="error" style="display: none;">
            <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ã“ã®ã‚¢ãƒ—ãƒªã¯LINEã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚</p>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="mainScreen" class="screen">
            <!-- ãƒšã‚¢çŠ¶æ…‹è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰ -->
            <div id="pairStatus" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">ğŸ‘¥ ãƒšã‚¢ã®è¨­å®šçŠ¶æ…‹</p>
                <div id="pairStatusContent">
                    <p style="color: #999; font-size: 14px;">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <!-- ãƒšã‚¢è¨­å®šãƒœã‚¿ãƒ³ã‚’æ å†…ã«é…ç½® -->
                <button id="pairSettingButton" onclick="showPairScreen()" style="background: #9B59B6; margin-top: 10px; font-size: 14px; padding: 10px 15px;">
                    âš™ï¸ ãƒšã‚¢ã‚’è¨­å®šã™ã‚‹
                </button>
            </div>
            
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãµãŸã‚Šã§ã‚ãã¶ -->
            <div style="margin-bottom: 20px;">
                <p style="color: #999; font-size: 12px; margin-bottom: 10px; text-align: center;">â”â”â” ãµãŸã‚Šã§ã‚ãã¶ â”â”â”</p>
                <button id="realtimeGameButton" onclick="startRealtimeGame()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); font-size: 17px; padding: 18px 20px;">
                    ğŸ® ãµãŸã‚Šã§ã‚ãã¶
                </button>
            </div>
            
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ã²ã¨ã‚Šã§è©¦ã™ -->
            <div style="margin-bottom: 20px;">
                <p style="color: #999; font-size: 12px; margin-bottom: 10px; text-align: center;">â”â”â” ã²ã¨ã‚Šã§è©¦ã™ â”â”â”</p>
                <button onclick="startRanking()">
                    ğŸ¯ æ–°ã—ã„ãƒ†ãƒ¼ãƒã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã‚‹
                </button>
                <button onclick="showReviewList()" style="background: #9B59B6;">
                    ğŸ”„ è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ã‚ãã¶
                </button>
                <button onclick="showHistory()" class="secondary-button">
                    ğŸ“‹ éå»ã®å›ç­”å±¥æ­´ã‚’è¦‹ã‚‹
                </button>
            </div>
            
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ -->
            <div style="padding-top: 20px; border-top: 2px dashed #ddd;">
                <p style="text-align: center; color: #999; font-size: 12px; margin-bottom: 10px;">â”â”â” Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ â”â”â”</p>
                <button onclick="testFirebaseConnection()" style="background: #FF6B35;">
                    ğŸ”Œ Firebaseæ¥ç¶šç¢ºèª
                </button>
                <button onclick="testFirebaseSave()" style="background: #9B59B6;">
                    ğŸ’¾ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜
                </button>
            </div>
        </div>
        
        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥åŠ›ç”»é¢ -->
        <div id="rankingScreen" class="screen">
            <div class="theme-box">
                <h2>ğŸ“Œ ä»Šå›ã®ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="currentTheme">---</p>
            </div>
            
            <div class="ranking-form">
                <div class="rank-item">
                    <div class="rank-label">1ä½</div>
                    <input type="text" class="rank-input" id="rank1" placeholder="1ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">2ä½</div>
                    <input type="text" class="rank-input" id="rank2" placeholder="2ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">3ä½</div>
                    <input type="text" class="rank-input" id="rank3" placeholder="3ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">4ä½</div>
                    <input type="text" class="rank-input" id="rank4" placeholder="4ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">5ä½</div>
                    <input type="text" class="rank-input" id="rank5" placeholder="5ä½ã‚’å…¥åŠ›">
                </div>
            </div>
            
            <button onclick="saveRanking()">
                ğŸ’¾ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¿å­˜ã™ã‚‹
            </button>
            
            <button onclick="backToMain()" class="secondary-button">
                â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
        
        <!-- å±¥æ­´è¡¨ç¤ºç”»é¢ -->
        <div id="historyScreen" class="screen">
            <h2 style="color: #4A90E2; margin-bottom: 20px;">ğŸ“‹ éå»ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            
            <div id="historyList" class="history-list">
                <!-- ã“ã“ã«å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            
            <button onclick="backToMain()" class="secondary-button">
                â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
        
        <!-- ãƒšã‚¢è¨­å®šç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰ -->
        <div id="pairScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ’‘ ãƒšã‚¢è¨­å®š</h2>
            
            <!-- è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div style="background: #F8F4FF; border: 2px solid #9B59B6; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #9B59B6; font-size: 16px; margin-bottom: 10px;">ğŸ“Œ ã‚ãªãŸã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«æ•™ãˆã¦ãã ã•ã„</p>
                <div style="background: white; border: 2px dashed #9B59B6; border-radius: 8px; padding: 15px; text-align: center;">
                    <p id="myPairCode" style="font-size: 32px; font-weight: bold; color: #9B59B6; letter-spacing: 4px; font-family: 'Courier New', monospace;">------</p>
                </div>
                <button onclick="copyPairCode()" style="background: #9B59B6; margin-top: 10px; font-size: 14px; padding: 10px;">
                    ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
                </button>
            </div>
            
            <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
            <div style="background: #FFF8F0; border: 2px solid #FF9800; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #FF9800; font-size: 16px; margin-bottom: 10px;">ğŸ”— ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ãƒšã‚¢ã«ãªã‚‹</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <input type="text" id="partnerCodeInput" placeholder="ABC123" maxlength="6" 
                    style="width: 100%; padding: 15px; border: 2px solid #FF9800; border-radius: 8px; font-size: 24px; font-weight: bold; text-align: center; letter-spacing: 4px; text-transform: uppercase; font-family: 'Courier New', monospace; margin-bottom: 10px;">
                <button onclick="connectWithPartner()" style="background: #FF9800;">
                    âœ¨ ãƒšã‚¢ã«ãªã‚‹
                </button>
            </div>
            
            <!-- ç¾åœ¨ã®ãƒšã‚¢æƒ…å ± -->
            <div id="currentPairInfo" style="background: #F0FFF4; border: 2px solid #50C878; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: none;">
                <h3 style="color: #50C878; font-size: 16px; margin-bottom: 10px;">âœ… ãƒšã‚¢æˆç«‹ä¸­</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 8px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: <span id="partnerName" style="font-weight: bold; color: #333;">---</span></p>
                <button onclick="disconnectPair()" style="background: #ff6b6b; font-size: 14px; padding: 10px;">
                    âŒ ãƒšã‚¢ã‚’è§£é™¤
                </button>
            </div>
            
            <button onclick="backToMain()" class="secondary-button">
                â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
        
        <!-- å¾…æ©Ÿãƒ«ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="waitingRoomScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ® ãµãŸã‚Šã§ã‚ãã¶</h2>
            
            <!-- å¾…æ©Ÿä¸­ã®è¡¨ç¤º -->
            <div id="waitingArea" style="text-align: center; padding: 40px 20px;">
                <div style="background: linear-gradient(135deg, #FFF0F5, #F0F8FF); border: 3px solid #FF6B9D; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">â³</p>
                    <p id="waitingMessage" style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã‚¢ãƒ—ãƒªã‚’é–‹ãã¨<br>è‡ªå‹•çš„ã«ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã™</p>
                </div>
                
                <div id="themePreview" style="background: #F8F9FA; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <p style="color: #666; font-size: 13px; margin-bottom: 10px;">ğŸ“Œ ä»Šå›ã®ãŠé¡Œ</p>
                    <p id="waitingTheme" style="color: #333; font-size: 15px; font-weight: bold;">---</p>
                </div>
            </div>
            
            <!-- å‚åŠ ç¢ºèªã®è¡¨ç¤º -->
            <div id="joinArea" style="text-align: center; padding: 40px 20px; display: none;">
                <div style="background: linear-gradient(135deg, #FFF0F5, #F0F8FF); border: 3px solid #4A90E2; border-radius: 15px; padding: 30px 20px; margin-bottom: 20px;">
                    <p style="font-size: 48px; margin-bottom: 15px;">ğŸ‰</p>
                    <p id="joinMessage" style="color: #666; font-size: 16px; line-height: 1.8; font-weight: bold;">---ã•ã‚“ãŒå¾…ã£ã¦ã„ã¾ã™ï¼</p>
                    <p style="color: #999; font-size: 13px; margin-top: 15px;">ä¸€ç·’ã«ã‚²ãƒ¼ãƒ ã‚’ã—ã¾ã™ã‹ï¼Ÿ</p>
                </div>
                
                <div style="background: #F8F9FA; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <p style="color: #666; font-size: 13px; margin-bottom: 10px;">ğŸ“Œ ãŠé¡Œ</p>
                    <p id="joinTheme" style="color: #333; font-size: 15px; font-weight: bold;">---</p>
                </div>
                
                <button onclick="joinGame()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2); font-size: 17px; padding: 18px 20px;">
                    âœ¨ å‚åŠ ã™ã‚‹
                </button>
            </div>
            
            <button onclick="cancelWaitingRoom()" class="secondary-button">
                â† ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
        
        <!-- ã‚²ãƒ¼ãƒ å…¥åŠ›ç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="gameInputScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ® ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥åŠ›</h2>
            
            <div class="theme-box">
                <h2>ğŸ“Œ ä»Šå›ã®ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="gameTheme">---</p>
            </div>
            
            <!-- é€²è¡ŒçŠ¶æ³è¡¨ç¤º -->
            <div id="gameProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">ğŸ“Š é€²è¡ŒçŠ¶æ³</p>
                <div id="gameProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <div class="ranking-form">
                <div class="rank-item">
                    <div class="rank-label">1ä½</div>
                    <input type="text" class="rank-input" id="gameRank1" placeholder="1ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">2ä½</div>
                    <input type="text" class="rank-input" id="gameRank2" placeholder="2ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">3ä½</div>
                    <input type="text" class="rank-input" id="gameRank3" placeholder="3ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">4ä½</div>
                    <input type="text" class="rank-input" id="gameRank4" placeholder="4ä½ã‚’å…¥åŠ›">
                </div>
                <div class="rank-item">
                    <div class="rank-label">5ä½</div>
                    <input type="text" class="rank-input" id="gameRank5" placeholder="5ä½ã‚’å…¥åŠ›">
                </div>
            </div>
            
            <button onclick="submitGameRanking()">
                ğŸ’¾ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é€ä¿¡
            </button>
        </div>
        
        <!-- äºˆæƒ³ç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="guessScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ¤” ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’äºˆæƒ³</h2>
            
            <div style="background: #FFF0F5; border: 2px solid #FF6B9D; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; line-height: 1.8; text-align: center;">
                    <span id="guessPartnerName" style="font-weight: bold; color: #FF6B9D;">---</span>ã•ã‚“ã®<br>
                    ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ­£ã—ã„é †ç•ªã«ä¸¦ã¹ã¦ãã ã•ã„
                </p>
            </div>
            
            <div class="theme-box" style="margin-bottom: 20px;">
                <h2>ğŸ“Œ ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="guessTheme">---</p>
            </div>
            
            <!-- é€²è¡ŒçŠ¶æ³è¡¨ç¤º -->
            <div id="guessProgress" style="background: #F0F8FF; border: 2px solid #4A90E2; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">ğŸ“Š é€²è¡ŒçŠ¶æ³</p>
                <div id="guessProgressContent">
                    <p style="color: #999; font-size: 14px;">---</p>
                </div>
            </div>
            
            <!-- ä¸¦ã³æ›¿ãˆã‚¨ãƒªã‚¢ -->
            <div id="guessRankingArea" style="margin: 20px 0;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button onclick="submitGuess()">
                âœ… äºˆæƒ³ã‚’é€ä¿¡
            </button>
        </div>
        
        <!-- çµæœç”»é¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰ -->
        <div id="resultScreen" class="screen">
            <h2 style="color: #FF6B9D; margin-bottom: 20px;">ğŸ‰ çµæœç™ºè¡¨</h2>
            
            <div id="resultContent" style="margin: 20px 0;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button onclick="playAgain()" style="background: linear-gradient(135deg, #FF6B9D, #4A90E2);">
                ğŸ® ã‚‚ã†ä¸€åº¦éŠã¶
            </button>
            
            <button onclick="backToMain()" class="secondary-button">
                â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
        
        <!-- æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°é¸æŠç”»é¢ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰ -->
        <div id="reviewListScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ”„ æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³</h2>
            
            <p style="color: #666; font-size: 14px; line-height: 1.8; text-align: center; margin-bottom: 20px; padding: 15px; background: #F8F4FF; border-radius: 10px;">
                éå»ã«ä½œã£ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é¸ã‚“ã§<br>
                ã‚‚ã†ä¸€åº¦ä¸¦ã¹ã¦ã¿ã¾ã—ã‚‡ã†ï¼
            </p>
            
            <div id="reviewRankingList" class="history-list">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button onclick="backToMain()" class="secondary-button">
                â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
        
        <!-- æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šä¸¦ã³æ›¿ãˆç”»é¢ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰ -->
        <div id="reviewGuessScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ”„ ä¸¦ã³æ›¿ãˆã¦ã¿ã‚ˆã†</h2>
            
            <div class="theme-box" style="margin-bottom: 20px;">
                <h2>ğŸ“Œ ãƒ†ãƒ¼ãƒ</h2>
                <p class="theme-text" id="reviewTheme">---</p>
            </div>
            
            <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px;">
                æ­£ã—ã„é †ç•ªã«ä¸¦ã¹ã¦ãã ã•ã„
            </p>
            
            <!-- ä¸¦ã³æ›¿ãˆã‚¨ãƒªã‚¢ -->
            <div id="reviewGuessArea" style="margin: 20px 0; padding-bottom: 80px;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <!-- å›ºå®šé…ç½®ã®ä¸¸å‹ãƒœã‚¿ãƒ³ -->
            <button onclick="cancelReview()" class="fixed-round-button fixed-round-button-home">
                HOME
            </button>
            
            <button onclick="submitReviewGuess()" class="fixed-round-button fixed-round-button-submit">
                ç­”ãˆåˆã‚ã›
            </button>
        </div>
        
        <!-- æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šçµæœç”»é¢ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰ -->
        <div id="reviewResultScreen" class="screen">
            <h2 style="color: #9B59B6; margin-bottom: 20px;">ğŸ‰ çµæœ</h2>
            
            <div id="reviewResultContent" style="margin: 20px 0;">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <button onclick="showReviewList()" style="background: #9B59B6;">
                ğŸ”„ åˆ¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§æŒ‘æˆ¦
            </button>
            
            <button onclick="backToMain()" class="secondary-button">
                â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
    </div>

    <script>
        // ========================================
        // ãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ï¼ˆ28å€‹ï¼‰
        // ========================================
        const THEMES = [
            // ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ç³»ï¼ˆ8å€‹ï¼‰
            'æœ€è¿‘ã€å¬‰ã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ¥½ã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ„Ÿè¬ã‚’æ„Ÿã˜ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ„›ã‚’æ„Ÿã˜ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€ãƒãƒã£ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€æ‚²ã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€ãƒ ã‚«ã¤ã„ãŸã“ã¨ã¯ï¼Ÿ',
            'æœ€è¿‘ã€ä¸å®‰ã«æ„Ÿã˜ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿ',
            
            // Yearç³»ï¼ˆ2å€‹ï¼‰
            'ã“ã®1å¹´ã§ã€è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚‚ã®ã¯ï¼Ÿ',
            'ã“ã®1å¹´ã§ã€è¡Œã£ã¦ã‚ˆã‹ã£ãŸãŠåº—ã¯ï¼Ÿ',
            
            // ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ç³»ï¼ˆ15å€‹ï¼‰
            'ã‚ãŸã—ã®å¥½ããªé£Ÿã¹ç‰©ãƒ»æ–™ç†TOP5',
            'ã‚ãŸã—ã®å«Œã„ãƒ»è‹¦æ‰‹ãªé£Ÿã¹ç‰©ãƒ»æ–™ç†TOP5',
            'ã‚ãŸã—ã®å¥½ããªé£²é£Ÿåº—TOP5',
            'ã‚ãŸã—ã®å¥½ããªæ˜ ç”»TOP5',
            'ã‚ãŸã—ã®å¥½ããªæ¼«ç”»ãƒ»ã‚¢ãƒ‹ãƒ¡TOP5',
            'ã‚ãŸã—ã®å¥½ããªã‚²ãƒ¼ãƒ TOP5',
            'ã‚ãŸã—ã®å¥½ããªåœ°åŸŸãƒ»ã‚¨ãƒªã‚¢TOP5',
            'ã‚ãŸã—ã®å¶ãˆãŸã„å¤¢ãƒ»ç›®æ¨™TOP5',
            'ã‚ãŸã—ã®å®ç‰©TOP5',
            'ã‚ãŸã—ã®å¥½ããªæœ¬TOP5',
            'ã‚ãŸã—ã®æ¬²ã—ã„ã‚‚ã®TOP5',
            'ã‚ãŸã—ã®ä¼šã£ã¦ã¿ãŸã„äººTOP5',
            'ã‚ãŸã—ã®å°Šæ•¬ã™ã‚‹äººTOP5',
            'ã‚ãŸã—ã®å­¦ç”Ÿæ™‚ä»£ã®å¾—æ„ç§‘ç›®TOP5',
            'ã‚ãŸã—ã®å­¦ç”Ÿæ™‚ä»£ã®è‹¦æ‰‹ç§‘ç›®TOP5',
            
            // ã‚«ãƒƒãƒ—ãƒ«ç³»ï¼ˆ3å€‹ï¼‰
            'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®å¥½ããªã¨ã“ã‚TOP5',
            'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«æ„Ÿè¬ã‚’ã—ãŸå ´é¢ãƒ»ã‚·ãƒ¼ãƒ³TOP5',
            'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’ç´ æ•µã¨æ„Ÿã˜ãŸå ´é¢ãƒ»ã‚·ãƒ¼ãƒ³TOP5'
        ];
        
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        const LIFF_ID = '2008911809-CBLKsbT1';
        let currentTheme = '';
        let userProfile = null;
        let currentUser = null; // Firebaseä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ç”¨å¤‰æ•°ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰
        let currentGameSession = null;  // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
        let sessionListener = null;     // Firebaseç›£è¦–ãƒªã‚¹ãƒŠãƒ¼
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ç”¨å¤‰æ•°ï¼ˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼‰
        let currentReviewRanking = null;  // ç¾åœ¨æŒ¯ã‚Šè¿”ã‚Šä¸­ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        let reviewCorrectAnswer = null;   // æ­£è§£ãƒ‡ãƒ¼ã‚¿
        
        // ========================================
        // Firebase è¨­å®šï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDf8Yn-r5W1i6YptJ9DXch7i14JRi9bAf0",
            authDomain: "test-futari-no-ranking.firebaseapp.com",
            databaseURL: "https://test-futari-no-ranking-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-futari-no-ranking",
            storageBucket: "test-futari-no-ranking.firebasestorage.app",
            messagingSenderId: "802679547612",
            appId: "1:802679547612:web:1582d3e0176282ede43619",
            measurementId: "G-N364EXJQV8"
        };
        
        // FirebaseåˆæœŸåŒ–
        let firebaseApp = null;
        let database = null;
        
        function initializeFirebase() {
            try {
                // FirebaseåˆæœŸåŒ–
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('âœ… Firebaseæ¥ç¶šæˆåŠŸï¼');
                return true;
            } catch (error) {
                console.error('âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // ========================================
        // LIFFåˆæœŸåŒ–
        // ========================================
        window.onload = function() {
            initializeLiff();
            setupEnterKeyNavigation();
        };
        
        function initializeLiff() {
            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login();
                }
            })
            .catch((err) => {
                console.error('LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = 
                    '<p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + err.message + '</p>';
            });
        }
        
        function getUserProfile() {
            liff.getProfile()
                .then(profile => {
                    userProfile = profile;
                    
                    // Firebaseã‚’åˆæœŸåŒ–ï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
                    initializeFirebase();
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’Firebaseã«ä¿å­˜ãƒ»å–å¾—ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰
                    initializeUser();
                    
                    document.getElementById('loading').style.display = 'none';
                    showScreen('mainScreen');
                })
                .catch((err) => {
                    console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                });
        }
        
        // ========================================
        // ãƒšã‚¢æ©Ÿèƒ½ï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ã§è¿½åŠ ï¼‰
        // ========================================
        
        // ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆ6æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ è‹±æ•°å­—ï¼‰
        function generatePairCode() {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // ç´›ã‚‰ã‚ã—ã„æ–‡å­—ã‚’é™¤å¤–ï¼ˆI,O,0,1ãªã©ï¼‰
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®åˆæœŸåŒ–ï¼ˆFirebaseã«ä¿å­˜ï¼‰
        function initializeUser() {
            if (!database || !userProfile) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæœªåˆæœŸåŒ–');
                return;
            }
            
            const userId = userProfile.userId;
            const userRef = database.ref('users/' + userId);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            userRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šæƒ…å ±ã‚’æ›´æ–°
                        currentUser = snapshot.val();
                        
                        // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ›´æ–°
                        userRef.update({
                            displayName: userProfile.displayName,
                            pictureUrl: userProfile.pictureUrl || '',
                            lastLoginAt: new Date().toISOString()
                        });
                        
                        console.log('âœ… æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—:', currentUser);
                    } else {
                        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ä¿å­˜
                        const newPairCode = generatePairCode();
                        const newUser = {
                            userId: userId,
                            displayName: userProfile.displayName,
                            pictureUrl: userProfile.pictureUrl || '',
                            pairCode: newPairCode,
                            partnerId: null,
                            createdAt: new Date().toISOString(),
                            lastLoginAt: new Date().toISOString()
                        };
                        
                        userRef.set(newUser)
                            .then(() => {
                                currentUser = newUser;
                                console.log('âœ… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ:', currentUser);
                                updatePairStatus();
                            })
                            .catch((error) => {
                                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                            });
                        
                        return; // æ–°è¦ä½œæˆã®å ´åˆã¯ã“ã“ã§çµ‚äº†
                    }
                    
                    // ãƒšã‚¢çŠ¶æ…‹ã‚’æ›´æ–°
                    updatePairStatus();
                })
                .catch((error) => {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ãƒšã‚¢çŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
        function updatePairStatus() {
            const statusContent = document.getElementById('pairStatusContent');
            const realtimeGameButton = document.getElementById('realtimeGameButton');
            
            if (!currentUser) {
                statusContent.innerHTML = '<p style="color: #999; font-size: 14px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
                return;
            }
            
            if (currentUser.partnerId) {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ã‚‹å ´åˆï¼šãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®åå‰ã‚’å–å¾—ã—ã¦è¡¨ç¤º
                const partnerRef = database.ref('users/' + currentUser.partnerId);
                partnerRef.once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            statusContent.innerHTML = 
                                '<p style="color: #50C878; font-size: 15px; font-weight: bold;">âœ… ãƒšã‚¢æˆç«‹</p>' +
                                '<p style="color: #666; font-size: 14px; margin-top: 5px;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ' + partner.displayName + '</p>';
                            
                            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                            if (realtimeGameButton) {
                                realtimeGameButton.disabled = false;
                                realtimeGameButton.style.opacity = '1';
                                realtimeGameButton.style.cursor = 'pointer';
                            }
                        } else {
                            statusContent.innerHTML = '<p style="color: #ff6b6b; font-size: 14px;">âš ï¸ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                            
                            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                            if (realtimeGameButton) {
                                realtimeGameButton.disabled = true;
                                realtimeGameButton.style.opacity = '0.5';
                                realtimeGameButton.style.cursor = 'not-allowed';
                            }
                        }
                    })
                    .catch((error) => {
                        console.error('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                        statusContent.innerHTML = '<p style="color: #ff6b6b; font-size: 14px;">âŒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼</p>';
                        
                        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                        if (realtimeGameButton) {
                            realtimeGameButton.disabled = true;
                            realtimeGameButton.style.opacity = '0.5';
                            realtimeGameButton.style.cursor = 'not-allowed';
                        }
                    });
            } else {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ãªã„å ´åˆ
                statusContent.innerHTML = 
                    '<p style="color: #999; font-size: 14px;">ã¾ã ãƒšã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>' +
                    '<p style="color: #9B59B6; font-size: 13px; margin-top: 5px;">ã€Œãƒšã‚¢ã‚’è¨­å®šã™ã‚‹ã€ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†</p>';
                
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
                if (realtimeGameButton) {
                    realtimeGameButton.disabled = true;
                    realtimeGameButton.style.opacity = '0.5';
                    realtimeGameButton.style.cursor = 'not-allowed';
                    realtimeGameButton.style.background = '#CCC';
                }
            }
        }
        
        // ãƒšã‚¢è¨­å®šç”»é¢ã‚’è¡¨ç¤º
        function showPairScreen() {
            if (!currentUser) {
                alert('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }
            
            // è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            document.getElementById('myPairCode').textContent = currentUser.pairCode;
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            if (currentUser.partnerId) {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ã‚‹å ´åˆ
                const partnerRef = database.ref('users/' + currentUser.partnerId);
                partnerRef.once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            document.getElementById('partnerName').textContent = partner.displayName;
                            document.getElementById('currentPairInfo').style.display = 'block';
                        }
                    })
                    .catch((error) => {
                        console.error('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    });
            } else {
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒã„ãªã„å ´åˆ
                document.getElementById('currentPairInfo').style.display = 'none';
            }
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('partnerCodeInput').value = '';
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('pairScreen');
        }
        
        // ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
        function copyPairCode() {
            const code = currentUser.pairCode;
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        alert('âœ… ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nã‚³ãƒ¼ãƒ‰: ' + code + '\n\nãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ã£ã¦ãã ã•ã„ã€‚');
                    })
                    .catch(() => {
                        // ã‚³ãƒ”ãƒ¼å¤±æ•—æ™‚
                        alert('ãƒšã‚¢ã‚³ãƒ¼ãƒ‰: ' + code + '\n\nã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«é€ã£ã¦ãã ã•ã„ã€‚');
                    });
            } else {
                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆãªã„å ´åˆ
                alert('ãƒšã‚¢ã‚³ãƒ¼ãƒ‰: ' + code + '\n\nã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«é€ã£ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ãƒšã‚¢ã«ãªã‚‹
        function connectWithPartner() {
            const partnerCode = document.getElementById('partnerCodeInput').value.trim().toUpperCase();
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (partnerCode === '') {
                alert('âŒ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (partnerCode.length !== 6) {
                alert('âŒ ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã¯6æ–‡å­—ã§ã™ã€‚');
                return;
            }
            
            // è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (partnerCode === currentUser.pairCode) {
                alert('âŒ è‡ªåˆ†ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã¯å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚\nãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // Firebaseã§ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢
            const usersRef = database.ref('users');
            usersRef.orderByChild('pairCode').equalTo(partnerCode).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('âŒ ã“ã®ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¦‹ã¤ã‘ãŸ
                    let partnerId = null;
                    let partnerData = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        partnerId = childSnapshot.key;
                        partnerData = childSnapshot.val();
                    });
                    
                    if (!partnerId || !partnerData) {
                        alert('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        return;
                    }
                    
                    // æ—¢ã«ãƒšã‚¢ãŒã„ã‚‹å ´åˆã¯ç¢ºèª
                    if (currentUser.partnerId) {
                        if (!confirm('æ—¢ã«ãƒšã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚\næ–°ã—ã„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                            return;
                        }
                    }
                    
                    // è‡ªåˆ†ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’æ›´æ–°
                    const myUserRef = database.ref('users/' + userProfile.userId);
                    myUserRef.update({
                        partnerId: partnerId
                    })
                        .then(() => {
                            // ç›¸æ‰‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚‚æ›´æ–°
                            const partnerUserRef = database.ref('users/' + partnerId);
                            return partnerUserRef.update({
                                partnerId: userProfile.userId
                            });
                        })
                        .then(() => {
                            // æˆåŠŸ
                            currentUser.partnerId = partnerId;
                            alert('âœ… ãƒšã‚¢è¨­å®šå®Œäº†ï¼\n\nãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ' + partnerData.displayName + '\n\nã“ã‚Œã§ãŠäº’ã„ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å…±æœ‰ã§ãã¾ã™ã€‚');
                            
                            // è¡¨ç¤ºã‚’æ›´æ–°
                            updatePairStatus();
                            showPairScreen();
                        })
                        .catch((error) => {
                            alert('âŒ ãƒšã‚¢è¨­å®šã‚¨ãƒ©ãƒ¼:\n' + error.message);
                            console.error('âŒ ãƒšã‚¢è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                        });
                })
                .catch((error) => {
                    alert('âŒ ã‚³ãƒ¼ãƒ‰æ¤œç´¢ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ã‚³ãƒ¼ãƒ‰æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ãƒšã‚¢ã‚’è§£é™¤
        function disconnectPair() {
            if (!confirm('ãƒšã‚¢ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãŠäº’ã„ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¦‹ãˆãªããªã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            if (!currentUser.partnerId) {
                alert('âŒ ãƒšã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            const partnerId = currentUser.partnerId;
            
            // è‡ªåˆ†ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚’ã‚¯ãƒªã‚¢
            const myUserRef = database.ref('users/' + userProfile.userId);
            myUserRef.update({
                partnerId: null
            })
                .then(() => {
                    // ç›¸æ‰‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼IDã‚‚ã‚¯ãƒªã‚¢
                    const partnerUserRef = database.ref('users/' + partnerId);
                    return partnerUserRef.update({
                        partnerId: null
                    });
                })
                .then(() => {
                    // æˆåŠŸ
                    currentUser.partnerId = null;
                    alert('âœ… ãƒšã‚¢ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
                    
                    // è¡¨ç¤ºã‚’æ›´æ–°
                    updatePairStatus();
                    showPairScreen();
                })
                .catch((error) => {
                    alert('âŒ ãƒšã‚¢è§£é™¤ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ãƒšã‚¢è§£é™¤ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ========================================
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰
        // ========================================
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ é–‹å§‹
        function startRealtimeGame() {
            // ãƒšã‚¢ãƒã‚§ãƒƒã‚¯
            if (!currentUser || !currentUser.partnerId) {
                alert('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nå…ˆã«ã€Œãƒšã‚¢è¨­å®šã€ã‹ã‚‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ãƒšã‚¢ã«ãªã£ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // æ—¢å­˜ã®å¾…æ©Ÿä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            checkExistingSession();
        }
        
        // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        function checkExistingSession() {
            const sessionsRef = database.ref('gameSessions');
            
            // è‡ªåˆ†ã¾ãŸã¯ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒé–¢ã‚ã£ã¦ã„ã‚‹å¾…æ©Ÿä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
            sessionsRef.orderByChild('gameStatus').equalTo('waiting').once('value')
                .then((snapshot) => {
                    let existingSession = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        const session = childSnapshot.val();
                        const sessionId = childSnapshot.key;
                        
                        // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è‡ªåˆ†ã¾ãŸã¯ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‹ç¢ºèª
                        if (session.players && 
                            (session.players[userProfile.userId] || session.players[currentUser.partnerId])) {
                            existingSession = {
                                id: sessionId,
                                data: session
                            };
                        }
                    });
                    
                    if (existingSession) {
                        // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹
                        if (existingSession.data.players[userProfile.userId]) {
                            // è‡ªåˆ†ãŒä½œæˆã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³
                            showWaitingRoom(existingSession.id, existingSession.data, 'host');
                        } else {
                            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒä½œæˆã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³
                            showWaitingRoom(existingSession.id, existingSession.data, 'guest');
                        }
                    } else {
                        // æ–°ã—ãã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                        createGameSession();
                    }
                })
                .catch((error) => {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        function createGameSession() {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ†ãƒ¼ãƒã‚’é¸ã¶
            const theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const sessionData = {
                mode: 'realtime',
                theme: theme,
                gameStatus: 'waiting',  // waiting â†’ inputting â†’ guessing â†’ finished
                createdAt: new Date().toISOString(),
                players: {}
            };
            
            // è‡ªåˆ†ã‚’è¿½åŠ 
            sessionData.players[userProfile.userId] = {
                displayName: userProfile.displayName,
                status: 'waiting'  // waiting â†’ inputting â†’ completed
            };
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¿½åŠ 
            sessionData.players[currentUser.partnerId] = {
                displayName: '',  // å¾Œã§å–å¾—
                status: 'waiting'
            };
            
            // Firebaseã«ä¿å­˜
            const sessionsRef = database.ref('gameSessions');
            const newSessionRef = sessionsRef.push();
            
            newSessionRef.set(sessionData)
                .then(() => {
                    console.log('âœ… ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ:', newSessionRef.key);
                    showWaitingRoom(newSessionRef.key, sessionData, 'host');
                })
                .catch((error) => {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚²ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // å¾…æ©Ÿãƒ«ãƒ¼ãƒ è¡¨ç¤º
        function showWaitingRoom(sessionId, sessionData, role) {
            currentGameSession = {
                id: sessionId,
                data: sessionData,
                role: role  // 'host' ã¾ãŸã¯ 'guest'
            };
            
            if (role === 'host') {
                // ãƒ›ã‚¹ãƒˆï¼šå¾…æ©Ÿç”»é¢
                document.getElementById('waitingArea').style.display = 'block';
                document.getElementById('joinArea').style.display = 'none';
                document.getElementById('waitingTheme').textContent = sessionData.theme;
                
                // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åã‚’å–å¾—
                database.ref('users/' + currentUser.partnerId).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const partner = snapshot.val();
                            document.getElementById('waitingMessage').textContent = 
                                partner.displayName + 'ã•ã‚“ã‚’å¾…ã£ã¦ã„ã¾ã™...';
                        }
                    });
            } else {
                // ã‚²ã‚¹ãƒˆï¼šå‚åŠ ç¢ºèªç”»é¢
                document.getElementById('waitingArea').style.display = 'none';
                document.getElementById('joinArea').style.display = 'block';
                document.getElementById('joinTheme').textContent = sessionData.theme;
                
                // ãƒ›ã‚¹ãƒˆåã‚’å–å¾—
                const hostId = Object.keys(sessionData.players).find(id => id !== userProfile.userId);
                database.ref('users/' + hostId).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const host = snapshot.val();
                            document.getElementById('joinMessage').textContent = 
                                host.displayName + 'ã•ã‚“ãŒå¾…ã£ã¦ã„ã¾ã™ï¼';
                        }
                    });
            }
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('waitingRoomScreen');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–é–‹å§‹
            startSessionListener(sessionId);
        }
        
        // ã‚²ãƒ¼ãƒ ã«å‚åŠ 
        function joinGame() {
            if (!currentGameSession) {
                alert('âŒ ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            sessionRef.update({
                gameStatus: 'inputting'
            })
                .then(() => {
                    console.log('âœ… ã‚²ãƒ¼ãƒ å‚åŠ æˆåŠŸ');
                    // å…¥åŠ›ç”»é¢ã¸ï¼ˆãƒªã‚¹ãƒŠãƒ¼ãŒè‡ªå‹•çš„ã«åå¿œï¼‰
                })
                .catch((error) => {
                    console.error('âŒ ã‚²ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ å‚åŠ ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–é–‹å§‹
        function startSessionListener(sessionId) {
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°è§£é™¤
            if (sessionListener) {
                sessionListener.off();
            }
            
            const sessionRef = database.ref('gameSessions/' + sessionId);
            
            sessionListener = sessionRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    console.log('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    return;
                }
                
                const sessionData = snapshot.val();
                currentGameSession.data = sessionData;
                
                console.log('ğŸ“¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°:', sessionData.gameStatus);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
                switch (sessionData.gameStatus) {
                    case 'waiting':
                        // å¾…æ©Ÿä¸­ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
                        break;
                        
                    case 'inputting':
                        // å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º
                        showGameInputScreen(sessionData);
                        break;
                        
                    case 'guessing':
                        // äºˆæƒ³ãƒ•ã‚§ãƒ¼ã‚º
                        showGuessScreen(sessionData);
                        break;
                        
                    case 'finished':
                        // çµæœè¡¨ç¤º
                        showResultScreen(sessionData);
                        break;
                }
            });
        }
        
        // å¾…æ©Ÿãƒ«ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelWaitingRoom() {
            // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
            if (sessionListener) {
                sessionListener.off();
                sessionListener = null;
            }
            
            // ãƒ›ã‚¹ãƒˆã®å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
            if (currentGameSession && currentGameSession.role === 'host') {
                const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                sessionRef.remove()
                    .then(() => {
                        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤æˆåŠŸ');
                    })
                    .catch((error) => {
                        console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    });
            }
            
            currentGameSession = null;
            backToMain();
        }
        
        // ã‚²ãƒ¼ãƒ å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
        function showGameInputScreen(sessionData) {
            // ãƒ†ãƒ¼ãƒã‚’è¡¨ç¤º
            document.getElementById('gameTheme').textContent = sessionData.theme;
            
            // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
            updateGameProgress(sessionData);
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            for (let i = 1; i <= 5; i++) {
                document.getElementById('gameRank' + i).value = '';
            }
            
            // è‡ªåˆ†ãŒæ—¢ã«å…¥åŠ›æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (sessionData.rankings && sessionData.rankings[userProfile.userId]) {
                // å…¥åŠ›æ¸ˆã¿ã®å ´åˆã¯ã€å…¥åŠ›å†…å®¹ã‚’è¡¨ç¤º
                const myRanking = sessionData.rankings[userProfile.userId];
                for (let i = 1; i <= 5; i++) {
                    document.getElementById('gameRank' + i).value = myRanking[i.toString()] || '';
                }
            }
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('gameInputScreen');
            
            // 1ä½ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                document.getElementById('gameRank1').focus();
            }, 100);
        }
        
        // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
        function updateGameProgress(sessionData) {
            const players = sessionData.players || {};
            const playerIds = Object.keys(players);
            
            let progressHtml = '';
            
            playerIds.forEach((playerId) => {
                const player = players[playerId];
                const isMe = playerId === userProfile.userId;
                const displayName = isMe ? 'ã‚ãªãŸ' : player.displayName;
                
                let statusIcon = '';
                let statusText = '';
                let statusColor = '#999';
                
                if (sessionData.gameStatus === 'inputting') {
                    if (sessionData.rankings && sessionData.rankings[playerId]) {
                        statusIcon = 'âœ…';
                        statusText = 'å…¥åŠ›å®Œäº†';
                        statusColor = '#50C878';
                    } else {
                        statusIcon = 'â³';
                        statusText = 'å…¥åŠ›ä¸­...';
                        statusColor = '#FF9800';
                    }
                } else if (sessionData.gameStatus === 'guessing') {
                    if (sessionData.guesses && sessionData.guesses[playerId]) {
                        statusIcon = 'âœ…';
                        statusText = 'äºˆæƒ³å®Œäº†';
                        statusColor = '#50C878';
                    } else {
                        statusIcon = 'ğŸ¤”';
                        statusText = 'äºˆæƒ³ä¸­...';
                        statusColor = '#FF9800';
                    }
                }
                
                progressHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0;">';
                progressHtml += '<span style="color: #666; font-size: 14px;">' + statusIcon + ' ' + displayName + '</span>';
                progressHtml += '<span style="color: ' + statusColor + '; font-size: 13px; font-weight: bold;">' + statusText + '</span>';
                progressHtml += '</div>';
            });
            
            const contentId = sessionData.gameStatus === 'inputting' ? 'gameProgressContent' : 'guessProgressContent';
            document.getElementById(contentId).innerHTML = progressHtml;
        }
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡
        function submitGameRanking() {
            // å…¥åŠ›å€¤ã‚’å–å¾—
            const rankings = [];
            for (let i = 1; i <= 5; i++) {
                const value = document.getElementById('gameRank' + i).value.trim();
                if (value === '') {
                    alert((i) + 'ä½ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                    document.getElementById('gameRank' + i).focus();
                    return;
                }
                rankings.push(value);
            }
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const rankingData = {
                "1": rankings[0],
                "2": rankings[1],
                "3": rankings[2],
                "4": rankings[3],
                "5": rankings[4]
            };
            
            // Firebaseã«ä¿å­˜
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updateData = {};
            updateData['rankings/' + userProfile.userId] = rankingData;
            updateData['players/' + userProfile.userId + '/status'] = 'completed';
            
            sessionRef.update(updateData)
                .then(() => {
                    console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡æˆåŠŸ');
                    
                    // ä¸¡è€…ãŒå…¥åŠ›å®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    return sessionRef.once('value');
                })
                .then((snapshot) => {
                    const sessionData = snapshot.val();
                    const rankings = sessionData.rankings || {};
                    const players = Object.keys(sessionData.players);
                    
                    // å…¨å“¡ãŒå…¥åŠ›å®Œäº†ã—ãŸã‹
                    if (players.every(playerId => rankings[playerId])) {
                        // äºˆæƒ³ãƒ•ã‚§ãƒ¼ã‚ºã¸ç§»è¡Œ
                        return sessionRef.update({
                            gameStatus: 'guessing'
                        });
                    }
                })
                .catch((error) => {
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // äºˆæƒ³ç”»é¢ã‚’è¡¨ç¤º
        function showGuessScreen(sessionData) {
            // ãƒ†ãƒ¼ãƒã‚’è¡¨ç¤º
            document.getElementById('guessTheme').textContent = sessionData.theme;
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åã‚’å–å¾—
            const partnerId = currentUser.partnerId;
            database.ref('users/' + partnerId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const partner = snapshot.val();
                        document.getElementById('guessPartnerName').textContent = partner.displayName;
                    }
                });
            
            // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
            updateGameProgress(sessionData);
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°é …ç›®ã‚’å–å¾—
            const partnerRanking = sessionData.rankings[partnerId];
            if (!partnerRanking) {
                alert('âŒ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // é …ç›®ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const items = [];
            for (let i = 1; i <= 5; i++) {
                items.push(partnerRanking[i.toString()]);
            }
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yates ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }
            
            // ä¸¦ã³æ›¿ãˆã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
            createGuessRankingUI(items);
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('guessScreen');
        }
        
        // äºˆæƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°UIã‚’ç”Ÿæˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼‰
        function createGuessRankingUI(items) {
            const container = document.getElementById('guessRankingArea');
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-index', index);
                itemDiv.setAttribute('data-item', item);
                
                // é †ä½ç•ªå·
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + 'ä½';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ï¼ˆâ‰¡ã‚¢ã‚¤ã‚³ãƒ³ï¼‰
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = 'â‰¡';
                
                // ãƒ†ã‚­ã‚¹ãƒˆ
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px;';
                
                // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.cssText = 'display: flex; gap: 5px;';
                
                // ä¸Šã¸ãƒœã‚¿ãƒ³
                if (index > 0) {
                    const upBtn = document.createElement('button');
                    upBtn.textContent = 'â†‘';
                    upBtn.style.cssText = 'background: #4A90E2; color: white; border: none; border-radius: 5px; padding: 8px 12px; font-size: 16px; cursor: pointer;';
                    upBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveItem(index, -1);
                    };
                    buttonsDiv.appendChild(upBtn);
                }
                
                // ä¸‹ã¸ãƒœã‚¿ãƒ³
                if (index < items.length - 1) {
                    const downBtn = document.createElement('button');
                    downBtn.textContent = 'â†“';
                    downBtn.style.cssText = 'background: #4A90E2; color: white; border: none; border-radius: 5px; padding: 8px 12px; font-size: 16px; cursor: pointer;';
                    downBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveItem(index, 1);
                    };
                    buttonsDiv.appendChild(downBtn);
                }
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(handleSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(buttonsDiv);
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ç”¨ï¼‰
                setupGameDragEvents(itemDiv);
                
                container.appendChild(itemDiv);
            });
            
            // ç¾åœ¨ã®é …ç›®ãƒªã‚¹ãƒˆã‚’ä¿å­˜
            container.setAttribute('data-items', JSON.stringify(items));
        }
        
        // é …ç›®ã‚’ç§»å‹•ï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰
        function moveItem(index, direction) {
            const container = document.getElementById('guessRankingArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            const newIndex = index + direction;
            
            // ç¯„å›²ãƒã‚§ãƒƒã‚¯
            if (newIndex < 0 || newIndex >= items.length) {
                return;
            }
            
            // å…¥ã‚Œæ›¿ãˆ
            [items[index], items[newIndex]] = [items[newIndex], items[index]];
            
            // UIã‚’å†ç”Ÿæˆ
            createGuessRankingUI(items);
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ç”¨ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ”¹å–„ç‰ˆï¼šã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ç§»å‹•ï¼‰
        function setupGameDragEvents(element) {
            let draggedElement = null;
            let placeholder = null;
            let isDragging = false;
            
            // ã‚¿ãƒƒãƒã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚¹ãƒãƒ›ï¼‰
            element.addEventListener('touchstart', function(e) {
                isDragging = false;
                draggedElement = this;
                
                // 200mså¾Œã«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                setTimeout(() => {
                    if (draggedElement === this && !isDragging) {
                        isDragging = true;
                        this.classList.add('dragging');
                        
                        // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        
                        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œæˆ
                        placeholder = this.cloneNode(true);
                        placeholder.style.opacity = '0.3';
                        placeholder.style.pointerEvents = 'none';
                    }
                }, 200);
            }, { passive: true });
            
            // ã‚¿ãƒƒãƒãƒ ãƒ¼ãƒ–ï¼ˆã‚¹ãƒãƒ›ï¼‰
            element.addEventListener('touchmove', function(e) {
                if (!isDragging || !draggedElement) return;
                
                const touch = e.touches[0];
                const touchY = touch.clientY;
                
                // ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
                const container = document.getElementById('guessRankingArea');
                const items = Array.from(container.children);
                
                // ã‚¿ãƒƒãƒä½ç½®ã«æœ€ã‚‚è¿‘ã„è¦ç´ ã‚’è¦‹ã¤ã‘ã‚‹
                let closestElement = null;
                let closestDistance = Infinity;
                
                items.forEach(item => {
                    if (item === draggedElement) return;
                    
                    const rect = item.getBoundingClientRect();
                    const itemCenterY = rect.top + rect.height / 2;
                    const distance = Math.abs(touchY - itemCenterY);
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestElement = item;
                    }
                });
                
                // æœ€ã‚‚è¿‘ã„è¦ç´ ã®å‰ã¾ãŸã¯å¾Œã«æŒ¿å…¥
                if (closestElement) {
                    const rect = closestElement.getBoundingClientRect();
                    const closestCenterY = rect.top + rect.height / 2;
                    
                    if (touchY < closestCenterY) {
                        // ä¸Šã«æŒ¿å…¥
                        if (closestElement !== draggedElement.nextSibling) {
                            container.insertBefore(draggedElement, closestElement);
                        }
                    } else {
                        // ä¸‹ã«æŒ¿å…¥
                        if (closestElement.nextSibling !== draggedElement) {
                            container.insertBefore(draggedElement, closestElement.nextSibling);
                        }
                    }
                }
            }, { passive: true });
            
            // ã‚¿ãƒƒãƒã‚¨ãƒ³ãƒ‰ï¼ˆã‚¹ãƒãƒ›ï¼‰
            element.addEventListener('touchend', function(e) {
                isDragging = false;
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    
                    // é †åºã‚’æ›´æ–°
                    updateGameItemsOrder();
                    
                    draggedElement = null;
                    placeholder = null;
                }
            });
            
            // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«
            element.addEventListener('touchcancel', function(e) {
                isDragging = false;
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                    placeholder = null;
                }
            });
            
            // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
            element.setAttribute('draggable', 'true');
            
            element.addEventListener('dragstart', function(e) {
                draggedElement = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            element.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (draggedElement === this) return;
                
                const container = document.getElementById('guessRankingArea');
                const bounding = this.getBoundingClientRect();
                const offset = e.clientY - bounding.top;
                
                if (offset > bounding.height / 2) {
                    // ä¸‹åŠåˆ†ï¼šã“ã®è¦ç´ ã®å¾Œã«æŒ¿å…¥
                    container.insertBefore(draggedElement, this.nextSibling);
                } else {
                    // ä¸ŠåŠåˆ†ï¼šã“ã®è¦ç´ ã®å‰ã«æŒ¿å…¥
                    container.insertBefore(draggedElement, this);
                }
            });
            
            element.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
                updateGameItemsOrder();
                draggedElement = null;
            });
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ï¼šé …ç›®é †åºã‚’æ›´æ–°
        function updateGameItemsOrder() {
            const container = document.getElementById('guessRankingArea');
            const items = Array.from(container.children);
            const newOrder = items.map((item, index) => {
                item.setAttribute('data-index', index);
                return item.getAttribute('data-item');
            });
            
            // ç¾åœ¨ã®é †åºã‚’ä¿å­˜
            container.setAttribute('data-items', JSON.stringify(newOrder));
            
            // UIã‚’å†ç”Ÿæˆï¼ˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼‰
            createGuessRankingUI(newOrder);
        }
        
        // äºˆæƒ³ã‚’é€ä¿¡
        function submitGuess() {
            const container = document.getElementById('guessRankingArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            if (!items || items.length !== 5) {
                alert('âŒ äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (!confirm('ã“ã®é †ç•ªã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\n' + 
                         '1ä½: ' + items[0] + '\n' +
                         '2ä½: ' + items[1] + '\n' +
                         '3ä½: ' + items[2] + '\n' +
                         '4ä½: ' + items[3] + '\n' +
                         '5ä½: ' + items[4])) {
                return;
            }
            
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const guessData = {
                "1": items[0],
                "2": items[1],
                "3": items[2],
                "4": items[3],
                "5": items[4]
            };
            
            // Firebaseã«ä¿å­˜
            const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
            const updateData = {};
            updateData['guesses/' + userProfile.userId] = guessData;
            updateData['players/' + userProfile.userId + '/status'] = 'completed';
            
            sessionRef.update(updateData)
                .then(() => {
                    console.log('âœ… äºˆæƒ³é€ä¿¡æˆåŠŸ');
                    
                    // ä¸¡è€…ãŒäºˆæƒ³å®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    return sessionRef.once('value');
                })
                .then((snapshot) => {
                    const sessionData = snapshot.val();
                    const guesses = sessionData.guesses || {};
                    const players = Object.keys(sessionData.players);
                    
                    // å…¨å“¡ãŒäºˆæƒ³å®Œäº†ã—ãŸã‹
                    if (players.every(playerId => guesses[playerId])) {
                        // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                        const results = calculateScores(sessionData);
                        
                        // çµæœã‚’ä¿å­˜ã—ã¦å®Œäº†çŠ¶æ…‹ã¸
                        return sessionRef.update({
                            gameStatus: 'finished',
                            results: results,
                            finishedAt: new Date().toISOString()
                        });
                    }
                })
                .catch((error) => {
                    console.error('âŒ äºˆæƒ³é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆæ–¹å¼Bï¼šå€‹æ•°ï¼‹é †ä½ï¼‰
        function calculateScores(sessionData) {
            const rankings = sessionData.rankings;
            const guesses = sessionData.guesses;
            const players = Object.keys(sessionData.players);
            const results = {};
            
            players.forEach((playerId) => {
                // ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®äºˆæƒ³ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                const partnerId = players.find(id => id !== playerId);
                const partnerRanking = rankings[partnerId];  // æ­£è§£
                const myGuess = guesses[playerId];            // äºˆæƒ³
                
                let matchCount = 0;    // å½“ã¦ãŸå€‹æ•°
                let rankScore = 0;     // é †ä½ãƒœãƒ¼ãƒŠã‚¹
                
                for (let rank = 1; rank <= 5; rank++) {
                    const rankStr = rank.toString();
                    const correctItem = partnerRanking[rankStr];
                    const guessedItem = myGuess[rankStr];
                    
                    if (correctItem === guessedItem) {
                        // å®Œå…¨ä¸€è‡´
                        matchCount++;
                        rankScore += (6 - rank);  // 1ä½=5ç‚¹ã€2ä½=4ç‚¹ã€...ã€5ä½=1ç‚¹
                    }
                }
                
                const totalScore = matchCount + rankScore;
                
                results[playerId] = {
                    score: totalScore,
                    matchCount: matchCount,
                    rankScore: rankScore
                };
            });
            
            return results;
        }
        
        // çµæœç”»é¢ã‚’è¡¨ç¤º
        function showResultScreen(sessionData) {
            const rankings = sessionData.rankings;
            const guesses = sessionData.guesses;
            const results = sessionData.results;
            const players = Object.keys(sessionData.players);
            
            const myId = userProfile.userId;
            const partnerId = players.find(id => id !== myId);
            
            const myScore = results[myId];
            const partnerScore = results[partnerId];
            
            // å‹æ•—åˆ¤å®š
            let resultTitle = '';
            let resultEmoji = '';
            if (myScore.score > partnerScore.score) {
                resultTitle = 'ã‚ãªãŸã®å‹ã¡ï¼';
                resultEmoji = 'ğŸ‰';
            } else if (myScore.score < partnerScore.score) {
                resultTitle = 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®å‹ã¡ï¼';
                resultEmoji = 'ğŸ˜„';
            } else {
                resultTitle = 'å¼•ãåˆ†ã‘ï¼';
                resultEmoji = 'ğŸ¤';
            }
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åã‚’å–å¾—
            database.ref('users/' + partnerId).once('value')
                .then((snapshot) => {
                    const partnerName = snapshot.exists() ? snapshot.val().displayName : 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼';
                    
                    // çµæœHTMLã‚’ç”Ÿæˆ
                    let html = '';
                    
                    // å‹æ•—è¡¨ç¤º
                    html += '<div style="text-align: center; margin-bottom: 30px;">';
                    html += '<p style="font-size: 64px; margin-bottom: 10px;">' + resultEmoji + '</p>';
                    html += '<h3 style="color: #FF6B9D; font-size: 24px; margin-bottom: 10px;">' + resultTitle + '</h3>';
                    html += '</div>';
                    
            // ç«¶äº‰å‹ï¼šå€‹åˆ¥ã‚¹ã‚³ã‚¢è¡¨ç¤º
            html += '<div style="background: #F0F8FF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">';
            html += '<h3 style="color: #4A90E2; font-size: 16px; margin-bottom: 15px;">ğŸ† å¯¾æˆ¦æˆç¸¾</h3>';
            html += '<div style="display: flex; justify-content: space-around; text-align: center;">';
            
            // è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px; margin-bottom: 5px;">ã‚ãªãŸ</p>';
            html += '<p style="color: #FF6B9D; font-size: 32px; font-weight: bold;">' + myScore.score + '<span style="font-size: 16px; color: #999;"> / 20</span></p>';
            html += '<p style="color: #999; font-size: 12px;">å½“ã¦ãŸå€‹æ•°: ' + myScore.matchCount + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">é †ä½ãƒœãƒ¼ãƒŠã‚¹: ' + myScore.rankScore + 'ç‚¹</p>';
            html += '</div>';
            
            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ã‚¹ã‚³ã‚¢
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px; margin-bottom: 5px;">' + partnerName + '</p>';
            html += '<p style="color: #4A90E2; font-size: 32px; font-weight: bold;">' + partnerScore.score + '<span style="font-size: 16px; color: #999;"> / 20</span></p>';
            html += '<p style="color: #999; font-size: 12px;">å½“ã¦ãŸå€‹æ•°: ' + partnerScore.matchCount + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">é †ä½ãƒœãƒ¼ãƒŠã‚¹: ' + partnerScore.rankScore + 'ç‚¹</p>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // å”åŠ›å‹ï¼šåˆè¨ˆã‚¹ã‚³ã‚¢è¡¨ç¤º
            const totalScore = myScore.score + partnerScore.score;
            const maxScore = 40;
            let cooperativeEmoji = '';
            let cooperativeMessage = '';
            
            if (totalScore >= 35) {
                cooperativeEmoji = 'ğŸ‰';
                cooperativeMessage = 'å®Œç’§ãªã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼';
            } else if (totalScore >= 30) {
                cooperativeEmoji = 'ğŸ˜Š';
                cooperativeMessage = 'ç´ æ™´ã‚‰ã—ã„ï¼';
            } else if (totalScore >= 25) {
                cooperativeEmoji = 'ğŸ‘';
                cooperativeMessage = 'ã„ã„æ„Ÿã˜ï¼';
            } else if (totalScore >= 20) {
                cooperativeEmoji = 'ğŸ¤”';
                cooperativeMessage = 'ã¾ã ã¾ã ä¼¸ã³ã—ã‚ã‚ã‚Šï¼';
            } else if (totalScore >= 15) {
                cooperativeEmoji = 'ğŸ’ª';
                cooperativeMessage = 'æ¬¡ã¯é ‘å¼µã‚ã†ï¼';
            } else {
                cooperativeEmoji = 'ğŸ˜…';
                cooperativeMessage = 'ã‚‚ã£ã¨è©±ãã†ï¼';
            }
            
            html += '<div style="background: #F0FFF4; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<h3 style="color: #50C878; font-size: 16px; margin-bottom: 15px;">ğŸ’‘ ãµãŸã‚Šã®æˆç¸¾</h3>';
            html += '<p style="font-size: 48px; margin-bottom: 10px;">' + cooperativeEmoji + '</p>';
            html += '<p style="color: #50C878; font-size: 32px; font-weight: bold; margin-bottom: 5px;">' + totalScore + '<span style="font-size: 20px; color: #999;"> / ' + maxScore + 'ç‚¹</span></p>';
            html += '<p style="color: #666; font-size: 16px; font-weight: bold;">' + cooperativeMessage + '</p>';
            html += '</div>';
                    
                    // æ­£è§£ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
                    html += '<div style="background: #FFF8F0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">';
                    html += '<h3 style="color: #FF9800; font-size: 16px; margin-bottom: 15px;">âœ¨ ' + partnerName + 'ã•ã‚“ã®æ­£è§£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>';
                    const partnerRanking = rankings[partnerId];
                    const myGuess = guesses[myId];
                    for (let i = 1; i <= 5; i++) {
                        const rankStr = i.toString();
                        const correct = partnerRanking[rankStr];
                        const guess = myGuess[rankStr];
                        const isCorrect = correct === guess;
                        const icon = isCorrect ? 'âœ…' : 'âŒ';
                        const color = isCorrect ? '#50C878' : '#ff6b6b';
                        const bgColor = isCorrect ? '#F0FFF4' : 'transparent';
                        
                        html += '<div style="display: flex; align-items: center; margin: 8px 0; padding: 10px; border-radius: 8px; background: ' + bgColor + ';">';
                        html += '<span style="color: #666; font-size: 14px; min-width: 40px;">' + i + 'ä½:</span>';
                        html += '<span style="color: #333; font-size: 15px; flex: 1;">' + correct + '</span>';
                        html += '<span style="color: ' + color + '; font-size: 14px; font-weight: bold;">' + icon + ' ' + (isCorrect ? 'æ­£è§£' : guess) + '</span>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    // è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
                    html += '<div style="background: #F0FFF4; border-radius: 10px; padding: 20px; margin-bottom: 20px;">';
                    html += '<h3 style="color: #50C878; font-size: 16px; margin-bottom: 15px;">âœ¨ ã‚ãªãŸã®æ­£è§£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>';
                    const myRanking = rankings[myId];
                    const partnerGuess = guesses[partnerId];
                    for (let i = 1; i <= 5; i++) {
                        const rankStr = i.toString();
                        const correct = myRanking[rankStr];
                        const guess = partnerGuess[rankStr];
                        const isCorrect = correct === guess;
                        const icon = isCorrect ? 'âœ…' : 'âŒ';
                        const color = isCorrect ? '#50C878' : '#ff6b6b';
                        const bgColor = isCorrect ? '#F0FFF4' : 'transparent';
                        
                        html += '<div style="display: flex; align-items: center; margin: 8px 0; padding: 10px; border-radius: 8px; background: ' + bgColor + ';">';
                        html += '<span style="color: #666; font-size: 14px; min-width: 40px;">' + i + 'ä½:</span>';
                        html += '<span style="color: #333; font-size: 15px; flex: 1;">' + correct + '</span>';
                        html += '<span style="color: ' + color + '; font-size: 14px; font-weight: bold;">' + icon + ' ' + (isCorrect ? 'æ­£è§£' : guess) + '</span>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    document.getElementById('resultContent').innerHTML = html;
                });
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('resultScreen');
        }
        
        // ã‚‚ã†ä¸€åº¦éŠã¶
        function playAgain() {
            // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
            if (sessionListener) {
                sessionListener.off();
                sessionListener = null;
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if (currentGameSession) {
                const sessionRef = database.ref('gameSessions/' + currentGameSession.id);
                sessionRef.remove()
                    .then(() => {
                        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤æˆåŠŸ');
                    })
                    .catch((error) => {
                        console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    });
            }
            
            currentGameSession = null;
            
            // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
            startRealtimeGame();
        }
        
        // ========================================
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³æ©Ÿèƒ½ï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ»ä¸€äººãƒ—ãƒ¬ã‚¤ï¼‰
        // ========================================
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¦é–‹å§‹
        function showReviewList() {
            // Firebaseã‹ã‚‰è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (!database || !userProfile) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
                return;
            }
            
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDã‚’è¿½åŠ 
                        rankings.push(data);
                    });
                    
                    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒãªã„å ´åˆ
                    if (rankings.length === 0) {
                        alert('âŒ ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“\nå…ˆã«ã€Œæ–°ã—ã„ãƒ†ãƒ¼ãƒã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã‚‹ã€ã§éŠã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼');
                        return;
                    }
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
                    const randomIndex = Math.floor(Math.random() * rankings.length);
                    const selectedRanking = rankings[randomIndex];
                    
                    console.log('âœ… ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ:', selectedRanking.theme);
                    
                    // é¸æŠã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§äºˆæƒ³é–‹å§‹
                    startReviewGuess(selectedRanking.id);
                })
                .catch((error) => {
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šä¸¦ã³æ›¿ãˆé–‹å§‹
        function startReviewGuess(rankingId) {
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const rankingRef = database.ref('rankings/' + rankingId);
            
            rankingRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                        return;
                    }
                    
                    const rankingData = snapshot.val();
                    currentReviewRanking = {
                        id: rankingId,
                        data: rankingData
                    };
                    
                    // æ­£è§£ã‚’ä¿å­˜
                    reviewCorrectAnswer = rankingData.ranking;
                    
                    // ãƒ†ãƒ¼ãƒã‚’è¡¨ç¤º
                    document.getElementById('reviewTheme').textContent = rankingData.theme;
                    
                    // é …ç›®ã‚’å–å¾—ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    const items = [];
                    for (let i = 1; i <= 5; i++) {
                        items.push(rankingData.ranking[i.toString()]);
                    }
                    
                    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yates ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
                    for (let i = items.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [items[i], items[j]] = [items[j], items[i]];
                    }
                    
                    // UIã‚’ç”Ÿæˆ
                    createReviewGuessUI(items);
                    
                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    showScreen('reviewGuessScreen');
                })
                .catch((error) => {
                    console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                });
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šUIã‚’ç”Ÿæˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼‰
        function createReviewGuessUI(items) {
            const container = document.getElementById('reviewGuessArea');
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.setAttribute('data-index', index);
                itemDiv.setAttribute('data-item', item);
                itemDiv.style.userSelect = 'none';  // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç„¡åŠ¹åŒ–
                
                // é †ä½ç•ªå·
                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-number';
                rankSpan.textContent = (index + 1) + 'ä½';
                
                // ãƒ†ã‚­ã‚¹ãƒˆ
                const textSpan = document.createElement('span');
                textSpan.textContent = item;
                textSpan.style.cssText = 'color: #333; font-size: 15px; flex: 1; padding: 0 10px; user-select: none;';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ï¼ˆâ‰¡ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’å³ç«¯ã«é…ç½®
                const handleSpan = document.createElement('span');
                handleSpan.className = 'drag-handle';
                handleSpan.textContent = 'â‰¡';
                handleSpan.style.cssText = 'margin-left: auto;';
                
                itemDiv.appendChild(rankSpan);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(handleSpan);
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                setupDragEvents(itemDiv);
                
                container.appendChild(itemDiv);
            });
            
            // ç¾åœ¨ã®é …ç›®ãƒªã‚¹ãƒˆã‚’ä¿å­˜
            container.setAttribute('data-items', JSON.stringify(items));
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šï¼ˆæ”¹å–„ç‰ˆï¼šã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ç§»å‹•ï¼‰
        function setupDragEvents(element) {
            let draggedElement = null;
            let placeholder = null;
            let isDragging = false;
            
            // ã‚¿ãƒƒãƒã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚¹ãƒãƒ›ï¼‰
            element.addEventListener('touchstart', function(e) {
                isDragging = false;
                draggedElement = this;
                
                // 200mså¾Œã«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                setTimeout(() => {
                    if (draggedElement === this && !isDragging) {
                        isDragging = true;
                        this.classList.add('dragging');
                        
                        // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        
                        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œæˆ
                        placeholder = this.cloneNode(true);
                        placeholder.style.opacity = '0.3';
                        placeholder.style.pointerEvents = 'none';
                    }
                }, 200);
            }, { passive: true });
            
            // ã‚¿ãƒƒãƒãƒ ãƒ¼ãƒ–ï¼ˆã‚¹ãƒãƒ›ï¼‰
            element.addEventListener('touchmove', function(e) {
                if (!isDragging || !draggedElement) return;
                
                const touch = e.touches[0];
                const touchY = touch.clientY;
                
                // ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
                const container = document.getElementById('reviewGuessArea');
                const items = Array.from(container.children);
                
                // ã‚¿ãƒƒãƒä½ç½®ã«æœ€ã‚‚è¿‘ã„è¦ç´ ã‚’è¦‹ã¤ã‘ã‚‹
                let closestElement = null;
                let closestDistance = Infinity;
                
                items.forEach(item => {
                    if (item === draggedElement) return;
                    
                    const rect = item.getBoundingClientRect();
                    const itemCenterY = rect.top + rect.height / 2;
                    const distance = Math.abs(touchY - itemCenterY);
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestElement = item;
                    }
                });
                
                // æœ€ã‚‚è¿‘ã„è¦ç´ ã®å‰ã¾ãŸã¯å¾Œã«æŒ¿å…¥
                if (closestElement) {
                    const rect = closestElement.getBoundingClientRect();
                    const closestCenterY = rect.top + rect.height / 2;
                    
                    if (touchY < closestCenterY) {
                        // ä¸Šã«æŒ¿å…¥
                        if (closestElement !== draggedElement.nextSibling) {
                            container.insertBefore(draggedElement, closestElement);
                        }
                    } else {
                        // ä¸‹ã«æŒ¿å…¥
                        if (closestElement.nextSibling !== draggedElement) {
                            container.insertBefore(draggedElement, closestElement.nextSibling);
                        }
                    }
                }
            }, { passive: true });
            
            // ã‚¿ãƒƒãƒã‚¨ãƒ³ãƒ‰ï¼ˆã‚¹ãƒãƒ›ï¼‰
            element.addEventListener('touchend', function(e) {
                isDragging = false;
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    
                    // é †åºã‚’æ›´æ–°
                    updateReviewItemsOrder();
                    
                    draggedElement = null;
                    placeholder = null;
                }
            });
            
            // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«
            element.addEventListener('touchcancel', function(e) {
                isDragging = false;
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                    placeholder = null;
                }
            });
            
            // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
            element.setAttribute('draggable', 'true');
            
            element.addEventListener('dragstart', function(e) {
                draggedElement = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            element.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (draggedElement === this) return;
                
                const container = document.getElementById('reviewGuessArea');
                const bounding = this.getBoundingClientRect();
                const offset = e.clientY - bounding.top;
                
                if (offset > bounding.height / 2) {
                    // ä¸‹åŠåˆ†ï¼šã“ã®è¦ç´ ã®å¾Œã«æŒ¿å…¥
                    container.insertBefore(draggedElement, this.nextSibling);
                } else {
                    // ä¸ŠåŠåˆ†ï¼šã“ã®è¦ç´ ã®å‰ã«æŒ¿å…¥
                    container.insertBefore(draggedElement, this);
                }
            });
            
            element.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
                updateReviewItemsOrder();
                draggedElement = null;
            });
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šé …ç›®é †åºã‚’æ›´æ–°
        function updateReviewItemsOrder() {
            const container = document.getElementById('reviewGuessArea');
            const items = Array.from(container.children);
            const newOrder = items.map((item, index) => {
                item.setAttribute('data-index', index);
                return item.getAttribute('data-item');
            });
            
            // ç¾åœ¨ã®é †åºã‚’ä¿å­˜
            container.setAttribute('data-items', JSON.stringify(newOrder));
            
            // UIã‚’å†ç”Ÿæˆï¼ˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼‰
            createReviewGuessUI(newOrder);
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šé …ç›®ã‚’ç§»å‹•
        function moveReviewItem(index, direction) {
            const container = document.getElementById('reviewGuessArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            const newIndex = index + direction;
            
            // ç¯„å›²ãƒã‚§ãƒƒã‚¯
            if (newIndex < 0 || newIndex >= items.length) {
                return;
            }
            
            // å…¥ã‚Œæ›¿ãˆ
            [items[index], items[newIndex]] = [items[newIndex], items[index]];
            
            // UIã‚’å†ç”Ÿæˆ
            createReviewGuessUI(items);
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šç­”ãˆåˆã‚ã›ï¼ˆæ–¹å¼Bï¼šå€‹æ•°ï¼‹é †ä½ï¼‰
        function submitReviewGuess() {
            const container = document.getElementById('reviewGuessArea');
            const items = JSON.parse(container.getAttribute('data-items'));
            
            if (!items || items.length !== 5) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆæ–¹å¼Bï¼‰
            let matchCount = 0;    // å½“ã¦ãŸå€‹æ•°
            let rankScore = 0;     // é †ä½ãƒœãƒ¼ãƒŠã‚¹
            const details = [];    // è©³ç´°æƒ…å ±
            
            for (let rank = 1; rank <= 5; rank++) {
                const rankStr = rank.toString();
                const correctItem = reviewCorrectAnswer[rankStr];
                const guessedItem = items[rank - 1];
                
                if (correctItem === guessedItem) {
                    // å®Œå…¨ä¸€è‡´
                    matchCount++;
                    const rankPoint = 6 - rank;  // 1ä½=5ç‚¹ã€2ä½=4ç‚¹ã€...ã€5ä½=1ç‚¹
                    rankScore += rankPoint;
                    details.push({
                        rank: rank,
                        correct: correctItem,
                        guess: guessedItem,
                        isCorrect: true,
                        rankPoint: rankPoint
                    });
                } else {
                    details.push({
                        rank: rank,
                        correct: correctItem,
                        guess: guessedItem,
                        isCorrect: false,
                        rankPoint: 0
                    });
                }
            }
            
            const totalScore = matchCount + rankScore;
            
            // çµæœã‚’è¡¨ç¤º
            showReviewResult(items, matchCount, rankScore, totalScore, details);
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šçµæœè¡¨ç¤ºï¼ˆæ–¹å¼Bå¯¾å¿œï¼‰
        function showReviewResult(guessedItems, matchCount, rankScore, totalScore, details) {
            let html = '';
            
            // è©•ä¾¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ5æ®µéšï¼‰
            let emoji = '';
            let message = '';
            if (totalScore === 20) {
                emoji = 'ğŸ‰';
                message = 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼';
            } else if (totalScore >= 15) {
                emoji = 'ğŸ˜Š';
                message = 'ã™ã”ã„ï¼';
            } else if (totalScore >= 10) {
                emoji = 'ğŸ‘';
                message = 'ã„ã„æ„Ÿã˜ï¼';
            } else if (totalScore >= 5) {
                emoji = 'ğŸ¤”';
                message = 'ãŠã—ã„ï¼';
            } else {
                emoji = 'ğŸ’ª';
                message = 'æ¬¡ã¯é ‘å¼µã‚ã†ï¼';
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            html += '<div style="text-align: center; margin-bottom: 30px;">';
            html += '<p style="font-size: 64px; margin-bottom: 10px;">' + emoji + '</p>';
            html += '<h3 style="color: #9B59B6; font-size: 24px; margin-bottom: 10px;">' + message + '</h3>';
            html += '</div>';
            
            // ã‚¹ã‚³ã‚¢è©³ç´°
            html += '<div style="background: #F8F4FF; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">';
            html += '<p style="color: #9B59B6; font-size: 48px; font-weight: bold; margin-bottom: 10px;">' + totalScore + 'ç‚¹<span style="font-size: 24px; color: #999;"> / 20ç‚¹</span></p>';
            html += '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">å½“ã¦ãŸå€‹æ•°</p>';
            html += '<p style="color: #9B59B6; font-size: 24px; font-weight: bold;">' + matchCount + 'å€‹</p>';
            html += '<p style="color: #999; font-size: 12px;">' + matchCount + 'ç‚¹</p>';
            html += '</div>';
            html += '<div>';
            html += '<p style="color: #666; font-size: 13px;">é †ä½ãƒœãƒ¼ãƒŠã‚¹</p>';
            html += '<p style="color: #9B59B6; font-size: 24px; font-weight: bold;">' + rankScore + 'ç‚¹</p>';
            html += '<p style="color: #999; font-size: 12px;">1ä½=5, 2ä½=4...</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // ç­”ãˆåˆã‚ã›è©³ç´°
            html += '<div style="background: #F0F8FF; border-radius: 10px; padding: 20px; margin-bottom: 20px;">';
            html += '<h3 style="color: #4A90E2; font-size: 16px; margin-bottom: 15px;">âœ¨ ç­”ãˆåˆã‚ã›</h3>';
            
            for (let i = 0; i < details.length; i++) {
                const detail = details[i];
                const isCorrect = detail.isCorrect;
                const icon = isCorrect ? 'âœ…' : 'âŒ';
                const color = isCorrect ? '#50C878' : '#ff6b6b';
                const pointText = isCorrect ? '+' + detail.rankPoint + 'ç‚¹' : '0ç‚¹';
                const bgColor = isCorrect ? '#F0FFF4' : 'transparent';
                
                html += '<div style="display: flex; align-items: center; margin: 8px 0; padding: 10px; border-radius: 8px; background: ' + bgColor + ';">';
                html += '<span style="color: #666; font-size: 14px; min-width: 40px;">' + detail.rank + 'ä½:</span>';
                html += '<span style="color: #333; font-size: 15px; flex: 1;">' + detail.correct + '</span>';
                html += '<span style="color: ' + color + '; font-size: 14px; font-weight: bold;">' + icon + ' ' + (isCorrect ? pointText : detail.guess) + '</span>';
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('reviewResultContent').innerHTML = html;
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('reviewResultScreen');
        }
        
        // æŒ¯ã‚Šè¿”ã‚Šäºˆæƒ³ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelReview() {
            currentReviewRanking = null;
            reviewCorrectAnswer = null;
            backToMain();
        }
        
        // ========================================
        // Enterã‚­ãƒ¼ã§æ¬¡ã®å…¥åŠ›æ¬„ã«ç§»å‹•
        // ========================================
        function setupEnterKeyNavigation() {
            // é€šå¸¸ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥åŠ›
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById('rank' + i);
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (i < 5) {
                            // æ¬¡ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                            document.getElementById('rank' + (i + 1)).focus();
                        } else {
                            // 5ä½ã®å ´åˆã¯ä¿å­˜ãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                            this.blur();
                        }
                    }
                });
            }
            
            // ã‚²ãƒ¼ãƒ å…¥åŠ›ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById('gameRank' + i);
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (i < 5) {
                            document.getElementById('gameRank' + (i + 1)).focus();
                        } else {
                            this.blur();
                        }
                    }
                });
            }
        }
        
        // ========================================
        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        function showScreen(screenId) {
            // ã™ã¹ã¦ã®ç”»é¢ã‚’éè¡¨ç¤º
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
            
            // æŒ‡å®šã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤º
            document.getElementById(screenId).classList.add('active');
        }
        
        function backToMain() {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆãƒ•ã‚§ãƒ¼ã‚º5-Aã§è¿½åŠ ï¼‰
            if (sessionListener) {
                sessionListener.off();
                sessionListener = null;
            }
            currentGameSession = null;
            
            showScreen('mainScreen');
        }
        
        // ========================================
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä½œæˆæ©Ÿèƒ½
        // ========================================
        function startRanking() {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ†ãƒ¼ãƒã‚’é¸ã¶
            currentTheme = THEMES[Math.floor(Math.random() * THEMES.length)];
            document.getElementById('currentTheme').textContent = currentTheme;
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            for (let i = 1; i <= 5; i++) {
                document.getElementById('rank' + i).value = '';
            }
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
            showScreen('rankingScreen');
            
            // 1ä½ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                document.getElementById('rank1').focus();
            }, 100);
        }
        
        function saveRanking() {
            // å…¥åŠ›å€¤ã‚’å–å¾—
            const rankings = [];
            for (let i = 1; i <= 5; i++) {
                const value = document.getElementById('rank' + i).value.trim();
                if (value === '') {
                    alert((i) + 'ä½ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                    document.getElementById('rank' + i).focus();
                    return;
                }
                rankings.push(value);
            }
            
            // FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!database) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (!userProfile) {
                alert('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            // Firebaseã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const newRanking = {
                userId: userProfile.userId,
                userName: userProfile.displayName,
                theme: currentTheme,
                ranking: {
                    "1": rankings[0],
                    "2": rankings[1],
                    "3": rankings[2],
                    "4": rankings[3],
                    "5": rankings[4]
                },
                createdAt: new Date().toISOString()
            };
            
            // Firebaseã«ä¿å­˜ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’è‡ªå‹•ç”Ÿæˆï¼‰
            const rankingsRef = database.ref('rankings');
            const newRankingRef = rankingsRef.push();
            
            newRankingRef.set(newRanking)
                .then(() => {
                    alert('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\nFirebaseã«æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
                    console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜æˆåŠŸ:', newRanking);
                    backToMain();
                })
                .catch((error) => {
                    alert('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ========================================
        // å±¥æ­´è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆFirebaseã‹ã‚‰å–å¾—ï¼‰
        // ========================================
        function showHistory() {
            const historyList = document.getElementById('historyList');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            showScreen('historyScreen');
            
            // FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!database) {
                historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼<br>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            if (!userProfile) {
                historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            // Firebaseã‹ã‚‰è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const rankingsRef = database.ref('rankings');
            const userRankingsQuery = rankingsRef.orderByChild('userId').equalTo(userProfile.userId);
            
            userRankingsQuery.once('value')
                .then((snapshot) => {
                    const rankings = [];
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key; // IDã‚’è¿½åŠ 
                        rankings.push(data);
                    });
                    
                    // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                    rankings.sort((a, b) => {
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    });
                    
                    // è¡¨ç¤º
                    if (rankings.length === 0) {
                        historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 20px;">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“<br>æ–°ã—ã„ãƒ†ãƒ¼ãƒã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>';
                    } else {
                        let html = '';
                        rankings.forEach((item) => {
                            const date = new Date(item.createdAt);
                            const dateStr = date.getFullYear() + 'å¹´' + 
                                          (date.getMonth() + 1) + 'æœˆ' + 
                                          date.getDate() + 'æ—¥ ' + 
                                          date.getHours() + ':' + 
                                          String(date.getMinutes()).padStart(2, '0');
                            
                            html += '<div class="history-item">';
                            html += '<div class="history-theme">' + item.theme + '</div>';
                            html += '<div class="history-date">' + dateStr + ' by ' + item.userName + '</div>';
                            html += '<div class="history-rankings">';
                            
                            // ranking ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰è¡¨ç¤º
                            for (let i = 1; i <= 5; i++) {
                                if (item.ranking && item.ranking[i.toString()]) {
                                    html += '<div>' + i + 'ä½: ' + item.ranking[i.toString()] + '</div>';
                                }
                            }
                            
                            html += '</div>';
                            html += '</div>';
                        });
                        historyList.innerHTML = html;
                    }
                    
                    console.log('âœ… å±¥æ­´å–å¾—æˆåŠŸ:', rankings.length + 'ä»¶');
                })
                .catch((error) => {
                    historyList.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px 20px;">âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼<br>' + error.message + '</p>';
                    console.error('âŒ å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // ========================================
        // Firebase æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆãƒ•ã‚§ãƒ¼ã‚º3ã§è¿½åŠ ï¼‰
        // ========================================
        
        // æ¥ç¶šç¢ºèª
        function testFirebaseConnection() {
            if (!database) {
                alert('âŒ FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
            const testRef = database.ref('.info/connected');
            
            testRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    alert('âœ… Firebaseæ¥ç¶šæˆåŠŸï¼\n\nãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ­£å¸¸ã«æ¥ç¶šã§ãã¾ã—ãŸã€‚');
                    console.log('âœ… Firebase Realtime Database æ¥ç¶šæˆåŠŸ');
                } else {
                    alert('âš ï¸ æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            });
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function testFirebaseSave() {
            if (!database) {
                alert('âŒ FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (!userProfile) {
                alert('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const testData = {
                userId: userProfile.userId,
                userName: userProfile.displayName,
                message: 'ã“ã‚Œã¯Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆã§ã™ï¼',
                timestamp: new Date().toISOString(),
                testNumber: Math.floor(Math.random() * 1000)
            };
            
            // Firebaseã«ä¿å­˜
            const testRef = database.ref('test/' + Date.now());
            
            testRef.set(testData)
                .then(() => {
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸï¼\n\n' +
                          'ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ' + testData.userName + '\n' +
                          'ãƒ†ã‚¹ãƒˆç•ªå·: ' + testData.testNumber + '\n\n' +
                          'Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€Œãƒ‡ãƒ¼ã‚¿ã€ã‚¿ãƒ–ã§\n' +
                          'ã€Œtestã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ï¼');
                    console.log('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ:', testData);
                })
                .catch((error) => {
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:\n' + error.message);
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
    </script>
</body>
</html>
