{
  "CURRENT_RULES": "以下のルールをFirebase Consoleにコピーして使用してください",
  "LAST_UPDATED": "2026-02-02",
  "VERSION": "v2.0",
  
  "rules": {
    "users": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "gameSessions": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "pairCodes": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "analytics": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "rankings": {
      ".read": "auth != null",
      ".write": "auth != null"
    }
  },
  
  "_CHANGE_HISTORY": [
    {
      "date": "2026-02-02",
      "version": "v2.0",
      "reason": "Firebase匿名認証とLINE userIdの不一致により、v1.0のルールが動作しなかった。シンプルな認証ベースのルールに変更。",
      "changes": [
        "users: $userId レベルの厳密なチェックを削除 → 認証済みユーザー全員に読み書き許可",
        "gameSessions/pairCodes: ノード全体への権限を追加（セッション作成・一覧取得に必要）",
        "analytics: 新規追加（モニタリング機能用）",
        "rankings: 新規追加（開発メニュー「ひとりであそぶ」用）"
      ],
      "security_level": "α版テストに適したレベル：認証必須（LIFF経由のみ）、ただしテスター間でデータ閲覧は可能（理論上）",
      "notes": "β版以降はCustom Token認証を実装し、より厳密なアクセス制御を行う予定"
    },
    {
      "date": "2026-02-02",
      "version": "v1.0",
      "reason": "複雑なルールセットから未使用機能を削除し、必要最小限に簡素化する試み（結果：動作せず）",
      "status": "DEPRECATED - 動作しないため使用不可",
      "problem": "Firebase匿名認証で生成されるauth.uidとLINEのuserIdが不一致のため、$userId === auth.uidが常にfalseになる"
    }
  ],
  
  "_PREVIOUS_RULES": {
    "v1.0_DEPRECATED": {
      "rules": {
        "users": {
          "$userId": {
            ".read": "auth != null && ($userId === auth.uid || data.child('partnerId').val() === auth.uid)",
            ".write": "auth != null && $userId === auth.uid"
          }
        },
        "gameSessions": {
          "$sessionId": {
            ".read": "auth != null",
            ".write": "auth != null"
          }
        },
        "pairCodes": {
          "$code": {
            ".read": "auth != null",
            ".write": "auth != null"
          }
        }
      }
    }
  },
  
  "_USAGE_NOTES": {
    "how_to_apply": [
      "1. Firebase Console → Realtime Database → ルール タブを開く",
      "2. このファイルの「rules」セクション（11-35行目）をコピー",
      "3. Firebase エディタに貼り付け",
      "4. 「公開」ボタンをクリック"
    ],
    "security_considerations": {
      "current": "認証済みユーザー（LIFF経由のLINEログイン）のみアクセス可能",
      "alpha_phase": "テスター数が少ないため、この簡易的なルールで十分",
      "beta_phase": "Custom Token認証を実装し、より厳密なアクセス制御を行う",
      "production": "Cloud Functionsによるサーバーサイド処理を追加"
    }
  }
}
