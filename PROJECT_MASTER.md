# 🎮 ふたりのらんきんぐ - プロジェクトマスタードキュメント

**最終更新**: 2026年1月28日（セキュリティ対策完了！）  
**プロジェクト状態**: 🔒 **本番リリース準備完了** - MVP完成 + セキュリティ対策完了  
**次回セッション予定**: 実機総合テスト → テーマ・メッセージ最終調整 → 本番リリース

> 💡 **このドキュメントについて**  
> このファイルは「プロジェクトの全体像」と「AIへの引き継ぎ指示」を兼ねた**唯一の統合ドキュメント**です。  
> すべての進捗、決定事項、次回アクションはこのファイルに集約され、更新されます。  
> 次回開発時は、このファイルを読み込ませることで、AIが現在の状況を完全に把握できます。

> 📂 **ドキュメント管理方針**  
> - **PROJECT_MASTER.md**: 唯一の真実の情報源（常に更新）
> - **docs/ フォルダ**: 過去のドキュメント（参考資料、更新しない）
> - **README.md**: プロジェクト概要（シンプルな案内）

---

## 🔖 SortableJS統合完了版セーフポイント

> **⚠️ 重要：MVP完成版（動作確認済み・実機テスト成功）**

### セーフポイント情報
- **コミットID**: `9be7ba4`
- **コミットメッセージ**: "feat: apply SortableJS to game guess screen"
- **日時**: 2026年1月27日
- **状態**: 
  - ✅ SortableJS統合完了（開発用・ふたりであそぶ）
  - ✅ スワイプUI完全動作（null表示バグ解消）
  - ✅ 実機テスト成功（ペアテスト完了）
  - ✅ MVP要件を満たす

### このバージョンの特徴
```
✅ ひとりであそぶ（開発用）
   - SortableJS実装済み
   - 50ms長押しでドラッグ開始
   - Apple Music並みのスワイプ体験

✅ ふたりであそぶ
   - SortableJS実装済み
   - nullバグ解消
   - 2本指問題解消
   - 実機テスト成功

⚠️ 旧実装コード（約475行）がまだ残っている
   - setupGameDragEvents()
   - setupDragEvents()
   - cleanupAllPlaceholders()
   - isAnyElementDragging
```

### 復元方法（問題が起きた場合）

#### 方法1: 特定のコミットに戻す
```bash
# このバージョンに完全に戻す
git reset --hard 9be7ba4

# GitHubにも反映
git push origin main --force
```

#### 方法2: ファイルだけを復元
```bash
# このバージョンのindex.htmlだけを取得
git checkout 9be7ba4 -- index.html

# 変更を確認
git diff

# 問題なければコミット
git add index.html
git commit -m "revert: restore MVP safe point (9be7ba4)"
git push origin main
```

#### 方法3: AIに依頼する場合
```
「9be7ba4のバージョンに戻してください」
または
「SortableJS統合完了版セーフポイントに戻してください」
または
「MVP完成版に戻してください」
```

---

## 🎉 コードベース最適化完了（Phase 3）

> **2026年1月27日完了：旧実装コード削減完了**

### 削減実績
- **コミットID**: `96eb3a9`
- **削減行数**: 505行（13.2%削減）
- **Before**: 3,818行
- **After**: 3,313行

### 削除したコード
```
✅ setupGameDragEvents()        (205行) - ふたり用旧実装
✅ setupDragEvents()            (205行) - ひとり用旧実装
✅ updateGameItemsOrder()        (15行)
✅ updateRankNumbers()           (13行)
✅ updateReviewItemsOrder()      (14行)
✅ moveReviewItem()              (18行)
✅ cleanupAllPlaceholders()      (16行)
✅ isAnyElementDragging           (2行)
✅ 関数呼び出し・コメント         (17行)
```

### 実機テスト結果
```
✅ ひとりであそぶ（開発用）
   - スワイプ正常動作
   - Answerボタン正常動作
   - 結果表示正常

✅ ふたりであそぶ
   - スワイプ正常動作
   - 予想送信正常動作
   - 結果表示正常
   - nullバグなし
   - 2本指問題なし
   
✅ バグなし・問題なし
```

---

## 🎨 オリジナルテーマ入力機能実装完了（Phase 4）

> **2026年1月27日完了：カスタムテーマでゲームを遊べるように**

### 実装内容
- **初期実装**: `1d84ce8` - モード選択画面とカスタムテーマ入力画面の追加
- **ホスト権限**: `258cae3` - ゲストの自動参加とホストのみテーマ入力
- **フロー修正**: `0521582` - セッション作成の流れを修正
- **競合解決**: `faf41b9` - もう一度あそぶをホスト専用に

### 新機能
```
✅ モード選択画面
   - 🎲 ランダムテーマ
   - ✏️ オリジナルテーマ

✅ カスタムテーマ入力
   - 3〜50文字のバリデーション
   - リアルタイム文字数カウンター
   - ホストのみが入力可能

✅ ホスト/ゲスト権限
   - ゲスト：自動的に待機室参加
   - ホストのみ：モード選択・テーマ入力
   - ホストのみ：もう一度あそぶでテーマ決定

✅ データ構造拡張
   - themeMode: 'random' | 'custom'
   - theme: カスタムテーマテキスト
   - 将来の拡張に対応（投票モードなど）
```

### 実機テスト結果

#### ✅ 動作確認済み
- ランダムモード：基本動作完璧
- カスタムモード：基本動作完璧
- ゲーム進行：問題なし
- もう一度あそぶ：ホスト/ゲスト分離成功

#### 📝 残課題（MVP後に対応）
1. **アラート後の自動更新**
   - ゲストが「お待ちください」アラート中は画面が更新されない
   - リスナーは動いているが、アラートで遮断される
   - 優先度：低（機能は動作している）

2. **両者がホスト設定時の挙動**
   - 両者がモード選択画面で待機中
   - 一方が待機室を作っても、もう一方は自動参加しない
   - HOMEに戻れば自動参加できる
   - 優先度：低（レアケース）

3. **将来の拡張**
   - ホスト/ゲスト選択画面（複数人プレイ時）
   - 3テーマから投票モード
   - カスタムテーマDB保存

### コード品質
- ✅ Linterエラー：なし
- ✅ 拡張性：高（データ構造が拡張可能）
- ✅ 保守性：中（ホスト判定ロジックが複数箇所に分散）

---

## 🎯 スコアリング改善完了（Phase 5）

> **2026年1月27日完了：完全一致＋おしい評価の新スコアリング方式**

### 実装内容
- **hostId追加**: `5e25839` - ホスト/ゲスト判定の安定化、表記追加
- **スコアリング**: `8a491e2` - 新しい計算ロジック実装
- **表示修正**: `82114d8` - 結果画面の答え合わせ表を新方式に対応

### 新スコアリング方式

```javascript
【計算式】
✅ 順位完全一致：2点
✅ 順位±1（おしい）：1点
❌ それ以外：0点

【最大スコア】
- 1人：10点（5項目 × 2点）
- ふたり合計：20点

【旧方式との違い】
旧：完全一致のみ評価（matchCount + rankBonus）
新：おしい（±1）も評価される
```

### スコア例

```
【例】正解：A > B > C > D > E
     予想：A > C > B > D > E

旧スコア：8点（3個一致 + 順位ボーナス5点）
新スコア：8点（完全一致3個=6点 + おしい2個=2点）

【例】正解：A > B > C > D > E
     予想：C > A > B > E > D

旧スコア：0点（完全一致なし）
新スコア：5点（おしい5個=5点）

→ 「惜しい」予想も評価されるように！
```

### UI/UX改善

```
✅ 結果画面
- スコア表示：10点満点（旧：20点満点）
- 内訳表示：完全一致X個（×2点）+ おしい（±1）Y個（×1点）
- ホスト/ゲスト表記を追加

✅ 答え合わせ表
【旧】順位 | 正解 | 予想 | 評価 | スコア
【新】予想 | 項目 | 正解順位 | 評価 | 得点

- アイコン：⭕（完全一致）△（おしい）✕（外れ）
- 各項目の得点が明確に表示される
```

### 評価メッセージ調整

```
【ふたりのスコア（最大20点）】
- 20点：パーフェクト！完璧なコンビネーション！
- 18点以上：素晴らしい！ほぼ完璧！
- 15点以上：いい感じ！お互いをよく知ってる！
- 12点以上：まだまだ伸びしろあり！
- 8点以上：次は頑張ろう！
- 8点未満：もっと話そう！
```

### ⚠️ 重要な注意点

**古いゲームデータについて**
- 過去のゲームは旧形式（matchCount/rankScore）で保存されている
- `undefined`対策として`|| 0`でフォールバック処理を追加
- 新しいゲームは新形式（perfectCount/closeCount）で正常動作

### 適用範囲
- ✅ ふたりであそぶ（メイン機能）
- ✅ 振り返りモード（ひとりであそぶ）
- ✅ 開発用モード（ひとりであそぶ・開発用）

### コード品質
- ✅ Linterエラー：なし
- ✅ 一貫性：全モードで同じロジック
- ✅ 後方互換性：古いデータにも対応

---

## 🎊 MVP完成（2026年1月27日）

### ✅ MVP機能リスト

#### コア機能
```
✅ ペア設定機能
   - ペアコード生成・入力
   - パートナー情報表示
   - 実機テスト成功

✅ リアルタイムゲーム（ふたりであそぶ）
   - 待機室機能
   - 同時プレイ
   - スワイプUI（SortableJS）
   - 結果画面

✅ オリジナルテーマ機能
   - ランダム/カスタムモード選択
   - カスタムテーマ入力（3〜50文字）
   - ホスト/ゲスト権限管理

✅ スコアリングシステム
   - 完全一致：2点
   - おしい（±1）：1点
   - 最大20点（ふたり合計）
```

#### 技術実装
```
✅ SortableJS統合
   - Apple Music並みのスワイプ体験
   - 50ms長押しでドラッグ開始
   - リアルタイム順位更新

✅ Firebase連携
   - Realtime Database
   - セッション管理
   - リスナーによる自動同期

✅ ホスト/ゲスト管理
   - hostIdフィールドで安定化
   - 権限による機能制限
   - UI上での明示的な表記
```

### 📊 開発実績

```
開発期間：2026年1月23日〜27日（5日間）
総コミット数：30以上
コード行数：約3,700行（index.html）
主要ライブラリ：
  - Firebase Realtime Database
  - LINE LIFF SDK
  - SortableJS
```

### 🎯 1月31日までの目標：達成！

```
✅ MVP完成
✅ 実機テスト成功
✅ ペア機能動作確認
✅ カスタムテーマ機能実装
✅ スコアリング改善完了

→ 友人・知人カップルへの試用準備完了！
```

---

## 🔧 Phase 6: MVP完成後のバグ修正・UI改善（2026年1月28日）

### 実装概要

MVP完成後に発見された重大なバグの修正と、ユーザー体験向上のためのUI/UX改善を実施。すべての致命的なバグを解消し、本番リリース準備が完了。

### 📦 実装コミット

- **HOMEボタン実装**: `cc46f49` - HOMEボタンのコンポーネント化、送信ボタンUX改善
- **バグ修正**: `732d66d` - 送信ボタンバグ、ゲーム中断通知、結果画面確認
- **待機室改善**: `3aaa501` - キャンセルボタン統合、HOMEボタンUI改善
- **ホスト判定修正1**: `d96c2ca` - resumeSessionでhostId使用
- **ホスト判定修正2（根本原因）**: `cd45894` - checkExistingSessionでhostId使用、ボタンUX改善
- **色変更防止**: `d5f6fe1` - HOMEボタンに!important追加
- **開発メニュー**: （最新コミット予定） - 折りたたみ式実装

### 🐛 修正したバグ

#### 1. 送信ボタンが次のゲームで固まる問題（最重要）

**問題**:
- 1回目のゲーム：ランキング送信 → 「⏳ お相手の回答待ち...」表示
- 2回目のゲーム：新しいゲームなのにボタンが「お相手の回答待ち...」のまま
- → ゲーム続行不可

**原因**:
- 送信後にボタンの状態を変更したが、次回のゲーム開始時にリセットしていなかった

**修正内容**:
```javascript
// showGameInputScreen() と showGuessScreen() に追加
const submitButton = document.getElementById('submitGameRankingButton');
submitButton.textContent = '💾 ランキングを送信';  // リセット
submitButton.disabled = false;
submitButton.style.background = '';

// 既に送信済みの場合のみ「待機中」状態に
if (sessionData.rankings && sessionData.rankings[userProfile.userId]) {
    submitButton.textContent = '⏳ お相手の回答待ち...';
    submitButton.disabled = true;
    submitButton.style.background = '#999';
}
```

**結果**: ✅ 新しいゲームで常に「送信」ボタンが正常に表示される

---

#### 2. ゲストが2回目に待機室を削除してしまう問題（最重要）

**問題**:
- ゲストが1回目：待機室に入る → HOMEで退出 ✅ 正常（待機室は残る）
- ゲストが2回目：待機室に入る → HOMEで退出 ❌ 待機室が削除される！

**原因1（`resumeSession`）**:
```javascript
// 古いコード（バグあり）
const hostId = Object.keys(sessionData.players)[0];  // 最初のプレイヤーがホスト
// → Object.keys()の順序は不安定！
```

**原因2（`checkExistingSession`）- 根本原因**:
```javascript
// 古いコード（バグあり）
if (session.players && session.players[userProfile.userId]) {
    // 自分が作成したセッション（ホスト）← 間違い！
    existingSession = { role: 'host' };  // ゲストでもホストと判定！
}
// → ゲストが1回目に入室すると、joinGame()でplayersに追加される
// → ゲストが2回目に入室すると、playersに自分のIDがある→ホストと判定される！
```

**修正内容**:
```javascript
// resumeSession() - 修正後
const hostId = sessionData.hostId || Object.keys(sessionData.players)[0];
const role = (hostId === userProfile.userId) ? 'host' : 'guest';

// checkExistingSession() - 修正後
const hostId = session.hostId || Object.keys(session.players || {})[0];
const isHost = (hostId === userProfile.userId);

if (isHost) {
    existingSession = { role: 'host' };
} else if (session.partnerId === userProfile.userId) {
    existingSession = { role: 'guest' };
}
```

**結果**: ✅ ゲストが何度入退室しても、常に正しく「ゲスト」として判定される

---

### 🎨 UI/UX改善

#### 1. HOMEボタンの完全実装

**実装内容**:
```
✅ 共通関数の作成
- confirmBackToMain(message) - 確認ダイアログ付き
- backToMain() - ゲーム終了処理

✅ 各画面に追加
- 待機室：「待機室を退出してHOMEに戻りますか？」
- 回答画面：「HOMEに戻ると現在のゲームを終了します。よろしいですか？」
- 予想画面：「HOMEに戻ると現在のゲームを終了します。よろしいですか？」
- 結果画面：「HOMEに戻ると現在のゲームを終了します。よろしいですか？」
```

**ゲーム中断の相互通知**:
```javascript
// ゲーム中にHOMEを押した場合
await sessionRef.update({
    gameAborted: true,
    abortedBy: userProfile.userId,
    abortedAt: new Date().toISOString()
});

// セッションリスナーで検知
if (sessionData.gameAborted && sessionData.abortedBy !== userProfile.userId) {
    alert('お相手がゲームを終了しました。ホーム画面に戻ります。');
    showScreen('mainScreen');
}
```

**結果**: ✅ どちらかがゲームを終了すると、相手にも通知される

---

#### 2. 待機室のキャンセルボタン統合

**変更内容**:
```
【変更前】
[← キャンセル]  [HOME]  ← 2つのボタン

【変更後】
[HOME]  ← 1つだけ、シンプル！
```

**挙動**:
- ホストがHOME → 待機室削除 + 相手に通知
- ゲストがHOME → ゲストのみ退出、待機室は維持

**結果**: ✅ UIがシンプルになり、挙動も明確に

---

#### 3. ボタンのテキスト選択防止

**問題**: ボタンを長押しすると、テキストが選択されてしまう

**修正内容**:
```css
button {
    user-select: none;
    -webkit-user-select: none;  /* Safari */
    -webkit-tap-highlight-color: transparent;  /* タップ時の青いハイライト削除 */
}

button:focus {
    outline: none;  /* フォーカス枠削除 */
}
```

**結果**: ✅ ボタンのテキストが選択されなくなった

---

#### 4. HOMEボタンの色変更完全防止

**問題**: HOMEボタンを長押しすると、一瞬青くなる

**修正内容**:
```css
.fixed-round-button-home {
    background: #95A5A6 !important;  /* 強制的にグレー */
}

.fixed-round-button-home:active {
    background: #95A5A6 !important;  /* タップ時も強制グレー */
}

.fixed-round-button-home:focus {
    background: #95A5A6 !important;  /* フォーカス時も強制グレー */
}

.fixed-round-button-home:hover {
    background: #95A5A6 !important;  /* ホバー時も強制グレー */
}
```

**結果**: ✅ HOMEボタンが**常にグレー固定**

---

#### 5. 開発メニューの折りたたみ式実装

**問題**: 開発用のボタンが常に表示されている

**実装内容**:
```html
<!-- 開発メニューボタン -->
<button onclick="toggleDevMenu()">
    🔧 開発メニュー
</button>

<!-- 開発メニューの中身（初期状態は非表示） -->
<div id="devMenuContent" style="display: none;">
    <button onclick="startRanking()">📝 ひとりであそぶ</button>
    <button onclick="showDevReviewList()">🧪 ひとりであそぶ（開発用）</button>
    <button onclick="showHistory()">📋 過去の回答履歴を見る</button>
</div>
```

**結果**: ✅ 開発メニューが必要なときだけ表示される

---

### 📊 改善成果

#### 完了したタスク数
**42タスク完了** 🎉

1. ✅ UI改善（21タスク）
2. ✅ HOMEボタン実装（5タスク）
3. ✅ 送信ボタンUX（3タスク）
4. ✅ バグ修正（8タスク）
5. ✅ UI改善追加（5タスク）

#### 修正したファイル
- `index.html`: 約150行の追加・修正

#### 実機テスト結果
```
✅ 送信ボタン：新しいゲームで正常に動作
✅ 待機室：ゲストが何度入退室しても正常
✅ HOMEボタン：常にグレー、テキスト選択なし
✅ ゲーム中断：相手に正しく通知される
✅ 開発メニュー：折りたたみ式で見やすい
```

---

### 📝 次のステップ

#### 優先度高：試用・フィードバック収集
1. **友人・知人カップルへの試用依頼**
   - 実際の使用感を収集
   - バグ報告の収集
   - 改善要望のヒアリング

2. **フィードバック分析**
   - UX課題の特定
   - 優先度の決定
   - 改善計画の策定

#### 優先度中：UX改善（MVP後）
1. **残課題の対応**
   - HOMEボタンの常時表示
   - 確認ダイアログの追加
   - アラート後の自動更新

2. **機能拡張**
   - 3テーマから投票モード
   - カスタムテーマDB
   - ランキング数選択（3項目・7項目など）

#### 優先度低：技術負債の解消
1. **リファクタリング**
   - 単一HTMLファイルの分割
   - グローバル変数の整理
   - 関数の整理

---

## 🔐 Phase 7: セキュリティ対策実装（2026年1月28日）

### 実装概要

MVP完成後、本番リリースに向けてFirebaseのセキュリティ対策を実施。危険なSecurity Rulesを発見・修正し、Firebase匿名認証を実装してアプリを保護。

### 📦 実装コミット

- **匿名認証実装**: `41c988c` - Firebase匿名認証のコード追加
- **Authentication SDK追加**: `b178d8c` - firebase-auth-compat.js読み込み

---

### 🚨 発見した重大なセキュリティリスク

#### 危険なSecurity Rules設定

**問題**:
```json
{
  "rules": {
    ".read": "now < 1771599600000",   // 2026年2月21日まで
    ".write": "now < 1771599600000"   // 2026年2月21日まで
  }
}
```

**リスク**:
- ❌ 2026年2月21日まで、**誰でも**データの読み書きが可能
- ❌ 他のユーザーの個人情報（LINE名、ゲーム回答）が丸見え
- ❌ データの改ざん・削除が可能
- ❌ LIFFアプリ経由でなくても、Firebase URLを知っていればアクセス可能

**原因**: Firebaseプロジェクト作成時のデフォルト設定（テスト用）がそのまま残っていた

---

### 🔧 実施したセキュリティ対策

#### 1. Firebase匿名認証の実装

**コード修正**:
```javascript
// getUserProfile() 関数に追加
function getUserProfile() {
    liff.getProfile()
        .then(profile => {
            userProfile = profile;
            initializeFirebase();
            
            // Firebase匿名認証を追加
            return firebase.auth().signInAnonymously();
        })
        .then(() => {
            console.log('✅ Firebase認証成功');
            initializeUser();
            document.getElementById('loading').style.display = 'none';
            showScreen('mainScreen');
        })
        .catch((err) => {
            console.error('認証エラー:', err);
            // エラー処理
        });
}
```

**結果**: ✅ LIFFアプリを開いたユーザーのみがFirebaseにアクセス可能に

---

#### 2. Firebase Authentication SDKの追加

**追加したコード**:
```html
<!-- Firebase Authentication -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
```

**結果**: ✅ `firebase.auth()` が使用可能になり、匿名認証が動作

---

#### 3. Security Rulesの修正

**修正前（危険）**:
```json
{
  "rules": {
    ".read": "now < 1771599600000",  // 誰でもアクセス可能
    ".write": "now < 1771599600000"
  }
}
```

**修正後（安全）**:
```json
{
  "rules": {
    "users": {
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    
    "pairCodes": {
      "$code": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    
    "gameSessions": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$sessionId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    
    "rankings": {
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    }
  }
}
```

**重要なポイント**:
- `auth != null`: Firebase認証済みのユーザーのみアクセス可能
- `/gameSessions` と `/gameSessions/$sessionId`: 両方のレベルでルールを設定
  - セッション一覧の取得（`checkExistingSession`）
  - 新しいセッションの作成（`createGameSession`）
  - 特定のセッションへのアクセス（`startSessionListener`）

---

#### 4. Firebaseコンソールでの設定

**実施した設定**:
1. ✅ Authentication → Sign-in method → 「匿名」を有効化
2. ✅ Realtime Database → ルール → 新しいSecurity Rulesを公開

**結果**: ✅ 全ての設定が正常に反映され、アプリが動作

---

### 🐛 発生したエラーと修正

#### エラー1: ペア設定が「読み込み中...」で止まる

**原因**: Security Rulesで `auth != null && auth.uid == $userId` としていたが、匿名認証の `auth.uid` とデータベースの `$userId`（LINE ID）が一致しない

**修正**: Security Rulesを `auth != null` に緩和（認証済みユーザーならアクセス可能）

---

#### エラー2: `firebase.auth is not a function`

**原因**: Firebase Authentication SDKが読み込まれていなかった

**修正**: `firebase-auth-compat.js` のscriptタグを追加

---

#### エラー3: `permission_denied at /gameSessions`

**原因**: `/gameSessions` 全体へのアクセスルールが設定されていなかった（`$sessionId` のみ設定）

**修正**: `/gameSessions` レベルでも `.read` と `.write` ルールを追加

---

### 📊 セキュリティレベルの変化

#### 修正前（危険）
```
❌ 2026年2月21日まで誰でもアクセス可能
❌ 個人情報が丸見え
❌ データの改ざん・削除が可能
❌ 第三者による不正アクセスが可能
```

#### 修正後（安全）
```
✅ LIFFアプリ経由（LINE認証済み）のユーザーのみアクセス可能
✅ 認証なしのアクセスは完全にブロック
✅ 第三者による不正アクセスを防止
✅ MVPリリースに十分なセキュリティレベル
```

---

### 🎓 習得したセキュリティ知識

#### 1. Firebase Security Rulesの仕組み

**基本構文**:
```json
{
  "rules": {
    "パス": {
      ".read": "条件式",   // 読み取り権限
      ".write": "条件式"   // 書き込み権限
    }
  }
}
```

**auth変数**:
- `auth`: Firebase Authenticationの認証情報
- `auth != null`: ログイン済みかどうか
- `auth.uid`: ユーザーの一意なID
- `auth.uid == $userId`: 本人確認（IDが一致するか）

**階層構造**:
```
gameSessions
├── .read: "auth != null"    ← /gameSessions 全体へのアクセス
├── .write: "auth != null"
└── $sessionId
    ├── .read: "auth != null"    ← /gameSessions/特定ID へのアクセス
    └── .write: "auth != null"
```

---

#### 2. 匿名認証の仕組み

**流れ**:
```
1. LIFFアプリを開く（LINE認証）
   ↓
2. firebase.auth().signInAnonymously()
   ↓
3. Firebaseが一意なIDを自動生成
   auth.uid = "anonymous-xyz123"
   ↓
4. このIDでFirebaseにアクセス
   Security Rulesで auth != null がtrueになる
```

**特徴**:
- ✅ 実装が簡単（1行で完了）
- ✅ 追加コストなし（無料枠内）
- ✅ MVPには十分なセキュリティ
- ⚠️ デバイス変更でリセットされる
- ⚠️ 完全な本人確認ではない

---

#### 3. 将来的なセキュリティ強化（参考情報）

**方法1: Custom Token（推奨）**
```javascript
// Firebase Functionsでカスタムトークンを生成
const customToken = await admin.auth().createCustomToken(lineUserId);

// クライアントでサインイン
await firebase.auth().signInWithCustomToken(customToken);

// 結果: auth.uid === LINE ID（完全な本人確認）
```

**メリット**:
- ✅ `auth.uid` と LINE IDが一致
- ✅ 完全な本人確認が可能
- ✅ Security Rulesで `auth.uid == $userId` が使える

**必要なもの**:
- Firebase Functions（バックエンド）
- 月額課金プラン（無料枠あり）
- 実装時間：2〜3時間

**実装タイミング**:
- ユーザー数が1000人以上になったら
- 有料化を検討したら
- エンタープライズ対応が必要になったら

---

### 📝 学んだ重要な教訓

1. **Firebase APIキーは秘密ではない**
   - 公開されても問題ない（識別子でしかない）
   - 本当のセキュリティはSecurity Rulesで決まる

2. **Security Rulesの階層構造**
   - `/gameSessions` と `/gameSessions/$sessionId` は別物
   - 両方のレベルでルールを設定する必要がある

3. **認証の2段階**
   - LINE認証（LIFF）：ユーザーが誰かを確認
   - Firebase認証：Firebaseへのアクセス権限を確認
   - 両方が必要！

4. **段階的なセキュリティ**
   - MVP: 匿名認証で十分
   - 本番: Custom Tokenで完全な本人確認
   - 規模に応じて強化していく

---

### ✅ 実機テスト結果

```
✅ ペア設定：正常に読み込まれる
✅ 「ふたりであそぶ」：正常に動作
✅ ゲームモード選択：表示される
✅ 待機室：参加できる
✅ ゲーム進行：問題なし
✅ エラーなし
```

---

### 📊 完了したタスク

**Phase 7完了タスク: 4タスク** 🎉

1. ✅ Firebase Security Rulesの危険な設定を発見・修正
2. ✅ Firebase匿名認証の実装
3. ✅ Firebase Authentication SDKの追加
4. ✅ Security Rulesのデバッグと最適化

**累計: 47タスク完了**

---

### 📝 次のステップ

#### 優先度高：実機総合テスト
1. **全機能の動作確認**
   - ペア設定
   - ランダムモード
   - カスタムモード
   - スコアリング
   - 結果表示

2. **セキュリティ確認**
   - 認証なしでアクセスできないことを確認
   - 他人のデータが見えないことを確認

#### 優先度中：コンテンツ調整
1. **テーマ内容の最終確認**
   - 28個のテーマが適切か
   - 追加・削除の検討

2. **フィードバックメッセージの調整**
   - 点数別のメッセージが適切か
   - より楽しめる表現に

#### 優先度低：将来的なセキュリティ強化
1. **Custom Token実装**（ユーザー数が増えたら）
2. **Firebase App Check**（不正アクセス防止）
3. **本番/テスト環境分離**

---

## 📍 プロジェクト概要

### コンセプト
> 夫婦・カップルが「お互いのランキング」を予想し合うことで、  
> コミュニケーションを深め、お互いをもっと知るゲーム

### ターゲット
- 夫婦・カップル（2人1組）
- 20代〜40代
- LINEを日常的に使っている

### プラットフォーム
- LINE LIFF（LINEアプリ内で動くWebアプリ）
- GitHub Pages（ホスティング）
- Firebase Realtime Database（データ保存・共有）

---

## 🎯 開発ロードマップ

### ✅ フェーズ1: LIFF環境構築（完了）
- GitHub リポジトリ作成
- LINE Developers 設定
- LIFF アプリ作成
- GitHub Pages デプロイ
- 基本動作確認

### ✅ フェーズ2-A: ランキング入力機能（完了）
- お題データ28個を実装
- お題ランダム表示
- 1位〜5位入力フォーム
- LocalStorageに保存
- 履歴表示機能
- カップル向けデザイン（ピンク基調）

### ✅ フェーズ2-B: UI/UX改善（完了）
- [x] スマホ最適化・レスポンシブデザイン
- [x] デザインカラー変更（ピンク→青系）
- [x] Enterキーで次の入力欄に移動
- [x] キャッチコピー変更
- [ ] 下書き保存機能（優先度低・将来実装）
- [ ] 成功時のアニメーション（将来実装）
- [ ] 履歴のフィルター・検索機能（将来実装）

### ✅ フェーズ3: Firebase導入（完了）
- [x] Firebaseアカウント・プロジェクト作成
- [x] Realtime Database 設定
- [x] Firebase SDK 導入
- [x] 接続テスト・データ保存テスト
- [x] ランキングデータをFirebaseに保存
- [x] 履歴表示をFirebaseから取得
- [x] 実機テスト成功
- [ ] LINE UserID認証の実装（フェーズ4で実装予定）
- [ ] セキュリティルール設定（フェーズ4で実装予定）

### ✅ フェーズ4: ペア機能実装（完了）
- [x] ペアコード生成機能（6桁ランダムコード）
- [x] ペアコード入力・検証
- [x] パートナー情報表示
- [x] ペア解除機能
- [x] メイン画面にペア状態表示

### ✅ フェーズ5-A: リアルタイムゲーム実装（完了！）
> 「ふたりであそぶ」モード - 今すぐパートナーと一緒にプレイ

- [x] ゲームセッション管理
  - [x] ゲーム開始機能（同じお題を2人に配信）
  - [x] セッション状態管理（待機中/入力中/予想中/結果表示）
  - [x] リアルタイム同期（パートナーの状態を表示）
- [x] ランキング入力フェーズ
  - [x] 同時入力画面
  - [x] 入力完了通知
  - [x] 両者入力完了を待つ仕組み
- [x] 予想フェーズ（順位当てゲーム）
  - [x] バラバラの項目を表示
  - [x] ボタンで並び替え（上へ/下へ）
  - [x] 予想完了通知
  - [x] 両者予想完了を待つ仕組み
- [x] 結果表示
  - [x] 正解の順位を表示
  - [x] スコア計算（完全一致2点/部分一致1点）
  - [x] 勝敗判定
  - [x] もう一度遊ぶボタン

### 🔜 フェーズ5-B: ウィークリーゲーム実装（後回し）
> 週次スケジュールモード - 時間をかけてじっくりプレイ

- [ ] 週次お題管理
- [ ] 非同期ランキング入力
- [ ] 予想入力（3つを当てる）
- [ ] 週次結果発表

### 🔜 フェーズ6: 自動配信（Cloud Functions）
- [ ] LINE Messaging API 設定
- [ ] Cloud Functions 導入
- [ ] 週次スケジュール設定
- [ ] 自動通知機能
- [ ] リマインダー機能

### 🔜 フェーズ7: 磨き上げ・リリース
- [ ] バグフィックス
- [ ] パフォーマンス最適化
- [ ] 利用規約・プライバシーポリシー
- [ ] テストユーザー試用
- [ ] フィードバック反映

---

## 🔧 技術スタック

### フロントエンド
- **言語**: JavaScript (Vanilla JS)
- **マークアップ**: HTML5
- **スタイル**: CSS3（現在は `index.html` 内に記述）
- **LIFF SDK**: v2.x

### バックエンド（予定）
- **Firebase Realtime Database**: データ保存・同期
- **Firebase Cloud Functions**: 自動配信・スケジュール実行
- **LINE Messaging API**: プッシュ通知

### ホスティング
- **GitHub Pages**: 静的サイトホスティング
- **カスタムドメイン**: 将来検討

### 開発環境
- **エディタ**: Cursor / VSCode
- **バージョン管理**: Git / GitHub
- **デバッグ**: Chrome DevTools, LIFF Inspector

---

## 📂 現在のファイル構成

```
liff-ranking-practice/
├─ index.html                    ← LIFFアプリ本体（HTML+CSS+JS統合）
├─ PROJECT_MASTER.md             ← ★プロジェクト統合管理（唯一の情報源）
├─ README.md                     ← プロジェクト概要（シンプルな案内）
├─ GLOSSARY.md                   ← 📚 開発用語集（非エンジニア向け）
└─ docs/                         ← 参考資料（過去のドキュメント、更新しない）
    ├─ README.md                 ← 旧README（環境構築手順）
    ├─ チェックリスト.md
    ├─ 全体設計_壁打ち.md
    ├─ 次回セッション_クイックスタート.md
    └─ 開発進捗と引き継ぎ.md
```

**ファイルの役割：**
- **index.html**: アプリケーション本体
- **PROJECT_MASTER.md**: すべての情報が集約される唯一のドキュメント（常に最新）
- **README.md**: 初めて見る人向けの簡単な案内
- **GLOSSARY.md**: 開発用語集（わからない用語はここで確認）
- **docs/**: 過去の経緯を知りたい時に参照する資料

### 将来の構成（フェーズ3以降）
```
liff-ranking-practice/
├─ index.html                    ← HTMLのみ
├─ css/
│   └─ style.css                 ← スタイル分離
├─ js/
│   ├─ app.js                    ← メインロジック
│   ├─ firebase.js               ← Firebase関連
│   └─ themes.js                 ← お題データ
├─ PROJECT_MASTER.md             ← プロジェクト管理
├─ README.md                     ← プロジェクト概要
└─ docs/                         ← 参考資料
```

---

## 🔗 重要な情報

### GitHub
- **リポジトリ**: https://github.com/tomoshiya/liff-ranking-practice
- **GitHub Pages URL**: https://tomoshiya.github.io/liff-ranking-practice/
- **ユーザー名**: tomoshiya

### LINE Developers
- **プロバイダー**: 練習用
- **チャネル名**: ランキングアプリ練習
- **チャネルタイプ**: LINEログイン
- **LIFF ID**: 2008911809-CBLKsbT1
- **LIFF URL**: https://liff.line.me/2008911809-CBLKsbT1
- **エンドポイントURL**: https://tomoshiya.github.io/liff-ranking-practice/
- **Scope**: openid, profile, chat_message.write
- **管理画面**: https://developers.line.biz/console/

### ローカル環境
- **プロジェクトフォルダ**: `C:\Users\rshio\Documents\liff-ranking-practice\`
- **OS**: Windows 10
- **シェル**: PowerShell

---

## 📊 現在実装されている機能

### 1. お題システム
- **お題数**: 28個
- **カテゴリ**: 
  - エモーション系（8個）：最近の感情や出来事
  - Year系（2個）：この1年の振り返り
  - パーソナリティ系（15個）：好き嫌い、夢、宝物など
  - カップル系（3個）：パートナーについて
- **表示方法**: ランダム選択

### 2. ランキング入力
- **入力欄**: 1位〜5位（5つ）
- **バリデーション**: 全ての欄が必須
- **保存先**: LocalStorage
- **保存データ**: お題、ランキング、日時、ユーザー名

### 3. 履歴表示
- **表示件数**: 最大50件
- **表示内容**: お題、ランキング、日時、作成者
- **並び順**: 新しい順

### 4. UI/UX
- **カラー**: ピンク基調（#FF6B9D メイン、#6BCBFF サブ）
- **レスポンシブ**: スマホ向け（max-width: 600px）
- **画面数**: 3画面（メイン、入力、履歴）
- **アニメーション**: ボタンホバー効果

---

## 🎮 ゲームフロー（2つのモード）

### モードA：リアルタイムゲーム（優先実装・MVP）
> 「ふたりであそぶ」- 今すぐパートナーと一緒にプレイ

```
【ユーザーA】              【ユーザーB】
    |                          |
「ふたりであそぶ」        「ふたりであそぶ」
ボタンをタップ                ボタンをタップ
    |                          |
    └──────┬──────┘
           ↓
  ゲームセッション作成
  同じお題が2人に配信
「好きな食べ物TOP5」
           ↓
    ┌──────┴──────┐
    |                          |
ランキング入力              ランキング入力
1位〜5位を入力              1位〜5位を入力
    |                          |
入力完了                    入力完了
「パートナー入力中...」    「パートナー入力中...」
    |                          |
    └──────┬──────┘
           ↓
     両者入力完了
    「予想フェーズ開始！」
           ↓
    ┌──────┴──────┐
    |                          |
予想フェーズ                予想フェーズ
パートナーの項目が          自分の項目が
バラバラで表示              バラバラで表示
    |                          |
スワイプで並び替え          スワイプで並び替え
正しい順位を予想            正しい順位を予想
    |                          |
予想完了                    予想完了
「パートナー予想中...」    「パートナー予想中...」
    |                          |
    └──────┬──────┘
           ↓
     両者予想完了
           ↓
    スコア計算・結果発表
           ↓
    ┌──────┴──────┐
    |                          |
結果表示                    結果表示
・パートナーの正解順位      ・自分の正解順位
・自分の予想と答え合わせ    ・パートナーの予想と答え合わせ
・スコア表示                ・スコア表示
・勝敗判定                  ・勝敗判定
    |                          |
「もう一度遊ぶ」            「もう一度遊ぶ」
```

**特徴：**
- リアルタイム同期（パートナーの状態が見える）
- すぐに結果が出る
- 何度でも遊べる
- Cloud Functions不要

---

### モードB：ウィークリーゲーム（後で実装）
> 週次スケジュール - 時間をかけてじっくりプレイ

```
月曜日 8:00
  ↓ Cloud Functions（自動）
📢 お題公開
「今週のお題：好きな食べ物TOP5」
「水曜日までにランキングを入力してね！」
  ↓
火曜日〜水曜日
  ↓ ユーザー操作
📝 各自がランキングを入力
  ↓
水曜日 23:59
  ↓ 自動締切
🔒 ランキング入力締切
「パートナーも入力完了しました！」
「金曜日までに予想を入力してね！」
  ↓
木曜日〜金曜日
  ↓ ユーザー操作
🤔 パートナーのランキングを3つ予想
  ↓
金曜日 23:59
  ↓ 自動締切
🔒 予想締切
「明日の朝、結果を発表します！」
  ↓
土曜日 8:00
  ↓ Cloud Functions（自動）
🎉 結果発表
「あなた: 2個正解、パートナー: 3個正解」
「詳細はアプリで確認してね！」
  ↓
土曜日〜日曜日
  ↓ ユーザー操作
💬 お互いのランキングを見て会話
  ↓
次の月曜日へ...
```

**特徴：**
- 週次スケジュール（自動配信）
- 時間差OK（非同期）
- 予想もTOP5を並び替え（リアルタイムと同じ）
- Cloud Functions必要

---

## 🗄️ データ設計（Firebase移行後）

### users（ユーザー情報）
```javascript
users: {
  "LINE_USER_ID_1": {
    displayName: "たろう",
    pictureUrl: "https://...",
    partnerId: "LINE_USER_ID_2",  // null if no partner
    pairCode: "ABC123",            // 自分が生成したコード
    createdAt: "2026-01-19T10:00:00Z",
    lastLoginAt: "2026-01-19T15:30:00Z"
  }
}
```

### gameSessions（リアルタイムゲームセッション）★新規追加
```javascript
gameSessions: {
  "session_001": {
    sessionId: "session_001",
    mode: "realtime",              // realtime | weekly
    theme: "好きな食べ物TOP5",
    themeId: "theme_001",
    partnerId: "LINE_USER_ID_2",   // パートナーのID（ゲスト判定用）
    
    // 参加者（ホストが作成時に登録、ゲストは参加時に追加される）
    players: {
      "LINE_USER_ID_1": {
        displayName: "たろう",
        status: "completed"        // waiting | inputting | guessing | completed
      },
      "LINE_USER_ID_2": {
        displayName: "はなこ",
        status: "completed"
      }
    },
    
    // ゲーム状態
    gameStatus: "guessing",        // waiting | inputting | guessing | finished
    
    // ランキングデータ（各プレイヤーの入力）
    rankings: {
      "LINE_USER_ID_1": {
        "1": "寿司",
        "2": "ラーメン",
        "3": "カレー",
        "4": "ピザ",
        "5": "ハンバーグ"
      },
      "LINE_USER_ID_2": {
        "1": "パスタ",
        "2": "寿司",
        "3": "焼肉",
        "4": "ラーメン",
        "5": "カレー"
      }
    },
    
    // 予想データ（お互いの予想）
    guesses: {
      "LINE_USER_ID_1": {
        // USER_1がUSER_2のランキングを予想
        "1": "寿司",
        "2": "焼肉",
        "3": "ラーメン",
        "4": "パスタ",
        "5": "カレー"
      },
      "LINE_USER_ID_2": {
        // USER_2がUSER_1のランキングを予想
        "1": "ラーメン",
        "2": "寿司",
        "3": "カレー",
        "4": "ハンバーグ",
        "5": "ピザ"
      }
    },
    
    // 結果
    results: {
      "LINE_USER_ID_1": {
        score: 3,                  // 正解数
        perfectMatch: 1,           // 完全一致数（順位も正解）
        partialMatch: 2            // 部分一致数（項目は正解だが順位違い）
      },
      "LINE_USER_ID_2": {
        score: 2,
        perfectMatch: 1,
        partialMatch: 1
      }
    },
    
    createdAt: "2026-01-23T10:00:00Z",
    finishedAt: "2026-01-23T10:15:00Z"
  }
}
```

### rankings（個人ランキング履歴）
```javascript
rankings: {
  "ranking_001": {
    userId: "LINE_USER_ID_1",
    themeId: "theme_001",
    theme: "好きな食べ物TOP5",
    ranking: {
      "1": "寿司",
      "2": "ラーメン",
      "3": "カレー",
      "4": "ピザ",
      "5": "ハンバーグ"
    },
    mode: "solo",                 // solo | realtime | weekly
    sessionId: null,              // ゲームセッションID（リアルタイムの場合）
    weekId: null,                 // 週の識別子（ウィークリーの場合）
    createdAt: "2026-01-19T11:00:00Z"
  }
}
```

### guesses（予想データ - ウィークリーモード用）
```javascript
guesses: {
  "guess_001": {
    rankingId: "ranking_001",
    guesserId: "LINE_USER_ID_2",
    targetUserId: "LINE_USER_ID_1",
    guesses: ["寿司", "ラーメン", "焼肉"],
    result: {
      correctCount: 2,
      details: [
        { guess: "寿司", actualRank: 1, isCorrect: true },
        { guess: "ラーメン", actualRank: 2, isCorrect: true },
        { guess: "焼肉", actualRank: null, isCorrect: false }
      ]
    },
    createdAt: "2026-01-19T12:00:00Z"
  }
}
```

### themes（お題マスタ）※将来的にDB化
```javascript
themes: {
  "theme_001": {
    title: "好きな食べ物TOP5",
    category: "パーソナリティ",
    icon: "🍽️",
    color: "#FF6B9D",
    description: "あなたの好きな食べ物・料理を教えてください",
    isActive: true
  }
}
```

### weeks（週次ゲーム管理）
```javascript
weeks: {
  "2026-W03": {
    weekId: "2026-W03",
    themeId: "theme_001",
    theme: "好きな食べ物TOP5",
    startDate: "2026-01-20",
    rankingDeadline: "2026-01-22T23:59:59Z",
    guessDeadline: "2026-01-24T23:59:59Z",
    revealDate: "2026-01-25T08:00:00Z",
    status: "active"  // active | closed
  }
}
```

---

## 🔐 セキュリティとプライバシー

### データアクセス制御
- ✅ 自分のランキングは自分だけが編集可能
- ✅ パートナーのランキングは予想入力後のみ閲覧可能
- ❌ 他人のランキングは閲覧不可

### Firebase セキュリティルール（案）
```javascript
{
  "rules": {
    "users": {
      "$userId": {
        ".read": "$userId === auth.uid",
        ".write": "$userId === auth.uid"
      }
    },
    "rankings": {
      "$rankingId": {
        ".read": "auth.uid === data.child('userId').val() || auth.uid === root.child('users').child(data.child('userId').val()).child('partnerId').val()",
        ".write": "auth.uid === data.child('userId').val()"
      }
    }
  }
}
```

### プライバシーポリシー
- 正式リリース前に作成必須
- 保存するデータ: LINE UserID、表示名、ランキング内容
- データの利用目的: ゲーム機能の提供
- データの保存期間: アカウント削除まで
- 第三者提供: なし

---

## 💰 コストとスケーリング

### Firebase 無料枠（Sparkプラン）
- **Realtime Database**: 1GB保存、10GB/月転送
- **Cloud Functions**: 200万回/月実行、40万GB秒/月
- **Authentication**: 無制限

### 想定利用量（100ペア = 200ユーザー）
- **保存**: 約5MB（1GBの0.5%）
- **転送**: 約500MB/月（10GBの5%）
- **Functions実行**: 約3,200回/月（200万の0.16%）

→ **当面は完全無料で運用可能**

### 有料化検討ライン
- 1,000ペア（2,000ユーザー）を超えたら
- 画像アップロード機能を追加したら
- リアルタイム通信が大幅に増えたら

---

## ⚠️ 既知の課題と制約

### 技術的課題
1. **LINE UserIDでのFirebase認証方法**
   - カスタム認証トークンが必要
   - Cloud Functionsでトークン生成が必要
   - 実装がやや複雑

2. **非同期処理の理解**
   - データ取得に時間がかかる
   - `.then()` を使った処理が必要
   - エラーハンドリングが重要

3. **ペア認証のタイミング**
   - 片方が入力しない場合の対応
   - リマインダー機能が必須

4. **技術負債の蓄積（2026年1月26日認識）**
   - 単一HTMLファイル3257行 → AIの把握限界
   - グローバル変数10個以上 → 状態管理が散在
   - 類似関数の重複（setupGameDragEvents vs setupDragEvents）→ 300行の重複コード
   - リスナー管理の実装ミス → 根本的な理解不足
   - **対策**: 段階的リファクタリング（MVP完成後、2月第2週〜）

### UX課題
1. **初めてのユーザー導線**
   - チュートリアルの必要性
   - 空状態のメッセージ

2. **継続利用の促進**
   - 通知のタイミング
   - モチベーション維持の仕組み

### ビジネス課題
1. **テストユーザーの獲得**
   - 友人・知人に依頼
   - SNSでの募集

2. **フィードバック収集方法**
   - Googleフォーム
   - アプリ内フィードバック機能

---

## ✅ 完了事項（実績）

### 2026年1月17日（初日）
- ✅ LIFF環境構築完了
- ✅ 基本アプリ作成
- ✅ 動作確認成功
- ✅ 設計ドキュメント作成

### 2026年1月19日
- ✅ ランキング入力機能完成
  - お題データ28個実装
  - ランダム表示機能
  - 1〜5位入力フォーム
  - LocalStorage保存
  - 履歴表示機能
- ✅ デザイン改善（ピンク基調）
- ✅ 実機動作確認
- ✅ 壁打ち実施
  - 開発順序の整理
  - Firebase理解
  - 非同期処理の理解
  - Cloud Functionsの重要性確認
  - LIFF/LINEの使い分け理解
  - プロジェクト整理方針の決定
- ✅ ドキュメント統合・整理
  - PROJECT_MASTER.md 作成（唯一の情報源）
  - README.md 刷新（シンプルな案内）
  - 既存ドキュメントをdocs/に移動（参考資料化）
  - 情報の一元管理体制確立

### 2026年1月20日
- ✅ GitHubファイル整理完了
  - docs/ フォルダ作成
  - README.md 新版作成・アップロード
  - PROJECT_MASTER.md アップロード
  - プロジェクト構造の最適化
- ✅ ユーザーフィードバック収集
  - 実際に2回使用して課題を抽出
  - スマホ最適化の必要性を確認
  - デザインの方向性を決定
- ✅ UI/UX大幅改善（フェーズ2-B完了）
  - スマホ最適化・レスポンシブデザイン実装
  - デザインカラー変更（ピンク系→中性的な青系）
  - Enterキーで次の入力欄に移動機能
  - キャッチコピー変更（2行表示）
  - 極小画面（360px以下）対応
- ✅ 技術学習
  - フロントエンド/バックエンドの理解
  - JSONの理解
  - お題管理の将来設計を検討
- ✅ 方針決定
  - お題重複管理は優先度低と判断（正しい判断）
  - 次はFirebase導入を優先
  - ペア機能が最重要と確認

### 2026年1月22日（フェーズ3完了！）
- ✅ 開発環境整備
  - GLOSSARY.md（開発用語集）作成
  - 非エンジニア向けに50以上の専門用語を解説
  - PROJECT_MASTER.mdからリンク設定
- ✅ Git環境構築
  - ローカルとGitHubの連携設定完了
  - Git Credential Manager認証設定
  - GitHub非公開メールアドレス設定
  - git add/commit/push の習得
- ✅ Firebase SDK導入
  - index.htmlにFirebase SDK追加
  - Firebase設定情報の記述
  - Firebase初期化コード実装
  - 接続テスト機能実装
- ✅ Firebase接続テスト成功
  - LIFFアプリからFirebase接続確認
  - テストデータ保存成功
  - Firebaseコンソールでデータ確認
- ✅ LocalStorage → Firebase 完全移行
  - saveRanking()関数をFirebase対応に変更
  - showHistory()関数をFirebase対応に変更
  - エラーハンドリング実装
  - ローディング表示実装
  - 実機テスト成功（2件のランキング保存確認）
- ✅ データ構造確認
  - userId、userName、theme、ranking、createdAt 正常保存
  - Firebaseコンソールでデータ構造検証完了
- ✅ 今後の開発戦略についての壁打ち
  - ネイティブアプリ開発の検討（React Native推奨）
  - ゲーム開発の検討（Phaser.js推奨、Unityは不要）
  - 学習ロードマップの策定（6ヶ月〜1年スパン）
  - 技術スタックの整理と優先順位の明確化
  - MVP完成目標の設定（今月中＝1月31日）
  - **方針決定**: まずは「ふたりのランキング」の完成に注力
  - **現実的なプラン**: フェーズ4-5を1月31日までに完成させる

### 2026年1月23日（フェーズ4完了！）
- ✅ ペア機能実装完了
  - ペアコード生成機能（6桁ランダムコード、紛らわしい文字を除外）
  - ペアコード共有機能（コピーボタン）
  - ペアコード入力・検証機能（Firebase検索）
  - ペア成立機能（双方向のパートナーID設定）
  - ペア状態表示（メイン画面に表示）
  - ペア解除機能
- ✅ ユーザー管理機能実装
  - users ノードをFirebaseに作成
  - 新規ユーザー自動登録
  - 既存ユーザー情報更新
  - 最終ログイン日時記録
- ✅ 実機動作確認
  - ペア状態表示確認
  - ペア設定ボタン確認
  - ペアコード表示確認
- ✅ ゲーム設計の見直し・方針決定
  - **重要決定**: リアルタイムゲームとウィークリーゲームの2モード搭載
  - **開発順序**: リアルタイムゲーム優先（テストしやすい）
  - リアルタイムゲームフロー確定（順位当てゲーム）
  - PROJECT_MASTER.md 大幅更新（新フロー反映）

### 2026年1月23日（フェーズ5-A完了＋UI/UX大幅改善！）
- ✅ リアルタイムゲーム完全実装
  - 「ふたりであそぶ」ボタン実装
  - ゲームセッション管理（gameSessions ノード）
  - 待機室機能（ホスト/ゲスト）
  - ランキング同時入力機能
  - リアルタイム同期（パートナーの状態表示）
  - 予想フェーズ（ドラッグ&ドロップで並び替え）
  - スコア計算・結果表示
  - 「もう一度遊ぶ」機能
- ✅ 振り返り予想機能実装（一人練習モード）
  - 過去のランキングから選択
  - 並び替えUI実装
  - スコア計算・結果表示
- ✅ ドラッグ&ドロップUI実装
  - シームレスな並び替え（1位→5位も一度で可能）
  - タッチ対応（スマホ）
  - デスクトップ対応（マウス）
  - 長押し判定（200ms）
  - 振動フィードバック
  - 順位番号表示（1位、2位...）
  - ドラッグハンドル（≡アイコン）
- ✅ スコアリングシステム設計・実装
  - **方式B採用**: 個数+順位ボーナス（最大20点/人）
  - 当てた個数スコア（1個あたり1点、最大5点）
  - 順位ボーナス（1位=5点、2位=4点...5位=1点）
  - 振り返り予想の結果表示（5段階評価メッセージ）
  - リアルタイムゲームの結果表示（対戦成績＋ふたりの成績、6段階評価）
- ✅ UI/UX大幅改善（第2弾）
  - **TOP画面整理**: 3セクション分割（ふたりであそぶ/ひとりで試す/テスト）
  - **文言統一**: 「お題」→「テーマ」、「過去のランキング」→「過去の回答履歴」
  - **ボタン改善**: 「ペア設定」→「ペアを設定する」、枠内配置
  - **ペア未設定時**: 「ふたりであそぶ」ボタンをグレーアウト
  - **結果画面**: 当たった行の背景を薄い緑色で表示（視覚的フィードバック）
- ✅ 振り返り予想UI改善
  - **ランダム選択**: 一覧をスキップして即座にゲーム開始
  - **ドラッグハンドル**: 右端に配置（≡アイコン）
  - **ボタン削除**: 上へ/下へボタンを削除（スワイプのみ）
  - **テキスト選択無効化**: コピー動作を完全に無効化
  - **丸型固定ボタン**: 左下「HOME」、右下「ANSWER」
  - **順位番号リアルタイム更新**: スワイプ中に即座に更新
  - **視覚フィードバック強化**: ドラッグ中の要素を拡大・影強化
- ✅ ふたりであそぶUI改善
  - **ドラッグハンドル**: 右端に配置（≡アイコン）
  - **ボタン削除**: 上へ/下へボタンを削除（スワイプのみ）
  - **テキスト選択無効化**: コピー動作を完全に無効化
  - **順位番号リアルタイム更新**: スワイプ中に即座に更新
- ✅ 全ページ共通UI改善
  - **HOMEボタン**: 全ての画面に左下の丸型HOMEボタンを追加
  - **統一感**: 固定配置の丸型ボタンで操作性向上
- ✅ テスター登録対応
  - LINE Developers Consoleでテスター登録方法を確認
  - パートナー（妻）のアカウントを登録
  - 開発中アプリへのアクセス権限付与成功
- ✅ 実機テスト
  - 妻のアカウントでログイン成功
  - ペア設定動作確認
  - UI改善の動作確認（全体的に良い感じ！）

### 2026年1月24日（ペア機能バグ修正）
- ✅ ペア機能の重大バグ修正
  - **問題**: 両者が「ふたりであそぶ」を押すと、両方とも待機画面のままでゲームが開始されない
  - **原因**: セッション作成時に両方のプレイヤーを登録していたため、パートナーもホスト扱いになっていた
  - **修正内容**:
    - セッション作成時はホストのみを登録するように変更
    - ゲスト参加時にplayersに追加する処理を実装
    - セッション検索ロジックを新構造（partnerId フィールド）に対応
  - **結果**: ゲストに「参加する」ボタンが表示され、押すとゲームが正常に開始される
- ✅ データ構造の改善
  - gameSessionsに`partnerId`フィールドを追加（パートナー識別用）
  - ホスト/ゲストの判定ロジックを最適化

### 2026年1月24日（実機テストフィードバック対応）
- ✅ 重大バグ修正（5件）
  1. **ランキング入力中に相手が送信すると入力内容が消える**
     - 原因：セッション更新時に画面全体を再描画していた
     - 修正：既に入力画面が表示されている場合は、進行状況のみ更新
  2. **予想入力中に相手が送信すると予想内容がリセットされる**
     - 同上の修正で解決
  3. **待機画面の「キャンセル」ボタンが機能しない**
     - 修正：`showScreen`関数を改善し、より確実に画面切り替え
  4. **結果発表の「もう一度遊ぶ」「HOME」ボタンが機能しない**
     - 修正：エラーハンドリング追加、ボタンレイアウト改善
  5. **全てのHOMEボタンの動作確認と修正**
     - 全7箇所のHOMEボタンを確認・修正完了

- ✅ UI/UX改善（4件）
  1. **結果発表：緑背景で文字が見えない問題**
     - 修正：「あなたの正解ランキング」セクションの背景をグレーに変更
  2. **結果発表：表にタイトル行を追加**
     - 実装：順位/正解/予想/評価/スコアのタイトル行を追加
  3. **結果発表：表の順序を変更**
     - 実装：順位→正解→予想→評価→スコアの順に表示
  4. **結果発表：評価を✓/✕マークで表示**
     - 実装：✅/❌から✓/✕に変更、スコアも「〇pt」形式で表示

- ✅ 結果表示の大幅改善
  - グリッドレイアウトで見やすい表形式に変更
  - 各項目の獲得ptを表示（1位=5pt、2位=4pt...）
  - タイトル行に背景色を追加（見やすさ向上）

### 2026年1月28日（Phase 7: セキュリティ対策実装）
- ✅ Firebase Security Rulesの重大な脆弱性を発見
  - 2026年2月21日まで誰でもアクセス可能な危険な設定
  - 個人情報（LINE名、ゲーム回答）が第三者に閲覧可能
  - データの改ざん・削除が可能な状態

- ✅ Firebase匿名認証の実装
  - `firebase.auth().signInAnonymously()` を実装
  - LIFFアプリ経由のユーザーのみがアクセス可能に
  - Firebase Authentication SDKを追加

- ✅ Security Rulesの修正と最適化
  - 認証必須（`auth != null`）に変更
  - `/gameSessions` と `/gameSessions/$sessionId` の両方にルール設定
  - `checkExistingSession`, `createGameSession`, `cleanupAndRestoreSessions` が正常動作

- ✅ セキュリティ知識の習得
  - Security Rulesの階層構造の理解
  - `auth` 変数の使い方
  - 匿名認証 vs Custom Tokenの違い
  - 段階的なセキュリティ強化の考え方

- ✅ 実機テスト成功
  - ペア設定、ゲームプレイ、すべて正常動作
  - セキュリティエラーなし

---

## 🎯 次回アクション（優先順位順）

### 完了済み ✅
1. ✅ **プロジェクトマスタードキュメント作成**
2. ✅ **ドキュメント統合・整理**
3. ✅ **GitHubでのファイル整理**
4. ✅ **ユーザーフィードバック収集**
5. ✅ **UI/UX大幅改善**
6. ✅ **フェーズ2完了！**
7. ✅ **開発用語集（GLOSSARY.md）作成**
8. ✅ **Git環境構築・習得**
9. ✅ **Firebaseアカウント・プロジェクト作成**
10. ✅ **Firebase SDK導入**
11. ✅ **Firebase接続テスト成功**
12. ✅ **LocalStorage → Firebase 完全移行**
13. ✅ **フェーズ3完了！**
14. ✅ **ペア機能実装（コード生成・入力・検証・表示・解除）**
15. ✅ **フェーズ4完了！**
16. ✅ **ゲーム設計見直し（リアルタイム＋ウィークリー2モード）**

### 🎯 MVP完成目標（2026年1月31日まで）
**目標**: リアルタイムゲームを完成させて、パートナーと遊べる状態にする

### ✅ フェーズ5-A完了（リアルタイムゲーム＋UI/UX改善）

#### 1. ゲームセッション管理
17. ✅ **ゲーム開始機能**
    - 「ふたりであそぶ」ボタン実装
    - gameSessionsノード作成
    - ランダムテーマ選択
    - パートナーへの通知（ゲーム待機状態）

18. ✅ **セッション状態管理**
    - リアルタイム同期の実装
    - 状態監視（waiting/inputting/guessing/finished）
    - パートナーの進行状況表示

#### 2. ランキング入力フェーズ
19. ✅ **同時入力機能**
    - セッション専用入力画面
    - 入力中の状態表示
    - 入力完了通知

20. ✅ **両者完了待ち機能**
    - 「パートナー入力中...」表示
    - 両者完了の検知
    - 自動的に予想フェーズへ移行

#### 3. 予想フェーズ
21. ✅ **予想画面UI実装**
    - パートナーの項目をバラバラに表示
    - ドラッグ＆ドロップで並び替え（シームレス移動）
    - 順位番号リアルタイム更新
    - 順位確定ボタン

22. ✅ **予想ロジック実装**
    - 並び替えデータの保存
    - 予想完了通知
    - 両者完了の検知

#### 4. 結果表示
23. ✅ **スコア計算ロジック**
    - 方式B実装（個数+順位ボーナス、最大20点）
    - 当てた個数スコア（1個=1点）
    - 順位ボーナス（1位=5点、2位=4点...5位=1点）

24. ✅ **結果表示画面**
    - 正解ランキング表示
    - 自分の予想と正解の比較
    - スコア表示（対戦成績＋ふたりの成績）
    - 勝敗判定
    - 評価メッセージ（5段階・6段階）
    - 当たった行の背景色表示
    - 「もう一度遊ぶ」ボタン

#### 5. UI/UX改善
25. ✅ **TOP画面整理・文言統一**
26. ✅ **振り返り予想UI改善**
27. ✅ **全ページにHOMEボタン追加**
28. ✅ **テキスト選択無効化**
29. ✅ **順位番号リアルタイム更新**

### 1月24日（実機テストフィードバック対応）
30. ✅ **実機テスト実施**
    - 夫婦で初回プレイ＆バグ・改善点の洗い出し
    - 9件の重大バグ・UI問題を発見

31. ✅ **重大バグ修正（5件）**
    - ランキング入力中に相手が送信すると内容が消える → 修正完了
    - 予想入力中に相手が送信すると内容がリセットされる → 修正完了
    - 待機画面の「キャンセル」ボタンが機能しない → 修正完了
    - 結果発表の「もう一度遊ぶ」「HOME」ボタンが機能しない → 修正完了
    - 全てのHOMEボタンの動作確認と修正 → 完了

32. ✅ **UI/UX改善（4件）**
    - 結果発表：緑背景で文字が見えない → 修正完了
    - 結果発表：表にタイトル行を追加 → 実装完了
    - 結果発表：表の順序を変更（順位→正解→予想→評価→スコア）→ 実装完了
    - 結果発表：評価を✓/✕マークで表示 → 実装完了

### 2026年1月26日（セッション管理バグ修正＋技術負債の認識）
33. ✅ **緊急バグ修正（セッション管理）**
    - **問題**: 待機室キャンセルボタンでエラーが発生、部屋から出られない
    - **原因1**: `backToMain()`がasync関数になったのに、呼び出し側でawaitしていなかった
    - **原因2**: Firebaseリスナー管理が根本的に間違っていた（`sessionListener.off()`は動作しない）
    - **修正内容**:
      - `backToMain()`呼び出しを`showScreen('mainScreen')`に変更（4箇所）
      - リスナー管理を修正：`sessionListener` → `currentSessionRef`に変更
      - `currentSessionRef.off()`で正しくリスナー解除
    - **影響範囲**: 待機室、結果画面、振り返り予想のキャンセル処理

34. ✅ **スワイプUI改善の試行錯誤**
    - **要求**: スワイプ中にリアルタイムで順位番号を更新したい
    - **試行**: `touchmove`中に`updateRankNumbers()`を呼び出す実装
    - **結果**: 複数のバグが発生（6位/7位表示、null表示、複数要素の重複）
    - **原因**: プレースホルダー（opacity: 0）のカウント、ドラッグ中要素の位置計算の複雑さ
    - **判断**: 元の安定した動作に戻す（`touchend`でのみ更新）
    - **学び**: 動いているコードは安易に触らない

35. ✅ **技術負債の認識と今後の方針決定**
    - **ユーザーからの重要な指摘**:
      - 開発精度が落ちている（バグが増えている）
      - コンテキストの保持限界（3257行の単一ファイル）
      - 技術負債・スパゲッティコード化の懸念
    - **現状分析**:
      - グローバル変数が10個以上（状態管理が散在）
      - 類似関数が重複（setupGameDragEvents vs setupDragEvents）
      - 単一HTMLファイル3257行（AIの把握限界）
      - リスナー管理の理解不足
    - **決定した方針**: 段階的リファクタリング
      - Phase 1: MVP完成（〜1/31）- 現状のまま必須機能を追加
      - Phase 2: フィードバック収集（2月第1週）
      - Phase 3: リファクタリング（2月第2週〜）- ファイル分割、共通処理統一
    - **優先機能**: 「ふたり向け」機能を優先（オリジナルテーマ、テーマ選択、スコア改善、履歴）
    - **後回し**: 「ひとり向け」機能の細かい改善

### 次回：実機テスト＋優先機能実装（1月27日以降）

**🎯 優先度A：まず修正版をテスト**
33. ⬜ **修正版の実機テスト**
    - 9件の修正が正常に動作するか確認
    - 新たなバグがないか確認

**🎯 優先度B：機能追加（テスト後に実施）**
34. ⬜ **スコアリング改善（推奨：最優先）**
    - 現在：完全一致のみ得点
    - 改善：完全一致=2pt、±1位のズレ=1pt、外れ=0pt
    - 最大10点方式で「おしい！」も楽しめるように
    - **推定時間**: 30分〜1時間

35. ⬜ **テーマをリストから選択できる機能**
    - 現在：ランダムのみ
    - 改善：28個のテーマから好きなものを選択
    - **推定時間**: 1〜2時間

36. ⬜ **ランキング入力後に順番を入れ替える機能**
    - 「あ、順番間違えた！」を修正できる
    - **推定時間**: 1〜2時間

**注**: フェーズ6（自動配信）は、最初のテストユーザーには手動で「今日のお題！」とLINEで送ることで回避可能。MVPには必須ではない。

---

## 📝 重要な決定事項

### 技術選定
| 項目 | 決定内容 | 理由 |
|------|---------|------|
| データベース | Firebase Realtime Database | 無料枠が大きい、初心者向け、リアルタイム |
| ホスティング | GitHub Pages | 無料、簡単、自動デプロイ |
| フロントエンド | Vanilla JavaScript | シンプル、学習コスト低 |
| ペア認証 | ペアコード方式 | 実装が簡単、確実 |
| 自動配信 | Cloud Functions | サーバーレス、スケジュール実行 |

### 開発方針
| 項目 | 決定内容 |
|------|---------|
| 開発スタイル | MVP → 段階的リリース |
| ゲームフロー | 週次スケジュール（月曜お題公開） |
| スコアリング | 最初は正解数のみ、後で順位考慮追加 |
| お題管理 | ハードコード → JSON → DB |
| MVP完成目標 | 2026年1月31日（フェーズ5-A完了＋必須機能追加） |
| 初回テスト配信 | 2026年2月上旬（友人・知人カップル） |
| 正式リリース目標 | 2026年3月中旬〜4月上旬 |
| **リファクタリング方針** | **段階的アプローチ（2026年1月26日決定）** |
| - Phase 1 | MVP完成（〜1/31）現状のまま必須機能追加 |
| - Phase 2 | フィードバック収集（2/1〜2/7） |
| - Phase 3 | リファクタリング（2/8〜）ファイル分割、コード整理 |
| **機能優先順位** | **「ふたり向け」機能を優先、「ひとり向け」は後回し** |

### 今後の展開（長期戦略・2026年1月22日決定）
| 項目 | 決定内容 | 時期 |
|------|---------|------|
| ネイティブアプリ化 | React Native で iOS/Android版開発 | 2026年6-8月 |
| ゲーム開発学習 | Phaser.js でカジュアルゲーム制作 | 2026年4-5月 |
| 次のアプリ | カップル向け新アプリ（ゲーム or ツール） | 2026年11-12月 |
| 学習優先順位 | JavaScript深化 → React → React Native | 段階的に |

### UX方針
| 項目 | 決定内容 |
|------|---------|
| 通知 | LINE通知（Cloud Functions） |
| 入力 | LIFFアプリ（Webフォーム） |
| 結果表示 | LIFF + LINE通知（概要） |
| カラー | ピンク基調（#FF6B9D） |

---

## 📝 このドキュメントの更新ルール

### いつ更新するか
- ✅ 新機能を実装した時
- ✅ 重要な決定をした時
- ✅ 壁打ち・相談をした時
- ✅ バグを修正した時
- ✅ 次回アクションが変わった時

### 更新する場所
1. **完了事項**: `## ✅ 完了事項（実績）`
   - 日付ごとに箇条書きで追加
   
2. **次回アクション**: `## 🎯 次回アクション（優先順位順）`
   - 完了したら ✅ に変更
   - 新しいアクションを追加
   
3. **重要な決定事項**: `## 📝 重要な決定事項`
   - 技術選定、方針決定などを記録
   
4. **既知の課題**: `## ⚠️ 既知の課題と制約`
   - 新しい課題が見つかったら追加

5. **最終更新日**: 一番上の日時を更新

### 更新しない場所
- プロジェクト概要（変わらない）
- 技術スタック（大きな変更のみ）
- データ設計（確定するまで）

---

## 🤖 AI引き継ぎ用プロンプト

次回開発セッションでは、以下のように伝えてください：

```
【引き継ぎ】ふたりのらんきんぐ LIFFアプリ開発の続きです

@PROJECT_MASTER.md を読み込んで、現在の状況を把握してください。

## 今回やりたいこと
[ここに具体的な作業内容を記入]

例：
- 「下書き保存機能を実装したい」
- 「Firebase導入を始めたい」
- 「ペアコード機能を作りたい」
- 「コードをリファクタリングしたい」
- 「壁打ちをしたい（テーマ：〇〇）」

## 質問・相談
[あれば記入]

---
非エンジニアなので、丁寧に説明してください。
作業完了後、PROJECT_MASTER.md を更新してください。
```

---

## 🚀 次回セッション用プロンプト（コピー用）

**次回開始時に以下をコピー&ペーストしてください：**

```
【引き継ぎ】ふたりのらんきんぐ LIFFアプリ開発の続きです

@PROJECT_MASTER.md を読み込んで、現在の状況を把握してください。

## 前回までの状況（1月28日）
- ✅ MVP完成（Phase 4-6）
  - オリジナルテーマ入力機能
  - スコアリング改善（完全一致2pt、おしい1pt）
  - HOMEボタン実装、UI/UX改善
  - 全ての重大バグ修正完了
- ✅ セキュリティ対策完了（Phase 7）
  - Firebase Security Rulesの危険な設定を修正
  - Firebase匿名認証を実装
  - 認証なしのアクセスを完全にブロック
  - 実機テスト成功

## 今回やりたいこと

**【推奨】実機総合テスト：**
- 全機能の動作確認（ペア設定、ランダム、カスタム、スコア）
- セキュリティの確認（認証なしでアクセスできないこと）
- バグがないかチェック

**【その後】本番リリース準備：**
1. テーマ内容の最終確認・調整
2. フィードバックメッセージの調整
3. プライバシーポリシー作成
4. Firebase設定の最終確認
5. LINE配信準備

**または：**
- 「壁打ちをしたい（テーマ：〇〇）」
- 「新しい機能を追加したい」
- その他の要望

## 重要な注意事項
- **MVP完成・セキュリティ対策完了**
- **次は実機総合テスト→本番リリース準備**
- **動いている機能には触らない**

## 目標
友人・知人カップルに試用してもらい、
フィードバックを収集する！

---
非エンジニアなので、丁寧に説明してください。
作業完了後、PROJECT_MASTER.md を更新してください。
```

**📝 メモ：1月28日セッション完了**
- セキュリティ対策完了（Firebase Security Rules + 匿名認証）
- 危険な設定（誰でもアクセス可能）を発見・修正
- 実機テスト成功、すべて正常動作
- 本番リリース準備完了

**🎯 次回の推奨順序：**
1. **実機総合テスト**（全機能確認）
2. **テーマ・メッセージ調整**（コンテンツ最終確認）
3. **プライバシーポリシー作成**（法的要件）
4. **本番リリース**（友人カップルへ配信）

**🔒 セキュリティレベル：**
- ✅ 認証必須（LIFFアプリ経由のみ）
- ✅ 第三者アクセスブロック
- ✅ MVPには十分
- 🔸 将来：Custom Token実装（完全な本人確認）

---

## 📚 参考リンク

### 公式ドキュメント
- **LIFF**: https://developers.line.biz/ja/docs/liff/
- **LINE Messaging API**: https://developers.line.biz/ja/docs/messaging-api/
- **Firebase**: https://firebase.google.com/docs
- **Firebase Realtime Database**: https://firebase.google.com/docs/database
- **Cloud Functions**: https://firebase.google.com/docs/functions

### チュートリアル
- **LIFF入門**: https://developers.line.biz/ja/docs/liff/getting-started/
- **Firebase + LIFF**: https://firebase.google.com/docs/auth/web/line-oauth
- **JavaScript基礎**: https://developer.mozilla.org/ja/docs/Web/JavaScript

### コミュニティ
- **LINE Developers Community**: https://www.line-community.me/
- **Firebase日本語コミュニティ**: https://firebase-community.jp/

---

## 📖 用語集（初心者向け）

わからない用語が出てきたら、**[GLOSSARY.md（開発用語集）](GLOSSARY.md)** を参照してください。

開発中に登場する専門用語を非エンジニア向けに分かりやすく解説しています。

### よく使う用語（クイックリファレンス）

| 用語 | 意味 |
|------|------|
| **LIFF** | LINEアプリ内でWebページを表示する機能 |
| **Firebase** | Googleのアプリ開発サービス（データベース、認証など） |
| **Realtime Database** | リアルタイムに同期するデータベース |
| **LocalStorage** | ブラウザ内のデータ保存場所（共有不可） |
| **SDK** | プログラムを作るための道具箱 |
| **API** | アプリ同士が会話するためのルール |
| **Cloud Functions** | 自動実行されるプログラム |
| **GitHub Pages** | 無料のホームページ公開サービス |

詳しい説明は **[GLOSSARY.md](GLOSSARY.md)** をご覧ください。

---

## 📞 サポート情報

### 開発者
- **名前**: tomoshiya
- **GitHub**: https://github.com/tomoshiya
- **プロジェクト**: 非エンジニア、学習しながら開発中

### 開発ペース
- **週5〜10時間**
- **主に夜間・週末**

### 相談・質問
- **AI（このセッション）**: 開発全般の相談
- **LINE Developers Community**: 技術的な質問
- **Firebase公式**: Firebase関連

---

**最終更新**: 2026年1月26日 23:45  
**次回更新**: 主要な進捗があった時（次回は修正版の実機テスト完了時）

---

## 🔍 技術負債とリファクタリングについて（非エンジニア向け解説）

### リファクタリングとは？

**リファクタリング = 「見た目は変えずに、中身を整理整頓すること」**

#### 身近な例え
- **リフォーム前の家**: 物が散らかっている、どこに何があるか分からない、でも住める
- **リフォーム後の家**: 同じ家だけど、整理整頓されて使いやすい、掃除しやすい

#### プログラムの場合
```javascript
// リファクタリング前（動くけど汚い）
let a = 10;
let b = 20;
let c = a + b;  // 何を計算してるか分からない

// リファクタリング後（同じ動作だけど分かりやすい）
let applePrice = 10;
let orangePrice = 20;
let totalPrice = applePrice + orangePrice;  // 明確！
```

**重要なポイント：**
- 機能は変わらない（ユーザーから見たら同じ）
- コードが読みやすくなる
- バグが見つけやすくなる
- 新しい機能を追加しやすくなる

---

### グローバル変数とは？

**グローバル変数 = 「どこからでも使える変数（便利だけど危険）」**

#### 身近な例え：家の中の物

##### 🏠 グローバル変数（家の共有スペースに置いた物）
```
リビングのテーブルに「家の鍵」を置く
↓
誰でも触れる → 便利！
でも...
・誰が最後に使った？
・なくなったら誰のせい？
・勝手に場所を変えられる
```

##### 🔒 ローカル変数（自分の部屋の引き出しに置いた物）
```
自分の部屋の引き出しに「家の鍵」を保管
↓
自分しか触れない → 安全！
・誰が使ったか明確
・なくなったら自分のせい
・勝手に場所を変えられない
```

---

### 現在のアプリの問題（グローバル変数が多すぎる）

#### 現在のコード：
```javascript
// グローバル変数（ファイルのどこからでもアクセスできる）
let currentTheme = '';           // 現在のテーマ
let userProfile = null;          // ユーザー情報
let currentUser = null;          // Firebase上のユーザー
let currentGameSession = null;   // ゲームセッション
let currentSessionRef = null;    // Firebaseリスナー
let currentReviewRanking = null; // 振り返り用ランキング
let reviewCorrectAnswer = null;  // 振り返り用正解
// ... さらに増える可能性

// どの関数からでも触れる
function startGame() {
    currentTheme = 'ラーメン';  // ここで変更
}

function showResult() {
    console.log(currentTheme);  // ここでも使える
}

function playAgain() {
    currentTheme = null;  // ここでも変更できる！
}
```

**問題点：**
1. **追跡が困難**: どの関数が、いつ、何を変更したか分からない
2. **バグの原因特定が難しい**: 10箇所で触っていたら、どこがバグ？
3. **意図しない変更**: A関数がB関数の変数を壊す可能性

---

### リファクタリング後のイメージ

#### 理想のコード：
```javascript
// グローバル変数を1つのオブジェクトにまとめる
const gameState = {
    theme: '',
    user: null,
    session: null,
    sessionRef: null,
    reviewMode: {
        ranking: null,
        correctAnswer: null
    }
};

// 状態の変更は専用の関数を通す
function setTheme(newTheme) {
    gameState.theme = newTheme;
    console.log('テーマ変更:', newTheme);
}

function getTheme() {
    return gameState.theme;
}

// 使う側
function startGame() {
    setTheme('ラーメン');  // 明確に変更している
}
```

**改善点：**
1. **整理整頓**: 関連する変数が1箇所にまとまっている
2. **追跡が容易**: 変更は専用関数を通すので、ログが取れる
3. **安全**: 意図しない変更を防げる

---

### ファイル分割のイメージ

#### 現在（3257行の単一ファイル）：
```
index.html (3257行)
├── HTML（画面構造）
├── CSS（デザイン）
└── JavaScript
    ├── LIFF初期化
    ├── Firebase設定
    ├── ひとりであそぶ機能
    ├── ふたりであそぶ機能
    ├── ドラッグ&ドロップ（2種類）
    └── その他50個の関数
```

**問題：**
- 1つのファイルが長すぎて、どこに何があるか分からない
- 修正時に関係ない部分まで読む必要がある
- AIが全体を把握できない

---

#### リファクタリング後（ファイル分割）：
```
liff-ranking-practice/
├── index.html (200行)
│   └── 画面の骨組みだけ
│
├── css/
│   └── style.css (300行)
│       └── デザインだけ
│
└── js/
    ├── config.js (50行)
    │   └── Firebase設定だけ
    │
    ├── session-manager.js (200行)
    │   └── セッション管理だけ
    │
    ├── realtime-game.js (400行)
    │   └── 「ふたりであそぶ」の処理だけ
    │
    ├── solo-mode.js (300行)
    │   └── 「ひとりであそぶ」の処理だけ
    │
    ├── drag-drop.js (200行)
    │   └── ドラッグ処理だけ（共通化）
    │
    └── main.js (150行)
        └── 初期化処理だけ
```

**メリット：**
1. **1ファイルが短い** → AIが完全に把握できる
2. **責任が明確** → バグがあったらどのファイルか分かる
3. **修正が容易** → 関係ない部分を読まなくて良い
4. **再利用しやすい** → drag-drop.jsは他のプロジェクトでも使える

---

### なぜ今すぐリファクタリングしないのか？

#### 理由1: 時間がかかる
- リファクタリング: 2〜3日
- 機能追加: 1日
- **1月31日の期限に間に合わない可能性**

#### 理由2: リスクがある
- ファイル分割中に新しいバグが入る可能性
- 全ての機能を再テストする必要がある

#### 理由3: フィードバック優先
- 「本当に必要な機能」がまだ分からない
- ユーザーテスト後に、使われる機能だけをリファクタリングする方が効率的

---

### 段階的リファクタリングの戦略

#### Phase 1: MVP完成（〜1/31）
```
現在のコード（汚いけど動く）
↓
必須機能を追加（オリジナルテーマ、テーマ選択、スコア改善）
↓
友人カップルでテスト可能な状態
```

#### Phase 2: フィードバック収集（2/1〜2/7）
```
友人カップルに使ってもらう
↓
「本当に使う機能」を特定
↓
「不要な機能」を特定
```

#### Phase 3: リファクタリング（2/8〜）
```
使われる機能だけを抽出
↓
ファイルを分割
↓
グローバル変数を整理
↓
共通処理を統一
↓
テストコード追加
↓
綺麗で保守しやすいコードベース完成！
```

---

### まとめ

| 用語 | 意味 | 家の例え |
|------|------|---------|
| **リファクタリング** | 機能を変えずに、コードを整理整頓すること | 家のリフォーム（間取りは同じ、整理整頓） |
| **グローバル変数** | どこからでも使える変数（便利だけど危険） | リビングに置いた物（誰でも触れる） |
| **ローカル変数** | 特定の場所でしか使えない変数（安全） | 自分の部屋の引き出し（自分しか触れない） |
| **ファイル分割** | 大きなファイルを小さく分けること | 1つの大きな部屋を、寝室・リビング・キッチンに分ける |
| **技術負債** | 後で直すべき汚いコード（借金のようなもの） | 後回しにした片付け（いつか整理が必要） |

**今の方針：**
- **今**: MVP完成を優先（汚くても動けばOK）
- **2月**: フィードバックを得てから、本当に必要な部分だけリファクタリング
- **結果**: 効率的に、リスク少なく、質の高いアプリを作れる！

---

## 🎉 MVP完成！

### ✅ 完了した機能
1. **✅ オリジナルテーマ入力機能**
   - ✅ モード選択画面（ランダム/カスタム）
   - ✅ カスタムテーマ入力（3〜50文字）
   - ✅ ホスト/ゲスト権限管理
   - ✅ もう一度あそぶ対応
   
2. **✅ スコアリング改善**
   - ✅ 完全一致：2点
   - ✅ おしい（±1）：1点
   - ✅ 最大20点（ふたり合計）
   - ✅ 答え合わせ表の改善

### 🚀 次は試用フェーズへ！
友人・知人カップルに試用してもらい、フィードバックを収集する段階です。

### 優先度中：UX改善（MVP後に実施）
3. **HOMEボタンの常時表示**
   - 「回答中」「予想中」でもHOMEボタンを表示
   - いつでもゲームを中断可能に

4. **HOMEボタンの確認ダイアログ**
   - 「ホームに戻ると、現在のゲームを終了します。よろしいですか？」
   - 誤操作防止のための1ステップ追加

### 優先度低：将来実装
- テーマカテゴリ追加
- ランキング共有機能
- 統計・分析機能

---

## 🎯 MVP完成への道筋

### 現在地（2026年1月27日）
```
✅ Phase 1-3: コアゲーム機能完成（100%）
✅ SortableJS統合完成（100%）
✅ コードベース最適化完了（100%）
□ オリジナルテーマ機能（0%）
□ スコアリング改善（0%）
```

### 目標（2026年1月31日）
```
MVP完成 → 友人・知人カップルに試用依頼
```
